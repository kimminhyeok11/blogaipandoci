var O=Object.defineProperty;var P=(T,e,t)=>e in T?O(T,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):T[e]=t;var D=(T,e,t)=>P(T,typeof e!="symbol"?e+"":e,t);try{typeof window!="undefined"&&(window.Config=window.Config||(typeof Config!="undefined"?Config:{}));const T=window.Config}catch(T){}class BlogApp{constructor(){D(this,"state",{user:null,isAuthReady:!1,currentCategory:"\uC804\uCCB4",editorInstance:null,archives:{category:"\uC804\uCCB4",tag:"",page:1,pageSize:20,sort:"latest",total:0}});D(this,"supabase",null);D(this,"authService",null);D(this,"_inFlight",new Map);D(this,"_reqTokens",{home:0,archives:0,popular:0});D(this,"_scrollStore",new Map);D(this,"_isPopNavigating",!1);this.handleGlobalClick=this.handleGlobalClick.bind(this),this.handlePopState=this.handlePopState.bind(this),this.init()}async withDedupe(e,t){if(this._inFlight.has(e))return this._inFlight.get(e);const s=(async()=>{try{return await t()}finally{this._inFlight.delete(e)}})();return this._inFlight.set(e,s),s}async init(){var e,t,s;try{if(await this.ensureSupabaseReady(1200),window.AuthService&&this.supabase){this.authService=new window.AuthService(this.supabase),this.authService.subscribe((i,r)=>{this.state.user=(r==null?void 0:r.user)||null;try{this._logAuthEvent("auth_state_change",{event:i})}catch(n){}this.renderNav()});try{this.authService.onAuthStateChange()}catch(i){}}if(this.bindGlobalListeners(),this.authService){const i=await this.authService.getSession();this.state.user=(i==null?void 0:i.user)||null;try{const r=new URL(window.location.href),n=r.searchParams,o=window.location.hash||"",d=n.get("token_hash"),u=(n.get("type")||"").toLowerCase(),c=this._normalizeOtpType(u),p=n.get("code"),g=/access_token=|refresh_token=|type=recovery/.test(o);if(d&&c){this.setLoading(!0);try{const{data:l,error:h}=await this.supabase.auth.verifyOtp({token_hash:d,type:c});if(!h&&((e=l==null?void 0:l.session)!=null&&e.user)){this.state.user=l.session.user,n.delete("token_hash"),n.delete("type");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}else h&&(console.warn("verifyOtp \uC624\uB958:",h),UIComponents.showToast("\uB85C\uADF8\uC778 \uD1A0\uD070 \uD655\uC778\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4. \uB9C1\uD06C\uB97C \uB2E4\uC2DC \uC694\uCCAD\uD574\uC8FC\uC138\uC694.","error"))}catch(l){console.warn("verifyOtp \uC2E4\uD328:",l)}}else if(d&&!c){this.setLoading(!0);try{const{data:l,error:h}=await this.supabase.auth.verifyOtp({token_hash:d,type:"magiclink"});if(!h&&((t=l==null?void 0:l.session)!=null&&t.user)){this.state.user=l.session.user,n.delete("token_hash");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}else h&&(console.warn("verifyOtp(magiclink, fallback) \uC624\uB958:",h),UIComponents.showToast("\uB85C\uADF8\uC778 \uB9C1\uD06C \uD655\uC778 \uC2E4\uD328. \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.","error"))}catch(l){console.warn("verifyOtp(magiclink, fallback) \uC2E4\uD328:",l)}}else if(p){this.setLoading(!0);try{const{data:l,error:h}=await this.supabase.auth.exchangeCodeForSession({code:p});if(!h&&((s=l==null?void 0:l.session)!=null&&s.user)){this.state.user=l.session.user,n.delete("code");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}}catch(l){console.warn("exchangeCodeForSession \uC2E4\uD328:",l)}}else if(g){this.setLoading(!0);const{data:{session:l}}=await this.supabase.auth.getSession();if(l!=null&&l.user){this.state.user=l.user;const h=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,h),UIComponents.showToast(l.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}}}catch(r){}}else this.state.user=null;this.state.isAuthReady=!0,this.renderNav(),this.handleRouting(),window.addEventListener("popstate",this.handlePopState);const a=DOM.$("#app-loader");a&&DOM.hide(a,{complete:()=>a.remove()}),this.supabase&&this.supabase.auth&&typeof this.supabase.auth.onAuthStateChange=="function"&&this.supabase.auth.onAuthStateChange((i,r)=>{var d;const n=(r==null?void 0:r.user)||null,o=((d=this.state.user)==null?void 0:d.id)!==(n==null?void 0:n.id);this.state.user=n,o&&(this.renderNav(),n?UIComponents.showToast(n.email+"\uB2D8, \uD658\uC601\uD569\uB2C8\uB2E4!","success"):(UIComponents.showToast("\uB85C\uADF8\uC544\uC6C3\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","info"),this.navigate("/")))});try{this.supabase&&await this.logSiteVisit()}catch(i){console.warn("\uBC29\uBB38 \uB85C\uADF8 \uAE30\uB85D \uC2E4\uD328:",i)}}catch(a){console.error("App initialization failed:",a),UIComponents.showToast("\uC571 \uCD08\uAE30\uD654 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.","error");const i=DOM.$("#app-loader");i&&(i.innerHTML='<div class="text-red-600">\uC571 \uB85C\uB4DC\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.</div>')}}_normalizeOtpType(e=""){switch(String(e||"").toLowerCase()){case"login":case"signin":case"email":return"magiclink";case"register":return"signup";case"recover":return"recovery";case"magiclink":case"signup":case"recovery":case"invite":return e;default:return e||"magiclink"}}async ensureSupabaseReady(e=800){var t,s,a,i;try{if(this.supabase)return!0;const r=Date.now();if(window.supabase&&((t=window.Config)!=null&&t.SUPABASE_URL)&&((s=window.Config)!=null&&s.SUPABASE_ANON_KEY))return this.supabase=window.supabase.createClient(window.Config.SUPABASE_URL,window.Config.SUPABASE_ANON_KEY,{auth:{storageKey:"sb-insurelog-auth-token"}}),!0;for(;Date.now()-r<e;)if(await new Promise(n=>setTimeout(n,50)),window.supabase&&((a=window.Config)!=null&&a.SUPABASE_URL)&&((i=window.Config)!=null&&i.SUPABASE_ANON_KEY))return this.supabase=window.supabase.createClient(window.Config.SUPABASE_URL,window.Config.SUPABASE_ANON_KEY,{auth:{storageKey:"sb-insurelog-auth-token"}}),!0;return!!this.supabase}catch(r){return console.warn("ensureSupabaseReady \uC2E4\uD328:",r),!1}}bindGlobalListeners(){document.addEventListener("click",this.handleGlobalClick),document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelector('[id*="modal"]:not(.hidden)');t&&t.id&&DOM.closeModal(t.id)}try{this._keySeq=this._keySeq||[];const t=(e.key||"").toLowerCase();if(t==="g"){this._keySeq=["g"];return}this._keySeq[0]==="g"&&(t==="a"?(e.preventDefault(),this.navigate("/archives")):t==="d"?(e.preventDefault(),this.navigate("/dashboard")):t==="l"&&(e.preventDefault(),this.navigate("/login")),this._keySeq=[])}catch(t){}})}handleGlobalClick(e){const t=e.target.closest("[data-route]");if(t){const s=!!(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||e.button!==void 0&&e.button!==0),a=t.tagName==="A"?t:t.closest("a"),i=a&&(a.getAttribute("target")==="_blank"||a.hasAttribute("download"));if(s||i)return;e.preventDefault();const r=t.getAttribute("href")||t.getAttribute("data-href");r&&r!=="#"&&this.navigate(r)}if(e.target.classList&&e.target.classList.contains("modal-overlay")){const s=e.target.closest('[id*="modal"]');s&&s.id&&DOM.closeModal(s.id)}}handlePopState(){this._isPopNavigating=!0,this.handleRouting(),this.renderNav();try{this.restoreScrollForCurrentPath()}catch(e){}this._isPopNavigating=!1}navigate(e){const t=this.normalizePath(e);if(window.location.pathname+window.location.search!==t){try{this.saveScrollForCurrentPath()}catch(i){}window.history.pushState(null,"",t),this.handleRouting(),this.renderNav()}}handleRouting(){const e=this.normalizePath(window.location.pathname),t=new URLSearchParams(window.location.search);let s;e==="/"||e==="/home"||e==="/library"?s="view-library":e==="/archives"||e==="/archive"||e==="/post"?s="view-archives":e.startsWith("/post/")?s="view-post":e==="/dashboard"?s="view-dashboard":e==="/writer"||e.startsWith("/writer/")?s="view-writer":s="view-library";const a=DOM.$(".app-view.active");a&&a.id!==s&&(a.classList.remove("active"),DOM.hide(a));try{const i=window.Router&&typeof window.Router.resolve=="function"?window.Router.resolve(e):null;if(i&&typeof i.exec=="function"){if(i.requiresAuth&&!this.checkAuth(!0))return;i.exec(this,t)}else this.render404()}catch(i){console.warn("Router \uCC98\uB9AC \uC911 \uC624\uB958:",i),this.render404()}}bindModalCloseHandlers(e,t={}){try{const s=DOM.$(`#${e}`);if(!s)return;const{closeSelector:a=".modal-close",cancelSelector:i=".cancel-btn",onClose:r=null}=t,n=()=>{if(DOM.closeModal(e),typeof r=="function")try{r()}catch(u){}},o=s.querySelector(a),d=s.querySelector(i);o&&o.addEventListener("click",n),d&&d.addEventListener("click",n)}catch(s){}}renderDashboard(e="#view-dashboard"){var a;if(!this.checkAuth(!0))return;this.switchToView("view-dashboard");const t=DOM.$(e);if(!t)return;const s=((a=this.state.user)==null?void 0:a.email)||"\uC54C \uC218 \uC5C6\uC74C";t.innerHTML=`
          <section class="max-w-4xl mx-auto py-10 px-6">
            <div class="flex items-center justify-between mb-4">
              <h1 class="text-2xl font-bold">\uB300\uC2DC\uBCF4\uB4DC</h1>
              <a href="/writer" data-route class="px-3 py-2 rounded-lg bg-black text-white">\uC0C8 \uAE00 \uC4F0\uAE30</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold mb-2">\uACC4\uC815</h2>
                <p class="text-sm text-gray-600">\uC774\uBA54\uC77C: ${this.escapeHTML(s)}</p>
              </div>
              <div class="p-4 border rounded-lg">
                <h2 class="text-lg font-semibold mb-2">\uCD5C\uADFC \uD65C\uB3D9</h2>
                <div id="dashboard-recent" class="text-sm text-gray-600">\uBD88\uB7EC\uC624\uB294 \uC911\u2026</div>
              </div>
            </div>
          </section>`,this.updatePageMeta("\uB300\uC2DC\uBCF4\uB4DC - InsureLog","\uB0B4 \uACC4\uC815 \uBC0F \uCD5C\uADFC \uD65C\uB3D9",window.location.href,"/og-image.svg"),this.loadRecentActivities().catch(i=>this.handleError(i,"loadRecentActivities"))}async loadRecentActivities(){try{if(!this.supabase)return;const e=window.Config&&window.Config.DB_TABLE_NAME||"posts",{data:t,error:s}=await this.supabase.from(e).select("id, title, slug, status, updated_at").order("updated_at",{ascending:!1}).limit(5);if(s)throw s;const a=DOM.$("#dashboard-recent");if(!a)return;if(!t||t.length===0){a.textContent="\uCD5C\uADFC \uD3B8\uC9D1 \uD56D\uBAA9\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.";return}a.innerHTML='<ul class="space-y-2">'+t.map(i=>{const r="/writer/"+i.slug,n=this.formatDateKR(i.updated_at);return`<li class="flex items-center justify-between">
                    <a href="${r}" data-route class="text-sm font-medium">${this.escapeHTML(i.title||"\uC81C\uBAA9 \uC5C6\uC74C")}</a>
                    <span class="text-xs text-gray-500">${n}</span>
                </li>`}).join("")+"</ul>"}catch(e){this.handleError(e,"loadRecentActivities")}}normalizePath(e){try{const t=new URL(e,window.location.origin);let s=t.pathname||"/";try{s=decodeURI(s)}catch(a){}return s==="/index.html"&&(s="/"),s.length>1&&s.endsWith("/")&&(s=s.slice(0,-1)),s=s.replace(/\/+/g,"/"),s+(t.search||"")}catch(t){return e==="/index.html"?"/":e.length>1&&e.endsWith("/")?e.slice(0,-1):e||"/"}}getQueryParams(){const e=new URLSearchParams(window.location.search),t={};return e.forEach((s,a)=>{t[a]=s}),t}updateRobotsMeta(e="index,follow"){const t=DOM.$('meta[name="robots"]');t&&(t.content=e)}updatePrevNextLinks(e=1,t=1){const s=document.head;if(!s)return;const a=d=>{let u=s.querySelector(`link[rel="${d}"]`);return u||(u=document.createElement("link"),u.setAttribute("rel",d),s.appendChild(u)),u},i=new URL(window.location.href),r=d=>{const u=new URL(i.href);return u.searchParams.set("page",String(d)),u.toString()},n=a("prev");t>1?n.setAttribute("href",r(t-1)):n.removeAttribute("href");const o=a("next");t<e?o.setAttribute("href",r(t+1)):o.removeAttribute("href")}focusFirstInView(e){try{const t=DOM.$("#"+e);if(!t)return;t.hasAttribute("tabindex")||t.setAttribute("tabindex","-1"),t.focus({preventScroll:!0})}catch(t){}}saveScrollForCurrentPath(){const e=window.location.pathname+window.location.search;this._scrollStore.set(e,{x:window.scrollX,y:window.scrollY})}restoreScrollForCurrentPath(){const e=window.location.pathname+window.location.search,t=this._scrollStore.get(e);t&&typeof t.y=="number"&&window.scrollTo({left:t.x||0,top:t.y||0,behavior:"auto"})}renderArchives(e="#view-archives"){e==="#view-archives"&&this.switchToView("view-archives");const t=DOM.$(e);if(!t)return;try{const g=new URLSearchParams(window.location.search),l=g.get("category"),h=g.get("tag"),m=Number(g.get("page")||this.state.archives.page)||1,f=Number(g.get("pageSize")||this.state.archives.pageSize)||20,w=g.get("sort")||this.state.archives.sort||"latest";this.state.archives.category=l||this.state.archives.category||"\uC804\uCCB4",this.state.archives.tag=h||this.state.archives.tag||"",this.state.archives.page=m,this.state.archives.pageSize=f,this.state.archives.sort=["latest","oldest","title"].includes(w)?w:"latest"}catch(g){}const{category:s,tag:a,pageSize:i,sort:r}=this.state.archives;t.innerHTML=`<section class="max-w-4xl mx-auto py-10 px-6"><div class="flex items-center justify-between"><h1 class="text-2xl font-bold">\uC544\uCE74\uC774\uBE0C</h1><div id="archives-header-info" class="text-xs text-gray-500">\uD398\uC774\uC9C0\uB2F9 ${i}\uAC1C</div></div><div class="mt-4 grid grid-cols-1 sm:grid-cols-4 gap-3"><div><label class="block text-xs text-gray-600">\uCE74\uD14C\uACE0\uB9AC</label><select id="archives-filter-category" class="mt-1 w-full border rounded-lg p-2"><option value="\uC804\uCCB4">\uC804\uCCB4</option></select></div><div><label class="block text-xs text-gray-600">\uD0DC\uADF8</label><input id="archives-filter-tag" type="text" class="mt-1 w-full border rounded-lg p-2" placeholder="\uC608: \uBCF4\uD5D8"></div><div><label class="block text-xs text-gray-600">\uC815\uB82C</label><select id="archives-filter-sort" class="mt-1 w-full border rounded-lg p-2"><option value="latest">\uCD5C\uC2E0\uC21C</option><option value="oldest">\uC624\uB798\uB41C\uC21C</option><option value="title">\uC81C\uBAA9\uC21C</option></select></div><div><label class="block text-xs text-gray-600">\uAC1C\uC218</label><select id="archives-filter-pageSize" class="mt-1 w-full border rounded-lg p-2"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select></div><div class="sm:col-span-4 flex items-center justify-end"><button id="archives-filter-apply" class="px-3 py-2 rounded-lg bg-black text-white">\uD544\uD130 \uC801\uC6A9</button></div></div><div id="archives-list" class="mt-6 space-y-6"></div><div id="archives-pagination" class="mt-8 flex items-center justify-center gap-2"></div></section>`;const n=this.state.archives.page||1,o=n>1?`\uC544\uCE74\uC774\uBE0C - \uD398\uC774\uC9C0 ${n} - InsureLog`:"\uC544\uCE74\uC774\uBE0C - InsureLog";this.updatePageMeta(o,"\uC6D4\uBCC4 \uC544\uCE74\uC774\uBE0C\uC640 \uCE74\uD14C\uACE0\uB9AC/\uD0DC\uADF8 \uD544\uD130",window.location.href,"/og-image.svg");const d=DOM.$("#archives-filter-tag");d&&(d.value=a||"");const u=DOM.$("#archives-filter-sort");u&&(u.value=r||"latest");const c=DOM.$("#archives-filter-pageSize");c&&(c.value=String(i||20));const p=DOM.$("#archives-filter-apply");p&&(p.onclick=()=>{const g=DOM.$("#archives-filter-category"),l=DOM.$("#archives-filter-tag"),h=DOM.$("#archives-filter-sort"),m=DOM.$("#archives-filter-pageSize");this.state.archives.category=g?g.value:"\uC804\uCCB4",this.state.archives.tag=l?l.value.trim():"",this.state.archives.sort=h?h.value:"latest",this.state.archives.pageSize=m&&Number(m.value)||20,this.state.archives.page=1;const f=new URLSearchParams({category:this.state.archives.category||"\uC804\uCCB4",tag:this.state.archives.tag||"",sort:this.state.archives.sort||"latest",pageSize:String(this.state.archives.pageSize||20),page:"1"});this.navigate(`/archives?${f.toString()}`)}),this.loadArchives().catch(g=>this.handleError(g,"loadArchives"))}async loadArchives(){const{category:e,tag:t,page:s,pageSize:a,sort:i}=this.state.archives,r=DOM.$("#archives-list");if(!r||!this.supabase)return;const n=window.Config&&window.Config.DB_TABLE_NAME||"posts";let o=this.supabase.from(n).select("id",{count:"exact",head:!0}).eq("status","published");e&&e!=="\uC804\uCCB4"&&(o=o.eq("category",e)),t&&(o=o.contains("tags",[String(t).toLowerCase()]));const{count:d}=await o;this.state.archives.total=d||0;let c=this.supabase.from(n).select("id, title, slug, created_at, category, thumbnail_url").eq("status","published");t&&(c=c.contains("tags",[String(t).toLowerCase()])),i==="latest"?c=c.order("created_at",{ascending:!1}):i==="oldest"?c=c.order("created_at",{ascending:!0}):i==="title"?c=c.order("title",{ascending:!0}):c=c.order("created_at",{ascending:!1}),e&&e!=="\uC804\uCCB4"&&(c=c.eq("category",e));const p=(s-1)*a,g=p+a-1;c=c.range(p,g);const l=Date.now();this._reqTokens.archives=l;const h=`archives:${e}:${t}:${p}-${g}`,{data:m,error:f}=await this.withDedupe(h,()=>c);if(f)throw f;const w=new Set(["\uC804\uCCB4"]);(m||[]).forEach(y=>{y.category&&w.add(y.category)});const $=DOM.$("#archives-filter-category");$&&$.options.length<=1&&($.innerHTML=Array.from(w).map(y=>`<option value="${this.escapeHTML(y)}">${this.escapeHTML(y)}</option>`).join(""),$.value=e||"\uC804\uCCB4");const b=m||[];if(this._reqTokens.archives===l){if(!b||b.length===0)r.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';else{const y=this.renderPostsListHTML(b);r.innerHTML=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${y}</div>`}this.renderArchivesPagination();try{const y=Math.max(1,Math.ceil((this.state.archives.total||0)/(this.state.archives.pageSize||20)));this.updatePrevNextLinks(y,this.state.archives.page||1);const v=(this.state.archives.page||1)>1||!!this.state.archives.tag;this.updateRobotsMeta(v?"noindex,follow":"index,follow")}catch(y){}try{const y=(s-1)*a+1,v=Math.min(this.state.archives.total,s*a),k=document.querySelector("#view-archives section .text-xs.text-gray-500");k&&(k.textContent=`\uCD1D ${this.state.archives.total}\uAC1C \xB7 ${y}\u2013${v} \uD45C\uC2DC\uC911`)}catch(y){}}}renderArchivesPagination(){const{page:e,pageSize:t,total:s}=this.state.archives,a=Math.max(1,Math.ceil(s/t)),i=DOM.$("#archives-pagination");if(!i)return;if(a<=1){i.innerHTML="";return}const r=(g,l=null,h=!1)=>`<button data-page="${g}" ${h?'aria-current="page"':""} aria-label="${l||`\uD398\uC774\uC9C0 ${g}`}" class="px-3 py-1 rounded border ${h?"bg-black text-white":"hover:bg-black/5"}">${l||g}</button>`,n=e>1?r(e-1,"\uC774\uC804"):'<span class="px-3 py-1 text-gray-400" aria-hidden="true">\uC774\uC804</span>',o=e<a?r(e+1,"\uB2E4\uC74C"):'<span class="px-3 py-1 text-gray-400" aria-hidden="true">\uB2E4\uC74C</span>',d=5,u=Math.max(1,e-Math.floor(d/2)),c=Math.min(a,u+d-1),p=[];for(let g=u;g<=c;g++)p.push(r(g,null,g===e));i.innerHTML=n+p.join("")+o,i.querySelectorAll("button[data-page]").forEach(g=>{g.onclick=()=>{const l=Number(g.getAttribute("data-page"))||1;this.state.archives.page=l;const h=new URLSearchParams({category:this.state.archives.category||"\uC804\uCCB4",tag:this.state.archives.tag||"",sort:this.state.archives.sort||"latest",pageSize:String(this.state.archives.pageSize||20),page:String(l)});this.navigate(`/archives?${h.toString()}`)}})}switchToView(e){const t=DOM.$("#"+e);DOM.$$(".app-view").forEach(s=>{s!==t&&(s.classList.remove("active"),DOM.hide(s))}),t&&(t.style.display="block",t.classList.add("active"),DOM.show(t),this._isPopNavigating||window.scrollTo({top:0,behavior:"smooth"}),this.focusFirstInView(e),window.LayoutManager&&typeof window.LayoutManager.onViewRendered=="function"&&window.LayoutManager.onViewRendered(t))}renderNav(){const e=DOM.$("#main-nav-container");if(!e)return;const t=!!this.state.user,s=e.querySelector("#nav-links");if(s&&this._navLogged===t){let c=this.normalizePath(window.location.pathname);c==="/archive"&&(c="/archives"),c==="/post"&&(c="/archives"),(c==="/home"||c==="/library")&&(c="/"),s.querySelectorAll("a[data-route]").forEach(p=>{const g=p.getAttribute("href");let l="/";try{l=this.normalizePath(new URL(g,window.location.origin).pathname)}catch(m){l=this.normalizePath(g||"/")}l==="/archive"&&(l="/archives"),(l==="/home"||l==="/library")&&(l="/"),l===c?p.setAttribute("aria-current","page"):p.removeAttribute("aria-current")});return}const n=['<a href="/archives" data-route class="nav-link">\uC544\uCE74\uC774\uBE0C</a>',t?'<a href="/writer" data-route class="nav-link">\uAE00\uC4F0\uAE30</a>':"",t?'<a href="/dashboard" data-route class="nav-link">\uB300\uC2DC\uBCF4\uB4DC</a>':"",'<a href="/feed.xml" class="nav-link" rel="alternate" type="application/rss+xml">RSS</a>','<a href="/sitemap.xml" class="nav-link">Sitemap</a>',t?'<a id="logout-btn" href="#" class="nav-link">\uB85C\uADF8\uC544\uC6C3</a>':'<a id="login-link" href="/login" data-route class="nav-link">\uB85C\uADF8\uC778</a>'].filter(Boolean).join("");e.innerHTML='<nav class="w-full nav-inner" role="navigation" aria-label="\uC8FC\uC694"><a href="/" data-route class="brand font-extrabold text-xl tracking-tight" aria-label="\uD648">InsureLog</a><div id="nav-links" class="header-nav mobile-nav-actions">'+n+"</div></nav>",this._navLogged=t;let o=this.normalizePath(window.location.pathname);o==="/archive"&&(o="/archives"),o==="/post"&&(o="/archives"),(o==="/home"||o==="/library")&&(o="/"),e.querySelectorAll("#nav-links a[data-route]").forEach(c=>{const p=c.getAttribute("href")||"/";let g=(()=>{try{return this.normalizePath(new URL(p,window.location.origin).pathname)}catch(h){return this.normalizePath(p)}})();g==="/archive"&&(g="/archives"),(g==="/home"||g==="/library")&&(g="/"),g===o?c.setAttribute("aria-current","page"):c.removeAttribute("aria-current")});const u=DOM.$("#logout-btn");u&&(u.onclick=async c=>{var p,g;try{(p=c==null?void 0:c.preventDefault)==null||p.call(c)}catch(l){}try{this.authService?await this.authService.signOut():(g=this.supabase)!=null&&g.auth&&await this.supabase.auth.signOut(),UIComponents.showToast("\uB85C\uADF8\uC544\uC6C3\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","info"),this.navigate("/")}catch(l){this.navigate("/")}})}renderHome(e=new URLSearchParams){this.switchToView("view-library");const t=DOM.$("#view-library");if(t){t.innerHTML='<section><div class="section-header"><h2 class="section-title">\uCD5C\uADFC \uAE00</h2></div><div id="home-posts" class="grid grid-cols-1 gap-2"></div><div id="home-pagination" class="flex justify-center"></div></section>';const s=Number(e.get("page")||"1"),a=s>1?`\uCD5C\uADFC \uAE00 - \uD398\uC774\uC9C0 ${s} - InsureLog`:"InsureLog - \uCD5C\uADFC \uAE00",i=s>1?`\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D \xB7 \uD398\uC774\uC9C0 ${s}`:"\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D";this.updatePageMeta(a,i,window.location.href,"/og-image.svg"),this.updateRobotsMeta(s===1?"index,follow":"noindex,follow"),this.loadHomePosts(e).catch(r=>this.handleError(r,"loadHomePosts"))}}renderPost(e,t="#view-post"){t==="#view-post"&&this.switchToView("view-post");const s=DOM.$(t);s&&(s.innerHTML='<article><div class="mb-6"><div class="h-8 w-2/3 bg-gray-200 animate-pulse rounded"></div></div><div class="space-y-3"><div class="h-5 bg-gray-200 animate-pulse rounded"></div><div class="h-5 bg-gray-200 animate-pulse rounded"></div></div></article>',this.loadPostDetail(e,t).catch(a=>this.handleError(a,"loadPostDetail")))}renderPostModal(e){const t=encodeURIComponent(String(e||"").trim());this.navigate(t?`/post/${t}`:"/archives")}renderArchivesModal(){this.navigate("/archives")}renderWriterModal(e){if(!this.checkAuth(!0))return;const t=String(e||"").trim(),s=t?`/writer/${encodeURIComponent(t)}`:"/writer";this.navigate(s)}renderWriter(e,t="#view-writer"){if(!this.checkAuth(!0))return;t==="#view-writer"&&this.switchToView("view-writer");const s=DOM.$(t);if(!s)return;const a=!!e;s.innerHTML=`<section class="nav-inner py-10"><div class="flex items-center justify-between"><h1 class="text-2xl font-bold">${a?"\uAE00 \uC218\uC815":"\uAE00 \uC791\uC131"}</h1><button type="button" id="btn-open-post-picker" class="btn btn-outline btn-sm">\uAE30\uC874 \uAE00 \uBD88\uB7EC\uC624\uAE30</button></div><form id="writer-form" class="mt-6 space-y-5 editor-shell"><div id="writer-errors" class="sr-only" role="alert" aria-live="assertive"></div><div><label class="block text-sm font-medium">\uC81C\uBAA9</label><input id="post-title" type="text" class="form-input" placeholder="\uC81C\uBAA9\uC744 \uC785\uB825\uD558\uC138\uC694" required aria-errormessage="writer-errors" aria-invalid="false"></div><div><label class="block text-sm font-medium">\uC694\uC57D</label><textarea id="post-summary" class="form-textarea" placeholder="\uC694\uC57D\uC744 \uC785\uB825\uD558\uC138\uC694"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">\uCE74\uD14C\uACE0\uB9AC</label><input id="post-category" type="text" class="form-input" placeholder="\uC608: \uAE30\uC220"></div><div><label class="block text-sm font-medium">\uC0C1\uD0DC</label><select id="post-status" class="form-select"><option value="draft">\uCD08\uC548</option><option value="published">\uBC1C\uD589</option></select></div></div><div><label class="block text-sm font-medium">\uD0DC\uADF8</label><input id="post-tags" type="text" class="form-input" placeholder="\uD0DC\uADF8\uB97C \uC27C\uD45C\uB85C \uAD6C\uBD84\uD574 \uC785\uB825 (\uC608: \uBCF4\uD5D8,\uC790\uB3D9\uCC28,\uAC00\uC774\uB4DC)"></div><div id="tag-suggestions" class="flex flex-wrap gap-2 mt-2" aria-label="\uCD94\uCC9C \uD0DC\uADF8" aria-live="polite"></div><div><label class="block text-sm font-medium">\uC378\uB124\uC77C \uC774\uBBF8\uC9C0</label><input id="post-thumb" type="file" accept="image/*" class="form-input"/></div><div><label class="block text-sm font-medium">\uCF58\uD150\uCE20 (\uBCF5\uC0AC/\uBD99\uC5EC\uB123\uAE30 \uC9C0\uC6D0)</label><div id="editor-toolbar" class="editor-toolbar btn-group mt-2"><button type="button" data-cmd="bold" class="btn btn-outline btn-sm">\uAD75\uAC8C</button><button type="button" data-cmd="italic" class="btn btn-outline btn-sm">\uAE30\uC6B8\uC784</button><button type="button" data-cmd="underline" class="btn btn-outline btn-sm">\uBC11\uC904</button><button type="button" data-cmd="h2" class="btn btn-outline btn-sm">H2</button><button type="button" data-cmd="p" class="btn btn-outline btn-sm">\uBCF8\uBB38</button><button type="button" data-cmd="ul" class="btn btn-outline btn-sm">\uBAA9\uB85D</button><button type="button" data-cmd="ol" class="btn btn-outline btn-sm">\uBC88\uD638\uBAA9\uB85D</button><button type="button" data-cmd="quote" class="btn btn-outline btn-sm">\uC778\uC6A9</button><button type="button" data-cmd="code" class="btn btn-outline btn-sm">\uCF54\uB4DC</button><button type="button" data-cmd="link" class="btn btn-outline btn-sm">\uB9C1\uD06C</button><button type="button" data-cmd="clear" class="btn btn-outline btn-sm">\uC11C\uC2DD\uD574\uC81C</button></div><div id="post-content-editor" contenteditable="true" class="editor-surface prose-custom" placeholder="\uB2E4\uB978 \uAE00\uC744 \uBCF5\uC0AC\uD574 \uBD99\uC5EC\uB123\uC73C\uBA74 \uD615\uC2DD\uC774 \uC720\uC9C0\uB429\uB2C8\uB2E4."></div><p class="text-xs text-gray-500 mt-1">\uBD99\uC5EC\uB123\uAE30 \uC2DC \uAE30\uBCF8 \uC11C\uC2DD(\uAD75\uAC8C, \uC81C\uBAA9, \uBAA9\uB85D \uB4F1)\uC774 \uC720\uC9C0\uB429\uB2C8\uB2E4. \uC800\uC7A5 \uC2DC \uC548\uC804\uD558\uAC8C \uC815\uC81C\uB41C HTML\uB85C \uC800\uC7A5\uD569\uB2C8\uB2E4.</p></div><div class="flex items-center gap-2"><button type="submit" class="btn btn-primary">\uC800\uC7A5</button><a href="/" data-route class="btn btn-secondary">\uCDE8\uC18C</a></div></form></section>`,this.updatePageMeta(a?"\uAE00 \uC218\uC815 - InsureLog":"\uAE00 \uC791\uC131 - InsureLog",a?"\uAE30\uC874 \uAE00\uC744 \uC218\uC815\uD569\uB2C8\uB2E4.":"\uC0C8 \uAE00\uC744 \uC791\uC131\uD569\uB2C8\uB2E4.",window.location.href,"/og-image.svg"),this.renderPostPickerUI(t),a&&this.loadWriterData(e).catch(r=>this.handleError(r,"loadWriterData")),this.loadTagSuggestions().catch(r=>this.handleError(r,"loadTagSuggestions"));const i=DOM.$("#writer-form");i&&i.addEventListener("submit",async r=>{r.preventDefault(),await this.submitWriterForm(a?e:null,t)},{once:!0}),this.setupContentEditor(a?e:null)}renderPostPickerUI(e="#view-writer"){const t=DOM.$(e)||DOM.$("#writer-modal")||DOM.$("#view-writer");if(!t)return;if(!DOM.$("#post-picker-modal")){const o=document.createElement("div");o.id="post-picker-modal",o.className="hidden",o.innerHTML=`
                <div class="modal-overlay">
                    <div class="modal-content modal-content-lg">
                        <div class="modal-header">
                            <h2 class="modal-title">\uAE30\uC874 \uAE00 \uC120\uD0DD</h2>
                            <button class="modal-close" id="post-picker-close" aria-label="\uB2EB\uAE30">\u2715</button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" id="post-picker-query" class="w-full border rounded-lg p-2" placeholder="\uC81C\uBAA9\uC73C\uB85C \uAC80\uC0C9..."/>
                            </div>
                            <div id="post-picker-list" class="space-y-2"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn px-4 py-2 rounded-lg border" id="post-picker-cancel">\uB2EB\uAE30</button>
                        </div>
                    </div>
                </div>`,t.appendChild(o)}const s=DOM.$("#btn-open-post-picker"),a=DOM.$("#post-picker-close"),i=DOM.$("#post-picker-cancel"),r=DOM.$("#post-picker-query");s&&(s.onclick=()=>{DOM.openModal("post-picker-modal"),this.loadPostsForPicker("")});const n=()=>DOM.closeModal("post-picker-modal");a&&(a.onclick=n),i&&(i.onclick=n),r&&(r.oninput=()=>{clearTimeout(this._postPickerTimer),this._postPickerTimer=setTimeout(()=>{this.loadPostsForPicker(r.value.trim())},200)})}async loadPostsForPicker(e=""){try{if(!this.supabase)return;const t=window.Config&&window.Config.DB_TABLE_NAME||"posts";let s=this.supabase.from(t).select("id, title, slug, status, created_at").order("created_at",{ascending:!1}).limit(50);e&&(s=this.supabase.from(t).select("id, title, slug, status, created_at").ilike("title",`%${e}%`).order("created_at",{ascending:!1}).limit(50));const{data:a,error:i}=await s;if(i)throw i;const r=DOM.$("#post-picker-list");if(!r)return;if(!a||a.length===0){r.innerHTML='<div class="text-sm text-gray-600">\uAC80\uC0C9 \uACB0\uACFC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';return}r.innerHTML=a.map(n=>{const o="/writer/"+n.slug,d=this.formatDateKR(n.created_at),c=`<span class="badge">${this.statusToKor(n.status)}</span>`;return`
                    <div class="post-picker-item">
                        <div class="post-picker-main">
                            <a href="${o}" data-route class="post-picker-title">${this.escapeHTML(n.title||"\uC81C\uBAA9 \uC5C6\uC74C")}</a>
                            <div class="post-picker-meta">\uC791\uC131\uC77C ${d} \xB7 \uC0C1\uD0DC ${c}</div>
                        </div>
                        <div class="post-picker-actions">
                            <a href="${o}" data-route class="btn-xs">\uD3B8\uC9D1</a>
                        </div>
                    </div>`}).join("")}catch(t){this.handleError(t,"loadPostsForPicker")}}statusToKor(e){switch(String(e||"").toLowerCase()){case"published":return"\uACF5\uAC1C";case"private":return"\uBE44\uACF5\uAC1C";case"draft":default:return"\uC784\uC2DC"}}renderLoginModal(){const e=document.getElementById("modal-container")||document.body,t=window.Config&&window.Config.SITE_URL||window.location.origin;if(!document.getElementById("login-modal")){const a=document.createElement("div");a.id="login-modal",a.className="hidden",a.innerHTML=`
                <div class="modal-overlay">
                    <div class="modal-content modal-content-md">
                        <div class="modal-header">
                            <h3 class="modal-title">\uB85C\uADF8\uC778</h3>
                            <button class="modal-close" aria-label="\uB2EB\uAE30">\u2715</button>
                        </div>
                        <div class="modal-body">
                            <form id="magic-form" class="login-form" novalidate>
                                <div id="login-errors" class="sr-only" role="alert" aria-live="assertive"></div>
                                <div class="form-field">
                                  <label class="block text-sm font-medium" for="magic-email">\uC774\uBA54\uC77C \uC8FC\uC18C</label>
                                  <input id="magic-email" type="email" class="form-input w-full" placeholder="you@example.com" required autocomplete="email" inputmode="email" aria-describedby="magic-help login-errors" aria-errormessage="magic-error">
                                </div>
                                <div id="magic-error" class="form-error hidden" role="alert" aria-live="assertive">
                                  <span>\uC62C\uBC14\uB978 \uC774\uBA54\uC77C \uD615\uC2DD\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694.</span>
                                </div>
                                <button id="magic-send" type="submit" class="btn btn-primary w-full">\uB85C\uADF8\uC778 \uB9C1\uD06C \uBCF4\uB0B4\uAE30</button>
                                <p id="magic-help" class="text-xs text-gray-500">\uBA54\uC77C\uC758 \uB9C1\uD06C\uB97C \uB204\uB974\uBA74 \uC790\uB3D9 \uB85C\uADF8\uC778\uB429\uB2C8\uB2E4. 1\uBD84 \uB0B4 \uB3C4\uCC29\uD558\uC9C0 \uC54A\uC73C\uBA74 \uC2A4\uD338\uD568\uB3C4 \uD655\uC778\uD574\uC8FC\uC138\uC694.</p>
                                <div id="magic-success" class="text-sm text-green-700 hidden" role="status" aria-live="polite">\uC774\uBA54\uC77C\uB85C \uB85C\uADF8\uC778 \uB9C1\uD06C\uB97C \uBCF4\uB0C8\uC2B5\uB2C8\uB2E4. \uBA54\uC77C\uD568\uC744 \uD655\uC778\uD574\uC8FC\uC138\uC694.</div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn px-4 py-2 rounded-lg border cancel-btn">\uB2EB\uAE30</button>
                        </div>
                    </div>
                </div>`,e.appendChild(a),this.bindModalCloseHandlers("login-modal",{onClose:()=>this.navigate("/")})}const s=DOM.$("#magic-form");if(s){if(s.dataset.bound==="true"){DOM.openModal("login-modal");return}const a=DOM.$("#magic-email"),i=DOM.$("#magic-error"),r=DOM.$("#magic-success"),n=DOM.$("#magic-send"),o=u=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(u||"").trim()),d=u=>{if(!i)return;i.classList.toggle("hidden",!u),a&&(a.classList.toggle("error",!!u),a.setAttribute("aria-invalid",u?"true":"false"));const c=DOM.$("#login-errors");c&&(c.textContent=u?"\uC62C\uBC14\uB978 \uC774\uBA54\uC77C \uD615\uC2DD\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694.":"")};a==null||a.addEventListener("input",()=>d(!1)),s.addEventListener("submit",async u=>{var p;u.preventDefault();const c=String((a==null?void 0:a.value)||"").trim();if(!o(c)){d(!0),a==null||a.focus();return}if(!this.authService&&!((p=this.supabase)!=null&&p.auth))return UIComponents.showToast("\uC778\uC99D \uBAA8\uB4C8\uC744 \uCD08\uAE30\uD654\uD558\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.","error");try{if(n==null||n.setAttribute("disabled","true"),n&&(n.textContent="\uBCF4\uB0B4\uB294 \uC911\u2026",n.setAttribute("aria-busy","true")),this.authService)await this.authService.signInWithOtp(c,t);else{const{error:g}=await this.supabase.auth.signInWithOtp({email:c,options:{shouldCreateUser:!0,emailRedirectTo:t}});if(g)throw g}UIComponents.showToast("\uB85C\uADF8\uC778 \uB9C1\uD06C\uB97C \uC774\uBA54\uC77C\uB85C \uBCF4\uB0C8\uC2B5\uB2C8\uB2E4.","success"),r&&r.classList.remove("hidden")}catch(g){try{this._logAuthEvent("login_magic_failed",{email:c})}catch(h){}UIComponents.showToast("\uBA54\uC77C \uBC1C\uC1A1\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.","error");const l=DOM.$("#login-errors");l&&(l.textContent="\uBA54\uC77C \uBC1C\uC1A1\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4. \uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.")}finally{setTimeout(()=>{n==null||n.removeAttribute("disabled"),n&&(n.textContent="\uB85C\uADF8\uC778 \uB9C1\uD06C \uBCF4\uB0B4\uAE30",n.removeAttribute("aria-busy"))},1200)}}),s.dataset.bound="true"}DOM.openModal("login-modal")}render404(){this.switchToView("view-library");const e=DOM.$("#view-library");e&&(e.innerHTML='<section class="max-w-md mx-auto py-20 px-6 text-center"><h1 class="text-2xl font-extrabold">\uD398\uC774\uC9C0\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</h1><p class="text-sm text-gray-600 mt-2">\uC694\uCCAD\uD558\uC2E0 \uD398\uC774\uC9C0\uAC00 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.</p><div class="mt-6"><a href="/" data-route class="px-4 py-2 rounded-full bg-black text-white">\uD648\uC73C\uB85C</a></div></section>',this.updatePageMeta("\uD398\uC774\uC9C0\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4 - InsureLog","\uC694\uCCAD\uD55C \uD398\uC774\uC9C0\uAC00 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.",window.location.href,"/og-image.svg"))}handleError(e,t=""){var a,i,r;console.error("Error in "+t+":",e);let s="\uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.";(a=e.message)!=null&&a.includes("fetch")?s="\uB124\uD2B8\uC6CC\uD06C \uC5F0\uACB0\uC744 \uD655\uC778\uD574\uC8FC\uC138\uC694.":(i=e.message)!=null&&i.includes("auth")?s="\uB85C\uADF8\uC778\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.":(r=e.message)!=null&&r.includes("permission")&&(s="\uAD8C\uD55C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),UIComponents.showToast(s,"error")}async _logAuthEvent(e,t={}){try{if(this.authService){await this.authService.logAuthEvent(e,t);return}const s={type:e,email_hint:(t.email||"").replace(/(^.).+(@.+$)/,"$1***$2"),provider:t.provider||null,user_agent:navigator&&navigator.userAgent||null,at:new Date().toISOString(),success:!1};this.supabase&&await this.supabase.from("auth_events").insert(s)}catch(s){}}setLoading(e,t="#app-container"){const s=DOM.$(t)?t:DOM.$("#modal-container")?"#modal-container":"#app-container";e?DOM.showLoading(s):DOM.hideLoading(s)}checkAuth(e=!0){return this.state.user?!0:(e&&(UIComponents.showToast("\uB85C\uADF8\uC778\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.","warning"),this.navigate("/login")),!1)}updatePageMeta(e,t,s,a=null){document.title=e;const i=DOM.$('meta[name="description"]');i&&(i.content=t||"");const r=s||window.location.href;let n=a||"/og-image.svg";try{n=new URL(n,window.location.origin).href}catch(f){}const o=DOM.$('link[rel="canonical"]');o&&(o.href=r);const d=DOM.$('meta[property="og:title"]'),u=DOM.$('meta[property="og:description"]'),c=DOM.$('meta[property="og:url"]'),p=DOM.$('meta[property="og:image"]');d&&(d.content=e),u&&(u.content=t||""),c&&(c.content=r),p&&(p.content=n);const g=DOM.$('meta[name="twitter:title"]'),l=DOM.$('meta[name="twitter:description"]'),h=DOM.$('meta[name="twitter:image"]'),m=DOM.$('meta[name="twitter:card"]');g&&(g.content=e),l&&(l.content=t||""),h&&(h.content=n),m&&(m.content="summary_large_image")}async loadWriterData(e){var r,n;if(!this.supabase)return;const t=window.Config&&window.Config.DB_TABLE_NAME||"posts";let{data:s,error:a}=await this.supabase.from(t).select("*").eq("slug",e).maybeSingle();if(a)throw a;if(!s){const o=await this.supabase.from(t).select("*").eq("id",e).maybeSingle();if(o.error)throw o.error;s=o.data||null}if(!s)return;DOM.$("#post-title").value=s.title||"",DOM.$("#post-summary").value=s.summary||"",DOM.$("#post-category").value=s.category||"",DOM.$("#post-status").value=s.status||"draft";const i=DOM.$("#post-content-editor");if(i){const o=this.renderContentHTML((n=(r=s.refined_content)!=null?r:s.content)!=null?n:"");i.innerHTML=o;const d=Array.isArray(s.tags)&&s.tags.length?s.tags:this.extractTagsFromHTML(s.refined_content),u=DOM.$("#post-tags");u&&d.length&&(u.value=d.join(","))}}async loadTagSuggestions(){try{const e=DOM.$("#tag-suggestions");if(!e)return;e.innerHTML='<span class="text-xs text-gray-500">\uD0DC\uADF8 \uBD88\uB7EC\uC624\uB294 \uC911...</span>';const t=await fetch("/api/tags");if(!t.ok)throw new Error("\uD0DC\uADF8 \uBAA9\uB85D \uC694\uCCAD \uC2E4\uD328");const s=await t.json(),a=Array.isArray(s.tags)?s.tags.slice(0,20):[];if(!a.length){e.innerHTML='<span class="text-xs text-gray-500">\uCD94\uCC9C \uD0DC\uADF8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</span>';return}const i=(r,n)=>{const o=document.createElement("button");return o.type="button",o.className="px-2 py-1 text-xs rounded-full border border-gray-300 hover:border-black hover:bg-gray-50",o.textContent=`${r}`,o.setAttribute("aria-label",`${r} \uD0DC\uADF8 \uCD94\uAC00 (\uBE48\uB3C4 ${n})`),o.addEventListener("click",()=>{try{const d=DOM.$("#post-tags"),u=(d.value||"").split(",").map(p=>p.trim()).filter(Boolean).map(p=>p.toLowerCase()),c=String(r||"").toLowerCase();u.includes(c)||u.push(c),d.value=u.join(", "),d.dispatchEvent(new Event("input"))}catch(d){}}),o};e.innerHTML="",a.forEach(r=>{e.appendChild(i(r.name,r.count))})}catch(e){const t=DOM.$("#tag-suggestions");t&&(t.innerHTML='<span class="text-xs text-gray-500">\uD0DC\uADF8\uB97C \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</span>')}}async submitWriterForm(e=null,t="#view-writer"){var a,i,r;const s=DOM.$(t)?t:DOM.$("#modal-container")?"#modal-container":"#view-writer";try{if(!this.supabase)throw new Error("Supabase\uAC00 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4");const n=DOM.$("#writer-form"),o=n==null?void 0:n.querySelector('button[type="submit"]'),d=DOM.$("#writer-errors"),u=DOM.$("#post-title"),c=((a=u==null?void 0:u.value)==null?void 0:a.trim())||"",p=[];if(c?c.length<2&&p.push("\uC81C\uBAA9\uC740 \uCD5C\uC18C 2\uC790 \uC774\uC0C1\uC774\uC5B4\uC57C \uD569\uB2C8\uB2E4."):p.push("\uC81C\uBAA9\uC744 \uC785\uB825\uD558\uC138\uC694."),p.length){d&&(d.textContent=p.join(" "),d.classList.remove("sr-only")),u&&(u.setAttribute("aria-invalid","true"),u.setAttribute("aria-errormessage","writer-errors"),u.focus());return}else d&&(d.textContent="",d.classList.add("sr-only")),u&&u.setAttribute("aria-invalid","false");n&&n.setAttribute("aria-busy","true"),o&&(o.disabled=!0,o.setAttribute("aria-disabled","true"),o.dataset._origText=o.textContent||"",o.textContent="\uC800\uC7A5 \uC911\u2026"),this.setLoading(!0,s),await ScriptLoader.loadUtilities();const g=c,l=DOM.$("#post-summary").value.trim(),h=DOM.$("#post-category").value.trim(),m=DOM.$("#post-status").value,f=DOM.$("#post-thumb");let w=[];const $=DOM.$("#post-tags"),b=(($==null?void 0:$.value)||"").trim();b&&(w=b.split(",").map(A=>A.trim()).filter(Boolean).map(A=>A.toLowerCase()));const y=DOM.$("#post-content-editor");let v="";if(y){const A=y.innerHTML||"";v=window.DOMPurify?window.DOMPurify.sanitize(A):A,v=v.replace(/<h1([^>]*)>/gi,"<h2$1>").replace(/<\/h1>/gi,"</h2>"),v=this.ensureImageAltAttributes(v,g);const C=DOM.$("#post-summary");if(C&&!C.value.trim()){const E=y.innerText||"";C.value=E.replace(/\s+/g," ").trim().slice(0,160)}}else{const A=((i=DOM.$("#post-content"))==null?void 0:i.value)||"";try{const C=JSON.parse(A);v=JSON.stringify(C)}catch(C){v=A}}let k=e||this.slugify(g);k=await this.ensureUniqueSlug(k,e);let L=null;if(f&&f.files&&f.files[0]){const A=f.files[0],C=`thumbnails/${k}.webp`;L=await this.uploadImageToBucket(A,C)}const M=window.Config&&window.Config.DB_TABLE_NAME||"posts",x=new Date().toISOString(),S={title:g,summary:l,category:h,status:m,refined_content:v,slug:k,updated_at:x,author_id:((r=this.state.user)==null?void 0:r.id)||null,tags:w};L&&(S.thumbnail_url=L);let _;if(e?_=await this.supabase.from(M).update(S).eq("slug",e).select("id").maybeSingle():(S.created_at=x,S.view_count=0,_=await this.supabase.from(M).insert(S).select("id").maybeSingle()),_.error)throw _.error;UIComponents.showToast("\uAE00\uC774 \uC800\uC7A5\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),m==="published"?this.navigate("/post/"+encodeURIComponent(k)):this.navigate("/")}catch(n){const o=DOM.$("#writer-errors");o&&(o.textContent=`\uC800\uC7A5 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4: ${n.message||n}`,o.classList.remove("sr-only")),this.handleError(n,"submitWriterForm")}finally{const n=DOM.$("#writer-form"),o=n==null?void 0:n.querySelector('button[type="submit"]');n&&n.setAttribute("aria-busy","false"),o&&(o.disabled=!1,o.removeAttribute("aria-disabled"),o.dataset._origText&&(o.textContent=o.dataset._origText)),this.setLoading(!1,"#view-writer")}}slugify(e){let s=String(e||"").toLowerCase().trim().normalize("NFKD").replace(/\s+/g,"-").replace(/[^\p{L}\p{N}\-]+/gu,"").replace(/-+/g,"-").replace(/^-+|-+$/g,"");return s||(s="post-"+Date.now().toString(36)),s}async ensureUniqueSlug(e,t=null){if(!this.supabase||t&&e===t)return e;const s=window.Config&&window.Config.DB_TABLE_NAME||"posts",{data:a,error:i}=await this.supabase.from(s).select("slug").eq("slug",e).limit(1);if(i||!a||a.length===0)return e;const r=Math.random().toString(36).slice(2,6);return`${e}-${r}`}async loadPostDetail(e,t="#view-post"){const s=DOM.$(t);if(await this.ensureSupabaseReady(1200),!this.supabase){s.innerHTML='<div class="max-w-3xl mx-auto py-10 px-6 text-gray-600">\uB370\uC774\uD130 \uC18C\uC2A4\uAC00 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.</div>';return}const a=window.Config&&window.Config.DB_TABLE_NAME||"posts";let{data:i,error:r}=await this.supabase.from(a).select("*").eq("slug",e).eq("status","published").maybeSingle();if(r)throw r;if(!i)try{const h=[],m=String(e||"");h.push(m),h.push(m.toLowerCase()),h.push(m.replace(/_/g,"-")),h.push(this.slugify(m));const f=Array.from(new Set(h.filter(w=>w&&typeof w=="string")));if(f.length){const{data:w,error:$}=await this.supabase.from(a).select("*").in("slug",f).eq("status","published").limit(1);i=w&&w[0]||null}}catch(h){}if(!i){s.innerHTML='<section class="max-w-md mx-auto py-20 px-6 text-center"><h1 class="text-2xl font-extrabold">\uAE00\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</h1><p class="text-sm text-gray-600 mt-2">\uC694\uCCAD\uD558\uC2E0 \uAE00\uC774 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.</p><div class="mt-6"><a href="/" data-route class="px-4 py-2 rounded-full bg-black text-white">\uD648\uC73C\uB85C</a></div></section>';return}try{await this.supabase.from(a).update({view_count:(i.view_count||0)+1}).eq("id",i.id)}catch(h){console.warn("view_count update \uC2E4\uD328:",h)}const n=this.escapeHTML(i.title||"\uC81C\uBAA9 \uC5C6\uC74C"),o=this.formatDate(i.created_at),d=i.category?`<span class="text-xs px-2 py-1 rounded-full bg-black/5">${this.escapeHTML(i.category)}</span>`:"",u=Array.isArray(i.tags)&&i.tags.length?i.tags:this.extractTagsFromHTML(i.refined_content),c=u&&u.length?`<div class="mt-2 flex flex-wrap gap-2">${u.map(h=>`<span class="text-xs px-2 py-1 rounded-full bg-blue-50 border border-blue-200">${this.escapeHTML(h)}</span>`).join("")}</div>`:"";await ScriptLoader.loadUtilities();const p=this.renderContentHTML(i.refined_content),g=this.state.user?`<a href="/writer/${encodeURIComponent(i.slug)}" data-route class="px-3 py-1 rounded-full border">\uC218\uC815</a>`:"";s.innerHTML=`<article class="post-detail py-10"><div class="post-detail-inner"><h1 class="post-title text-3xl font-extrabold tracking-tight">${n}</h1><div class="post-meta flex items-center"><span class="post-date">${o}</span>${d?d.replace("<span",'<span class="post-category"'):""}</div>${c?c.replace("<div",'<div class="post-tags"'):""}<div class="blog-post-content prose-custom">${p}</div></div><div class="post-detail-inner"><div class="mt-8 flex items-center gap-3"><button id="btn-like" class="px-3 py-1 rounded-full border">\uC88B\uC544\uC694 <span id="like-count"></span></button><button id="btn-share" class="px-3 py-1 rounded-full border">\uACF5\uC720</button><button id="btn-copy" class="px-3 py-1 rounded-full border">\uB9C1\uD06C\uBCF5\uC0AC</button>${g}</div><div id="related-posts" class="mt-12"></div><div id="popular-posts" class="mt-12"></div></div></article>`;const l=i.thumbnail_url?this.getTransformedPublicUrl(i.thumbnail_url,{width:1200,height:630,resize:"cover",quality:85,format:"webp"}):"/og-image.svg";this.updatePageMeta(i.title,i.summary||"",window.location.href,l);try{const h="likes:"+(i.slug||i.id),m=DOM.$("#like-count"),f=DOM.$("#btn-like"),w=DOM.$("#btn-share"),$=DOM.$("#btn-copy");let b=Number(localStorage.getItem(h)||"0");m&&(m.textContent=String(b)),f&&f.addEventListener("click",()=>{b+=1,localStorage.setItem(h,String(b)),m&&(m.textContent=String(b))}),w&&w.addEventListener("click",async()=>{try{navigator.share?await navigator.share({title:i.title,text:i.summary||"",url:window.location.href}):(await navigator.clipboard.writeText(window.location.href),UIComponents.showToast("\uB9C1\uD06C\uAC00 \uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"))}catch(y){}}),$&&$.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(window.location.href),UIComponents.showToast("\uB9C1\uD06C\uAC00 \uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success")}catch(y){}})}catch(h){}this.loadRelatedPosts(i).catch(h=>this.handleError(h,"loadRelatedPosts")),this.loadPopularPosts(i.id).catch(h=>this.handleError(h,"loadPopularPosts"))}renderContentHTML(e){if(!e)return'<p class="text-gray-600">\uCF58\uD150\uCE20\uAC00 \uC544\uC9C1 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.</p>';try{const a=typeof e=="string"?JSON.parse(e):e;if(a&&Array.isArray(a.blocks)){this._contentFirstImageEagerDone=!1;const i=a.blocks.map(r=>this.renderEditorBlock(r)).join("");return this.dedupeConsecutiveImages(i)}if(a&&a.ops&&Array.isArray(a.ops)){const i=a.ops.map(d=>{const u=typeof d.insert=="string"?this.escapeHTML(d.insert):"",c=d.attributes||{};let p=u;return c.bold&&(p=`<strong>${p}</strong>`),c.italic&&(p=`<em>${p}</em>`),c.underline&&(p=`<u>${p}</u>`),p}).join(""),r=window.DOMPurify?window.DOMPurify.sanitize(i):i,n=this.transformPlainImagesToOptimized(r),o=this.ensureImageAltAttributes(n,"");return this.dedupeConsecutiveImages(o)}}catch(a){}const t=typeof e=="string";if(t&&(/!\[[^\]]*\]\([^)]+\)/.test(e)||/\[[^\]]+\]\([^)]+\)/.test(e)||/(^|\n)\s{0,3}#{1,6}\s/.test(e)||/(^|\n)\s{0,3}[-*]\s+/.test(e)||/(^|\n)\s{0,3}\d+\.\s+/.test(e))&&window.marked){const a=t?e:String(e),i=this.preprocessPlainTextToMarkdown(a),r=window.marked.parse(i),n=window.DOMPurify?window.DOMPurify.sanitize(r):r,o=this.transformPlainImagesToOptimized(n),d=this.ensureImageAltAttributes(o,"");return this.dedupeConsecutiveImages(d)}if(t&&/<\w+[^>]*>/i.test(e)){const a=e,i=window.DOMPurify?window.DOMPurify.sanitize(a):a,r=this.transformPlainImagesToOptimized(i),n=this.ensureImageAltAttributes(r,"");return this.dedupeConsecutiveImages(n)}if(window.marked){const a=t?e:String(e),i=this.preprocessPlainTextToMarkdown(a),r=window.marked.parse(i),n=window.DOMPurify?window.DOMPurify.sanitize(r):r,o=this.transformPlainImagesToOptimized(n),d=this.ensureImageAltAttributes(o,"");return this.dedupeConsecutiveImages(d)}return`<pre>${this.escapeHTML(typeof e=="string"?e:JSON.stringify(e))}</pre>`}renderEditorBlock(e){var a;const t=e.type,s=e.data||{};switch(t){case"paragraph":return`<p>${this.escapeHTML(s.text||"")}</p>`;case"header":return`<h${s.level||2}>${this.escapeHTML(s.text||"")}</h${s.level||2}>`;case"list":const i=(s.items||[]).map(r=>`<li>${this.escapeHTML(r)}</li>`).join("");return s.style==="ordered"?`<ol>${i}</ol>`:`<ul>${i}</ul>`;case"quote":return`<blockquote>${this.escapeHTML(s.text||"")}</blockquote>`;case"image":if((a=s.file)!=null&&a.url){const r=this.escapeHTML(s.caption||""),n=navigator&&navigator.connection?navigator.connection:{},o=!!n.saveData,d=n.effectiveType||"",u=o||/(^|[^a-z])(2g|3g)/.test(d),c=u?[360,600]:[480,768,1200],p=u?900:1200,g=u?75:85,l=u?60:80,h=u?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px",m=this.getOptimizedPublicUrl(s.file.url,{width:p,quality:g,format:"webp"}),f=c.map(k=>`${this.getOptimizedPublicUrl(s.file.url,{width:k,quality:l,format:"webp"})} ${k}w`).join(", "),w=s.width&&s.height?` width="${s.width}" height="${s.height}"`:"",$=!s.width||!s.height?' class="aspect-16-9"':"",b=!this._contentFirstImageEagerDone;if(b){this._contentFirstImageEagerDone=!0;try{if(!document.querySelector(`link[rel="preload"][as="image"][href="${m}"]`)){const L=document.createElement("link");L.rel="preload",L.as="image",L.href=m,f&&L.setAttribute("imagesrcset",f),L.setAttribute("imagesizes",h),L.crossOrigin="anonymous",document.head.appendChild(L)}try{const L=new URL(m,window.location.origin).origin;if(!document.querySelector(`link[rel="preconnect"][href="${L}"]`)){const x=document.createElement("link");x.rel="preconnect",x.href=L,x.crossOrigin="anonymous",document.head.appendChild(x)}}catch(L){}}catch(k){}}return`<figure><img src="${m}" srcset="${f}" sizes="${h}" alt="${r}"${b?"":' loading="lazy"'}${b?' fetchpriority="high"':' fetchpriority="low"'} decoding="async"${w}${$}/><figcaption>${r}</figcaption></figure>`}return"";case"code":return`<pre><code>${this.escapeHTML(s.code||"")}</code></pre>`;default:return""}}setupContentEditor(e=null){const t=DOM.$("#post-content-editor"),s=DOM.$("#editor-toolbar");if(!t)return;t.setAttribute("role","textbox"),t.setAttribute("aria-label","\uCF58\uD150\uCE20 \uD3B8\uC9D1\uAE30"),this._lastSelectionRange=null,t.addEventListener("focus",()=>document.execCommand("defaultParagraphSeparator",!1,"p"));const a=()=>{if(!s)return;const i=(r,n)=>{const o=s.querySelector(`button[data-cmd="${r}"]`);o&&o.classList.toggle("bg-black text-white",!!n)};try{i("bold",document.queryCommandState("bold")),i("italic",document.queryCommandState("italic")),i("underline",document.queryCommandState("underline"));const r=document.queryCommandValue("formatBlock");i("h1",/H1/i.test(r)),i("h2",/H2/i.test(r)),i("p",/P/i.test(r))}catch(r){}};if(document.addEventListener("selectionchange",()=>{if(document.activeElement===t){const i=window.getSelection();i&&i.rangeCount&&(this._lastSelectionRange=i.getRangeAt(0)),a()}}),s){const i=r=>{r.target.closest("[data-cmd]")&&r.preventDefault()};s.addEventListener("pointerdown",i,{passive:!1}),s.addEventListener("mousedown",i,{passive:!1}),s.addEventListener("touchstart",i,{passive:!1}),s.addEventListener("click",r=>{const n=r.target.closest("[data-cmd]");if(!n)return;const o=n.getAttribute("data-cmd");t.focus();const d=window.getSelection();if(d&&this._lastSelectionRange)try{d.removeAllRanges(),d.addRange(this._lastSelectionRange)}catch(u){}this.execEditorCommand(o),a()})}t.addEventListener("keydown",i=>{(i.ctrlKey||i.metaKey)&&(i.key.toLowerCase()==="b"&&(i.preventDefault(),this.execEditorCommand("bold"),a()),i.key.toLowerCase()==="i"&&(i.preventDefault(),this.execEditorCommand("italic"),a()),i.key.toLowerCase()==="u"&&(i.preventDefault(),this.execEditorCommand("underline"),a()),i.shiftKey&&i.key==="1"&&(i.preventDefault(),this.execEditorCommand("h2"),a()),i.shiftKey&&i.key==="2"&&(i.preventDefault(),this.execEditorCommand("h2"),a()))}),t.addEventListener("dragover",i=>{i.preventDefault()}),t.addEventListener("drop",async i=>{var n;i.preventDefault();const r=(n=i.dataTransfer)==null?void 0:n.files;r&&r.length&&await this.handleEditorFiles(r,e)}),t.addEventListener("paste",async i=>{var o;const r=((o=i.clipboardData)==null?void 0:o.items)||[],n=[];for(const d of r)if(d.kind==="file"){const u=d.getAsFile();u&&u.type.startsWith("image/")&&n.push(u)}n.length?(i.preventDefault(),await this.handleEditorFiles(n,e)):setTimeout(()=>{this.linkifyElementContent(t)},0)}),t.addEventListener("click",i=>{const r=i.target.closest("figcaption");r&&(r.setAttribute("contenteditable","true"),r.focus())}),t.addEventListener("input",i=>{const r=i.target.closest("figcaption");if(r){const n=r.closest("figure"),o=n?n.querySelector("img"):null;if(o){const d=r.textContent.trim();o.setAttribute("alt",d||o.getAttribute("alt")||"")}}clearTimeout(this._linkifyTimer),this._linkifyTimer=setTimeout(()=>{this.linkifyElementContent(t)},200)}),t.addEventListener("blur",i=>{i.target&&i.target.matches("figcaption")&&i.target.removeAttribute("contenteditable")},!0)}execEditorCommand(e){switch(e){case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"h1":document.execCommand("formatBlock",!1,"h2");break;case"h2":document.execCommand("formatBlock",!1,"h2");break;case"p":document.execCommand("formatBlock",!1,"p");break;case"ul":document.execCommand("insertUnorderedList");break;case"ol":document.execCommand("insertOrderedList");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":this.insertHTMLAtCursor("<pre><code></code></pre>");break;case"link":{const t=prompt("\uB9C1\uD06C URL\uC744 \uC785\uB825\uD558\uC138\uC694");t&&document.execCommand("createLink",!1,t);break}case"clear":document.execCommand("removeFormat");break;default:break}}insertHTMLAtCursor(e){document.execCommand("insertHTML",!1,e)}linkifyElementContent(e){try{if(!e)return;const t=/(?:https?:\/\/[^\s<]+|www\.[^\s<]+)$/g,s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),a=[];let i;for(;i=s.nextNode();){const r=i.parentElement;if(!r||r.closest("a"))continue;const n=i.nodeValue||"";/(https?:\/\/|www\.)/.test(n)&&a.push(i)}a.forEach(r=>{const n=r.nodeValue||"",o=[],d=[];let u=0;if(n.replace(/(?:https?:\/\/[^\s<]+|www\.[^\s<]+)/g,(p,g)=>(o.push(n.slice(u,g)),d.push(p),u=g+p.length,p)),o.push(n.slice(u)),d.length===0)return;const c=document.createDocumentFragment();for(let p=0;p<o.length;p++){const g=o[p];g&&c.appendChild(document.createTextNode(g));const l=d[p];if(l){const h=l.startsWith("www.")?"https://"+l:l,m=document.createElement("a");m.href=h,m.textContent=l,m.rel="noopener noreferrer",m.target="_blank",c.appendChild(m)}}r.parentNode.replaceChild(c,r)})}catch(t){console.warn("linkifyElementContent error",t)}}async handleEditorFiles(e,t){try{for(let s=0;s<e.length;s++){const a=e.item?e.item(s):e[s];if(!a||!a.type.startsWith("image/"))continue;const i=`img_${Date.now()}_${s}.webp`,r=`content-images/${i}`,{savedPath:n,width:o,height:d}=await this.uploadImageToBucket(a,r),u=navigator&&navigator.connection?navigator.connection:{},c=!!u.saveData,p=u.effectiveType||"",g=c||/(^|[^a-z])(2g|3g)/.test(p),l=g?900:1200,h=g?75:85,m=g?60:80,f=this.getTransformedPublicUrl(n,{width:l,quality:h,format:"webp"}),w=this.deriveAltFromFileName(a.name||i),b=(g?[360,600]:[480,768,1200]).map(k=>`${this.getTransformedPublicUrl(n,{width:k,quality:m,format:"webp"})} ${k}w`).join(", "),y=g?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px",v=o&&d?` width="${o}" height="${d}"`:"";this.insertHTMLAtCursor(`<figure><img src="${f}" srcset="${b}" sizes="${y}" alt="${this.escapeHTML(w)}" loading="lazy" decoding="async"${v}/><figcaption>${this.escapeHTML(w)}</figcaption></figure>`)}}catch(s){this.handleError(s,"handleEditorFiles")}}extractTagsFromHTML(e){try{const t=typeof e=="string"?e:String(e||""),s=document.createElement("div");s.innerHTML=t;const a=s.querySelector("[data-tags]");return((a==null?void 0:a.getAttribute("data-tags"))||"").split(",").map(r=>r.trim()).filter(Boolean)}catch(t){return[]}}async loadRelatedPosts(e){if(!this.supabase)return;const t=window.Config&&window.Config.DB_TABLE_NAME||"posts",{data:s,error:a}=await this.supabase.from(t).select("id, title, summary, slug, category, thumbnail_url, created_at").eq("status","published").neq("id",e.id).eq("category",e.category).order("created_at",{ascending:!1}).limit(3);if(a)throw a;const i=DOM.$("#related-posts");if(!i)return;if(!s||s.length===0){i.innerHTML="";return}const r=s.map(n=>{const o="/post/"+encodeURIComponent(n.slug||n.id),d=!!n.thumbnail_url,u=d?(()=>{const l=[96,120,144,160],h="(max-width: 640px) 96px, 120px",m=this.getTransformedPublicUrl(n.thumbnail_url,{width:120,height:120,resize:"cover",quality:80,format:"webp"}),f=l.map(w=>`${this.getTransformedPublicUrl(n.thumbnail_url,{width:w,height:w,resize:"cover",quality:80,format:"webp"})} ${w}w`).join(", ");return`<img src="${m}" srcset="${f}" sizes="${h}" alt="${this.escapeHTML(n.title||"")}" class="post-card-thumb-img" width="120" height="120" decoding="async" loading="lazy"/>`})():`<span class="thumb-initial">${this.escapeHTML(String(n.title||"N").trim().charAt(0).toUpperCase())}</span>`;return`<article class="post-card post-card-compact"><a href="${o}" data-route class="post-card-thumb${d?"":" placeholder"}">${u}</a><div class="post-card-main"><h3 class="post-card-title"><a href="${o}" data-route>${this.escapeHTML(n.title)}</a></h3><p class="post-card-meta">${this.formatDate(n.created_at)}</p></div></article>`}).join("");i.innerHTML=`<h2 class="text-lg font-bold mb-3">\uAD00\uB828 \uAE00</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${r}</div>`}async loadPopularPosts(e=null){const t=DOM.$("#popular-posts");if(!t||!this.supabase)return;const s=window.Config&&window.Config.DB_TABLE_NAME||"posts",a=Date.now();this._reqTokens.popular=a;const i=`popular:${e||""}`,{data:r,error:n}=await this.withDedupe(i,()=>this.supabase.from(s).select("id, title, slug, thumbnail_url, created_at, view_count").eq("status","published").order("view_count",{ascending:!1,nullsFirst:!1}).limit(5));if(n)throw n;let o=(r||[]).filter(c=>c&&c.id!==e);if(!o||o.length===0){t.innerHTML="";return}if(this._reqTokens.popular!==a)return;const d='<h2 class="text-lg font-bold mb-3">\uB9CE\uC774 \uBCF8 \uAE00</h2>',u=o.map((c,p)=>{const g="/post/"+encodeURIComponent(c.slug||c.id),l=Number(c.view_count||0),h=this.formatDateKR(c.created_at);return`<li class="popular-item"><span class="popular-rank">${p+1}</span><a class="popular-link" href="${g}" data-route>${this.escapeHTML(c.title||"")}</a><span class="popular-date">${h}</span><span class="popular-views">${l.toLocaleString("ko-KR")}</span></li>`}).join("");t.innerHTML=d+`<ul class="popular-list">${u}</ul>`}deriveAltFromFileName(e=""){try{let t=String(e||"").replace(/\.[a-z0-9]+$/i,"");return t=decodeURIComponent(t),t=t.replace(/[_\-]+/g," ").replace(/\s+/g," ").trim(),t||"\uC774\uBBF8\uC9C0"}catch(t){return"\uC774\uBBF8\uC9C0"}}ensureImageAltAttributes(e,t=""){try{const s=document.createElement("div");return s.innerHTML=String(e||""),s.querySelectorAll("img").forEach(i=>{if((i.getAttribute("alt")||"").trim())return;let n="";const o=i.closest("figure"),d=o?o.querySelector("figcaption"):null;if(n=((d==null?void 0:d.textContent)||"").trim(),n||(n=String(t||"").trim()),!n){const u=i.getAttribute("src")||"";try{const p=(new URL(u,window.location.origin).pathname.split("/").pop()||"").split("?")[0];n=this.deriveAltFromFileName(p)}catch(c){const p=(u.split("/").pop()||"").split("?")[0];n=this.deriveAltFromFileName(p)}}i.setAttribute("alt",n||"\uC774\uBBF8\uC9C0"),d&&!d.textContent.trim()&&(d.textContent=n||"\uC774\uBBF8\uC9C0")}),s.innerHTML}catch(s){return e}}preprocessPlainTextToMarkdown(e=""){try{let t=String(e||"");return t=t.replace(/^\s*h([1-6])\s+(.+)$/gmi,(s,a,i)=>`${"#".repeat(Number(a))} ${i}`),t=t.replace(/(^|\s)(https?:\/\/[^\s]+\.(?:png|jpe?g|webp|gif|svg))(?!\S)/gmi,(s,a,i)=>`${a}![](${i})`),t}catch(t){return String(e||"")}}transformPlainImagesToOptimized(e,t=""){try{const s=document.createElement("div");s.innerHTML=String(e||"");const a=navigator&&navigator.connection?navigator.connection:{},i=!!a.saveData,r=a.effectiveType||"",n=i||/(^|[^a-z])(2g|3g)/.test(r),o=n?[360,600]:[480,768,1200],d=n?900:1200,u=n?75:85,c=n?60:80,p=n?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px";return Array.from(s.querySelectorAll("img")).forEach((l,h)=>{if(l.hasAttribute("srcset"))return;const m=l.getAttribute("src")||"";if(!m)return;const w=(l.getAttribute("alt")||"").trim()||(()=>{try{const S=(new URL(m,window.location.origin).pathname.split("/").pop()||"").split("?")[0];return this.deriveAltFromFileName(S)}catch(x){const S=(m.split("/").pop()||"").split("?")[0];return this.deriveAltFromFileName(S)}})()||t||"\uC774\uBBF8\uC9C0",$=this.getOptimizedPublicUrl(m,{width:d,quality:u,format:"webp"}),b=o.map(x=>`${this.getOptimizedPublicUrl(m,{width:x,quality:c,format:"webp"})} ${x}w`).join(", "),y=document.createElement("figure"),v=l.cloneNode(!0);v.setAttribute("src",$),v.setAttribute("srcset",b),v.setAttribute("sizes",p),v.setAttribute("alt",w),h===0?(v.removeAttribute("loading"),v.setAttribute("fetchpriority","high")):(v.setAttribute("loading","lazy"),v.setAttribute("fetchpriority","low")),v.setAttribute("decoding","async"),y.appendChild(v);const L=document.createElement("figcaption");L.textContent=w,y.appendChild(L);const M=l.parentElement;M&&M.tagName.toLowerCase()==="p"?M.replaceWith(y):l.replaceWith(y)}),s.innerHTML}catch(s){return e}}dedupeConsecutiveImages(e){try{const t=document.createElement("div");t.innerHTML=String(e||"");const s=i=>`${i.getAttribute("src")||""}|${i.getAttribute("srcset")||""}`,a=Array.from(t.querySelectorAll("figure, img")).filter(i=>!(i.tagName.toLowerCase()==="img"&&i.closest("figure")));for(let i=0;i<a.length;i++){const r=a[i],n=r.tagName.toLowerCase()==="img"?r:r.querySelector("img");if(!n)continue;const o=r.previousElementSibling;if(!o)continue;const d=o.tagName.toLowerCase()==="img"?o:o.querySelector&&o.querySelector("img");if(!d)continue;s(n)===s(d)&&r.remove()}return t.innerHTML}catch(t){return e}}getOptimizedPublicUrl(e,t={}){try{const s=new URL(e,window.location.origin);if(!/supabase\.co\/.+\/object\/public\//.test(s.href))return e;const i=new URLSearchParams;t.width&&i.set("width",String(t.width)),t.height&&i.set("height",String(t.height)),t.resize&&i.set("resize",String(t.resize)),t.format&&i.set("format",String(t.format)),t.quality&&i.set("quality",String(t.quality));const r=i.toString();return r?s.search&&s.search.length>1?`${s.href}&${r}`:`${s.href}?${r}`:s.href}catch(s){return e}}getTransformedPublicUrl(e,t={}){var s;try{if(!e)return"";if(/^https?:\/\//i.test(e))return this.getOptimizedPublicUrl(e,t);const a=window.Config&&window.Config.IMAGE_BUCKET_NAME||"thought-images",i=this.supabase.storage.from(a).getPublicUrl(e,{transform:{width:t.width,height:t.height,resize:t.resize,format:t.format,quality:t.quality}});return((s=i==null?void 0:i.data)==null?void 0:s.publicUrl)||""}catch(a){return""}}async loadHomePosts(e=new URLSearchParams){const t=DOM.$("#home-posts");if(!t)return;const s=Number(e.get("page")||"1");t.innerHTML='<div class="animate-pulse space-y-3"><div class="h-6 bg-gray-200 rounded"></div><div class="h-24 bg-gray-200 rounded"></div><div class="h-24 bg-gray-200 rounded"></div></div>';const a=e.get("scenario");if(a==="empty"){t.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';return}if(a==="error"){t.innerHTML='<div class="text-red-600"><p class="font-semibold">\uAC8C\uC2DC\uAE00\uC744 \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</p><p class="text-sm text-red-500">\uC9C4\uB2E8 \uC2DC\uB098\uB9AC\uC624\uC5D0 \uC758\uD574 \uC624\uB958\uAC00 \uAC15\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.</p></div>';return}if(await this.ensureSupabaseReady(1200),!this.supabase)return;const i=window.Config&&window.Config.POSTS_PER_PAGE||10,r=(s-1)*i,n=r+i-1,o=window.Config&&window.Config.DB_TABLE_NAME||"posts",d=Date.now();this._reqTokens.home=d;const u=`home:${r}-${n}`;try{const{data:c,count:p,error:g}=await this.withDedupe(u,()=>this.supabase.from(o).select("id, title, summary, slug, category, thumbnail_url, created_at",{count:"exact"}).eq("status","published").order("created_at",{ascending:!1}).range(r,n));if(g)throw g;if(!c||c.length===0){t.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';const l=DOM.$("#home-pagination");l&&(l.innerHTML="");return}try{const l=DOM.$("#home-pagination");if(l){const h=Math.max(1,Math.ceil((p||0)/i));if(h<=1)l.innerHTML="",this.updatePrevNextLinks(1,1),this.updateRobotsMeta("index,follow"),this.updatePageMeta("InsureLog - \uCD5C\uADFC \uAE00","\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D",window.location.href,"/og-image.svg");else{const m=(M,x=null,S=!1)=>`<button data-page="${M}" ${S?'aria-current="page"':""} aria-label="${x||`\uD398\uC774\uC9C0 ${M}`}" class="px-3 py-1 rounded border ${S?"bg-black text-white":"hover:bg-black/5"}">${x||M}</button>`,f=s>1?m(s-1,"\uC774\uC804"):'<span class="px-3 py-1 text-gray-400" aria-hidden="true">\uC774\uC804</span>',w=s<h?m(s+1,"\uB2E4\uC74C"):'<span class="px-3 py-1 text-gray-400" aria-hidden="true">\uB2E4\uC74C</span>',$=5,b=Math.max(1,s-Math.floor($/2)),y=Math.min(h,b+$-1),v=[];for(let M=b;M<=y;M++)v.push(m(M,null,M===s));l.innerHTML=f+v.join("")+w,l.querySelectorAll("button[data-page]").forEach(M=>{M.onclick=()=>{const x=Number(M.getAttribute("data-page"))||1;this.navigate(`/?page=${x}`)}}),this.updatePrevNextLinks(h,s),this.updateRobotsMeta(s===1?"index,follow":"noindex,follow");const k=s>1?`\uCD5C\uADFC \uAE00 - \uD398\uC774\uC9C0 ${s} - InsureLog`:"InsureLog - \uCD5C\uADFC \uAE00",L=s>1?`\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D \xB7 \uD398\uC774\uC9C0 ${s}`:"\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D";this.updatePageMeta(k,L,window.location.href,"/og-image.svg")}}}catch(l){}if(this._reqTokens.home!==d)return;t.innerHTML=this.renderPostsListHTML(c);try{const l=Array.from(t.querySelectorAll(".post-card-thumb-img"));if(l.length){const h=l.find(m=>{const f=m.getBoundingClientRect();return f&&f.height>0&&f.top>=0&&f.top<(window.innerHeight||0)*.9})||l[0];if(h){h.getAttribute("loading")==="lazy"&&h.removeAttribute("loading"),h.setAttribute("fetchpriority","high");const m=h.currentSrc||h.getAttribute("src"),f=h.getAttribute("srcset")||"",w=h.getAttribute("sizes")||"";if(m){if(!document.querySelector(`link[rel="preload"][as="image"][href="${m}"]`)){const b=document.createElement("link");b.rel="preload",b.as="image",b.href=m,f&&b.setAttribute("imagesrcset",f),w&&b.setAttribute("imagesizes",w),b.crossOrigin="anonymous",document.head.appendChild(b)}try{const b=new URL(m,window.location.origin).origin;if(!document.querySelector(`link[rel="preconnect"][href="${b}"]`)){const v=document.createElement("link");v.rel="preconnect",v.href=b,v.crossOrigin="anonymous",document.head.appendChild(v)}}catch(b){}}}}}catch(l){}}catch(c){const p=c&&(c.message||c.msg)?String(c.message||c.msg):"\uC54C \uC218 \uC5C6\uB294 \uC624\uB958",g=c&&(c.status||c.code)?String(c.status||c.code):"";t.innerHTML='<div class="error-banner"><div class="error-banner-content"><svg class="error-banner-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v2h2v-2zm0-8H9v6h2V5z"/></svg><div class="error-banner-text"><div class="error-banner-title">\uAC8C\uC2DC\uAE00\uC744 \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</div><div class="error-banner-message">\uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574 \uC8FC\uC138\uC694.'+(g?" ("+this.escapeHTML(g)+")":"")+'</div><div class="error-details">'+this.escapeHTML(p)+"</div></div></div></div>",this.handleError(c,"loadHomePosts")}}renderPostsListHTML(e){return e.map((t,s)=>{const a="/post/"+encodeURIComponent(t.slug||t.id),i=navigator&&navigator.connection?navigator.connection:{},r=!!i.saveData,n=i.effectiveType||"",o=r||/(^|[^a-z])(2g|3g)/.test(n),d=280,u=Math.round(d*(9/16)),c=o?70:80,p=o?[d]:[d,d*2],g="(max-width: 640px) 100vw, 280px",l=t.thumbnail_url?this.getTransformedPublicUrl(t.thumbnail_url,{width:d,height:u,resize:"cover",quality:c,format:"webp"}):null,h=t.thumbnail_url?p.map(M=>`${this.getTransformedPublicUrl(t.thumbnail_url,{width:M,height:Math.round(M*(u/d)),resize:"cover",quality:c,format:"webp"})} ${M}w`).join(", "):"",m=s===0,f=m?"":' loading="lazy"',w=m?' fetchpriority="high"':' fetchpriority="low"';if(m&&l)try{if(!document.querySelector(`link[rel="preload"][as="image"][href="${l}"]`)){const x=document.createElement("link");x.rel="preload",x.as="image",x.href=l,h&&x.setAttribute("imagesrcset",h),x.setAttribute("imagesizes",g),x.crossOrigin="anonymous",document.head.appendChild(x)}}catch(M){}const $=l?`<img src="${l}"${h?` srcset="${h}" sizes="${g}"`:""} alt="${this.escapeHTML(t.title||"")}" class="post-card-thumb-img" width="${d}" height="${u}" decoding="async"${f}${w}/>`:"",b=this.escapeHTML(String(t.title||"N").trim().charAt(0).toUpperCase()),y=`<a href="${a}" data-route class="post-card-thumb${l?"":" placeholder"}">${l?$:`<span class="thumb-initial">${b}</span>`}</a>`,v=this.formatDateKR(t.created_at),k=t.category?`<span class="badge">${this.escapeHTML(t.category)}</span>`:"",L=this.state.user?`<a href="/writer/${encodeURIComponent(t.slug)}" data-route class="btn-xs">\uD3B8\uC9D1</a>`:"";return'<article class="post-card post-card-wide" data-route data-href="'+a+`" tabindex="0"><h2 class="post-card-title"><a href="${a}" data-route>${this.escapeHTML(t.title||"\uC81C\uBAA9 \uC5C6\uC74C")}</a></h2><div class="post-card-content-grid"><div class="post-card-summary-block">`+(t.summary?`<p class="post-card-summary">${this.escapeHTML(t.summary)}</p>`:"")+`<div class="post-card-meta">\uC791\uC131\uC77C ${v}${t.category?` \xB7 \uCE74\uD14C\uACE0\uB9AC ${k}`:""}</div><div class="post-card-actions">${L}</div></div>`+y+"</div></article>"}).join("")}formatDateKR(e){try{const t=new Date(e),s=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${s}.${a}.${i}`}catch(t){return""}}formatDate(e){try{return new Date(e).toLocaleDateString("ko-KR",{year:"numeric",month:"short",day:"numeric"})}catch(t){return""}}escapeHTML(e){return String(e||"").replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t])}async logSiteVisit(){try{const{error:e}=await this.supabase.from("site_visits").insert({visited_at:new Date().toISOString()});if(e)throw e}catch(e){console.warn("site_visits insert \uC2E4\uD328:",e.message||e)}}async uploadImageToBucket(e,t){const s=window.Config&&window.Config.IMAGE_BUCKET_NAME||"thought-images",{blob:a,width:i,height:r}=await this.convertToWebP(e),{error:n}=await this.supabase.storage.from(s).upload(t,a,{contentType:"image/webp",upsert:!0});if(n)throw n;return{savedPath:t,width:i,height:r}}async convertToWebP(e){if(e.type==="image/webp"){const r=await this.readImageFromFile(e);return{blob:e,width:r.width,height:r.height}}const t=await this.readImageFromFile(e),s=document.createElement("canvas");return s.width=t.width,s.height=t.height,s.getContext("2d").drawImage(t,0,0),{blob:await new Promise(r=>s.toBlob(r,"image/webp",.9)),width:t.width,height:t.height}}readImageFromFile(e){return new Promise((t,s)=>{const a=URL.createObjectURL(e),i=new Image;i.onload=()=>{URL.revokeObjectURL(a),t(i)},i.onerror=s,i.src=a})}}window.BlogApp=BlogApp;
