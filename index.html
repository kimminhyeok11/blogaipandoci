<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KQ8THNV2');</script>
    <!-- End Google Tag Manager -->

    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & Meta Tags -->
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app/" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app/">
    <meta property="og:title" content="InsureLog">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://blogaipandoci.vercel.app/">
    <meta property="twitter:title" content="InsureLog">
    <meta property="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Code Highlighting (Prettify) Styles -->
    <style>
        /* Prettify Tomorrow Theme */
        .pln{color:#4d4d4c}.str{color:#718c00}.kwd{color:#8959a8}.com{color:#8e908c}.typ{color:#4271ae}.lit{color:#f5871f}.pun,.opn,.clo{color:#4d4d4c}.tag{color:#c82829}.atn{color:#f5871f}.atv{color:#3e999f}.dec,.var{color:#c82829}.fun{color:#4271ae}
        pre.prettyprint{font-family:Consolas,Monaco,'Andale Mono',monospace;border:1px solid #EAEAEA;border-radius:8px;padding:1.2rem;background:#F9FAFB; font-size: 0.875rem;}
        ol.linenums{margin:0}ol.linenums li{padding-left:10px;color:#999;line-height:1.8;list-style-type:decimal}
    </style>

    <!-- Main Styles -->
    <style>
        :root {
            --bg-main: #F9FAFB;
            --bg-content: #FFFFFF;
            --border-color: #F3F4F6;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --accent: #111827;
            --accent-hover: #374151;
            --font-heading: 'Open Sans', sans-serif;
            --font-body: 'Open Sans', sans-serif;
        }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); background-color: var(--bg-main); color: var(--text-primary); font-size: 16px; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        #app-loader, #refiner-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: var(--bg-main); display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        #refiner-loader { z-index: 200; background-color: rgba(249, 250, 251, 0.8); backdrop-filter: blur(4px); display: none; flex-direction: column; gap: 1rem; }
        
        .loader-spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        .ai-loader, .image-loader { display: none; width: 1rem; height: 1rem; border: 2px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .app-view { display: none; } .app-view.active { display: block; }
        .brand-logo { font-family: var(--font-heading); font-weight: 800; font-size: 1.25rem; color: var(--text-primary); letter-spacing: -0.5px; }
        
        .btn { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 8px; transition: all 0.25s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid #D1D5DB; background-color: var(--bg-content); color: #374151; cursor: pointer; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .btn:hover { background-color: #F9FAFB; color: var(--text-primary); transform: translateY(-1px); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background-color: var(--bg-content) !important; color: var(--text-secondary) !important; }
        
        .form-input, .form-textarea { font-size: 0.95rem; padding: 0.75rem 1rem; border: 1px solid #D1D5DB; border-radius: 8px; width: 100%; background-color: var(--bg-content); color: var(--text-primary); transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1); }
        
        .prose-custom { color: #374151; line-height: 1.8; font-size: 1.05rem; }
        .prose-custom > *:not(:first-child) { margin-top: 1.5em; }
        .prose-custom p { margin-bottom: 1.5em; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-family: var(--font-heading); font-weight: 700; margin-top: 2.2em; margin-bottom: 1em; }
        .prose-custom h1 { font-size: 2.25rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 0.4em; }
        .prose-custom h2 {
            font-size: 1.25rem;
            background-color: var(--accent);
            color: white;
            padding: 0.4rem 0.9rem;
            border-radius: 9999px;
            display: inline-block;
        }
        .prose-custom h3 { 
            font-size: 1.25rem;
            border-bottom: 2px solid #E5E7EB;
            padding-bottom: 0.4em;
        }
        .prose-custom a { color: var(--text-primary); text-decoration: none; font-weight: 500; border-bottom: 2px solid #D1D5DB; transition: all 0.2s ease; }
        .prose-custom a:hover { border-bottom-color: var(--accent); }
        .prose-custom pre, .prose-custom blockquote { margin-top: 2.5em; margin-bottom: 2.5em; }
        .prose-custom pre { background-color: transparent; padding: 0; border: none; overflow-x: visible; }
        .prose-custom code { background-color: #E5E7EB; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.9em; color: #4B5563; }
        .prose-custom pre code { background-color: transparent; padding: 0; }
        .prose-custom blockquote { border-left: 3px solid #9CA3AF; padding-left: 1.5rem; color: var(--text-secondary); font-style: normal; }
        .prose-custom img { border-radius: 12px; max-width: 100%; height: auto; margin-top: 3em; margin-bottom: 3em; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        
        .pagination-controls a, .pagination-controls span { padding: 0.5rem 1rem; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s ease; }
        .pagination-controls a:hover { background-color: var(--bg-content); }
        .pagination-controls .active { background-color: var(--accent); color: white; border-color: var(--accent); }
        .pagination-controls .disabled { opacity: 0.5; pointer-events: none; }
        
        .ql-toolbar { border: 1px solid #D1D5DB !important; border-top-left-radius: 8px; border-top-right-radius: 8px; background: #F9FAFB; }
        .ql-container { border: 1px solid #D1D5DB !important; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; font-family: var(--font-body) !important; background: var(--bg-content); }
        .ql-editor { color: var(--text-primary); min-height: 350px; font-size: 1rem; line-height: 1.8; }
        .ql-editor p { margin-bottom: 1rem; }
        .ql-snow .ql-stroke { stroke: var(--text-secondary); } .ql-snow .ql-picker-label { color: var(--text-secondary) !important; }
        
        .youtube-embed-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 2em 0; border-radius: 12px; }
        .youtube-embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #view-refiner .refiner-grid { display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap: 1.5rem; height: calc(100vh - 140px); }
        #refiner-preview-container { height: 100%; overflow-y: auto; padding: 1.2rem; border: 1px solid #E5E7EB; background: var(--bg-content); border-radius: 12px; }
        #refiner-chat-container { display: flex; flex-direction: column; height: 100%; }
        #chat-history { flex-grow: 1; overflow-y: auto; padding: 1rem; space-y: 1rem; display: flex; flex-direction: column;}
        .chat-message { max-width: 90%; padding: 0.6rem 1rem; border-radius: 16px; line-height: 1.6; font-size: 0.9rem;}
        .chat-message.user { background-color: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-message.ai { background-color: #F3F4F6; border: 1px solid #E5E7EB; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-message.system { font-size: 0.75rem; text-align: center; color: var(--text-secondary); align-self: center; }
        #refiner-chat-form { border-top: 1px solid #E5E7EB; padding-top: 1rem; display: flex; gap: 0.5rem; }
        
        /* Table of Contents Styles */
        #toc-container {
            position: sticky;
            top: 100px;
            align-self: start;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        #toc-container h4 {
            font-family: var(--font-heading);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E7EB;
        }
        #toc-container ul { list-style: none; padding-left: 0; margin: 0; }
        #toc-container li a {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-left: 2px solid #E5E7EB;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        #toc-container li a:hover { color: var(--text-primary); background-color: #F3F4F6; }
        #toc-container li a.active { color: var(--text-primary); font-weight: 600; border-left-color: var(--accent); }
        #toc-container li.toc-h3 a { padding-left: 2rem; }
        
        /* Tag Styles */
        .tag-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
        .tag-item { background-color: #F3F4F6; color: #4B5563; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 500; transition: background-color 0.2s; }
        .tag-item:hover { background-color: #E5E7EB; color: #1F2937; }

        /* Author Box Styles */
        .author-box {
            margin-top: 3rem;
            padding: 1.5rem;
            background-color: var(--bg-content);
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .author-box img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        .author-box .name {
            font-family: var(--font-heading);
            font-weight: 700;
            color: var(--text-primary);
        }
        .author-box .bio {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Search Overlay */
        #search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(249, 250, 251, 0.95);
            backdrop-filter: blur(8px);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 4rem 1rem;
        }
        #search-container { width: 100%; max-width: 640px; }
        #search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            border: 2px solid #E5E7EB;
            border-radius: 9999px;
        }
        #search-results { max-height: calc(100vh - 200px); overflow-y: auto; }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        @media (max-width: 1024px) {
            #toc-container { display: none; }
        }
        @media (max-width: 768px) {
            .prose-custom h1 { font-size: 1.875rem; }
            #view-refiner .refiner-grid { 
                grid-template-columns: 1fr; 
                height: calc(100vh - 120px); 
                gap: 1.5rem; 
                flex-direction: column;
                display: flex;
            }
            #refiner-preview-wrapper { flex: 3; overflow-y: hidden; display: flex; flex-direction: column; }
            #refiner-preview-container { flex-grow: 1; height: 100%; }
            #refiner-chat-container { flex: 2; min-height: 0; }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ8THNV2"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="app-loader"><div class="loader-spinner"></div></div>
    <div id="refiner-loader">
        <div class="loader-spinner"></div>
        <p class="text-gray-600 font-semibold">AI가 글을 수정하고 있습니다...</p>
    </div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center px-4 py-2.5"></header>
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <main id="main-content">
            <div id="view-library" class="app-view"></div>
            <div id="view-post" class="app-view"></div>
            <div id="view-dashboard" class="app-view"></div>
            <div id="view-writer" class="app-view"></div>
            <div id="view-refiner" class="app-view"></div>
            <div id="view-tag" class="app-view"></div>
        </main>
    </div>
    <footer class="text-center py-8 px-4 border-t border-gray-200 mt-16">
        <p class="text-sm text-gray-500">
            개발 및 문의사항은 <a href="https://www.threads.com/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-700 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
    <div id="search-overlay">
        <div id="search-container">
            <input type="search" id="search-input" placeholder="검색어를 입력하세요..." autocomplete="off">
            <div id="search-results" class="mt-6 space-y-4"></div>
        </div>
        <button id="close-search-btn" class="absolute top-8 right-8 text-gray-500 hover:text-black">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
    <div id="structured-data-container"></div>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>
    
    <!-- Code Highlighting (Prettify) Script -->
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css"></script>

    <script type="module">
        // =================================================================================
        // --- SETUP & STATE MANAGEMENT ---
        // =================================================================================
        const SITE_URL = 'https://blogaipandoci.vercel.app';
        const SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        const IMAGE_BUCKET_NAME = 'thought-images';
        const POSTS_PER_PAGE = 5;
        const DRAFT_STORAGE_KEY = 'cortexlog_ai_draft';
        const defaultMeta = {
            title: "InsureLog",
            description: "AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.",
            image: 'https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp'
        };
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const state = { 
            user: null, 
            quill: null,
            isAuthReady: false,
            draftArticle: null,
            tocObserver: null,
        };
        const $ = (selector) => document.querySelector(selector);
        
        // =================================================================================
        // --- SEO & META TAGS ---
        // =================================================================================
        function updateMetaTags(post = null, tag = null) {
            const title = tag ? `#${tag} 태그 글 모음` : (post ? post.title : defaultMeta.title);
            const description = tag ? `${tag}와(과) 관련된 글들을 확인해보세요.` : (post ? (post.summary || defaultMeta.description) : defaultMeta.description);
            const url = tag ? `${SITE_URL}/tag/${tag}` : (post ? `${SITE_URL}/post/${post.slug}` : SITE_URL);
            let imageUrl = defaultMeta.image;
            if (post && post.refined_content) {
                const match = post.refined_content.match(/<img[^>]+src="([^">]+)"/);
                if (match && match[1]) imageUrl = match[1];
            }
            document.title = title;
            $('meta[name="description"]').setAttribute('content', description);
            $('link[rel="canonical"]').setAttribute('href', url);
            ['og:title', 'twitter:title'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', title));
            ['og:description', 'twitter:description'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', description));
            ['og:url', 'twitter:url'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', url));
            ['og:image', 'twitter:image'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', imageUrl));

            if(post) {
                generateStructuredData('Article', post);
            } else {
                generateStructuredData('WebSite');
            }
        }

        function generateStructuredData(type, data = {}) {
            let schema = {};
            if (type === 'WebSite') {
                schema = {
                    "@context": "https://schema.org",
                    "@type": "WebSite",
                    "url": SITE_URL,
                    "name": "InsureLog",
                    "description": "AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트",
                };
            } else if (type === 'Article' && data && data.refined_content) {
                const imageUrl = (data.refined_content.match(/<img[^>]+src="([^">]+)"/) || [])[1] || defaultMeta.image;
                schema = {
                    "@context": "https://schema.org",
                    "@type": "Article",
                    "mainEntityOfPage": {
                        "@type": "WebPage",
                        "@id": `${SITE_URL}/post/${data.slug}`
                    },
                    "headline": data.title,
                    "description": data.summary,
                    "image": imageUrl,
                    "author": { "@type": "Person", "name": data.profiles?.full_name || "InsureLog Admin" },
                    "publisher": { "@type": "Organization", "name": "InsureLog", "logo": { "@type": "ImageObject", "url": defaultMeta.image } },
                    "datePublished": new Date(data.created_at).toISOString(),
                    "dateModified": new Date(data.updated_at || data.created_at).toISOString() 
                };
            }
            let script = document.getElementById('json-ld-structured-data');
            if (!script) {
                script = document.createElement('script');
                script.type = 'application/ld+json';
                script.id = 'json-ld-structured-data';
                $('#structured-data-container').appendChild(script);
            }
            script.textContent = JSON.stringify(schema);
        }

        // =================================================================================
        // --- UI & ANIMATIONS ---
        // =================================================================================
        const animations = {
            pageEnter: (el) => anime({ targets: el, translateY: [20, 0], opacity: [0, 1], duration: 500, easing: 'easeOutCubic' }),
            pageExit: (el) => anime({ targets: el, translateY: [0, -20], opacity: [1, 0], duration: 300, easing: 'easeInCubic' }).finished,
        };
        
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `py-2 px-4 rounded-lg shadow-lg text-sm font-medium border ${isError ? 'bg-red-50 border-red-300 text-red-800' : 'bg-green-50 border-green-300 text-green-800'}`;
            toast.textContent = message;
            $('#toast-container').appendChild(toast);
            anime({ targets: toast, translateX: [20, 0], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
            setTimeout(async () => {
                await anime({ targets: toast, translateX: [0, 20], opacity: [1, 0], duration: 400, easing: 'easeInCubic' }).finished;
                toast.remove();
            }, 3000);
        }

        function renderModal({ title, content, confirmText, onConfirm, cancelText = '취소', onCancel = closeModal }) {
            const modalId = `modal-${Date.now()}`;
            const modalHtml = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div class="modal-content relative bg-white border border-gray-200 rounded-xl shadow-xl w-full max-w-sm p-6"><h3 class="text-lg font-bold font-heading mb-4">${title}</h3><div class="text-gray-500 mb-6 text-sm">${content}</div><div class="flex justify-end space-x-3"><button type="button" class="btn" id="modal-cancel-btn">${cancelText}</button>${confirmText ? `<button type="button" class="btn btn-primary" id="modal-confirm-btn">${confirmText}</button>` : ''}</div></div></div>`;
            $('#modal-container').innerHTML = modalHtml;
            const modalEl = $(`#${modalId}`);
            if (onConfirm) $('#modal-confirm-btn').addEventListener('click', onConfirm);
            $('#modal-cancel-btn').addEventListener('click', onCancel);
            modalEl.querySelector('.modal-backdrop').addEventListener('click', onCancel);
            anime({ targets: modalEl.querySelector('.modal-backdrop'), opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
            anime({ targets: modalEl.querySelector('.modal-content'), translateY: [20, 0], scale: [0.98, 1], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
        }
        
        async function closeModal() {
            const modal = $('#modal-container').firstElementChild;
            if (!modal) return;
            await Promise.all([
                anime({ targets: modal.querySelector('.modal-backdrop'), opacity: 0, duration: 300, easing: 'easeInCubic' }).finished,
                anime({ targets: modal.querySelector('.modal-content'), translateY: 20, scale: 0.98, opacity: 0, duration: 300, easing: 'easeInCubic' }).finished
            ]);
            $('#modal-container').innerHTML = '';
        }

        // =================================================================================
        // --- AUTHENTICATION ---
        // =================================================================================
        function showAuthModal() {
            const content = `<form id="auth-form" novalidate class="space-y-4"><div><label for="email" class="block text-sm font-medium text-black mb-1">이메일</label><input type="email" id="email" class="form-input" required autocomplete="email"></div><div><label for="password" class="block text-sm font-medium text-black mb-1">비밀번호 (6자 이상)</label><input type="password" id="password" class="form-input" required autocomplete="current-password" minlength="6"></div><div id="auth-error" class="text-red-500 text-xs h-3"></div></form>`;
            renderModal({ title: '시작하기', content, confirmText: '로그인', onConfirm: () => handleAuth('login') });
            const signUpBtn = document.createElement('button');
            signUpBtn.type = 'button'; signUpBtn.className = 'btn'; signUpBtn.textContent = '회원가입';
            $('#modal-confirm-btn').insertAdjacentElement('beforebegin', signUpBtn);
            signUpBtn.addEventListener('click', () => handleAuth('signup'));
        }
        
        async function handleAuth(action) {
            const email = $('#email').value; const password = $('#password').value;
            const errorDiv = $('#auth-error'); errorDiv.textContent = '';
            const { error } = action === 'login' ? await supabase.auth.signInWithPassword({ email, password }) : await supabase.auth.signUp({ email, password });
            if (error) { errorDiv.textContent = "인증 오류: " + error.message; } 
            else { showToast(action === 'signup' ? '가입 완료! 이메일을 확인하여 인증해주세요.' : '로그인되었습니다.'); closeModal(); }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) showToast('로그아웃 중 오류가 발생했습니다.', true);
            else { showToast('로그아웃되었습니다.'); navigateTo('/'); }
        }
        
        // =================================================================================
        // --- ROUTING & VIEW MANAGEMENT ---
        // =================================================================================
        function navigateTo(path) {
            history.pushState(null, null, path);
            handleRouting();
        }

        async function switchView(viewId, callback) {
            if (state.tocObserver) {
                state.tocObserver.disconnect();
                state.tocObserver = null;
            }
            const currentView = $('.app-view.active');
            if (currentView) {
                await animations.pageExit(currentView);
                currentView.classList.remove('active');
                currentView.innerHTML = '';
            }
            const nextView = $(`#${viewId}`);
            if (nextView) {
                if (callback) await callback(nextView);
                nextView.classList.add('active');
                animations.pageEnter(nextView);
                
                // Call Prettify after view is rendered
                // Use a small delay to ensure content is fully in the DOM
                setTimeout(() => PR.prettyPrint(), 50);
            }
        }
        
        function handleRouting() {
            if (!state.isAuthReady) return;
            const path = window.location.pathname;
            // GTM page_view event
            window.dataLayer.push({
                event: 'page_view',
                page_path: path,
                page_title: document.title
            });

            const parts = path.substring(1).split('/');
            let route = parts[0] || 'library';
            let param = parts[1] || null;
            let page = 1;

            if (route === 'page') {
                page = parseInt(parts[1], 10) || 1;
                route = 'library';
            } else if (route === 'dashboard' && parts[1] === 'page') {
                page = parseInt(parts[2], 10) || 1;
                route = 'dashboard';
            } else if (route === '') {
                route = 'library';
            }

            if (!state.user && ['dashboard', 'writer', 'refiner'].includes(route)) {
                showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                navigateTo('/');
                return;
            }

            switch (route) {
                case 'post': switchView('view-post', (el) => renderPostView(el, param)); break;
                case 'dashboard': switchView('view-dashboard', (el) => renderDashboardView(el, page)); break;
                case 'writer': switchView('view-writer', (el) => renderWriterView(el, param)); break;
                case 'refiner': switchView('view-refiner', (el) => renderRefinerView(el)); break;
                case 'tag': switchView('view-tag', (el) => renderTagView(el, param)); break;
                default: switchView('view-library', (el) => renderLibraryView(el, page));
            }
        }
        
        // =================================================================================
        // --- CORE RENDER FUNCTIONS ---
        // =================================================================================
        function renderNav() {
            $('#main-nav-container').innerHTML = `
                <nav class="w-full max-w-7xl flex items-center justify-between py-2.5 px-4 bg-white/80 backdrop-blur-lg border border-gray-200 rounded-xl shadow-sm">
                    <a href="/" class="brand-logo" data-action="route">InsureLog</a>
                    <div class="flex items-center space-x-2">
                        <button data-action="show-search" class="btn p-1.5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </button>
                        ${state.user 
                            ? `<a href="/dashboard" class="btn px-2 py-1 text-xs sm:px-4 sm:py-1.5 sm:text-sm" data-action="route">대시보드</a><button data-action="logout" class="btn px-2 py-1 text-xs sm:px-4 sm:py-1.5 sm:text-sm">로그아웃</button>` 
                            : `<button data-action="show-auth" class="btn btn-primary px-2 py-1 text-xs sm:px-4 sm:py-1.5 sm:text-sm">로그인 / 가입</button>`
                        }
                    </div>
                </nav>`;
        }
        
        async function renderLibraryView(container, page = 1) {
            updateMetaTags();
            $('#app-container').className = 'max-w-4xl mx-auto px-4 sm:px-6 lg:px-8';
            const { from, to } = getPaginationRange(page);
            
            // FIX: Fetch posts first, then profiles separately to avoid join issues.
            const { data: posts, error, count } = await supabase.from('posts').select('*', { count: 'exact' }).order('created_at', { ascending: false }).range(from, to);
            
            if (error) { 
                console.error("Error fetching posts:", error);
                showToast('데이터를 불러오는 데 실패했습니다.', true); 
                container.innerHTML = `<p class="text-center text-gray-500 py-20">글을 불러올 수 없습니다.</p>`; 
                return; 
            }

            if (posts.length === 0) {
                container.innerHTML = `<div class="py-16"><h1 class="text-4xl font-extrabold text-center font-heading mb-4">Insurance Insights</h1><p class="text-center text-gray-500 text-base mb-16">AI, 기술, 그리고 보험에 대한 기록들</p><div class="space-y-6"><p class="text-center text-gray-500 py-20">아직 작성된 글이 없습니다.</p></div></div>`;
                return;
            }

            const authorIds = [...new Set(posts.map(post => post.author_id).filter(id => id))];
            let profilesMap = new Map();

            if (authorIds.length > 0) {
                const { data: profiles, error: profileError } = await supabase
                    .from('profiles')
                    .select('id, full_name, avatar_url')
                    .in('id', authorIds);

                if (profileError) {
                    console.error("Error fetching profiles for list:", profileError);
                } else {
                    profiles.forEach(profile => profilesMap.set(profile.id, profile));
                }
            }
            
            const postsHtml = posts.map(post => {
                const profile = profilesMap.get(post.author_id);
                const avatarUrl = profile?.avatar_url || 'https://placehold.co/24x24/f9fafb/6b7280?text=A';
                const authorName = profile?.full_name || '작성자';
                return `
                <a href="/post/${post.slug}" data-action="route" class="block p-6 bg-white border border-gray-200 hover:border-gray-300 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group">
                    <h2 class="text-xl sm:text-2xl font-bold font-heading mb-2 text-gray-800 group-hover:text-black transition-colors">${post.title}</h2>
                    <p class="text-gray-600 mb-4">${post.summary || ''}</p>
                    <div class="mt-4 flex justify-between items-center text-sm">
                        <div class="flex items-center flex-wrap gap-2">
                             <img class="w-6 h-6 rounded-full" src="${avatarUrl}" alt="${authorName}">
                             ${renderTags(post.tags, false)}
                        </div>
                        <p class="text-gray-400 shrink-0">${new Date(post.created_at).toLocaleDateString('ko-KR')}</p>
                    </div>
                </a>`;
            }).join('');

            container.innerHTML = `<div class="py-16"><h1 class="text-4xl font-extrabold text-center font-heading mb-4">Insurance Insights</h1><p class="text-center text-gray-500 text-base mb-16">AI, 기술, 그리고 보험에 대한 기록들</p><div class="space-y-6">${postsHtml}</div>${renderPaginationControls(page, count, '/page/')}</div>`;
        }

        async function renderPostView(container, slug) {
            $('#app-container').className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8';
            if (!slug) { navigateTo('/'); return; }

            const { data: post, error } = await supabase.from('posts').select('*').eq('slug', slug).single();

            if (error || !post) { 
                console.error("Error fetching post:", error);
                showToast('글을 찾을 수 없습니다.', true); 
                navigateTo('/'); 
                return; 
            }

            let profile = null;
            if(post.author_id) {
                const { data: profileData, error: profileError } = await supabase.from('profiles').select('*').eq('id', post.author_id).single();
                if (profileError) {
                    console.error("Error fetching profile:", profileError);
                } else {
                    profile = profileData;
                }
            }
            
            updateMetaTags(post);
            
            const { data: allOtherPosts, error: allPostsError } = await supabase.from('posts').select('id, title, summary, slug').neq('id', post.id);

            const editButtonHtml = (state.user && state.user.id === post.author_id)
                ? `<a href="/writer/${post.slug}" class="btn" data-action="route">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m13.83 2.17 3 3L6.83 15.17H3.83V12.17l10-10ZM15.24 0 .92 14.31A.996.996 0 0 0 0 15v4a.996.996 0 0 0 1 1h4c.27 0 .52-.11.71-.29L19.03 4.4a2.5 2.5 0 0 0 0-3.53l-3-3a2.5 2.5 0 0 0-3.54-.29Z"/></svg>
                        <span>수정하기</span>
                    </a>`
                : '';
            
            const dateString = new Date(post.created_at).toLocaleString('ko-KR');
            let updatedString = '';
            if (post.updated_at) {
                const createdDate = new Date(post.created_at);
                const updatedDate = new Date(post.updated_at);
                if (updatedDate.getTime() - createdDate.getTime() > 60000) {
                     updatedString = ` (수정: ${updatedDate.toLocaleString('ko-KR')})`;
                }
            }
            
            const postLayout = `
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 pt-8 pb-12">
                    <div class="lg:col-span-3">
                        <aside id="toc-container"></aside>
                    </div>
                    <div class="lg:col-span-9">
                         <div class="max-w-4xl">
                             <article class="prose-custom max-w-none">
                                 <div class="flex justify-between items-center mb-8">
                                     <button class="btn" data-action="go-back"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>목록으로</button>
                                     ${editButtonHtml}
                                 </div>
                                 <h1 class="!mt-0">${post.title}</h1>
                                 <p class="text-sm text-gray-500 mb-8">${dateString}${updatedString}</p>
                                 <div id="post-content">${post.refined_content || ''}</div>
                                 <div class="border-t border-gray-200 mt-12 pt-4">${renderTags(post.tags)}</div>
                             </article>
                             ${renderAuthorProfile(profile)}
                             <div class="my-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"></ins></div>
                             ${allPostsError ? '' : createRelatedPostsHtml(findRelatedPosts(post, allOtherPosts))}
                             ${createShareButtonsHtml(`${SITE_URL}/post/${post.slug}`, post.title)}
                         </div>
                    </div>
                </div>`;
            container.innerHTML = postLayout;
            
            buildTableOfContents();
            lazyLoadImages();

            setTimeout(() => {
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.warn("AdSense push warning:", e.message);
                }
            }, 100);
        }

        async function renderDashboardView(container, page = 1) {
            updateMetaTags();
            $('#app-container').className = 'max-w-5xl mx-auto px-4 sm:px-6 lg:px-8';
            const { from, to } = getPaginationRange(page);
            const { data, error, count } = await supabase.from('posts').select('*', { count: 'exact' }).eq('author_id', state.user.id).order('created_at', { ascending: false }).range(from, to);
            if (error) { showToast('내 글 목록 로딩 실패: ' + error.message, true); container.innerHTML = `<p>내가 작성한 글을 불러올 수 없습니다.</p>`; return; }
            const listHtml = data.length > 0 ? data.map(post => `<li class="p-4 flex justify-between items-center hover:bg-gray-50 rounded-lg"><div><a href="/post/${post.slug}" data-action="route" class="font-semibold text-gray-800 hover:text-black">${post.title}</a><p class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleString('ko-KR')}</p></div><div class="space-x-2"><a href="/writer/${post.slug}" class="btn text-xs" data-action="route">수정</a><button class="btn text-xs" data-action="delete-post" data-id="${post.id}">삭제</button></div></li>`).join('') : '<li class="p-8 text-center text-gray-500">작성된 글이 없습니다.</li>';
            container.innerHTML = `<div class="py-12 space-y-16"><div><h1 class="text-2xl sm:text-3xl font-bold font-heading mb-2">AI 글 생성</h1><p class="text-gray-500 mb-8">아이디어나 주제만으로 AI가 고품질의 초안을 생성합니다.</p><div class="bg-white border border-gray-200 rounded-xl shadow-sm p-8"><form id="ai-writer-form" class="space-y-4"><div><label for="ai-topic" class="block text-sm font-medium text-gray-600 mb-2">글 주제</label><input type="text" id="ai-topic" class="form-input" required placeholder="예: '20대 사회초년생을 위한 실손보험 가이드'"></div><div class="flex justify-end items-center gap-4 pt-2"><div class="flex items-center gap-2"><label for="ai-image-toggle" class="text-sm font-medium text-gray-600 cursor-pointer">대표 이미지 생성</label><label class="toggle-switch"><input type="checkbox" id="ai-image-toggle" checked><span class="slider"></span></label></div><div class="ai-loader"></div><button type="submit" id="ai-generate-btn" class="btn btn-primary">AI로 초안 생성하기</button></div></form></div></div><div><div class="flex justify-between items-center mb-8"><div class="flex-grow"><h1 class="text-2xl sm:text-3xl font-bold font-heading">내 글 관리</h1><p class="text-gray-500 mt-2">작성한 글을 수정하거나 삭제할 수 있습니다.</p></div><a href="/writer" class="btn px-3 py-1.5 text-xs sm:px-4 sm:py-2 sm:text-sm" data-action="route"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>새 글 수동 작성</a></div><div class="bg-white border border-gray-200 rounded-xl shadow-sm"><ul class="divide-y divide-gray-200">${listHtml}</ul></div>${renderPaginationControls(page, count, '/dashboard/page/')}</div></div>`;
            $('#ai-writer-form').addEventListener('submit', (e) => { e.preventDefault(); handleAiWriterSubmit(); });
        }

        async function renderWriterView(container, slug, draft = null) {
            $('#app-container').className = 'max-w-4xl mx-auto px-4 sm:px-6 lg:px-8';
            updateMetaTags();
            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', tags: [] };
            if (draft) {
                post.id = draft.postId || null;
                post.title = draft.title;
                post.summary = draft.summary;
                post.refined_content = `${draft.imageHtml || ''}${draft.body}`;
                post.slug = draft.slug;
                post.tags = draft.tags || [];
            } else if (slug) {
                const { data, error } = await supabase.from('posts').select('*').eq('slug', slug).single();
                if (error || !data) { showToast('글 정보를 가져오지 못했습니다.', true); navigateTo('/dashboard'); return; }
                if (data.author_id !== state.user.id) { showToast('자신이 작성한 글만 수정할 수 있습니다.', true); navigateTo('/dashboard'); return; }
                post = data;
            }
            container.innerHTML = `<div class="py-12"><div class="mb-8"><button class="btn" data-action="go-back"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>대시보드로</button></div><h1 class="text-3xl font-bold font-heading mb-8">${post.id ? '글 수정하기' : '새 글 작성하기'}</h1><form id="writer-form" class="space-y-6"><input type="hidden" id="post-id" value="${post.id || ''}"><input type="hidden" id="post-slug" value="${post.slug || ''}"><input type="hidden" id="is-draft-publish" value="${draft ? 'true' : 'false'}"><div><label for="title" class="block text-sm font-medium text-gray-600 mb-2">제목</label><input type="text" id="title" class="form-input" required value="${post.title}"></div><div><label for="summary" class="block text-sm font-medium text-gray-600 mb-2">요약</label><textarea id="summary" class="form-textarea" rows="3" required>${post.summary}</textarea></div><div><label for="tags" class="block text-sm font-medium text-gray-600 mb-2">태그 (쉼표로 구분)</label><input type="text" id="tags" class="form-input" value="${(post.tags || []).join(', ')}"></div><div><div class="flex justify-between items-center mb-2"><label class="block text-sm font-medium text-gray-600">본문</label><button type="button" class="btn text-xs" data-action="toggle-html">HTML 보기</button></div><div id="editor"></div><textarea id="html-editor" class="form-textarea" style="display: none; min-height: 350px; font-family: monospace;"></textarea></div><div class="flex justify-end items-center pt-4 space-x-3"><button type="submit" id="submit-btn" class="btn btn-primary">저장하기</button><div class="border-l border-gray-300 h-6"></div><div class="flex items-center gap-2"><label for="writer-image-toggle" class="text-sm font-medium text-gray-600 cursor-pointer">대표 이미지 생성</label><label class="toggle-switch"><input type="checkbox" id="writer-image-toggle" checked><span class="slider"></span></label></div><button type="button" class="btn" data-action="go-to-refiner">AI로 다듬기</button></div></form></div>`;
            initQuillEditor(post.refined_content || '');
        }
        
        async function renderTagView(container, tag) {
            if (!tag) { navigateTo('/'); return; }
            const decodedTag = decodeURIComponent(tag);
            updateMetaTags(null, decodedTag);
            $('#app-container').className = 'max-w-4xl mx-auto px-4 sm:px-6 lg:px-8';
            
            const { data, error } = await supabase.from('posts').select('*').contains('tags', [decodedTag]).order('created_at', { ascending: false });
            
            if (error) { showToast('태그 글을 불러오는 데 실패했습니다.', true); container.innerHTML = `<p class="text-center text-gray-500 py-20">글을 불러올 수 없습니다.</p>`; return; }
            
            const postsHtml = data.length > 0 ? data.map(post => `
                <a href="/post/${post.slug}" data-action="route" class="block p-6 bg-white border border-gray-200 hover:border-gray-300 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 group">
                    <h2 class="text-xl sm:text-2xl font-bold font-heading mb-2 text-gray-800 group-hover:text-black transition-colors">${post.title}</h2>
                    <p class="text-gray-600 mb-4">${post.summary || ''}</p>
                    ${renderTags(post.tags)}
                    <p class="text-sm text-gray-400 mt-4">${new Date(post.created_at).toLocaleDateString('ko-KR')}</p>
                </a>`).join('') : `<p class="text-center text-gray-500 py-20">이 태그가 붙은 글이 없습니다.</p>`;
            
            container.innerHTML = `<div class="py-16"><h1 class="text-4xl font-extrabold text-center font-heading mb-4">#${decodedTag}</h1><p class="text-center text-gray-500 text-lg mb-12">'${decodedTag}' 태그가 포함된 글 목록입니다.</p><div class="space-y-6">${postsHtml}</div></div>`;
        }

        // =================================================================================
        // --- HELPER & UTILITY FUNCTIONS ---
        // =================================================================================
        function getPaginationRange(page) { const from = (page - 1) * POSTS_PER_PAGE; return { from, to: from + POSTS_PER_PAGE - 1 }; }
        function renderPaginationControls(currentPage, totalPosts, baseLink) { const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE); if (totalPages <= 1) return ''; let html = '<div class="flex justify-center items-center gap-2 mt-12 pagination-controls">'; html += `<a href="${baseLink}${currentPage - 1}" data-action="route" class="${currentPage === 1 ? 'disabled' : ''}">이전</a>`; for (let i = 1; i <= totalPages; i++) { html += `<a href="${baseLink}${i}" data-action="route" class="${i === currentPage ? 'active' : ''}">${i}</a>`; } html += `<a href="${baseLink}${currentPage + 1}" data-action="route" class="${currentPage === totalPages ? 'disabled' : ''}">다음</a>`; return html + '</div>'; }
        function findRelatedPosts(currentPost, otherPosts, count = 2) { const currentTitleWords = currentPost.title.toLowerCase().split(/\s+/); const scoredPosts = otherPosts.map(post => { let score = 0; const targetTitle = post.title.toLowerCase(); currentTitleWords.forEach(word => { if (word.length > 1 && targetTitle.includes(word)) score++; }); return { ...post, score }; }); return scoredPosts.filter(post => post.score > 0).sort((a, b) => b.score - a.score).slice(0, count); }
        function createShareButtonsHtml(url, title) { return `<div class="mt-12 py-8 mb-12 border-t border-gray-200"><h3 class="text-center text-sm font-bold text-gray-500 mb-4 tracking-wider">공유하기</h3><div class="flex justify-center items-center gap-4"><a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" target="_blank" class="btn"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg><span>X</span></a><a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank" class="btn"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M14 13.5h2.5l1-4H14v-2c0-1.03 0-2 2-2h1.5V2.14c-.326-.043-1.557-.14-2.857-.14C11.928 2 10 3.657 10 6.7v2.8H7v4h3V22h4z"></path></svg><span>Facebook</span></a><button class="btn" data-action="copy-link" data-url="${url}"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg><span>링크 복사</span></button></div></div>`; }
        function createRelatedPostsHtml(relatedPosts) { if (relatedPosts.length === 0) return ''; return `<div class="mt-8 pt-8 border-t border-gray-200"><h3 class="text-xl font-bold font-heading mb-6">관련 글</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">${relatedPosts.map(p => `<a href="/post/${p.slug}" data-action="route" class="block p-5 bg-gray-50 border border-transparent hover:border-gray-200 rounded-xl transition-all duration-300 group"><h4 class="font-semibold text-gray-800 group-hover:text-black transition-colors">${p.title}</h4><p class="text-gray-500 text-sm mt-1">${p.summary}</p></a>`).join('')}</div></div>`; }
        
        function renderTags(tags, withWrapper = true) {
            if (!tags || tags.length === 0) return '';
            const tagsHtml = tags.map(tag => `<a href="/tag/${encodeURIComponent(tag)}" class="tag-item" data-action="route">#${tag}</a>`).join(' ');
            if (withWrapper) {
                return `<div class="tag-list">${tagsHtml}</div>`;
            }
            return tagsHtml;
        }

        function renderAuthorProfile(profile) {
            if (!profile) return '';
            const avatarUrl = profile.avatar_url || 'https://placehold.co/120x120/f9fafb/6b7280?text=User';
            const authorName = profile.full_name || '익명';
            const authorBio = profile.bio || '작성자 정보가 없습니다.';
            return `
                <div class="author-box">
                    <img src="${avatarUrl}" alt="${authorName}" loading="lazy">
                    <div>
                        <p class="name">${authorName}</p>
                        <p class="bio">${authorBio}</p>
                    </div>
                </div>`;
        }
        
        function initQuillEditor(initialContent) {
            if (state.quill) state.quill = null;
            const BlockEmbed = Quill.import('blots/block/embed');
            class VideoEmbedBlot extends BlockEmbed {
                static create(value) { let node = super.create(); node.innerHTML = value; node.setAttribute('contenteditable', 'false'); return node; }
                static value(node) { return node.innerHTML; }
            }
            VideoEmbedBlot.blotName = 'video-embed';
            VideoEmbedBlot.tagName = 'div';
            VideoEmbedBlot.className = 'ql-video-embed-wrapper';
            Quill.register(VideoEmbedBlot);

            state.quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike', 'blockquote', 'code-block'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link', 'image'], ['clean']]
                }
            });

            state.quill.getModule('toolbar').addHandler('image', () => {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.click();

                input.onchange = async () => {
                    const file = input.files[0];
                    if (!file) return;
                    if (!state.user) {
                        showToast('이미지를 업로드하려면 로그인이 필요합니다.', true);
                        return;
                    }

                    const range = state.quill.getSelection(true);
                    state.quill.insertText(range.index, '[이미지 업로드 중...]', { 'italic': true });

                    try {
                        const webpBlob = await convertToWebP(file);
                        const imageUrl = await uploadImageFile(webpBlob);
                        
                        const loaderLength = '[이미지 업로드 중...]'.length;
                        state.quill.deleteText(range.index, loaderLength);
                        state.quill.insertEmbed(range.index, 'image', imageUrl);
                        state.quill.setSelection(range.index + 1);

                    } catch (error) {
                        console.error('Manual image upload failed:', error);
                        showToast(`이미지 업로드 실패: ${error.message}`, true);
                        const loaderLength = '[이미지 업로드 중...]'.length;
                        state.quill.deleteText(range.index, loaderLength);
                    }
                };
            });

            const Delta = Quill.import('delta');
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:(?:m|www)\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            state.quill.clipboard.addMatcher(Node.TEXT_NODE, (node, delta) => {
                const text = node.data;
                const match = text.match(youtubeRegex);
                if (match && match[1]) {
                    const embedHtml = `<div class="youtube-embed-container"><iframe src="https://www.youtube.com/embed/${match[1]}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>`;
                    return new Delta().insert({ 'video-embed': embedHtml }).insert('\n');
                }
                return delta;
            });
            state.quill.root.innerHTML = initialContent;
        }

        function base64ToBlob(base64, contentType = 'image/webp') { const byteCharacters = atob(base64); const byteArrays = []; for (let offset = 0; offset < byteCharacters.length; offset += 512) { const slice = byteCharacters.slice(offset, offset + 512); const byteNumbers = new Array(slice.length); for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i); byteArrays.push(new Uint8Array(byteNumbers)); } return new Blob(byteArrays, { type: contentType }); }
        
        async function uploadImageFile(imageFile) {
            if (!imageFile) throw new Error("이미지 파일이 없습니다.");
            const fileName = `${state.user.id}/${Date.now()}.webp`;
            const { error } = await supabase.storage
                .from(IMAGE_BUCKET_NAME)
                .upload(fileName, imageFile, { contentType: 'image/webp' });
            if (error) throw new Error(`이미지 업로드 실패: ${error.message}`);
            const { data } = supabase.storage.from(IMAGE_BUCKET_NAME).getPublicUrl(fileName);
            return data.publicUrl;
        }

        function convertToWebP(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => {
                            if (blob) resolve(blob);
                            else reject(new Error('Canvas to Blob conversion failed.'));
                        }, 'image/webp', quality);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        function lazyLoadImages() {
            const images = document.querySelectorAll('#post-content img');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (!img.getAttribute('data-loaded')) {
                            img.src = img.src;
                            img.setAttribute('data-loaded', 'true');
                        }
                        observer.unobserve(img);
                    }
                });
            }, { rootMargin: '0px 0px 200px 0px' });
            images.forEach(image => observer.observe(image));
        }

        // =================================================================================
        // --- TABLE OF CONTENTS ---
        // =================================================================================
        function buildTableOfContents() {
            const contentEl = $('#post-content');
            const tocContainer = $('#toc-container');
            if (!contentEl || !tocContainer) return;

            const headings = contentEl.querySelectorAll('h2, h3');
            if (headings.length < 2) return;

            const tocList = document.createElement('ul');
            headings.forEach((heading, index) => {
                const id = `toc-heading-${index}`;
                heading.id = id;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = heading.textContent;
                li.className = `toc-${heading.tagName.toLowerCase()}`;
                
                a.onclick = (e) => {
                    e.preventDefault();
                    const targetElement = document.getElementById(id);
                    if (!targetElement) return;

                    const navBar = document.getElementById('main-nav-container');
                    const navBarHeight = navBar ? navBar.offsetHeight : 0;
                    const targetPosition = targetElement.getBoundingClientRect().top + window.scrollY;
                    const offsetPosition = targetPosition - navBarHeight - 20; // 20px extra margin

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                };
                
                li.appendChild(a);
                tocList.appendChild(li);
            });

            tocContainer.innerHTML = '<h4>목차</h4>';
            tocContainer.appendChild(tocList);
            
            observeTocHeadings(headings);
        }

        function observeTocHeadings(headings) {
            if (state.tocObserver) state.tocObserver.disconnect();
            
            const navBar = document.getElementById('main-nav-container');
            const navBarHeight = navBar ? navBar.offsetHeight : 0;
            
            const options = {
                rootMargin: `-${navBarHeight + 20}px 0px -65% 0px`,
                threshold: 1.0,
            };

            const callback = (entries) => {
                let lastIntersecting = null;
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        lastIntersecting = entry.target;
                    }
                });

                document.querySelectorAll('#toc-container a.active').forEach(link => link.classList.remove('active'));

                if(lastIntersecting){
                    const activeLink = document.querySelector(`#toc-container a[href="#${lastIntersecting.id}"]`);
                    if (activeLink) activeLink.classList.add('active');
                } else {
                    const firstVisible = [...headings].find(h => h.getBoundingClientRect().bottom > navBarHeight);
                    if(firstVisible) {
                        const activeLink = document.querySelector(`#toc-container a[href="#${firstVisible.id}"]`);
                        if (activeLink) activeLink.classList.add('active');
                    }
                }
            };

            state.tocObserver = new IntersectionObserver(callback, options);
            headings.forEach(heading => state.tocObserver.observe(heading));
        }

        // =================================================================================
        // --- GEMINI API & IMAGE HANDLING (SECURE PROXY) ---
        // =================================================================================
        // NOTE: This application requires a backend proxy at '/api/generate' to securely handle API calls to Google's Gemini and Imagen models.
        // The proxy is responsible for attaching the API key and forwarding the request.
        // This frontend code will NOT work without the corresponding backend implementation.
        async function generateText(topic, isInitial = true, draft = null, instruction = null) { 
            const proxyUrl = '/api/generate';
            const systemPromptContent = `당신은 'InsureLog'의 수석 보험 분석가입니다. 복잡한 보험 상품과 금융 기술 주제를 명확하고, 깊이 있으며, 실용적인 방식으로 설명하는 전문가입니다. 독자들이 '무엇'을 선택해야 하는지 뿐만 아니라 '왜' 그것이 최선인지를 이해할 수 있도록 도와주세요. 다음과 같은 스타일로 글을 작성합니다.
            1. **구조:** 서론(문제 제기 및 중요성) -> 본론(핵심 원리 분석, 상품 비교, 각 선택의 근거 설명) -> 결론(결과 요약 및 추천)의 명확한 구조를 따릅니다.
            2. **내용:** 시장 동향과 데이터에 기반한 분석을 반드시 포함하여 깊이를 더합니다.
            3. **형식:** 생성물은 제목(title), 한두 문장의 요약(summary), SEO 친화적인 영어 URL 슬러그(slug), 글의 핵심 키워드를 담은 태그 배열(tags), 그리고 HTML 형식의 본문(body)을 포함한 JSON 객체여야 합니다. 슬러그는 소문자, 숫자, 하이픈(-)만 사용해야 합니다. 태그는 한국어로 3~5개 생성합니다.
            4. **본문 HTML 규칙:** 본문 내용은 유효한 HTML이어야 합니다. 본문(body) 필드에는 제목(title) 필드에 들어가는 글의 전체 제목을 절대 중복해서 포함하지 마세요. 모든 소제목은 '<h2>' 또는 '<h3>' 태그로 감싸주세요. 가독성을 위해 p, blockquote, pre, code 태그를 적극적으로 사용해주세요. 코드 블록은 반드시 <pre class="prettyprint linenums"> 태그로 감싸주세요.
            5. **가독성:** 문단과 문단 사이에는 충분한 간격을 두어 읽기 편하게 작성해주세요. 각 문단은 <p> 태그로 명확하게 구분하고, 너무 길지 않게 작성하여 모바일 가독성을 높여주세요.`;
            const editorSystemPrompt = `당신은 'InsureLog'의 유능한 편집자입니다. 사용자가 제공한 초안(draft)과 수정 요청(instruction)을 바탕으로, 글 전체를 수정하고 완성된 결과물을 JSON 형식으로 반환하는 임무를 맡았습니다. 반드시 전체 글의 맥락을 유지하면서 요청사항을 반영해야 합니다. 응답은 반드시 제목(title), 요약(summary), SEO 친화적인 영어 슬러그(slug), 태그 배열(tags), 본문(body) 필드를 포함한 단일 JSON 객체여야 합니다. 본문(body)에는 제목(title) 필드의 내용이 중복으로 포함되지 않도록 해주세요. 원본의 HTML 구조를 최대한 유지하되, 문단 구분을 명확히 하고 각 문단이 너무 길어지지 않도록 조정하여 전체적인 가독성을 향상시켜 주세요.`; 
            
            let systemPrompt, userQuery; 
            if (isInitial) { 
                systemPrompt = { parts: [{ text: systemPromptContent }] };
                userQuery = `주제: "${topic}"`; 
            } else { 
                systemPrompt = { parts: [{ text: editorSystemPrompt }] };
                userQuery = `{"draft": ${JSON.stringify(draft)}, "instruction": "${instruction}"}`; 
            } 
            
            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: systemPrompt, 
                generationConfig: { 
                    responseMimeType: "application/json", 
                    responseSchema: { 
                        type: "OBJECT", 
                        properties: { 
                            "title": { "type": "STRING" }, 
                            "summary": { "type": "STRING" }, 
                            "slug": { "type": "STRING" },
                            "tags": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "body": { "type": "STRING" } 
                        }, 
                        required: ["title", "summary", "slug", "tags", "body"] 
                    } 
                } 
            }; 

            const response = await fetch(proxyUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ type: 'text', payload: payload })
            }); 
            
            if (!response.ok) throw new Error(`Gemini API 오류: ${response.statusText}`); 
            const result = await response.json(); 
            const textContent = result.candidates?.[0]?.content?.parts?.[0]?.text; 
            if (!textContent) throw new Error("Gemini API로부터 유효한 콘텐츠를 받지 못했습니다."); 
            return JSON.parse(textContent); 
        }

        async function generateImage(title) { 
            const proxyUrl = '/api/generate';
            const payload = { 
                instances: [{ 
                    prompt: `A minimalist, flat design, vector-style abstract illustration about "${title}". Featuring a simple faceless human character illustration relevant to the topic. Use a light background (#FFFFFF) with a simple grayscale palette. Clean, modern style. No text.` 
                }], 
                parameters: { "sampleCount": 1 } 
            }; 

            const response = await fetch(proxyUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ type: 'image', payload: payload })
            }); 

            if (!response.ok) throw new Error(`Imagen API 오류: ${response.statusText}`); 
            const result = await response.json(); 
            const base64Data = result.predictions?.[0]?.bytesBase64Encoded; 
            if (!base64Data) throw new Error("Imagen API로부터 유효한 이미지 데이터를 받지 못했습니다."); 
            return base64Data; 
        }
        async function uploadBase64Image(base64Data, title) { if (!base64Data) throw new Error("이미지 데이터가 없습니다."); const imageBlob = base64ToBlob(base64Data); const fileName = `${state.user.id}/${Date.now()}.webp`; const { error } = await supabase.storage.from(IMAGE_BUCKET_NAME).upload(fileName, imageBlob); if (error) throw new Error(`이미지 업로드 실패: ${error.message}`); const { data } = supabase.storage.from(IMAGE_BUCKET_NAME).getPublicUrl(fileName); return data.publicUrl; }

        // =================================================================================
        // --- WORKFLOW & EVENT HANDLERS ---
        // =================================================================================
        async function handleGlobalClick(e, target) { 
            const action = target.dataset.action; 
            if (action === 'route') {
                e.preventDefault();
                navigateTo(target.getAttribute('href'));
                return;
            }

            switch (action) { 
                case 'go-back': 
                    history.back(); 
                    break; 
                case 'show-auth': 
                    showAuthModal(); 
                    break;
                case 'show-search':
                    toggleSearch(true);
                    break;
                case 'close-modal-backdrop': 
                    closeModal(); 
                    break; 
                case 'logout': 
                    handleLogout(); 
                    break; 
                case 'finalize-draft': 
                    handleMoveToEditor(); 
                    break; 
                case 'publish-draft': 
                    handleDirectPublish(); 
                    break;
                case 'go-to-refiner':
                    handleGoToRefiner();
                    break;
                case 'toggle-html':
                    handleToggleHtmlEditor();
                    break;
                case 'copy-link': 
                    const textArea = document.createElement("textarea"); 
                    textArea.value = target.dataset.url; 
                    document.body.appendChild(textArea); 
                    textArea.focus(); 
                    textArea.select(); 
                    try { 
                        document.execCommand('copy'); 
                        showToast('링크가 복사되었습니다!'); 
                    } catch (err) { 
                        showToast('링크 복사에 실패했습니다.', true); 
                    } 
                    document.body.removeChild(textArea); 
                    break; 
                case 'delete-post': 
                    renderModal({ 
                        title: '정말 삭제하시겠습니까?', 
                        content: '연관된 모든 이미지도 함께 영구적으로 삭제됩니다. 이 작업은 되돌릴 수 없습니다.', 
                        confirmText: '삭제', 
                        onConfirm: async () => { 
                            try { 
                                showToast('글과 이미지 삭제를 시작합니다...'); 
                                await deletePostAndAssociatedImages(target.dataset.id); 
                                showToast('글이 완전히 삭제되었습니다.'); 
                                handleRouting(); 
                            } catch (error) { 
                                console.error('Deletion Error:', error); 
                                showToast(`삭제 중 오류 발생: ${error.message}`, true); 
                            } finally { 
                                closeModal(); 
                            } 
                        } 
                    }); 
                    break; 
            } 
        }
        async function handleWriterSubmit() {
            const id = $('#post-id').value;
            const title = $('#title').value;
            const summary = $('#summary').value;
            const tags = $('#tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
            
            const htmlEditor = $('#html-editor');
            const isHtmlVisible = htmlEditor.style.display !== 'none';
            const refined_content = isHtmlVisible ? htmlEditor.value : state.quill.root.innerHTML;
            
            if (!title.trim() || !summary.trim()) {
                showToast('제목과 요약은 필수 항목입니다.', true);
                return;
            }
            $('#submit-btn').disabled = true;

            try {
                let finalSlug = $('#post-slug').value;
                if (!id && !finalSlug) {
                    finalSlug = title.toLowerCase()
                        .trim()
                        .replace(/[^\w\s-]/g, '')
                        .replace(/[\s_-]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                }
                
                const postData = { title, summary, refined_content, author_id: state.user.id, slug: finalSlug, tags };
                const { error } = id 
                    ? await supabase.from('posts').update(postData).eq('id', id)
                    : await supabase.from('posts').insert(postData);

                if (error) throw error;

                clearDraft();
                showToast(id ? '글이 수정되었습니다!' : '글이 생성되었습니다!');
                navigateTo('/dashboard');
            } catch (error) {
                console.error("Publish Error:", error);
                showToast(`발행 실패: ${error.message}`, true);
            } finally {
                $('#submit-btn').disabled = false;
            }
        }
        async function handleAiWriterSubmit() { 
            const topic = $('#ai-topic').value; 
            if (!topic.trim()) { 
                showToast('글 주제를 입력해주세요.', true); 
                return; 
            } 
            const loader = $('.ai-loader'); 
            const button = $('#ai-generate-btn'); 
            loader.style.display = 'block'; 
            button.disabled = true; 
            try { 
                showToast('AI가 글 초안을 작성하고 있습니다...'); 
                const article = await generateText(topic); 
                let imageBase64 = null;
                const generateImageToggle = $('#ai-image-toggle');
                if (generateImageToggle && generateImageToggle.checked) {
                    showToast('AI가 대표 이미지를 생성하고 있습니다...'); 
                    imageBase64 = await generateImage(article.title); 
                }
                state.draftArticle = { ...article, imageBase64 }; 
                saveDraft(state.draftArticle); 
                showToast('초안 생성 완료! 글 다듬기 화면으로 이동합니다.'); 
                navigateTo('/refiner'); 
            } catch (error) { 
                console.error('AI Writer Error:', error); 
                showToast(`오류 발생: ${error.message}`, true); 
            } finally { 
                loader.style.display = 'none'; 
                button.disabled = false; 
            } 
        }
        async function handleRefinerChatSubmit(e) { 
            e.preventDefault(); 
            const input = $('#refiner-input'); 
            const instruction = input.value.trim(); 
            if (!instruction) return; 
            
            const chatHistory = $('#chat-history'); 
            chatHistory.innerHTML += `<div class="chat-message user">${instruction}</div>`; 
            chatHistory.scrollTop = chatHistory.scrollHeight; 
            input.value = ''; 
            input.disabled = true; 
            
            const refinerLoader = $('#refiner-loader');
            refinerLoader.style.display = 'flex';

            try { 
                const currentDraft = { title: state.draftArticle.title, summary: state.draftArticle.summary, body: state.draftArticle.body, slug: state.draftArticle.slug, tags: state.draftArticle.tags }; 
                const updatedArticle = await generateText(null, false, currentDraft, instruction); 
                state.draftArticle = { ...state.draftArticle, ...updatedArticle };
                saveDraft(state.draftArticle); 
                renderRefinerPreview(); 
            } catch(error) { 
                console.error("Refiner Error:", error); 
                showToast(`수정 중 오류 발생: ${error.message}`, true); 
                chatHistory.innerHTML += `<div class="chat-message system">오류가 발생했습니다.</div>`;
            } finally { 
                input.disabled = false;
                refinerLoader.style.display = 'none';
            } 
        }
        function handleToggleHtmlEditor() {
            const editorDiv = $('#editor');
            const htmlEditor = $('#html-editor');
            const toggleBtn = document.querySelector('[data-action="toggle-html"]');

            if (!editorDiv || !htmlEditor || !toggleBtn) return;

            const isHtmlVisible = htmlEditor.style.display !== 'none';

            if (isHtmlVisible) {
                // Switch from HTML to Quill
                state.quill.root.innerHTML = htmlEditor.value;
                htmlEditor.style.display = 'none';
                document.querySelector('.ql-toolbar').style.display = 'block';
                editorDiv.style.display = 'block';
                toggleBtn.textContent = 'HTML 보기';
            } else {
                // Switch from Quill to HTML
                htmlEditor.value = state.quill.root.innerHTML;
                editorDiv.style.display = 'none';
                document.querySelector('.ql-toolbar').style.display = 'none';
                htmlEditor.style.display = 'block';
                toggleBtn.textContent = '에디터 보기';
            }
        }
        async function handleGoToRefiner() {
            const title = $('#title').value.trim();
            const summary = $('#summary').value.trim();
            const tags = $('#tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
            const postId = $('#post-id').value || null;
            const postSlug = $('#post-slug').value || null;
            
            const htmlEditor = $('#html-editor');
            const isHtmlVisible = htmlEditor.style.display !== 'none';
            const body = isHtmlVisible ? htmlEditor.value : state.quill.root.innerHTML;

            if (!title) {
                showToast('AI로 다듬기 위해서는 제목이 필요합니다.', true);
                return;
            }

            const button = document.querySelector('[data-action="go-to-refiner"]');
            button.disabled = true;
            button.innerHTML = '<div class="ai-loader" style="display: block; margin: 0 auto;"></div>';

            try {
                showToast('AI 글 다듬기를 위해 초안을 준비 중입니다...');
                
                const slug = postSlug || (await generateText(title, true)).slug;
                
                let imageBase64 = null;
                const generateImageToggle = $('#writer-image-toggle');
                if (generateImageToggle && generateImageToggle.checked) {
                    showToast('AI가 대표 이미지를 생성하고 있습니다...'); 
                    imageBase64 = await generateImage(title);
                }
                
                state.draftArticle = { postId, title, summary, body, imageBase64, slug, tags };
                saveDraft(state.draftArticle);
                
                showToast('준비 완료! 글 다듬기 화면으로 이동합니다.');
                navigateTo('/refiner');

            } catch (error) {
                console.error('Go to Refiner Error:', error);
                showToast(`AI 글 다듬기 준비 중 오류 발생: ${error.message}`, true);
            } finally {
                button.disabled = false;
                button.textContent = 'AI로 다듬기';
            }
        }
        async function handleRegenerateImage() { const btn = $('#regenerate-image-btn'); btn.disabled = true; btn.innerHTML = '<div class="image-loader" style="display: block;"></div>'; try { showToast('새 이미지를 생성하고 있습니다...'); const newImageBase64 = await generateImage(state.draftArticle.title); state.draftArticle.imageBase64 = newImageBase64; saveDraft(state.draftArticle); renderRefinerPreview(); showToast('이미지가 교체되었습니다.'); } catch (error) { console.error("Image Regeneration Error:", error); showToast(`이미지 재생성 실패: ${error.message}`, true); } finally { btn.disabled = false; btn.textContent = '이미지 재생성'; } }
        
        async function handleDirectPublish() {
            if (!state.draftArticle) return showToast("발행할 초안이 없습니다.", true);
            showToast("글 발행을 시작합니다...");
            try {
                const { postId, imageBase64, title, summary, slug, tags, body } = state.draftArticle;
                let refined_content = body;

                if (imageBase64) {
                    showToast("대표 이미지를 업로드하고 있습니다...");
                    const imageUrl = await uploadBase64Image(imageBase64, title);
                    const imageHtml = `<img src="${imageUrl}" alt="${title}" loading="lazy">`;
                    refined_content = imageHtml + body;
                }
                
                const postData = { title, summary, slug, tags, refined_content, author_id: state.user.id };

                const { error } = postId
                    ? await supabase.from('posts').update(postData).eq('id', postId)
                    : await supabase.from('posts').insert(postData);

                if (error) throw error;

                clearDraft();
                showToast(postId ? "글이 성공적으로 수정되었습니다!" : "글이 성공적으로 발행되었습니다!");
                navigateTo('/dashboard');
            } catch (error) {
                console.error("Direct publish error:", error);
                showToast(`발행 실패: ${error.message}`, true);
            }
        }

        async function handleMoveToEditor() { 
            if (!state.draftArticle) return showToast("편집할 초안이 없습니다.", true); 
            const imageHtml = state.draftArticle.imageBase64 ? `<img src="data:image/webp;base64,${state.draftArticle.imageBase64}" alt="${state.draftArticle.title}" loading="lazy">` : '';
            const finalDraftForEditor = { ...state.draftArticle, imageHtml }; 
            switchView('view-writer', (el) => renderWriterView(el, null, finalDraftForEditor)); 
        }
        async function deletePostAndAssociatedImages(postId) { const { data: post, error: fetchError } = await supabase.from('posts').select('refined_content').eq('id', postId).single(); if (fetchError) throw new Error(`삭제할 글을 찾지 못했습니다: ${fetchError.message}`); const content = post.refined_content || ''; const imageUrls = content.match(/https:\/\/[^"]+\/storage\/v1\/object\/public\/thought-images\/[^"]+/g) || []; const imagePaths = imageUrls.map(url => url.split('/thought-images/')[1] || '').filter(Boolean); if (imagePaths.length > 0) { const { error: storageError } = await supabase.storage.from(IMAGE_BUCKET_NAME).remove(imagePaths); if (storageError) throw new Error(`스토리지 이미지 삭제 실패: ${storageError.message}`); } const { error: dbError } = await supabase.from('posts').delete().eq('id', postId); if (dbError) throw new Error(`데이터베이스 글 삭제 실패: ${dbError.message}`); }
        
        // =================================================================================
        // --- SEARCH ---
        // =================================================================================
        // NOTE: This search functionality relies on a Supabase RPC (Remote Procedure Call) function
        // called 'search_posts' that must be created in your Supabase database.
        function toggleSearch(show) {
            const overlay = $('#search-overlay');
            if (show) {
                overlay.style.display = 'flex';
                anime({ targets: overlay, opacity: [0, 1], duration: 300, easing: 'easeOutCubic' });
                $('#search-input').focus();
            } else {
                anime({ 
                    targets: overlay, 
                    opacity: [1, 0], 
                    duration: 300, 
                    easing: 'easeInCubic',
                    complete: () => overlay.style.display = 'none' 
                });
            }
        }
        
        async function performSearch(query) {
            const resultsContainer = $('#search-results');
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }
            resultsContainer.innerHTML = '<div class="loader-spinner mx-auto"></div>';
            
            try {
                const { data, error } = await supabase.rpc('search_posts', { search_term: query });
                
                if (error) throw error;

                if (data.length === 0) {
                    resultsContainer.innerHTML = `<p class="text-center text-gray-500">검색 결과가 없습니다.</p>`;
                } else {
                    const resultsHtml = data.map(post => `
                        <a href="/post/${post.slug}" data-action="route" class="block p-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">
                            <h3 class="font-semibold text-gray-800">${post.title}</h3>
                            <p class="text-sm text-gray-600 mt-1">${post.summary}</p>
                        </a>
                    `).join('');
                    resultsContainer.innerHTML = resultsHtml;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `<p class="text-center text-red-500">검색 중 오류가 발생했습니다.</p>`;
            }
        }

        // =================================================================================
        // --- AI REFINER WORKFLOW & DRAFT MANAGEMENT ---
        // =================================================================================
        function renderRefinerView(container) {
            $('#app-container').className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8';
            if (!state.draftArticle) {
                showToast("초안 정보가 없습니다. 대시보드에서 다시 시작해주세요.", true);
                navigateTo('/dashboard');
                return;
            }
            container.innerHTML = `<div class="py-8"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><div><h1 class="text-2xl font-bold font-heading">AI 글 다듬기</h1><p class="text-gray-500 text-base mt-1">AI 초안을 확인하고, 채팅으로 수정을 요청하여 글을 완성하세요.</p></div><div class="flex gap-2 w-full sm:w-auto"><button class="btn w-full" data-action="finalize-draft">수동 편집</button><button class="btn btn-primary w-full" data-action="publish-draft">발행하기</button></div></div><div class="refiner-grid"><div id="refiner-preview-wrapper"><div class="flex justify-between items-center mb-4"><h2 class="font-bold text-base">미리보기</h2><button id="regenerate-image-btn" class="btn text-xs">이미지 재생성</button></div><div id="refiner-preview-container"></div></div><div id="refiner-chat-container"><div id="chat-history"><div class="chat-message ai">초안이 완성되었습니다. 어떤 부분을 수정할까요?</div></div><form id="refiner-chat-form"><input type="text" id="refiner-input" class="form-input" placeholder="수정 요청사항을 입력하세요..."><button type="submit" class="btn btn-primary">전송</button></form></div></div></div>`;
            renderRefinerPreview();
            $('#refiner-chat-form').addEventListener('submit', handleRefinerChatSubmit);
            $('#regenerate-image-btn').addEventListener('click', handleRegenerateImage);
        }

        function renderRefinerPreview() {
            const previewContainer = $('#refiner-preview-container');
            if (!previewContainer || !state.draftArticle) return;
            const { title, summary, body, imageBase64 } = state.draftArticle;
            const imageHtml = imageBase64 ? `<img src="data:image/webp;base64,${imageBase64}" alt="${title}" loading="lazy">` : '';
            previewContainer.innerHTML = `<div class="prose-custom max-w-none"><h1>${title}</h1><p class="text-gray-500 italic">${summary}</p>${imageHtml}${body}</div>`;
        }
        function saveDraft(draft) { localStorage.setItem(DRAFT_STORAGE_KEY, JSON.stringify(draft)); }
        function loadDraft() { const draftJson = localStorage.getItem(DRAFT_STORAGE_KEY); return draftJson ? JSON.parse(draftJson) : null; }
        function clearDraft() { localStorage.removeItem(DRAFT_STORAGE_KEY); state.draftArticle = null; }
        function checkForUnsavedDraft() { const savedDraft = loadDraft(); if (savedDraft) { renderModal({ title: '미완성 초안 발견', content: '작업을 중단했던 AI 글 초안이 있습니다. 이어서 작성하시겠습니까?', confirmText: '이어쓰기', onConfirm: () => { state.draftArticle = savedDraft; navigateTo('/refiner'); closeModal(); }, cancelText: '삭제', onCancel: () => { clearDraft(); closeModal(); } }); } }

        // =================================================================================
        // --- INITIALIZATION ---
        // =================================================================================
        function initializeApp() {
            window.addEventListener('popstate', handleRouting);
            document.addEventListener('click', (e) => { 
                const target = e.target.closest('[data-action]'); 
                if (target) { 
                    handleGlobalClick(e, target); 
                } 
            });
            document.addEventListener('submit', (e) => { const formId = e.target.id; if (formId === 'writer-form') { e.preventDefault(); handleWriterSubmit(); } else if (['ai-writer-form', 'auth-form', 'refiner-chat-form'].includes(formId)) { e.preventDefault(); } });
            
            // Search listeners
            const searchInput = $('#search-input');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(searchInput.value);
                }, 300); // Debounce search
            });
            $('#close-search-btn').addEventListener('click', () => toggleSearch(false));

            supabase.auth.onAuthStateChange(async (_event, session) => {
                const userJustChanged = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                
                if (userJustChanged) {
                    renderNav();
                }

                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav(); // Render nav on initial load
                    const loader = $('#app-loader');
                    anime({ targets: loader, opacity: 0, duration: 500, easing: 'easeOutCubic', complete: () => loader.style.display = 'none' });
                    handleRouting();
                    if (state.user) checkForUnsavedDraft();
                } else if (userJustChanged) {
                    handleRouting();
                }
            });
        }
        
        initializeApp();
    </script>
</body>
</html>

