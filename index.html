<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <meta name="nonce" content="r4nd0m">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    
    <!-- CSP (Content Security Policy) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://pagead2.googlesyndication.com https://www.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com https://*.adtrafficquality.google; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google https://*.gemius.pl https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.adtrafficquality.google https://*.google.com https://*.googlesyndication.com; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://blogaipandoci.vercel.app/og-image.svg">
    <meta property="og:site_name" content="InsureLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://blogaipandoci.vercel.app/og-image.svg">
    
    <!-- Scripts & Stylesheets -->
    <!-- 스타일 유틸리티(style.css)는 유지하고, 모듈 CSS는 개별 링크로 병렬 로드 -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <!-- 비임계 CSS는 preload 후 onload 적용으로 렌더 차단 최소화 -->
    <link rel="preload" as="style" href="/css/buttons.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" as="style" href="/css/forms.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" as="style" href="/css/modal.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" as="style" href="/css/toast.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" as="style" href="/css/loader.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/skeleton.css">
    <link rel="preload" as="style" href="/css/error.css" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/main.css">
    <!-- 코드 하이라이트 CSS는 초기 렌더 후 지연 로드하여 차단을 줄입니다 -->
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" crossorigin onload="this.onload=null;this.rel='stylesheet'">

    <!-- Global Config: Supabase URL/KEYs injected from user-provided values -->
    <script nonce="r4nd0m">
        window.Config = window.Config || {};
        // Supabase 프로젝트 URL
        window.Config.SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        // 공개용(클라이언트) anon 키
        window.Config.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        // 프로덕션 사이트 URL (매직링크 리디렉션 기준)
        window.Config.SITE_URL = 'https://blogaipandoci.vercel.app';
        // Provide legacy global identifier if any script refers directly to Config
        window.Config = window.Config;
    </script>

    <!-- Fonts -->
    <!-- 외부 도메인 프리커넥트/프리페치는 리소스 절약을 위해 제거 -->
    <!-- 폰트 스타일시트는 초기 페인트 후 비동기 로드로 전환 -->

    <!-- Google AdSense (프로덕션 환경에서만 로드) -->
</head>
<body class="antialiased">
    <!-- 앱 로더 -->
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center" hidden>
        <div class="loader-spinner"></div>
    </div>
    
    <!-- 헤더 (네비게이션) -->
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-1 sm:p-2 bg-white/80 backdrop-blur-sm"></header>
    
    <!-- 메인 콘텐츠 (뷰가 렌더링되는 곳) -->
    <main id="app-container" class="w-full">
    <div id="view-library" class="app-view"></div>
    <div id="view-post" class="app-view"></div>
    <div id="view-dashboard" class="app-view"></div>
    <div id="view-writer" class="app-view"></div>
    <div id="view-archives" class="app-view"></div>
    </main>

    <!-- 푸터 -->
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>

    <!-- 오프라인 배너 -->
    <style>
      .offline-banner{position:fixed;left:50%;transform:translateX(-50%);top:56px;z-index:50;background:#111;color:#fff;padding:8px 12px;border-radius:9999px;box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:12px;line-height:1;display:flex;align-items:center;gap:8px}
      .offline-banner .dot{width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block}
    </style>
    <div id="offline-banner" class="offline-banner" hidden>
      <span class="dot" aria-hidden="true"></span>
      <span>오프라인 상태입니다. 캐시로 표시 중</span>
    </div>

    <!-- 모달 및 토스트 컨테이너 -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3" aria-live="polite" aria-atomic="true"></div>
    
    <!-- [APP SCRIPT] -->
    <!-- Supabase ES 모듈 임포트 (다중 CDN 폴백) -->
    <script type="module" nonce="r4nd0m">
        // 네트워크 성능: 필요 시점에만 빠르게 연결 준비 (Just-In-Time preconnect)
        function addPreconnect(origin) {
            try {
                if (!origin) return;
                const u = new URL(origin, window.location.origin).origin;
                const existed = document.querySelector(`link[rel="preconnect"][href="${u}"]`);
                if (existed) return;
                const l = document.createElement('link');
                l.rel = 'preconnect';
                l.href = u;
                l.crossOrigin = 'anonymous';
                document.head.appendChild(l);
            } catch { /* noop */ }
        }
        // 간단한 Supabase 이미지 최적화 URL 생성 유틸 (public URL 대상)
        function createOptimizedThumb(url) {
            try {
                const u = new URL(url, window.location.origin);
                if (!/supabase\.co\/.+\/object\/public\//.test(u.href)) return url;
                const params = new URLSearchParams({ width: '160', height: '160', resize: 'cover', format: 'webp', quality: '80' });
                const q = params.toString();
                return u.search && u.search.length > 1 ? `${u.href}&${q}` : `${u.href}?${q}`;
            } catch { return url; }
        }

        // [Prefetch] 초기 LCP 개선을 위해 Supabase REST로 최근 글을 즉시 프리패치합니다.
        try {
            window.__homePrefetchData = window.__homePrefetchData || null;
            (async () => {
                const base = window.Config?.SUPABASE_URL || '';
                const key = window.Config?.SUPABASE_ANON_KEY || '';
                const table = (window.Config && window.Config.DB_TABLE_NAME) || 'posts';
                if (!base || !key) return;
                // Supabase REST 연결을 미리 준비해 초기 응답 지연을 줄입니다.
                try { addPreconnect(new URL(base).origin); } catch { /* noop */ }
                const url = `${base.replace(/\/$/, '')}/rest/v1/${table}`
                    + `?select=id,title,summary,slug,category,thumbnail_url,created_at,status`
                    + `&status=eq.published&order=created_at.desc&limit=8`;
                const res = await fetch(url, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Accept': 'application/json'
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (Array.isArray(data) && data.length > 0) {
                        window.__homePrefetchData = data;
                        // 첫/두 번째 썸네일을 네트워크 상태에 따라 조건부 preload하여 LCP 개선
                        try {
                            const conn = navigator.connection || {};
                            const isSlow = !!conn.saveData || /(^|[^a-z])(2g|3g)/.test(String(conn.effectiveType || ''));
                            const preloadCount = isSlow ? 1 : 2;
                            // LCP 후보 이미지의 도메인에 대해 JIT preconnect로 핸드셰이크를 앞당깁니다.
                            try {
                                const firstSrc = data[0]?.thumbnail_url ? createOptimizedThumb(String(data[0].thumbnail_url)) : '';
                                if (firstSrc) addPreconnect(new URL(firstSrc).origin);
                            } catch { /* noop */ }
                            for (let i = 0; i < Math.min(preloadCount, data.length); i++) {
                                const src = data[i]?.thumbnail_url ? createOptimizedThumb(String(data[i].thumbnail_url)) : '';
                                if (!src) continue;
                                const pl = document.createElement('link');
                                pl.rel = 'preload';
                                pl.as = 'image';
                                pl.href = src;
                                if (i === 0) pl.fetchPriority = 'high';
                                document.head.appendChild(pl);
                            }
                        } catch (_) { /* noop */ }
                    }
                }
            })().catch(() => {});
            // 네트워크 상태가 느리거나 데이터 절약 모드인 경우 애니메이션/데이터 비용을 줄입니다.
            try {
              const conn = navigator.connection || {};
              const saveData = !!conn.saveData;
              const et = String(conn.effectiveType || '');
              const isSlow = saveData || /(^|[^a-z])(2g|3g)/.test(et);
              if (isSlow) document.documentElement.classList.add('reduced-data');
            } catch (_) { /* noop */ }
        } catch (_) { /* noop */ }
        // Google Fonts 비동기 로더 제거: 네트워크 리소스 절약
        // 온라인/오프라인 상태 감지 및 배너 표시
        try {
            const banner = document.getElementById('offline-banner');
            const setState = () => {
                const online = navigator.onLine;
                if (!banner) return;
                if (online) banner.setAttribute('hidden',''); else banner.removeAttribute('hidden');
            };
            window.addEventListener('online', setState);
            window.addEventListener('offline', setState);
            setState();
        } catch (_) { /* noop */ }
        async function loadSupabaseModule() {
            const sources = [
                'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm',
                'https://unpkg.com/@supabase/supabase-js@2.45.5/+esm'
            ];
            for (const src of sources) {
                try {
                    // 모듈 임포트 직전에 해당 CDN으로 preconnect하여 로드 지연을 줄입니다.
                    try { addPreconnect(new URL(src).origin); } catch { /* noop */ }
                    const mod = await import(src);
                    console.log('Supabase loaded from:', src);
                    return mod;
                } catch (e) {
                    console.warn('Supabase import failed from', src, e);
                }
            }
            throw new Error('Supabase import failed from all sources');
        }

        // Supabase ES 모듈은 초기 페인트 이후 유휴 시간에 로드하여 초기 차단을 줄입니다.
        try {
            const lazyLoadSupabase = () => (async () => {
                try {
                    const { createClient } = await loadSupabaseModule();
                    window.supabase = { createClient };
                    console.log('Supabase ready (lazy)');
                } catch (e) {
                    console.warn('Supabase lazy load failed:', e);
                }
            })();
            if ('requestIdleCallback' in window) {
                requestIdleCallback(lazyLoadSupabase);
            } else {
                setTimeout(lazyLoadSupabase, 1200);
            }
        } catch (_) { /* noop */ }
        
        // 개발 환경에서는 Google AdSense 로드를 건너뜁니다 (403 및 Quirks Mode 회피)
        // 광고 스크립트는 프로덕션 도메인(HTTPS)에서만 로드
        const isProdHost = window.location.protocol === 'https:'
            && ['blogaipandoci.vercel.app'].includes(window.location.hostname);
        const adsEnabled = isProdHost && (window.Config?.ADS_ENABLED !== false);
        if (adsEnabled) {
            const loadAdsScript = () => {
                if (window.__adsScriptLoaded) return;
                // 필요 시점에만 프리커넥트 추가
                const addPreconnect = (href) => {
                    if (document.querySelector(`link[rel=preconnect][href="${href}"]`)) return;
                    const l = document.createElement('link');
                    l.rel = 'preconnect';
                    l.href = href;
                    l.crossOrigin = 'anonymous';
                    document.head.appendChild(l);
                };
                addPreconnect('https://pagead2.googlesyndication.com');
                addPreconnect('https://googleads.g.doubleclick.net');

                const adsScript = document.createElement('script');
                adsScript.async = true;
                adsScript.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112';
                adsScript.setAttribute('crossorigin', 'anonymous');
                adsScript.nonce = 'r4nd0m';
                adsScript.dataset.loaded = '1';
                window.__adsScriptLoaded = true;
                document.head.appendChild(adsScript);
            };
            // 실제 광고 슬롯이 존재하고, 가시 영역에 들어올 때만 로드
            const slots = () => Array.from(document.querySelectorAll('.adsbygoogle'));
            const beginGate = () => {
                const els = slots();
                if (!els.length || window.__adsScriptLoaded) return; // 슬롯이 없으면 스크립트 로드 생략
                if ('IntersectionObserver' in window) {
                    const io = new IntersectionObserver((entries, obs) => {
                        for (const e of entries) {
                            if (e.isIntersecting) {
                                obs.disconnect();
                                loadAdsScript();
                                break;
                            }
                        }
                    }, { rootMargin: '0px' }); // 가시 영역에 들어올 때만 로드
                    els.forEach(el => io.observe(el));
                } else {
                    // 폴백: 사용자 상호작용 후 로드
                    window.addEventListener('scroll', () => {
                        loadAdsScript();
                    }, { once: true, passive: true });
                }
            };
            // 슬롯이 나중에 동적으로 추가되는 경우를 대비해 감시
            const observeSlotsLater = () => {
                if (!('MutationObserver' in window)) return;
                const mo = new MutationObserver(() => {
                    if (window.__adsScriptLoaded) { mo.disconnect(); return; }
                    beginGate();
                });
                mo.observe(document.body, { childList: true, subtree: true });
            };
            const startGate = () => {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => { beginGate(); observeSlotsLater(); });
                } else {
                    beginGate();
                    observeSlotsLater();
                }
            };
            if (document.fonts && typeof document.fonts.ready?.then === 'function') {
                document.fonts.ready.then(startGate);
            } else {
                startGate();
            }
        } else {
            console.info('[Ads] 비프로덕션 호스트에서 광고 로드를 건너뜁니다:', window.location.hostname);
        }

        // 분리된 JavaScript 모듈들 로드
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.nonce = 'r4nd0m';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
        
        // 모듈들을 순차적으로 로드 (의존성 보장)
        (async () => {
            try {
                // Config와 DOM 유틸을 먼저 로드해 기본 전역을 준비
                await loadScript('/js/config.js');
                await loadScript('/js/dom-utils.js');
                // 초기 화면 구성 요소를 빠르게 파싱
                await loadScript('/js/ui-components.js');
                await loadScript('/js/blog-app.js');
                // 레이아웃 매니저 및 부가 모듈은 초기 페인트 이후 유휴 시간에 로드
                const deferScript = (src) => {
                  if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => loadScript(src));
                  } else {
                    setTimeout(() => loadScript(src), 1000);
                  }
                };
                deferScript('/js/layout-manager.js');
                deferScript('/js/script-loader.js');
                deferScript('/js/perf-monitor.js');
                
                const boot = () => {
                    new BlogApp();
                    // 레이아웃 매니저가 나중에 로드되는 경우 초기화 예약
                    const tryInitLayout = () => { if (window.LayoutManager) window.LayoutManager.init(); };
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(tryInitLayout);
                    } else {
                        setTimeout(tryInitLayout, 1200);
                    }
                };
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', boot);
                } else {
                    boot();
                }
            } catch (error) {
                console.error('모듈 로드 실패:', error);
                const loaderEl = document.getElementById('app-loader');
                if (loaderEl) loaderEl.innerHTML = '<div class="text-red-600">앱 로드에 실패했습니다.</div>';
            }
        })();
    </script>
</body>
</html>