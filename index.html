<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    
    <!-- Scripts & Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-main: #121212;
            --bg-content: #1E1E1E;
            --border-color: #2D2D2D;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --text-tertiary: #6B6B6B;
            --accent: #D946EF;
            --font-body: 'Noto Sans KR', sans-serif;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            font-size: 17px;
            line-height: 1.8;
        }
        main#app-container { flex-grow: 1; }
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }

        /* --- Typography & Prose --- */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); margin-top: 2em; margin-bottom: 1em; }
        .prose-custom h1 { font-size: 1.8rem !important; font-weight: 700 !important; } /* Controlled size */
        .prose-custom h2 { font-size: 1.5rem; font-weight: 700; }
        .prose-custom h3 { font-size: 1.25rem; font-weight: 700; }
        .prose-custom p { margin-bottom: 1.5em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: var(--bg-main); border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; color: var(--text-primary); background-color: var(--bg-content); border-radius: 0 8px 8px 0; }

        /* --- REVISED Post Header Style --- */
        .post-header-new { 
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem; /* Space between elements */
            margin-bottom: 3rem; 
        }
        .post-meta-box {
            display: inline-block;
            background-color: var(--text-primary);
            color: var(--bg-main);
            padding: 0.75rem 1.25rem;
            border-radius: 1rem; /* More rounded */
            font-weight: 700;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        .category-color-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        /* --- Post Card Style --- */
        .post-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .post-card { background-color: var(--bg-content); border-radius: 1rem; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .post-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .post-card-thumbnail-wrapper { position: relative; width: 100%; padding-top: 56.25%; background-color: #333; }
        .post-card-thumbnail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .post-card-content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
        .post-card-title { color: var(--text-primary); font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .post-card-summary { color: var(--text-secondary); flex-grow: 1; margin-bottom: 1rem; }
        .post-card-date { font-size: 0.8rem; color: var(--text-tertiary); margin-top: auto; }
        
        /* --- Recommended Posts --- */
        .recommended-posts-section { margin-top: 5rem; padding-top: 2rem; border-top: 1px solid var(--border-color); }
        .recommended-posts-title { font-size: 1.75rem; font-weight: 900; color: var(--text-primary); margin-bottom: 2rem; }
        .recommended-post-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 0.75rem; transition: background-color 0.2s ease; }
        .recommended-post-item:hover { background-color: var(--bg-content); }
        .recommended-post-thumbnail { width: 100px; height: 65px; object-fit: cover; border-radius: 0.5rem; flex-shrink: 0; background-color: #2A2A2A; }
        .recommended-post-info h4 { color: var(--text-primary); font-weight: 700; margin: 0; }
        .recommended-post-info span { color: var(--text-tertiary); font-size: 0.8rem; }
        
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app-loader" class="fixed inset-0 z-50 bg-bg-main flex items-center justify-center"><div class="loader-spinner"></div></div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    <main id="app-container" class="w-full max-w-7xl mx-auto px-4">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view max-w-5xl mx-auto"></div>
        <div id="view-writer" class="app-view max-w-4xl mx-auto"></div>
    </main>
    <footer class="text-center py-8 px-4 border-t border-gray-800/50 mt-24">
        <p class="text-sm text-gray-600">
            © 2024 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.com/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-white transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- App State and Config ---
        const SITE_URL = 'https://blogaipandoci.vercel.app';
        const SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        const IMAGE_BUCKET_NAME = 'thought-images';
        const POSTS_PER_PAGE = 9;
        const CATEGORIES = ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"];
        const CATEGORY_COLORS = {
            "AI 트렌드": "#FF6B6B", "보험 산업": "#4ECDC4", "핀테크": "#45B7D1",
            "데이터 과학": "#F7B801", "머신러닝": "#F9A620", "개발 일지": "#A7D2CB",
            "규제와 법률": "#7A65A4", "해외 동향": "#3D7B9B", "고객 경험": "#FFA07A", "기타": "#CFCFCF"
        };
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const state = { user: null, quill: null, isAuthReady: false, currentCategory: '전체' };
        const $ = (selector) => document.querySelector(selector);
        
        // --- Core App Logic ---
        function navigateTo(path, replace = false) {
            const newPath = path || '/';
            if (window.location.pathname + window.location.search !== newPath) {
                history[replace ? 'replaceState' : 'pushState']({ path: newPath }, '', newPath);
            }
            handleRouting();
        }

        async function switchView(viewId, callback) {
            const currentView = $('.app-view.active');
            if (currentView) {
                await anime({ targets: currentView, opacity: 0, duration: 200, easing: 'easeInQuad' }).finished;
                currentView.classList.remove('active');
                currentView.innerHTML = '';
            }
            const nextView = $(`#${viewId}`);
            if (nextView) {
                nextView.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                nextView.classList.add('active');
                anime({ targets: nextView, opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' });
                try {
                    await callback(nextView);
                } catch (error) {
                    console.error(`Error rendering view ${viewId}:`, error);
                    nextView.innerHTML = `<p class="text-center text-red-400 py-20">페이지 렌더링 중 오류 발생</p>`;
                }
                window.scrollTo(0, 0);
            }
        }
        
        function handleRouting() {
            if (!state.isAuthReady) return;
            const path = window.location.pathname;
            const params = new URLSearchParams(window.location.search);
            const [_, route = 'library', param = null] = path.split('/');
            
            if (!state.user && ['dashboard', 'writer'].includes(route)) {
                showToast('이 기능은 로그인이 필요합니다.', true);
                navigateTo('/');
                return;
            }
            
            switch (route) {
                case 'post': switchView('view-post', el => renderPostView(el, param)); break;
                case 'dashboard': switchView('view-dashboard', el => renderDashboardView(el)); break;
                case 'writer': switchView('view-writer', el => renderWriterView(el, param)); break;
                default: 
                    const page = parseInt(params.get('page'), 10) || 1;
                    state.currentCategory = params.get('category') || '전체';
                    switchView('view-library', el => renderLibraryView(el, page, state.currentCategory));
            }
        }
        
        // --- View Rendering ---
        function renderNav() { /* ... Same as previous correct version ... */ }
        
        async function renderLibraryView(container, page, category) {
            updateMetaTags();
            const categoryButtons = ['전체', ...CATEGORIES].map(cat => 
                `<button data-action="filter-category" data-category="${cat}" class="px-4 py-2 text-sm font-medium rounded-full transition ${cat === category ? 'bg-accent text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">${cat}</button>`
            ).join('');
            
            container.innerHTML = `
                <div class="py-12 sm:py-16">
                    <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-white tracking-tighter">InsureLog</h1><p class="text-lg text-gray-400">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                    <div class="flex items-center justify-center gap-3 mb-12 flex-wrap">${categoryButtons}</div>
                    <div id="post-list-container"></div>
                </div>`;
            
            await renderPostList(page, category);
        }

        async function renderPostList(page, category) {
            const listContainer = $('#post-list-container');
            listContainer.innerHTML = `<div class="min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;

            const { from, to } = { from: (page - 1) * POSTS_PER_PAGE, to: page * POSTS_PER_PAGE - 1 };
            let query = supabase.from('posts').select('id, title, slug, summary, created_at, thumbnail_url', { count: 'exact' });
            if (category !== '전체') query = query.eq('category', category);
            query = query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);

            const { data: posts, error, count: totalPosts } = await query;

            if (error) { listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글 목록 로딩 실패.</p>`; return; }

            const postsHtml = posts.length > 0
                ? `<div class="post-card-grid">${posts.map(post => `
                    <a href="/post/${post.slug}" data-route class="post-card">
                        ${post.thumbnail_url ? `<div class="post-card-thumbnail-wrapper"><img src="${post.thumbnail_url}" alt="${post.title}" class="post-card-thumbnail"></div>` : ''}
                        <div class="post-card-content">
                            <h3 class="post-card-title">${post.title}</h3>
                            <p class="post-card-summary">${post.summary || ''}</p>
                            <time class="post-card-date">${new Date(post.created_at).toLocaleDateString('ko-KR')}</time>
                        </div>
                    </a>`).join('')}</div>`
                : `<div class="text-center py-20 text-gray-400"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${state.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-accent text-white hover:bg-accent-hover">첫 글 작성하기</a>` : ''}</div>`;
            
            listContainer.innerHTML = `${postsHtml}${renderPaginationControls(page, totalPosts, '/', { category })}`;
        }
        
        async function renderPostView(container, slug) { 
            if (!slug) { navigateTo('/'); return; } 
            
            const { data: post, error } = await supabase.from('posts').select('*').eq('slug', slug).single(); 
            if (error || !post) { showToast('글을 찾을 수 없습니다.', true); navigateTo('/'); return; } 

            updateMetaTags(post); 
            const editButtonHtml = (state.user?.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-sm font-bold rounded-full transition bg-white/10 text-white hover:bg-white/20">수정</a>` : ''; 
            const categoryColor = CATEGORY_COLORS[post.category] || '#CFCFCF';

            container.innerHTML = `
                <div class="py-12 sm:py-16 max-w-4xl mx-auto">
                    <div class="flex justify-end items-center mb-4">${editButtonHtml}</div>
                    <article class="prose-custom">
                        <header class="post-header-new">
                            <div class="post-meta-box">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div>
                            <h1 class="post-meta-box">${post.title}</h1>
                            <div class="post-meta-box">
                                <span class="category-color-dot" style="background-color: ${categoryColor};"></span>
                                ${post.category || '미분류'}
                            </div>
                        </header>
                        <div id="post-content" class="mt-12">${post.refined_content || ''}</div>
                    </article>
                    <div id="post-footer"></div>
                </div>`;
            
            document.querySelectorAll('#post-content pre code').forEach(el => hljs.highlightElement(el));
            
            const footerContainer = $('#post-footer');
            const recommendedHtml = await renderRecommendedPostsAndAds(post);
            const nextPrevLinksHtml = await renderNextPrevLinks(post);
            footerContainer.innerHTML = recommendedHtml + nextPrevLinksHtml;

            // Activate ads
            footerContainer.querySelectorAll('.adsbygoogle').forEach(ad => {
                try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } 
                catch (e) { console.error("Adsense push error:", e); }
            });
        }
        
        async function renderDashboardView(container) {
            updateMetaTags({ title: '대시보드' });
            container.innerHTML = `<div class="py-12"><div class="flex justify-between items-center mb-10"><h1 class="text-4xl font-black text-white">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-accent text-white">새 글 작성</a></div><div id="dashboard-post-list"></div></div>`;
            const listContainer = $('#dashboard-post-list');
            listContainer.innerHTML = `<div class="min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;

            if (!state.user) return;
            const { data: posts, error } = await supabase.from('posts').select('id, title, slug, status, created_at').eq('author_id', state.user.id).order('created_at', { ascending: false });
            
            if (error) { listContainer.innerHTML = '<p class="text-center text-gray-400">글 목록 로딩 실패.</p>'; return; }
            if (posts.length === 0) { listContainer.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>'; return; }
            
            listContainer.innerHTML = `<ul class="w-full space-y-2">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-800/50"><div class="flex items-center gap-4"><span class="px-3 py-1 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-accent' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/writer/${post.slug}" data-route class="font-bold text-white hover:text-accent">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-white/10 hover:bg-white/20">수정</a></li>`).join('')}</ul>`;
        }

        async function renderWriterView(container, slug) {
            updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', category: CATEGORIES[0] };
            
            if (slug) {
                const { data, error } = await supabase.from('posts').select('*').eq('slug', slug).eq('author_id', state.user.id).single();
                if (error || !data) { showToast('글을 찾을 수 없거나 수정 권한이 없습니다.', true); navigateTo('/dashboard'); return; }
                post = data;
            }

            // You can add logic for loading saved drafts from localStorage here if needed

            const categoryOptions = CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
            
            container.innerHTML = `
                <div class="py-12"><form id="writer-form" class="space-y-8">
                    <input type="hidden" id="post-id" value="${post.id || ''}"><input type="hidden" id="post-slug" value="${post.slug || ''}">
                    <div>
                        <select id="category" class="w-auto bg-gray-800 border border-gray-700 rounded-full p-2 pl-4 pr-3 text-white mb-4">${categoryOptions}</select>
                        <textarea id="title" class="w-full bg-transparent text-4xl font-black text-white placeholder-gray-600 focus:outline-none resize-none" rows="2" placeholder="제목..." required>${post.title || ''}</textarea>
                    </div>
                    <div><label class="text-lg font-bold text-white mb-3 block">요약</label><textarea id="summary" class="w-full bg-gray-800 border border-gray-700 rounded-xl p-4" rows="3" placeholder="미리보기에 표시될 요약 (150자 이내)">${post.summary || ''}</textarea></div>
                    <div><label class="text-lg font-bold text-white mb-3 block">본문</label><div id="editor-container" class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden"><div id="editor"></div></div></div>
                    <div class="flex justify-end items-center gap-3 pt-5">
                        <button type="submit" data-action="draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-white/10 text-white hover:bg-white/20">초안 저장</button>
                        <button type="submit" data-action="published" class="px-6 py-2.5 text-sm font-bold rounded-full bg-accent text-white">발행하기</button>
                    </div>
                </form></div>`;
            
            setTimeout(() => {
                initQuillEditor(post.refined_content || '');
                $('#writer-form').addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    if (e.submitter?.dataset.action) handlePostSave(e.submitter.dataset.action, e.submitter); 
                });
            }, 100);
        }
        
        function initQuillEditor(initialContent) {
            if ($('#editor-container').querySelector('.ql-editor')) return;
            const toolbarOptions = [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], ['blockquote', 'code-block'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image']];
            state.quill = new Quill('#editor', {
                modules: { syntax: true, toolbar: toolbarOptions },
                theme: 'snow', placeholder: '이야기를 작성하세요...'
            });
            if (initialContent) state.quill.clipboard.dangerouslyPasteHTML(0, initialContent);
            document.querySelector('.ql-toolbar').style.cssText = 'border: none; border-bottom: 1px solid var(--border-color); border-radius: 0.5rem 0.5rem 0 0;';
            document.querySelector('.ql-container').style.cssText = 'border: none; font-size: 18px;';
        }
        
        async function handlePostSave(status, button) {
             if (!state.quill) { showToast('에디터 초기화 오류.', true); return; }
            const originalBtnText = button.textContent;
            button.disabled = true; button.innerHTML = `<div class="w-4 h-4 border-2 border-t-transparent rounded-full animate-spin mx-auto"></div>`;

            try {
                const title = $('#title').value.trim();
                if (!title) throw new Error('제목을 입력해주세요.');
                if (state.quill.getText().trim().length === 0) throw new Error('본문 내용을 입력해주세요.');

                const contentHTML = state.quill.root.innerHTML;
                let summary = $('#summary').value.trim() || state.quill.getText().trim().replace(/\s+/g, ' ').slice(0, 150);
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = contentHTML;
                const thumbnailUrl = tempDiv.querySelector('img')?.src || null;

                const id = $('#post-id').value;
                let slug = $('#post-slug').value.trim();

                if (!id) { // 새 글일 때만 슬러그 생성
                    slug = title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    const { data: existing } = await supabase.from('posts').select('id').eq('slug', slug).maybeSingle();
                    if (existing) slug = `${slug}-${Date.now().toString().slice(-6)}`;
                }

                const postData = { title, slug, status, author_id: state.user.id, refined_content: contentHTML, category: $('#category').value, summary, thumbnail_url: thumbnailUrl };
                const { data, error } = await (id ? supabase.from('posts').update(postData).eq('id', id) : supabase.from('posts').insert(postData)).select().single();
                
                if (error) throw new Error(error.message);
                
                showToast(status === 'published' ? '글이 발행되었습니다!' : '초안이 저장되었습니다.');
                navigateTo(status === 'published' ? `/post/${data.slug}` : '/dashboard');
            } catch (error) { showToast(`저장 실패: ${error.message}`, true);
            } finally { button.disabled = false; button.textContent = originalBtnText; }
        }

        async function renderRecommendedPostsAndAds(currentPost) {
            const { data: posts } = await supabase.from('posts').select('title, slug, category, thumbnail_url').eq('status', 'published').neq('id', currentPost.id).limit(5).order('created_at', { ascending: false });
            if (!posts?.length) return '';
            const postsHtml = posts.map(p => `<a href="/post/${p.slug}" data-route class="recommended-post-item"><img src="${p.thumbnail_url || 'https://placehold.co/100x65/1E1E1E/6B6B6B?text=InsureLog'}" class="recommended-post-thumbnail" alt="${p.title}"><div class="recommended-post-info"><h4>${p.title}</h4><span>${p.category}</span></div></a>`).join('');
            const adHtml = `<div class="mt-4"><ins class="adsbygoogle" style="display:block" data-ad-format="autorelaxed" data-ad-client="ca-pub-5239497835591112" data-ad-slot="7106336036"></ins></div>`;
            return `<section class="recommended-posts-section"><h2 class="recommended-posts-title">이어서 볼만한 글</h2><div class="space-y-2">${postsHtml}${adHtml}</div></section>`;
        }

        async function renderNextPrevLinks(post) { /* ... Same as previous correct version ... */ }
        function showToast(message, isError = false) { /* ... Same as previous correct version ... */ }
        // ... Other utility functions
        
        function initializeApp() {
            supabase.auth.onAuthStateChange((_event, session) => {
                const userJustChanged = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                
                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav(); 
                    handleRouting();
                    anime({ targets: '#app-loader', opacity: 0, duration: 400, complete: (anim) => anim.animatables[0].target.remove() });
                } else if (userJustChanged) {
                    renderNav();
                    handleRouting();
                }
            });

            document.addEventListener('click', (e) => {
                const routeTarget = e.target.closest('[data-route]');
                if (routeTarget) { e.preventDefault(); navigateTo(routeTarget.getAttribute('href')); return; }
                
                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget) {
                    if (actionTarget.type === 'submit') return;
                    e.preventDefault();
                    const action = actionTarget.dataset.action;
                    switch (action) {
                        case 'auth': /* showAuthModal(); */ break;
                        case 'logout': /* handleLogout(); */ break;
                        case 'filter-category': navigateTo(buildUrl('/', { page: 1, category: actionTarget.dataset.category })); break;
                    }
                }
            });
            window.addEventListener('popstate', handleRouting);
        }
        
        // --- Placeholder functions for brevity, assuming they are complete and correct ---
        renderNav = function() { $('#main-nav-container').innerHTML = `<nav class="w-full max-w-7xl flex items-center justify-between py-3 px-5 bg-black/30 backdrop-blur-xl border border-white/10 rounded-3xl shadow-lg"><a href="/" data-route class="font-black text-xl text-white tracking-tighter">InsureLog</a><div class="flex items-center space-x-3">${state.user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-white/10 text-white hover:bg-white/20">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-white/10 text-white">로그아웃</button>` : `<button data-action="auth" class="px-4 py-2 text-sm font-bold rounded-full bg-accent text-white">로그인</button>`}</div></nav>`; };
        renderNextPrevLinks = async function(post) { const { data: p } = await supabase.from('posts').select('title, slug').lt('created_at', post.created_at).limit(1).single(); const { data: n } = await supabase.from('posts').select('title, slug').gt('created_at', post.created_at).limit(1).single(); return `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-white/10"><div>${p ? `<a href="/post/${p.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-800/50"><span>이전 글</span><h4>${p.title}</h4></a>` : ''}</div><div class="md:text-right">${n ? `<a href="/post/${n.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-800/50"><span>다음 글</span><h4>${n.title}</h4></a>` : ''}</div></nav>`; };
        showToast = (message, isError = false) => { const el = document.createElement('div'); el.className = `fixed bottom-4 right-4 py-2 px-4 rounded-lg text-white ${isError ? 'bg-red-600' : 'bg-gray-800'}`; el.textContent = message; document.body.appendChild(el); setTimeout(() => el.remove(), 3000); };
        updateMetaTags = (post = null) => { document.title = post ? `${post.title} | InsureLog` : 'InsureLog'; };
        buildUrl = (path, params) => { const url = new URL(path, SITE_URL); Object.entries(params).forEach(([k, v]) => v && v !== '전체' && url.searchParams.append(k, v)); return url.pathname + url.search; };
        renderPaginationControls = (page, totalItems, basePath, params) => { const totalPages = Math.ceil(totalItems / POSTS_PER_PAGE); if (totalPages <= 1) return ''; return `<div class="flex justify-center items-center gap-4 mt-12"><a href="${page > 1 ? buildUrl(basePath, {...params, page: page - 1}) : '#'}" data-route class="px-4 py-2 text-sm rounded-full bg-gray-800 ${page === 1 ? 'opacity-50' : ''}">이전</a><span>${page} / ${totalPages}</span><a href="${page < totalPages ? buildUrl(basePath, {...params, page: page + 1}) : '#'}" data-route class="px-4 py-2 text-sm rounded-full bg-gray-800 ${page >= totalPages ? 'opacity-50' : ''}">다음</a></div>`; };


        initializeApp();
    </script>
</body>
</html>


