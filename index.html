<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    
    <!-- CSP (Content Security Policy) -->
    <!-- 참고: 'unsafe-eval'은 Editor.js 또는 기타 라이브러리에서 필요할 수 있으나, 가능하면 제거하는 것이 보안에 좋습니다. -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://www.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com https://*.adtrafficquality.google; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google https://*.gemius.pl https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://*.adtrafficquality.google https://*.google.com https://*.googlesyndication.com; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    <meta property="og:site_name" content="InsureLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Scripts & Stylesheets -->
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer nonce="r4nd0m"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>

    <!-- [STYLE] -->
    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            line-height: 1.7;
            min-height: 100vh;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; line-height: 1.75; }
        }
        main#app-container {
            padding-left: 1rem; 
            padding-right: 1rem; 
            flex-grow: 1;
            width: 100%;
            max-width: 100%;
        }
        @media (min-width: 640px) {
            main#app-container { padding-left: 1rem; padding-right: 1rem; }
        }
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom h1 { font-size: 2.25rem; }
        .prose-custom h2 { font-size: 1.875rem; }
        .prose-custom h3 { font-size: 1.5rem; }
        /* 추가: h4~h6 헤딩 스타일 */
        .prose-custom h4, .prose-custom h5, .prose-custom h6 { color: var(--text-primary); font-weight: 700; margin-top: 1.5em; margin-bottom: 0.75em; }
        .prose-custom h4 { font-size: 1.25rem; line-height: 1.75rem; }
        .prose-custom h5 { font-size: 1.125rem; line-height: 1.5rem; }
        .prose-custom h6 { font-size: 1rem; line-height: 1.5rem; }
        .prose-custom p { margin: 0 0 1.3em; color: var(--text-secondary); }
        .prose-custom div { margin-bottom: 1.3em; }
        .prose-custom p br { display: block; margin-bottom: 0.75em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.3em; }
        .prose-custom ul { list-style-type: disc; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom ol { list-style-type: decimal; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { margin-top: 0.5em; margin-bottom: 0.5em; margin-left: 1.25em; }
        .prose-custom code { font-family: var(--font-mono); font-size: 0.9em; background-color: #F3F4F6; padding: 0.2em 0.4em; border-radius: 6px; }
        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        .prose-custom img, .prose-custom figure { max-width: 90%; height: auto; border-radius: 12px; margin-top: 2em; margin-bottom: 2em; box-shadow: 0 10px 20px rgba(0,0,0,0.05); display: block; margin-left: auto; margin-right: auto; }
        .prose-custom figure { max-width: 100%; }
        .prose-custom figure img { max-width: 100%; margin-top:0; margin-bottom: 0.5em; }
        .prose-custom figcaption { text-align: center; font-size: 0.9em; color: var(--text-secondary); }
        .prose-custom table { width: 100%; border-collapse: collapse; margin-top: 2em; margin-bottom: 2em; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-radius: 8px; overflow: hidden; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 0.75em 1em; text-align: left; }
        .prose-custom th { background-color: var(--bg-content-secondary); font-weight: 700; color: var(--text-primary); }
        .prose-custom tr:nth-child(odd) { background-color: var(--bg-main); }
        .prose-custom tr:nth-child(even) { background-color: var(--bg-content-secondary); }
        
        /* 전역 헤딩 스타일 - prose-custom 클래스 없이도 적용 */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-primary);
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            line-height: 1.2;
        }
        h1 { font-size: 2.25rem; font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        h2 { font-size: 1.875rem; font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        h3 { font-size: 1.5rem; font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        h4 { font-size: 1.25rem; line-height: 1.75rem; }
        h5 { font-size: 1.125rem; line-height: 1.5rem; }
        h6 { font-size: 1rem; line-height: 1.5rem; }
        
        /* 단락 스타일 */
        p {
            margin: 0 0 1.3em;
            color: var(--text-secondary);
            line-height: 1.7;
        }
        
        /* 새로운 에디터 요소 스타일 */
        .prose-custom mark { background-color: #FEF08A; padding: 0.1em 0.2em; border-radius: 3px; }
        .prose-custom .cdx-checklist { margin-bottom: 1.3em; }
        .prose-custom .cdx-checklist__item { display: flex; align-items: flex-start; margin-bottom: 0.5em; }
        .prose-custom .cdx-checklist__item-checkbox { margin-right: 0.75em; margin-top: 0.2em; }
        .prose-custom .cdx-checklist__item-text { flex: 1; }
        .prose-custom .cdx-checklist__item--checked .cdx-checklist__item-text { text-decoration: line-through; opacity: 0.6; }
        .prose-custom .cdx-link { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); }
        .prose-custom .cdx-link:hover { background-color: var(--accent); color: white; }
        
        /* 마커 스타일 */
        .cdx-marker {
            background-color: #FEF08A !important;
            padding: 0.1em 0.2em !important;
            border-radius: 3px !important;
        }
        
        /* 인라인 코드 스타일 */
        .cdx-inline-code {
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace !important;
            font-size: 0.9em !important;
            background-color: #F3F4F6 !important;
            padding: 0.2em 0.4em !important;
            border-radius: 6px !important;
            color: #374151 !important;
        }
        
        .category-btn { transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem; font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent; }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #editorjs-holder {
            width: 100%;
            min-height: 600px;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }
        #editorjs-holder:focus-within {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }
        .codex-editor__redactor {
            padding-bottom: 100px !important;
        }
        .ce-block__content, .ce-toolbar__content {
            max-width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        .ce-toolbar__actions {
            left: -12px !important;
        }
        .ce-inline-toolbar {
            color: #333;
        }
        .image-tool__image-picture {
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        
        /* Editor.js 블록 스타일 개선 */
        .ce-block {
            margin-bottom: 1.5em !important;
        }
        .ce-paragraph {
            font-size: 16px !important;
            line-height: 1.6 !important;
            color: var(--text-primary) !important;
        }
        .ce-header {
            font-weight: 700 !important;
            margin-top: 1.5em !important;
            margin-bottom: 0.75em !important;
            color: var(--text-primary) !important;
        }
        .ce-header[data-level="1"] { font-size: 2rem !important; }
        .ce-header[data-level="2"] { font-size: 1.75rem !important; }
        .ce-header[data-level="3"] { font-size: 1.5rem !important; }
        .ce-header[data-level="4"] { font-size: 1.25rem !important; }
        .ce-header[data-level="5"] { font-size: 1.125rem !important; }
        .ce-header[data-level="6"] { font-size: 1rem !important; }
        
        /* 리스트 스타일 */
        .cdx-list {
            margin-bottom: 1.3em !important;
        }
        .cdx-list__item {
            margin-bottom: 0.5em !important;
            line-height: 1.6 !important;
        }
        
        /* 체크리스트 스타일 개선 */
        .cdx-checklist {
            margin-bottom: 1.3em !important;
        }
        .cdx-checklist__item {
            display: flex !important;
            align-items: flex-start !important;
            margin-bottom: 0.5em !important;
            line-height: 1.6 !important;
        }
        .cdx-checklist__item-checkbox {
            margin-right: 0.75em !important;
            margin-top: 0.2em !important;
            flex-shrink: 0 !important;
        }
        .cdx-checklist__item-text {
            flex: 1 !important;
        }
        .cdx-checklist__item--checked .cdx-checklist__item-text {
            text-decoration: line-through !important;
            opacity: 0.6 !important;
        }
        
        /* 인용구 스타일 */
        .cdx-quote {
            border-left: 3px solid var(--accent) !important;
            padding-left: 1.5em !important;
            font-style: italic !important;
            color: var(--text-primary) !important;
            background-color: var(--bg-content-secondary) !important;
            border-radius: 0 8px 8px 0 !important;
            margin-bottom: 1.3em !important;
        }
        
        /* 코드 블록 스타일 */
        .cdx-code {
            background-color: #282c34 !important;
            color: #abb2bf !important;
            padding: 1.5em !important;
            border-radius: 12px !important;
            margin-bottom: 1.5em !important;
            overflow-x: auto !important;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace !important;
        }
        
        /* 테이블 스타일 */
        .tc-table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 2em !important;
            margin-bottom: 2em !important;
            font-size: 0.9em !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03) !important;
            border-radius: 8px !important;
            overflow: hidden !important;
        }
        .tc-table__cell {
            border: 1px solid var(--border-color) !important;
            padding: 0.75em 1em !important;
            text-align: left !important;
        }
        @media (max-width: 639px) {
            .writer-controls-sticky { 
                position: sticky; bottom: 0; background-color: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
                padding: 1rem; border-top: 1px solid #E5E7EB; 
                margin-left: -0.75rem; margin-right: -0.75rem; 
                padding-top: 1rem !important; z-index: 30; 
            }
            .prose-custom img, .prose-custom figure { 
                width: calc(100% + 1.5rem); 
                margin-left: -0.75rem; 
                margin-right: -0.75rem; 
                max-width: none;
                border-radius: 0; 
                box-shadow: none; 
            }
        }
        .post-thumbnail img { loading: lazy; }
        button:focus, a:focus, input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--accent); outline-offset: 2px; 
        }
        #editorjs-holder:focus, #editorjs-holder:focus-within {
             outline: 2px solid var(--accent); outline-offset: 2px; 
        }
        @media (prefers-reduced-motion: reduce) { 
            *, *::before, *::after { 
                animation-duration: 0.01ms !important; 
                animation-iteration-count: 1 !important; 
                transition-duration: 0.01ms !important; 
            } 
        }
        footer { margin-top: 16px; } 
        @media (min-width: 640px) { footer { margin-top: 24px; } }
        
        /* 로더 스피너 스타일 */
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #D946EF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 카테고리 버튼 스타일 */
        .category-btn {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .category-btn:hover {
            background-color: #e5e7eb;
            color: #374151;
        }
        .category-btn.active {
            background-color: #D946EF;
            color: white;
            border-color: #D946EF;
        }
    </style>
</head>
<body class="antialiased">
    <!-- 앱 로더 -->
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    
    <!-- 헤더 (네비게이션) -->
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4 bg-white/80 backdrop-blur-sm"></header>
    
    <!-- 메인 콘텐츠 (뷰가 렌더링되는 곳) -->
    <main id="app-container" class="w-full">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>

    <!-- 푸터 -->
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>

    <!-- 모달 및 토스트 컨테이너 -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <!-- [APP SCRIPT] -->
    <script type="module" nonce="r4nd0m">
        // [Supabase] ES 모듈 임포트
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        /**
         * [Module: Config]
         * 앱의 핵심 설정을 정의합니다. (변경 없음)
         */
        const Config = {
            SITE_URL: 'https://blogaipandoci.vercel.app',
            SUPABASE_URL: 'https://ddehwkwzmmvcxltlplua.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To',
            IMAGE_BUCKET_NAME: 'thought-images', 
            DB_TABLE_NAME: 'posts', 
            POSTS_PER_PAGE: 10,
            CATEGORIES: ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"]
        };

        // [Accessibility] 광고/외부 스크립트가 body에 aria-hidden을 강제로 설정하는 경우 제거합니다.
        try {
            const removeBodyAriaHidden = () => {
                if (document.body.getAttribute('aria-hidden') === 'true') {
                    document.body.removeAttribute('aria-hidden');
                }
            };
            document.addEventListener('DOMContentLoaded', removeBodyAriaHidden, { once: true });
            const bodyObserver = new MutationObserver((mutations) => {
                for (const m of mutations) {
                    if (m.attributeName === 'aria-hidden') removeBodyAriaHidden();
                }
            });
            bodyObserver.observe(document.body, { attributes: true });
        } catch (_) { /* noop */ }

        /**
         * [Module: DOM]
         * DOM 관련 헬퍼 함수들을 모아놓은 유틸리티 객체입니다. (변경 없음)
         */
        const DOM = {
            $: document.querySelector.bind(document),
            
            animateSwitch: (el, show = true) => {
                if (!el) return Promise.resolve();
                if (typeof anime === 'function') {
                    const opts = show ? { opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' } : { opacity: 0, duration: 200, easing: 'easeInQuad' };
                    return anime({ targets: el, ...opts }).finished;
                } else {
                    el.style.opacity = show ? 1 : 0;
                    return Promise.resolve();
                }
            },

            showToast: (msg, err = false) => {
                const toast = document.createElement('div');
                toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${err ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
                toast.textContent = msg;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'polite');
                DOM.$('#toast-container').appendChild(toast);
                DOM.animateSwitch(toast, true);
                setTimeout(() => DOM.animateSwitch(toast, false).then(() => toast.remove()), 3000);
            },

            showModal: (id, html) => {
                if (DOM.$(`#${id}`)) return;
                const container = DOM.$('#modal-container');
                const modalWrapper = document.createElement('div');
                modalWrapper.id = id;
                modalWrapper.className = "fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4";
                modalWrapper.setAttribute('role', 'dialog');
                modalWrapper.setAttribute('aria-modal', 'true');
                modalWrapper.innerHTML = html;
                container.appendChild(modalWrapper);
                const content = modalWrapper.querySelector('.modal-content');
                DOM.animateSwitch(modalWrapper);
                if (content) DOM.animateSwitch(content, true);
                return modalWrapper;
            },

            closeModal: (id) => {
                const modal = DOM.$(`#${id}`);
                if (!modal) return Promise.resolve();
                return DOM.animateSwitch(modal, false).then(() => modal.remove());
            },

            buildUrl: (path, params) => {
                const url = new URL(path, Config.SITE_URL);
                Object.entries(params).forEach(([k, v]) => {
                    if (v !== undefined && v !== null && v !== '전체' && v !== '') url.searchParams.append(k, v);
                });
                return url.pathname + url.search;
            },

            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }
        };

        /**
         * [Module: ScriptLoader]
         * 스크립트 동적 로딩을 관리합니다. (nonce 설정 로직 추가)
         */
        const ScriptLoader = {
            _loaded: new Set(),
            _nonce: null,
            _sources: {
                'hljs': 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
                'dompurify': 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js',
                // [FIX] edjsHTML: jsDelivr의 브라우저 UMD 빌드로 교체 (v4)
                'edjsHTML': 'https://cdn.jsdelivr.net/npm/editorjs-html@4.0.0/.build/edjsHTML.browser.js',
                // [ADD] Markdown 렌더러 (UMD 글로벌: marked)
                'marked': 'https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js',
                'exif': 'https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js',
                'editorjs': 'https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest',
                'header': 'https://cdn.jsdelivr.net/npm/@editorjs/header@latest',
                'list': 'https://cdn.jsdelivr.net/npm/@editorjs/list@latest',
                'imageTool': 'https://cdn.jsdelivr.net/npm/@editorjs/image@latest',
                'quote': 'https://cdn.jsdelivr.net/npm/@editorjs/quote@latest',
                'code': 'https://cdn.jsdelivr.net/npm/@editorjs/code@latest',
                'table': 'https://cdn.jsdelivr.net/npm/@editorjs/table@latest',
                'delimiter': 'https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest',
                'linkTool': 'https://cdn.jsdelivr.net/npm/@editorjs/link@latest',
                'checklist': 'https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest',
                'marker': 'https://cdn.jsdelivr.net/npm/@editorjs/marker@latest',
                'inlineCode': 'https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest',
            },

            setNonce: (nonce) => {
                ScriptLoader._nonce = nonce;
            },

            load: (id) => {
                return new Promise((resolve, reject) => {
                    if (ScriptLoader._loaded.has(id)) {
                        return resolve();
                    }
                    if (!ScriptLoader._sources[id]) {
                        return reject(new Error(`Script source not found for id: ${id}`));
                    }
                    const src = ScriptLoader._sources[id];
                    const script = document.createElement('script');
                    script.src = src;
                    script.defer = true;
                    script.crossOrigin = 'anonymous';
                    script.id = `script-${id}`;
                    if (ScriptLoader._nonce) {
                        script.nonce = ScriptLoader._nonce;
                    }
                    script.onload = () => {
                        ScriptLoader._loaded.add(id);
                        resolve();
                    };
                    script.onerror = () => {
                        console.error(`[ScriptLoader] Failed to load script: ${src}`);
                        reject(new Error(`Failed to load script: ${id}`));
                    };
                    document.head.appendChild(script);
                });
            },
            loadRenderer: () => Promise.all([
                ScriptLoader.load('edjsHTML'),
                ScriptLoader.load('dompurify'),
                ScriptLoader.load('hljs'),
                ScriptLoader.load('marked')
            ]),
            loadEditor: () => Promise.all([
                ScriptLoader.load('editorjs'),
                ScriptLoader.load('header'),
                ScriptLoader.load('list'),
                ScriptLoader.load('imageTool'),
                ScriptLoader.load('quote'),
                ScriptLoader.load('code'),
                ScriptLoader.load('table'),
                ScriptLoader.load('delimiter'),
                ScriptLoader.load('linkTool'),
                ScriptLoader.load('checklist'),
                ScriptLoader.load('marker'),
                ScriptLoader.load('inlineCode')
            ]),
            loadExif: () => ScriptLoader.load('exif')
        };


        /**
         * [Main App Class: BlogApp]
         * 애플리케이션의 모든 로직을 캡슐화하는 메인 클래스입니다.
         * 기존의 State, Services, ViewRenderer, Router, App 모듈이 모두 이 클래스 내부의
         * state와 method로 통합되었습니다.
         */
        class BlogApp {
            
            // 앱 상태 (State)
            state = {
                user: null,
                isAuthReady: false,
                currentCategory: '전체',
                editorInstance: null,
            };

            // 서비스 인스턴스
            supabase = null;
            
            constructor() {
                // 1. Supabase 클라이언트 초기화
                try {
                    this.supabase = createClient(Config.SUPABASE_URL, Config.SUPABASE_ANON_KEY);
                } catch (e) {
                    console.error("Failed to initialize Supabase client:", e);
                    DOM.showToast('앱 초기화 실패. 페이지를 새로고침해주세요.', true);
                    return;
                }
                
                // 2. Nonce 값 설정 (CSP용)
                const nonce = document.querySelector('script[nonce]')?.nonce || null;
                ScriptLoader.setNonce(nonce);

                // 3. 이벤트 핸들러 'this' 컨텍스트 바인딩
                this.handleGlobalClick = this.handleGlobalClick.bind(this);
                this.handlePopState = this.handlePopState.bind(this);

                // 4. 앱 초기화 시작
                this.init();
            }

            /**
             * [App Init]
             * 앱의 핵심 로직을 초기화하고 인증 상태 변경을 감지합니다.
             */
            init() {
                this.bindGlobalListeners();

                this.supabase.auth.onAuthStateChange((_, session) => {
                    const user = session?.user || null;
                    const authChanged = this.state.user?.id !== user?.id;
                    this.state.user = user;

                    if (!this.state.isAuthReady) {
                        // 첫 로드 시:
                        this.state.isAuthReady = true;
                        this.renderNav(); // 네비게이션 렌더링
                        this.handleRouting(); // 라우팅 시작
                        window.addEventListener('popstate', this.handlePopState); // 뒤로가기/앞으로가기 감지
                        
                        // 앱 로더 숨기기
                        const loader = DOM.$('#app-loader');
                        if (loader) {
                            DOM.animateSwitch(loader, false).then(() => loader.remove());
                        }
                    } else if (authChanged) {
                        // 인증 상태 변경 시 (로그인/로그아웃)
                        this.renderNav();
                        this.handleRouting(); // 현재 뷰를 다시 렌더링 (예: 대시보드 접근 권한)
                    }
                });
            }

            /**
             * [Event Listeners]
             * 전역 이벤트 리스너를 바인딩합니다.
             */
            bindGlobalListeners() {
                document.addEventListener('click', this.handleGlobalClick);
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = DOM.$('[role="dialog"]');
                        if (modal) DOM.closeModal(modal.id);
                    }
                });
            }

            handleGlobalClick(e) {
                // 1. 데이터 액션 버튼 (data-action)
                const actionBtn = e.target.closest('[data-action]');
                if (actionBtn && !actionBtn.closest('form')) {
                    e.preventDefault();
                    const action = actionBtn.dataset.action;
                    switch (action) {
                        case 'auth': return this.showAuthModal();
                        case 'logout': return this.handleLogout();
                        case 'filter-category': 
                            return this.navigateTo(DOM.buildUrl('/', { page: 1, category: actionBtn.dataset.category }));
                        case 'close-modal':
                            return DOM.closeModal(actionBtn.closest('[role="dialog"]').id);
                    }
                }

                // 2. 내부 링크 라우팅 (SPA)
                const link = e.target.closest('a');
                if (link && link.href && link.origin === window.location.origin && !link.dataset.action && !link.href.endsWith('#') && link.target !== '_blank' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    this.navigateTo(link.href);
                }
            }

            handlePopState() {
                this.handleRouting();
            }

            // =================================================================
            // [Router Methods] (라우터)
            // =================================================================

            navigateTo(path, replace = false) {
                let relativePath;
                try {
                    const url = new URL(path, window.location.origin);
                    if (url.origin === window.location.origin) {
                        relativePath = url.pathname + url.search + url.hash;
                    } else {
                        window.location.href = path; // 외부 링크는 그냥 이동
                        return;
                    }
                } catch (e) {
                    relativePath = path || '/';
                }
                
                const action = replace ? 'replaceState' : 'pushState';
                const currentPath = window.location.pathname + window.location.search + window.location.hash;
                
                if (currentPath !== relativePath) {
                    history[action]({ path: relativePath }, '', relativePath);
                }
                this.handleRouting(); // 상태 변경 후 라우팅 실행
            }

            async switchView(viewId, callback) {
                const current = DOM.$('.app-view.active');
                if (current) {
                    await DOM.animateSwitch(current, false);
                    current.classList.remove('active');
                    current.innerHTML = '';
                }
                
                const next = DOM.$(`#${viewId}`);
                if (next) {
                    next.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                    next.classList.add('active');
                    await DOM.animateSwitch(next);
                    
                    try {
                        await callback(next); // 뷰 렌더링 콜백 실행
                    } catch (error) {
                        console.error(`Error rendering ${viewId}:`, error);
                        next.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                    }
                    window.scrollTo(0, 0); // 페이지 상단으로 스크롤
                }
            }

            handleRouting() {
                if (!this.state.isAuthReady) return; // 인증 준비 전에는 라우팅 안 함

                const path = window.location.pathname;
                const params = new URLSearchParams(window.location.search);
                const parts = path.split('/').filter(Boolean);
                const route = parts[0] || 'library';
                const param = parts[1] || null;

                // 1. 인증이 필요한 페이지 (대시보드, 글쓰기)
                if (!this.state.user && ['dashboard', 'writer'].includes(route)) {
                    DOM.showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                    this.navigateTo('/');
                    return;
                }

                // 2. 뷰 전환
                switch (route) {
                    case 'post': 
                        return this.switchView('view-post', el => this.renderPost(el, param));
                    case 'dashboard': 
                        return this.switchView('view-dashboard', el => this.renderDashboard(el));
                    case 'writer': 
                        return this.switchView('view-writer', el => this.renderWriter(el, param));
                    default: 
                        const page = parseInt(params.get('page'), 10) || 1;
                        this.state.currentCategory = params.get('category') || '전체';
                        return this.switchView('view-library', el => this.renderLibrary(el, page, this.state.currentCategory));
                }
            }

            // =================================================================
            // [ViewRenderer Methods] (뷰 렌더링)
            // =================================================================

            // --- 템플릿 헬퍼 ---
            _templates = {
                nav: (user) => `
                    <nav class="w-full max-w-4xl flex items-center justify-between py-3 px-6 bg-white/90 backdrop-blur-xl border border-gray-200/50 rounded-2xl shadow-lg" role="banner">
                        <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter hover:text-[#D946EF] transition-colors" aria-label="InsureLog 홈으로 이동">InsureLog</a>
                        <div class="flex items-center space-x-3">
                            ${user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors" aria-label="대시보드로 이동">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors" aria-label="로그아웃">로그아웃</button>` : `<button data-action="auth" aria-label="로그인 또는 회원가입" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition-colors">로그인 / 가입</button>`}
                        </div>
                    </nav>`,
                categoryBtns: (category) => ['전체', ...Config.CATEGORIES].map(cat => `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}" aria-pressed="${cat === category}">${cat}</button>`).join(''),
                pagination: (page, total, basePath, params) => {
                    const totalPages = Math.ceil(total / Config.POSTS_PER_PAGE);
                    if (totalPages <= 1) return '';
                    const prevUrl = page > 1 ? DOM.buildUrl(basePath, { ...params, page: page - 1 }) : '#';
                    const nextUrl = page < totalPages ? DOM.buildUrl(basePath, { ...params, page: page + 1 }) : '#';
                    return `<div class="flex justify-center items-center gap-4 mt-12" role="navigation" aria-label="페이지 탐색"><a href="${prevUrl}" data-route aria-label="이전 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${page} / ${totalPages}</span><a href="${nextUrl}" data-route aria-label="다음 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
                }
            }

            // --- 뷰 렌더링 ---

            renderNav() {
                DOM.$('#main-nav-container').innerHTML = this._templates.nav(this.state.user);
            }

            async renderLibrary(container, page, category) {
                this.updateMetaTags();
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                        <div class="flex items-center justify-center gap-2 mb-8 flex-wrap" role="tablist">${this._templates.categoryBtns(category)}</div>
                        <div id="post-list-container" class="border border-gray-200/80 rounded-2xl overflow-hidden min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>
                    </div>`;
                
                const { data: posts, error, count } = await this.getPosts(page, category);
                const listContainer = DOM.$('#post-list-container');
                
                if (error) {
                    console.error("Error fetching posts:", error); 
                    listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                    return;
                }
                
                const total = count ?? 0;
                const safePosts = Array.isArray(posts) ? posts : [];
                const postsHtml = safePosts.length > 0
                    ? `<div class="divide-y divide-gray-200/80">${safePosts.map(post => {
                        const thumb = post.thumbnail_url ? `<div class="w-24 h-16 sm:w-32 sm:h-20 flex-shrink-0 mr-4 sm:mr-5"><img src="${post.thumbnail_url}" alt="${post.title} 썸네일" class="w-full h-full object-cover rounded-lg bg-gray-100 post-thumbnail"></div>` : '';
                        return `<a href="/post/${post.slug}" data-route class="flex items-center p-4 transition-all duration-300 bg-transparent hover:bg-gray-50/80" role="article">${thumb}<div class="flex-grow"><p class="text-xs font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-sm font-bold">${post.title}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-2">${post.summary || ''}</p></div></a>`;
                    }).join('')}</div>`
                    : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${this.state.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
                
                listContainer.innerHTML = `${postsHtml}${this._templates.pagination(page, total, '/', { category })}`;
                listContainer.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
            }

            async renderPost(container, slug) {
                const { data: post, error } = await this.getPostBySlug(slug);
                if (error || !post) {
                    console.error("Error fetching post:", slug, error);
                    DOM.showToast('글을 찾을 수 없습니다.', true);
                    this.navigateTo('/');
                    return;
                }
                
                this.incrementViewCount(slug);
                const { data: popular } = await this.getRelatedPosts(slug);
                const [{ data: prev }, { data: next }] = await this.getAdjacentPosts(post.created_at);
                const popularHtml = popular?.length > 0 ? `<div class="mt-20"><h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2><div class="border-t border-gray-200">${popular.map(p => `<a href="/post/${p.slug}" data-route class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50" role="link"><h4 class="font-semibold text-gray-800 text-base">${p.title}</h4></a>`).join('')}</div></div>` : '';
                const navHtml = `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10" role="navigation" aria-label="이전/다음 글 탐색"><div>${prev ? `<a href="/post/${prev.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${prev.title}</h4></a>` : ''}</div><div class="text-left md:text-right">${next ? `<a href="/post/${next.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${next.title}</h4></a>` : ''}</div></nav>`;
                this.updateMetaTags(post);
                const editBtn = (this.state.user && this.state.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200" aria-label="글 수정">수정</a>` : '';
                const adTestAttr = ['localhost','127.0.0.1'].includes(window.location.hostname) ? ' data-adtest="on"' : '';
                
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <article role="article">
                            <header class="mb-8 sm:mb-12">
                                <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                                <h1 class="text-3xl sm:text-4xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    ${editBtn}
                                </div>
                            </header>
                            <div id="post-content" class="prose-custom max-w-none min-h-[300px] flex items-center justify-center">
                                <div class="loader-spinner"></div>
                            </div>
                        </article>
                        <div class="my-16" id="adsense-container" style="display: none;"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"${adTestAttr}></ins></div>
                        ${popularHtml}${navHtml}
                    </div>`;
                
                try {
                    await ScriptLoader.loadRenderer(); 

                    // edjsHTML이 UMD 빌드로 로드되면 window.edjsHTML에 할당됩니다.
                    // (이전 버전에서는 edjsHTML이었으나, 새 UMD 빌드에서는 edjsHTML.default 또는 edjsHTML일 수 있습니다.
                    // 'editorjs-html.js'는 'edjsHTML'을 전역으로 노출합니다.)
                    const parser = edjsHTML({
                        header: function(block) {
                            const level = block.data.level || 1;
                            const text = block.data.text || '';
                            return `<h${level}>${text}</h${level}>`;
                        },
                        paragraph: function(block) {
                            return `<p>${block.data.text || ''}</p>`;
                        },
                        list: function(block) {
                            const style = block.data.style === 'ordered' ? 'ol' : 'ul';
                            const items = block.data.items.map(item => `<li>${item}</li>`).join('');
                            return `<${style}>${items}</${style}>`;
                        },
                        checklist: function(block) {
                            const items = block.data.items.map(item => 
                                `<div class="cdx-checklist__item ${item.checked ? 'cdx-checklist__item--checked' : ''}">
                                    <input type="checkbox" class="cdx-checklist__item-checkbox" ${item.checked ? 'checked' : ''} disabled>
                                    <span class="cdx-checklist__item-text">${item.text}</span>
                                </div>`
                            ).join('');
                            return `<div class="cdx-checklist">${items}</div>`;
                        },
                        quote: function(block) {
                            return `<blockquote>${block.data.text || ''}</blockquote>`;
                        },
                        code: function(block) {
                            return `<pre><code>${block.data.code || ''}</code></pre>`;
                        },
                        delimiter: function(block) {
                            return '<hr>';
                        },
                        table: function(block) {
                            const rows = block.data.content.map((row, index) => {
                                const cells = row.map(cell => 
                                    index === 0 ? `<th>${cell}</th>` : `<td>${cell}</td>`
                                ).join('');
                                return `<tr>${cells}</tr>`;
                            }).join('');
                            return `<table><tbody>${rows}</tbody></table>`;
                        }
                    });
                    if (typeof parser?.parse !== 'function') {
                        console.error('edjsHTML parser not found. Check library loading.');
                        throw new Error('edjsHTML parser not found');
                    }

                    let savedData = { blocks: [] };
                    let rawHtml = '';

                    if (post.refined_content) {
                        try {
                            const parsed = JSON.parse(post.refined_content);
                            if (parsed && typeof parsed === 'object' && Array.isArray(parsed.blocks) && parsed.blocks.length > 0) {
                                savedData = parsed;
                                const htmlBlocks = parser.parse(savedData);
                                rawHtml = Array.isArray(htmlBlocks) ? htmlBlocks.join('') : String(htmlBlocks || '');
                            } else {
                                // Editor.js 데이터가 아니면 Markdown으로 가정
                                if (typeof marked !== 'undefined' && marked.parse) {
                                    rawHtml = marked.parse(post.refined_content);
                                } else {
                                    console.warn('Marked library not available; rendering raw text.');
                                    rawHtml = String(post.refined_content);
                                }
                            }
                        } catch (e) {
                            // JSON 파싱 실패 시 Markdown 폴백
                            // Silently fall back to Markdown parsing
                            if (typeof marked !== 'undefined' && marked.parse) {
                                rawHtml = marked.parse(post.refined_content);
                            } else {
                                rawHtml = String(post.refined_content);
                            }
                        }
                    }

                    // DOMPurify 훅 설정 (중복 방지)
                    if (!window.__dompurifyHooked) {
                        DOMPurify.addHook('uponSanitizeAttribute', function(node, data) {
                            if (data.attrName === 'style') {
                                try {
                                    const style = (data.attrValue || '').toLowerCase();
                                    const allowedStyles = [];
                                    const mAlign = style.match(/text-align\s*:\s*(left|center|right|justify)/);
                                    if (mAlign) allowedStyles.push(`text-align:${mAlign[1]}`);
                                    const mWidth = style.match(/(?:^|;|\s)width\s*:\s*([0-9]+(?:\.[0-9]+)?)(px|%)/);
                                    if (mWidth) allowedStyles.push(`width:${mWidth[1]}${mWidth[2]}`);
                                    data.attrValue = allowedStyles.join(';');
                                    if (!data.attrValue) data.keepAttr = false;
                                } catch (_) { data.keepAttr = false; }
                            }
                        });
                        window.__dompurifyHooked = true;
                    }
                    
                    const safeContent = DOMPurify.sanitize(rawHtml, { 
                        ADD_TAGS: ["iframe", "table", "tr", "td", "th", "tbody", "thead", "tfoot", "col", "colgroup", "span", "figure", "figcaption", "h1", "h2", "h3", "h4", "h5", "h6", "ul", "ol", "li", "p", "div", "br", "strong", "em", "code", "pre", "blockquote", "a", "img", "hr", "mark", "input", "label"], 
                        ADD_ATTR: ["rowspan", "colspan", "style", "class", "width", "height", "align", "frameborder", "allow", "allowfullscreen", "src", "href", "target", "rel", "alt", "title", "id", "type", "checked", "disabled", "for"]
                    });
                    
                    const contentEl = DOM.$('#post-content');
                    if(contentEl) {
                        contentEl.innerHTML = safeContent;
                        contentEl.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
                        
                        // 코드 하이라이팅
                        contentEl.querySelectorAll('pre code').forEach(el => {
                            if (typeof hljs !== 'undefined' && hljs.highlightElement) {
                                hljs.highlightElement(el);
                            }
                        });

                        contentEl.querySelectorAll('img').forEach(img => { img.loading = 'lazy'; img.decoding = 'async'; });
                        contentEl.querySelectorAll('a[target="_blank"]').forEach(a => { a.rel = 'noopener noreferrer'; });
                    }

                } catch (renderError) {
                    console.error("Error during post content rendering:", renderError); 
                    DOM.$('#post-content').innerHTML = `<p class="text-red-500">콘텐츠를 렌더링하는 중 오류가 발생했습니다.</p>`;
                }
                
                // 애드센스 로드 (프로덕션 환경에서만)
                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    const adsenseContainer = DOM.$('#adsense-container');
                    if (adsenseContainer) {
                        adsenseContainer.style.display = 'block';
                    }
                    try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { /* 애드센스 오류 무시 */ }
                }
            }

            async renderDashboard(container) {
                this.updateMetaTags({ title: '대시보드' });
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><div class="flex justify-between items-center mb-8 sm:mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]" aria-label="새 글 작성">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2 min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div>`;
                
                if (!this.state.user) return; // 방어 코드
                const { data: posts, error } = await this.getDashboardPosts(this.state.user.id);
                const list = DOM.$('#dashboard-post-list');
                
                if (error) {
                    list.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>';
                    return;
                }
                if (!posts?.length) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>';
                    return;
                }
                list.innerHTML = `<ul class="w-full" role="list">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors" role="listitem"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" data-route class="font-bold text-black hover:text-[#D946EF]" aria-label="글 보기: ${post.title}">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black" aria-label="글 수정: ${post.title}">수정</a></li>`).join('')}</ul>`;
                list.classList.remove('min-h-[200px]', 'flex', 'items-center', 'justify-center');
            }

            async renderWriter(container, slug) {
                // 기존 에디터 인스턴스 파괴
                if (this.state.editorInstance) {
                    try {
                        await this.state.editorInstance.destroy();
                    } catch(e) { console.warn("Editor.js destroy error", e); }
                    this.state.editorInstance = null;
                }
                
                this.updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

                let post = { id: null, title: '', summary: '', refined_content: null, slug: '', category: Config.CATEGORIES[0] };
                if (slug) {
                    const { data, error } = await this.getPostBySlug(slug);
                    if (error || !data || data.author_id !== this.state.user.id) {
                        DOM.showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true);
                        this.navigateTo('/dashboard');
                        return;
                    }
                    post = data;
                }
                
                const categoryOpts = Config.CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
                
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><form id="writer-form" class="space-y-8 sm:pb-0 pb-20" novalidate><input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}"><div><select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4" required aria-label="카테고리 선택">${categoryOpts}</select><textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required aria-label="제목 입력" maxlength="200">${post.title || ''}</textarea></div><div><label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label><textarea id="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)" aria-label="요약 입력">${post.summary || ''}</textarea></div><div><label for="editorjs-holder" class="block text-lg font-bold text-black mb-3">본문</label>
                    <div id="editorjs-holder" class="prose-custom max-w-none min-h-[400px] flex items-center justify-center">
                         <div class="loader-spinner"></div>
                    </div> 
                </div><div class="flex justify-between items-center pt-8 sm:pt-5 writer-controls-sticky">
                    <div></div> 
                    <div class="flex items-center space-x-3"><button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button><button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button>${post.id ? `<button type="button" data-action="delete" class="ml-4 px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition" aria-label="글 삭제">삭제</button>` : ''}</div></div></form></div>`;
                
                try {
                    await Promise.all([
                        ScriptLoader.loadEditor(),
                        ScriptLoader.loadExif() 
                    ]);
                    
                    DOM.$('#editorjs-holder').innerHTML = '';
                    DOM.$('#editorjs-holder').classList.remove('flex', 'items-center', 'justify-center', 'min-h-[400px]');
                    
                    let editorData = { blocks: [] };
                    if (post.refined_content) {
                        try { 
                            const parsed = JSON.parse(post.refined_content);
                            if (parsed && typeof parsed === 'object' && Array.isArray(parsed.blocks)) {
                                editorData = parsed;
                            }
                        }
                        catch(e) { console.warn("Failed to parse editor JSON, starting fresh.", e); }
                    }

                    // 전역 변수로 노출된 라이브러리 확인 및 사용
                    console.log('Available editor tools:', {
                        EditorJS: typeof window.EditorJS,
                        Header: typeof window.Header,
                        List: typeof window.List,
                        Checklist: typeof window.Checklist,
                        Quote: typeof window.Quote,
                        Delimiter: typeof window.Delimiter,
                        CodeTool: typeof window.CodeTool,
                        Table: typeof window.Table,
                        LinkTool: typeof window.LinkTool,
                        Marker: typeof window.Marker,
                        InlineCode: typeof window.InlineCode,
                        ImageTool: typeof window.ImageTool
                    });

                    // 필수 도구들이 로드되었는지 확인
                    if (!window.EditorJS) {
                        throw new Error('EditorJS가 로드되지 않았습니다.');
                    }

                    const tools = {};
                    
                    // 기본 도구들 추가 (사용 가능한 것만)
                    if (window.Header) tools.header = { class: window.Header, inlineToolbar: true };
                    if (window.List) tools.list = { class: window.List, inlineToolbar: true };
                    if (window.Checklist) tools.checklist = { class: window.Checklist, inlineToolbar: true };
                    if (window.Quote) tools.quote = { class: window.Quote, inlineToolbar: true };
                    if (window.Delimiter) tools.delimiter = window.Delimiter;
                    if (window.CodeTool) tools.code = window.CodeTool;
                    if (window.Table) tools.table = { class: window.Table, inlineToolbar: true };
                    if (window.Marker) tools.marker = { class: window.Marker, shortcut: 'CMD+SHIFT+M' };
                    if (window.InlineCode) tools.inlineCode = { class: window.InlineCode, shortcut: 'CMD+SHIFT+C' };
                    
                    // 링크 도구 (endpoint 없이 기본 설정)
                    if (window.LinkTool) {
                        tools.linkTool = { 
                            class: window.LinkTool,
                            config: {
                                endpoint: false // 자동 링크 미리보기 비활성화
                            }
                        };
                    }
                    
                    // 이미지 도구
                    if (window.ImageTool) {
                        tools.image = {
                            class: window.ImageTool,
                            config: {
                                uploader: {
                                    uploadByFile: (file) => this.uploadImageForEditor(file)
                                }
                            }
                        };
                    }

                    this.state.editorInstance = new window.EditorJS({
                        holder: 'editorjs-holder',
                        autofocus: false,
                        placeholder: '여기에 이야기를 작성하세요...',
                        data: editorData,
                        tools: tools,
                        // 모바일 최적화 설정
                        minHeight: 300,
                        defaultBlock: 'paragraph',
                        sanitizer: {
                            b: true,
                            i: true,
                            u: true,
                            s: true,
                            mark: true,
                            code: true,
                            kbd: true
                        },
                        // 인라인 툴바 설정 (모바일에서 중요)
                        inlineToolbar: ['bold', 'italic', 'link'],
                        // 툴박스 설정 (모바일에서 접근성 향상)
                        toolbox: {
                            display: ['paragraph', 'header', 'list', 'quote', 'delimiter', 'code', 'table', 'checklist', 'linkTool', 'marker', 'inlineCode']
                        },
                        onReady: () => { 
                            console.log('Editor.js is ready with tools:', Object.keys(tools));
                            // 모바일 환경 감지 및 최적화
                            this.optimizeEditorForMobile();
                        },
                    });

                } catch (libError) {
                    console.error("Failed to load editor libraries:", libError);
                    DOM.$('#editorjs-holder').innerHTML = `<p class="text-red-500">에디터를 불러오는 데 실패했습니다. 페이지를 새로고침해주세요.</p>`;
                }

                // 폼 이벤트 바인딩
                const form = DOM.$('#writer-form');
                if (!form) return;
                
                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (!this._validateForm()) return;
                    if (e.submitter?.dataset.action) {
                        this.handlePostSave(e.submitter.dataset.action, e.submitter);
                    }
                };
                
                const delBtn = form.querySelector('[data-action="delete"]');
                if (delBtn) {
                    delBtn.onclick = (e) => { 
                        e.preventDefault(); 
                        this.handlePostDelete(post.id); 
                    };
                }
            }
            
            _validateForm() {
                const title = DOM.$('#title')?.value.trim();
                const cat = DOM.$('#category')?.value;
                if (!title) { DOM.showToast('제목은 필수 항목입니다.', true); DOM.$('#title')?.focus(); return false; }
                if (!cat) { DOM.showToast('카테고리를 선택해주세요.', true); DOM.$('#category')?.focus(); return false; }
                if (!this.state.editorInstance) { DOM.showToast('에디터가 아직 로드되지 않았습니다.', true); return false; }
                return true;
            }

            // 모바일 에디터 최적화
            optimizeEditorForMobile() {
                const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    console.log('모바일 환경 감지됨 - 에디터 최적화 적용');
                    
                    // 에디터 컨테이너 스타일 조정
                    const editorHolder = DOM.$('#editorjs-holder');
                    if (editorHolder) {
                        editorHolder.style.minHeight = '250px';
                        editorHolder.style.fontSize = '16px'; // iOS 줌 방지
                        editorHolder.style.lineHeight = '1.6';
                    }
                    
                    // 툴박스 버튼 크기 조정
                    const style = document.createElement('style');
                    style.textContent = `
                        @media (max-width: 768px) {
                            .ce-toolbar__plus,
                            .ce-toolbar__settings-btn {
                                width: 44px !important;
                                height: 44px !important;
                                min-width: 44px !important;
                                min-height: 44px !important;
                            }
                            
                            .ce-toolbox {
                                max-height: 300px !important;
                                overflow-y: auto !important;
                            }
                            
                            .ce-toolbox__button {
                                padding: 12px !important;
                                min-height: 44px !important;
                                font-size: 14px !important;
                            }
                            
                            .ce-inline-toolbar {
                                transform: translateY(-50px) !important;
                            }
                            
                            .ce-inline-tool {
                                width: 44px !important;
                                height: 44px !important;
                                min-width: 44px !important;
                            }
                            
                            .ce-popover {
                                max-height: 250px !important;
                                overflow-y: auto !important;
                            }
                            
                            .cdx-input {
                                font-size: 16px !important;
                                padding: 12px !important;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                    
                    // 터치 이벤트 최적화
                    this.addMobileTouchHandlers();
                }
            }
            
            // 모바일 터치 이벤트 핸들러
            addMobileTouchHandlers() {
                const editorHolder = DOM.$('#editorjs-holder');
                if (!editorHolder) return;
                
                let touchStartY = 0;
                let touchStartTime = 0;
                
                editorHolder.addEventListener('touchstart', (e) => {
                    touchStartY = e.touches[0].clientY;
                    touchStartTime = Date.now();
                }, { passive: true });
                
                editorHolder.addEventListener('touchend', (e) => {
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchDuration = Date.now() - touchStartTime;
                    const touchDistance = Math.abs(touchEndY - touchStartY);
                    
                    // 짧은 탭으로 인식 (스크롤이 아닌)
                    if (touchDuration < 300 && touchDistance < 10) {
                        // 텍스트 선택 시 인라인 툴바 표시 지연
                        setTimeout(() => {
                            const selection = window.getSelection();
                            if (selection && selection.toString().length > 0) {
                                // 선택된 텍스트가 있으면 인라인 툴바가 표시되도록 함
                                console.log('텍스트 선택됨 - 인라인 툴바 활성화');
                            }
                        }, 100);
                    }
                }, { passive: true });
            }

            // --- 모달 렌더링 ---
            
            showAuthModal() {
                const modalId = 'auth-modal';
                const html = `<div id="auth-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative" role="document">
                    <button data-action="close-modal" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button>
                    <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2>
                    <p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p>
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500" aria-label="이메일 입력" autocomplete="email">
                        <button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button>
                    </form>
                </div>`;
                
                const modal = DOM.showModal(modalId, html);
                if (!modal) return;
                
                modal.querySelector('#auth-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const email = DOM.$('#email-input').value.trim();
                    if (!email) { DOM.showToast('이메일 입력해주세요.', true); return; }
                    const btn = e.target.querySelector('button');
                    btn.disabled = true; btn.textContent = '전송 중...';
                    
                    const { error } = await this.signIn(email); // Services.signIn -> this.signIn
                    
                    if (error) { 
                        DOM.showToast(`오류: ${error.message}`, true); 
                        btn.disabled = false; btn.textContent = '매직 링크 받기';
                    } else { 
                        DOM.showToast('이메일 확인해주세요!'); 
                        DOM.closeModal(modalId); 
                    }
                };
            }
            
            showDeleteConfirmModal(msg) {
                return new Promise(res => {
                    const modalId = 'delete-confirm-modal';
                    const html = `<div id="delete-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8" role="document">
                        <h3 id="delete-modal-title" class="sr-only">삭제 확인</h3>
                        <p class="text-center text-black text-lg mb-8">${msg}</p>
                        <div class="flex justify-center gap-4">
                            <button data-action="delete-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button>
                            <button data-action="delete-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button>
                        </div>
                    </div>`;
                    const modal = DOM.showModal(modalId, html);
                    if (!modal) return res(false);
                    modal.querySelector('[data-action="delete-yes"]').onclick = () => { DOM.closeModal(modalId); res(true); };
                    modal.querySelector('[data-action="delete-no"]').onclick = () => { DOM.closeModal(modalId); res(false); };
                });
            }

            // --- 메타 태그 업데이트 ---
            updateMetaTags(post = null) {
                const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
                const desc = post ? post.summary : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
                const url = post ? `${Config.SITE_URL}/post/${post.slug}` : Config.SITE_URL;
                const img = post?.thumbnail_url || null;
                
                document.title = title;
                DOM.$('meta[name="description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:title"]')?.setAttribute('content', title);
                DOM.$('meta[property="og:description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:url"]')?.setAttribute('content', url);
                DOM.$('link[rel="canonical"]')?.setAttribute('href', url);
                let ogImg = DOM.$('meta[property="og:image"]');
                if (img) {
                    if (ogImg) ogImg.setAttribute('content', img);
                    else {
                        ogImg = document.createElement('meta');
                        ogImg.setAttribute('property', 'og:image');
                        ogImg.setAttribute('content', img);
                        document.head.appendChild(ogImg);
                    }
                }
                const ld = DOM.$('#ld-json') || document.createElement('script');
                ld.type = 'application/ld+json';
                ld.id = 'ld-json';
                ld.textContent = JSON.stringify(post ? {
                    "@context": "https://schema.org", "@type": "BlogPosting",
                    "headline": post.title, "datePublished": post.created_at,
                    "dateModified": post.updated_at || post.created_at,
                    "author": { "@type": "Organization", "name": "InsureLog" },
                    "image": img ? [img] : undefined,
                    "mainEntityOfPage": { "@type": "WebPage", "@id": url },
                    "description": desc
                } : {
                    "@context": "https://schema.org", "@type": "WebSite",
                    "name": "InsureLog", "url": Config.SITE_URL, "description": desc
                });
                if (!DOM.$('#ld-json')) document.head.appendChild(ld);
            }

            // =================================================================
            // [Service Methods] (API 및 비즈니스 로직)
            // =================================================================
            
            signIn(email) {
                return this.supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: Config.SITE_URL } });
            }

            signOut() {
                return this.supabase.auth.signOut();
            }

            getPosts(page, category) {
                const { from, to } = { from: (page - 1) * Config.POSTS_PER_PAGE, to: page * Config.POSTS_PER_PAGE - 1 };
                let query = this.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, summary, category, thumbnail_url', { count: 'exact' });
                if (category !== '전체') query = query.eq('category', category);
                return query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);
            }

            getPostBySlug(slug) {
                return this.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, summary, category, thumbnail_url, refined_content, created_at, updated_at, author_id')
                    .eq('slug', slug)
                    .single();
            }

            getDashboardPosts(userId) {
                return this.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, status, created_at')
                    .eq('author_id', userId)
                    .order('created_at', { ascending: false });
            }

            getRelatedPosts(slug) {
                return this.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .eq('status', 'published')
                    .neq('slug', slug)
                    .order('view_count', { ascending: false, nullsFirst: false })
                    .limit(5);
            }

            getAdjacentPosts(createdAt) {
                const prev = this.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .lt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                const next = this.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .gt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: true })
                    .limit(1)
                    .maybeSingle();
                return Promise.all([prev, next]);
            }

            incrementViewCount(slug) {
                try {
                    const viewed = JSON.parse(sessionStorage.getItem('viewed_posts') || '[]');
                    if (!viewed.includes(slug)) {
                        this.supabase.rpc('increment_post_view', { post_slug: slug }).then(({error}) => {
                           if(error) console.warn("View count RPC error:", error);
                           else {
                                viewed.push(slug);
                                sessionStorage.setItem('viewed_posts', JSON.stringify(viewed));
                           }
                        });
                    }
                } catch (e) { console.warn('View count error:', e); }
            }

            savePost(data) {
                const id = data.id;
                delete data.id; 
                if (id) {
                    return this.supabase.from(Config.DB_TABLE_NAME).update(data).eq('id', id).select().single();
                } else {
                    return this.supabase.from(Config.DB_TABLE_NAME).insert(data).select().single();
                }
            }

            checkSlugExists(slug) {
                return this.supabase.from(Config.DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
            }

            deletePost(id) {
                // TODO: 스토리지의 이미지도 함께 삭제하는 로직을 추가하면 좋습니다.
                return this.supabase.from(Config.DB_TABLE_NAME).delete().eq('id', id);
            }

            async uploadImage(file) {
                const optimizedFile = await this.convertToWebP(file);
                let baseName = 'upload', ext = 'webp';
                if (optimizedFile.name) {
                    const parts = optimizedFile.name.split('.');
                    if (parts.length > 1) {
                        ext = parts.pop().toLowerCase();
                        baseName = parts.join('.').replace(/[^\w-]/g, '_');
                    } else {
                        baseName = optimizedFile.name.replace(/[^\w-]/g, '_');
                    }
                }
                if (!baseName) baseName = 'image';
                const path = `${this.state.user.id}/${baseName}-${Date.now()}.${ext}`;
                const { error } = await this.supabase.storage.from(Config.IMAGE_BUCKET_NAME).upload(path, optimizedFile, { upsert: true });
                if (error) throw new Error(`업로드 실패: ${error.message}`);
                const { data } = this.supabase.storage.from(Config.IMAGE_BUCKET_NAME).getPublicUrl(path);
                if (!data?.publicUrl) throw new Error('Public URL 실패');
                return data.publicUrl;
            }

            // =================================================================
            // [App Logic / Handlers] (기타 로직)
            // =================================================================

            async handleLogout() {
                try { 
                    await this.signOut(); 
                    DOM.showToast('로그아웃되었습니다.'); 
                } catch (e) { 
                    DOM.showToast('로그아웃 실패.', true);
                }
                this.navigateTo('/', true); // 홈으로 리다이렉트
            }

            async handlePostSave(action, btn) {
                if (!this.state.editorInstance) {
                    DOM.showToast('에디터가 준비되지 않았습니다.', true);
                    return;
                }
                const origText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;
                
                try {
                    const savedData = await this.state.editorInstance.save();
                    if (savedData.blocks.length === 0) {
                        DOM.showToast('본문은 필수 항목입니다.', true);
                        throw new Error('Content is empty.');
                    }
                    const title = DOM.$('#title').value.trim();
                    const status = action === 'publish' ? 'published' : 'draft';
                    let summary = DOM.$('#summary').value.trim();
                    if (!summary) {
                        const firstP = savedData.blocks.find(b => b.type === 'paragraph');
                        summary = firstP ? firstP.data.text.replace(/&nbsp;|<.*?>/g, ' ').replace(/\s+/g, ' ').slice(0, 150) + '...' : '';
                    }
                    const firstImg = savedData.blocks.find(b => b.type === 'image');
                    const thumb = firstImg ? firstImg.data.file.url : null;
                    const id = DOM.$('#post-id').value || null;
                    let slug = DOM.$('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    
                    if (!id) { // 새 글일 때만 슬러그 중복 검사
                        const { data } = await this.checkSlugExists(slug);
                        if (data) slug += `-${Date.now().toString().slice(-6)}`;
                    }

                    const postData = { id, title, slug, status, summary, author_id: this.state.user.id, refined_content: JSON.stringify(savedData), category: DOM.$('#category').value, thumbnail_url: thumb };
                    const { data: savedPost, error } = await this.savePost(postData);
                    
                    if (error) throw error;
                    
                    DOM.showToast(status === 'published' ? '발행되었습니다!' : '저장되었습니다.');
                    this.navigateTo(status === 'published' ? `/post/${savedPost.slug}` : '/dashboard');

                } catch (e) {
                    console.error("Save error:", e);
                    if (e.message !== 'Content is empty.') {
                        DOM.showToast(`저장 실패: ${e.message}`, true);
                    }
                } finally {
                    btn.disabled = false;
                    btn.textContent = origText;
                }
            }

            async handlePostDelete(id) {
                if (!id) return;
                const confirm = await this.showDeleteConfirmModal('정말 삭제하시겠습니까? 되돌릴 수 없습니다.');
                if (!confirm) return;
                
                DOM.showToast('삭제 중...');
                const { error } = await this.deletePost(id);
                if (error) {
                    DOM.showToast(`삭제 실패: ${error.message}`, true);
                } else {
                    DOM.showToast('삭제되었습니다.');
                    this.navigateTo('/dashboard');
                }
            }

            async uploadImageForEditor(file) {
                try {
                    DOM.showToast('이미지 업로드 및 변환 중...');
                    const url = await this.uploadImage(file); 
                    DOM.showToast('업로드 완료!', false);
                    return { success: 1, file: { url: url } };
                } catch (e) {
                    console.error('Editor image upload failed:', e);
                    DOM.showToast(`이미지 업로드 실패: ${e.message}`, true);
                    return { success: 0 };
                }
            }

            // --- 이미지 유틸리티 ---
            getOrientation(file) {
                return new Promise((res) => {
                    if (typeof EXIF === 'undefined') { 
                        res(1); 
                        return; 
                    }
                    EXIF.getData(file, function() { 
                        res(EXIF.getTag(this, 'Orientation') || 1);
                    });
                });
            }

            convertToWebP(file, quality = 0.8) {
                return new Promise((res) => {
                    if (typeof FileReader === 'undefined' || typeof Image === 'undefined' || typeof EXIF === 'undefined' || file.type === 'image/webp' || file.type === 'image/gif') {
                        res(file);
                        return;
                    }
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async (e) => {
                        const img = new Image(); 
                        img.src = e.target.result;
                        img.onload = async () => {
                            const orient = await this.getOrientation(file);
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                res(file);
                                return;
                            }
                            let w = img.width, h = img.height;
                            if (orient >= 5 && orient <= 8) { [w, h] = [h, w]; }
                            canvas.width = w; canvas.height = h;
                            const transforms = {2: [-1,0,0,1,w,0], 3: [-1,0,0,-1,w,h], 4: [1,0,0,-1,0,h], 5: [0,1,1,0,0,0], 6: [0,1,-1,0,h,0], 7: [0,-1,-1,0,h,w], 8: [0,-1,1,0,0,w]};
                            ctx.transform(...(transforms[orient] || [1,0,0,1,0,0]));
                            if (orient >= 5 && orient <= 8) {
                                 ctx.drawImage(img, 0, 0, img.height, img.width);
                            } else {
                                 ctx.drawImage(img, 0, 0, img.width, img.height);
                            }
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    let baseName = file.name ? file.name.split('.').slice(0, -1).join('.') : 'image';
                                    const webpFile = new File([blob], `${baseName}.webp`, { type: 'image/webp' });
                                    res(webpFile);
                                } else {
                                     res(file);
                                }
                            }, 'image/webp', quality);
                        };
                        img.onerror = () => res(file);
                    };
                    reader.onerror = () => res(file);
                });
            }
        }

        // --- [APP START] ---
        // DOMContentLoaded 이벤트 발생 시 BlogApp 클래스의 인스턴스를 생성하여 앱을 시작합니다.
        document.addEventListener('DOMContentLoaded', () => {
            new BlogApp();
        });

    </script>
</body>
</html>


