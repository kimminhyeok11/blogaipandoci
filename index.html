<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    <!-- 
      [CSP] 
      - nonce="r4nd0m"을 메인 스크립트에 적용했습니다.
      - 'unsafe-eval'은 Supabase-js v2의 ES module에서 필요할 수 있습니다.
      - 'unsafe-inline'은 Tailwind CSS의 JIT 엔진 및 Quill 툴바 스타일에 필요합니다.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.quilljs.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://cdn.quilljs.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    <meta property="og:site_name" content="InsureLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Scripts & Stylesheets (OPTIMIZED: Deferred loading where possible) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <!-- quill-better-table CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.css">
    
    <!-- *** FIX: highlight.js BEFORE quill.js *** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" defer crossorigin="anonymous"></script>
    <!-- quill-better-table JS -->
    <!-- [FIX] crossorigin="anonymous" 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.js" defer crossorigin="anonymous"></script>
    
    <!-- DOMPurify & EXIF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer crossorigin="anonymous"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.quilljs.com" crossorigin>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>

    <!-- 
      [STYLE]
      - 모든 스타일을 이 <style> 태그 안으로 통합했습니다.
      - CSS 변수, prose-custom (콘텐츠 스타일), Quill 에디터 오버라이드 등을 포함합니다.
    -->
    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            line-height: 1.7;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; line-height: 1.75; }
        }
        main#app-container {
            padding-left: 0.75rem; padding-right: 0.75rem; flex-grow: 1;
        }
        @media (min-width: 640px) {
            main#app-container { padding-left: 1rem; padding-right: 1rem; }
        }
        /* [View] 뷰 전환을 위한 기본 클래스 */
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }

        /* [Prose] 블로그 포스트 콘텐츠 스타일 */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom p { margin: 0 0 1.3em; color: var(--text-secondary); }
        .prose-custom div { margin-bottom: 1.3em; }
        .prose-custom p br { display: block; margin-bottom: 0.75em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.3em; }
        .prose-custom ul { list-style-type: disc; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom ol { list-style-type: decimal; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { margin-top: 0.5em; margin-bottom: 0.5em; margin-left: 1.25em; }
        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        
        /* [FIX] 데스크탑 이미지 크기 수정 */
        .prose-custom img { 
            max-width: 90%; /* 100% -> 90%로 변경 */
            height: auto; 
            border-radius: 12px; 
            margin-top: 2em; 
            margin-bottom: 2em; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            display: block; /* 가운데 정렬을 위해 추가 */
            margin-left: auto; /* 가운데 정렬을 위해 추가 */
            margin-right: auto; /* 가운데 정렬을 위해 추가 */
        }
        
        .prose-custom table { width: 100%; border-collapse: collapse; margin-top: 2em; margin-bottom: 2em; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-radius: 8px; overflow: hidden; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 0.75em 1em; text-align: left; }
        .prose-custom th { background-color: var(--bg-content-secondary); font-weight: 700; color: var(--text-primary); }
        .prose-custom tr:nth-child(odd) { background-color: var(--bg-main); }
        .prose-custom tr:nth-child(even) { background-color: var(--bg-content-secondary); }

        /* [Components] 재사용 가능한 UI 요소 */
        .category-btn { transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem; font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent; }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* [Quill] 에디터 스타일 오버라이드 */
        #quill-editor { min-height: 400px; font-size: 16px; }
        #quill-editor .ql-editor p, #quill-editor .ql-editor div { margin: 0 0 1em; }
        #quill-editor .ql-editor p br { display: block; margin-bottom: 0.6em; }
        .ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #D1D5DB; }
        .ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #D1D5DB; }
        #quill-editor-container { position: relative; }

        /* [Responsive] 모바일 반응형 */
        @media (max-width: 639px) {
            .writer-controls-sticky { 
                position: sticky; bottom: 0; background-color: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
                padding: 1rem; border-top: 1px solid #E5E7EB; 
                margin-left: -0.75rem; margin-right: -0.75rem; 
                padding-top: 1rem !important; z-index: 30; 
            }
            .prose-custom img { 
                width: calc(100% + 1.5rem); 
                margin-left: -0.75rem; 
                margin-right: -0.75rem; 
                max-width: none; /* [FIX] 데스크탑의 90% 제한을 모바일에서 해제 */
                border-radius: 0; 
                box-shadow: none; 
            }
        }
        .post-thumbnail img { loading: lazy; }

        /* [Accessibility] 포커스 링 */
        button:focus, a:focus, input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--accent); outline-offset: 2px; 
        }

        /* [Motion] 접근성 - 움직임 최소화 */
        @media (prefers-reduced-motion: reduce) { 
            *, *::before, *::after { 
                animation-duration: 0.01ms !important; 
                animation-iteration-count: 1 !important; 
                transition-duration: 0.01ms !important; 
            } 
        }

        /* [Layout] 푸터 여백 */
        footer { margin-top: 16px; } 
        @media (min-width: 640px) { footer { margin-top: 24px; } }
    </style>
</head>
<body class="antialiased">
    <!-- 앱 로더 -->
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    
    <!-- 헤더 (네비게이션) -->
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    
    <!-- 메인 콘텐츠 (뷰가 렌더링되는 곳) -->
    <main id="app-container" class="w-full">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>

    <!-- 푸터 -->
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>

    <!-- 모달 및 토스트 컨테이너 -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <!-- 
      ==================================================================
      [APP SCRIPT] - 메인 애플리케이션 (모듈형 리팩터링)
      - CSP 오류 수정을 위해 nonce="r4nd0m"을 추가했습니다.
      - 코드를 기능별 객체로 분리했습니다 (Config, State, DOM, Services, QuillEditor, ViewRenderer, Router, App).
      ==================================================================
    -->
    <script type="module" nonce="r4nd0m">
        // [Supabase] ES 모듈 임포트
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        /**
         * [Module: Config]
         * 애플리케이션의 모든 설정을 관리합니다.
         */
        const Config = {
            SITE_URL: 'https://blogaipandoci.vercel.app',
            SUPABASE_URL: 'https://ddehwkwzmmvcxltlplua.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To',
            IMAGE_BUCKET_NAME: 'thought-images', 
            DB_TABLE_NAME: 'posts', 
            POSTS_PER_PAGE: 10,
            CATEGORIES: ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"]
        };

        /**
         * [Module: State]
         * 전역 상태를 관리합니다. (사용자, 인증 상태, 현재 카테고리 등)
         */
        const State = {
            user: null,
            isAuthReady: false,
            currentCategory: '전체',
            supabase: null,
        };

        /**
         * [Module: DOM]
         * DOM 조작과 관련된 헬퍼 함수들을 관리합니다.
         */
        const DOM = {
            $: document.querySelector.bind(document),
            
            animateSwitch: (el, show = true) => {
                if (!el) return Promise.resolve();
                const opts = show ? { opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' } : { opacity: 0, duration: 200, easing: 'easeInQuad' };
                if (typeof anime === 'function') {
                    return anime({ targets: el, ...opts }).finished;
                } else {
                    el.style.opacity = show ? 1 : 0;
                    return Promise.resolve();
                }
            },

            showToast: (msg, err = false) => {
                const toast = document.createElement('div');
                toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${err ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
                toast.textContent = msg;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'polite');
                DOM.$('#toast-container').appendChild(toast);
                DOM.animateSwitch(toast, true);
                setTimeout(() => DOM.animateSwitch(toast, false).then(() => toast.remove()), 3000);
            },

            showModal: (id, html) => {
                if (DOM.$(`#${id}`)) return;
                const container = DOM.$('#modal-container');
                const modalWrapper = document.createElement('div');
                modalWrapper.id = id;
                modalWrapper.className = "fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4";
                modalWrapper.setAttribute('role', 'dialog');
                modalWrapper.setAttribute('aria-modal', 'true');
                modalWrapper.innerHTML = html;
                container.appendChild(modalWrapper);
                
                const content = modalWrapper.querySelector('.modal-content');
                
                DOM.animateSwitch(modalWrapper);
                if (content) DOM.animateSwitch(content, true);

                return modalWrapper;
            },

            closeModal: (id) => {
                const modal = DOM.$(`#${id}`);
                if (!modal) return Promise.resolve();
                return DOM.animateSwitch(modal, false).then(() => modal.remove());
            },

            buildUrl: (path, params) => {
                const url = new URL(path, Config.SITE_URL);
                Object.entries(params).forEach(([k, v]) => {
                    if (v !== undefined && v !== null && v !== '전체' && v !== '') url.searchParams.append(k, v);
                });
                return url.pathname + url.search;
            },

            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }
        };

        /**
         * [Module: Services]
         * Supabase API 호출 등 백엔드 통신을 관리합니다.
         */
        const Services = {
            init: () => {
                State.supabase = createClient(Config.SUPABASE_URL, Config.SUPABASE_ANON_KEY);
            },

            onAuthChange: (callback) => {
                return State.supabase.auth.onAuthStateChange((_, session) => {
                    callback(session?.user || null);
                });
            },

            signIn: (email) => {
                return State.supabase.auth.signInWithOtp({ 
                    email, 
                    options: { emailRedirectTo: Config.SITE_URL } 
                });
            },

            signOut: () => {
                return State.supabase.auth.signOut();
            },

            getPosts: (page, category) => {
                const { from, to } = { from: (page - 1) * Config.POSTS_PER_PAGE, to: page * Config.POSTS_PER_PAGE - 1 };
                let query = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, summary, category, thumbnail_url', { count: 'exact' });
                if (category !== '전체') query = query.eq('category', category);
                return query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);
            },

            getPostBySlug: (slug) => {
                return State.supabase.from(Config.DB_TABLE_NAME).select('*').eq('slug', slug).single();
            },

            getDashboardPosts: (userId) => {
                return State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, status, created_at')
                    .eq('author_id', userId)
                    .order('created_at', { ascending: false });
            },

            getRelatedPosts: (slug) => {
                const popular = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .eq('status', 'published')
                    .neq('slug', slug)
                    .order('view_count', { ascending: false, nullsFirst: false })
                    .limit(5);
                return popular;
            },

            getAdjacentPosts: (createdAt) => {
                 const prev = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .lt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false })
                    .limit(1).single();
                const next = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .gt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: true })
                    .limit(1).single();
                return Promise.all([prev, next]);
            },

            incrementViewCount: (slug) => {
                try {
                    const viewed = JSON.parse(sessionStorage.getItem('viewed_posts') || '[]');
                    if (!viewed.includes(slug)) { // slug 기반으로 변경
                        State.supabase.rpc('increment_post_view', { post_slug: slug }).then(({error}) => {
                           if(error) console.warn("View count RPC error:", error);
                           else {
                                viewed.push(slug);
                                sessionStorage.setItem('viewed_posts', JSON.stringify(viewed));
                           }
                        });
                    }
                } catch (e) { console.warn('View count error:', e); }
            },
            
            savePost: (data) => {
                const id = data.id;
                delete data.id; // insert/update 객체에서 id 제거
                if (id) {
                    // Update
                    return State.supabase.from(Config.DB_TABLE_NAME).update(data).eq('id', id).select().single();
                } else {
                    // Insert
                    return State.supabase.from(Config.DB_TABLE_NAME).insert(data).select().single();
                }
            },

            checkSlugExists: (slug) => {
                return State.supabase.from(Config.DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
            },

            deletePost: (id) => {
                return State.supabase.from(Config.DB_TABLE_NAME).delete().eq('id', id);
            },

            uploadImage: async (file) => {
                let baseName = 'upload';
                let ext = 'bin';

                if (file.name) {
                    const parts = file.name.split('.');
                    if (parts.length > 1) {
                        ext = parts.pop().toLowerCase();
                        baseName = parts.join('.');
                    } else {
                        baseName = file.name;
                    }
                }
                
                // 파일 타입에서 확장자 추론 (이름에 없는 경우)
                if(ext === 'bin' || !file.name) {
                     if (file.type === 'image/jpeg') ext = 'jpg';
                     else if (file.type === 'image/png') ext = 'png';
                     else if (file.type === 'image/webp') ext = 'webp';
                     else if (file.type === 'image/gif') ext = 'gif';
                     else if (file.type === 'image/svg+xml') ext = 'svg';
                }

                let sanitizedBaseName = baseName.replace(/[^\w-]/g, '_');
                if (!sanitizedBaseName || sanitizedBaseName.startsWith('-')) {
                    sanitizedBaseName = 'image';
                }
                
                const path = `${State.user.id}/${sanitizedBaseName}-${Date.now()}.${ext}`;

                const { error } = await State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).upload(path, file, { upsert: true });
                if (error) throw new Error(`업로드 실패: ${error.message}`);
                
                const { data } = State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).getPublicUrl(path);
                if (!data?.publicUrl) throw new Error('Public URL 실패');
                return data.publicUrl;
            }
        };

        /**
         * [Module: QuillEditor]
         * Quill 에디터의 생성, 관리, 이미지 핸들링을 담당합니다.
         */
        const QuillEditor = {
            instance: null,
            
            init: (containerSelector, loaderSelector) => new Promise((resolve, reject) => {
                const loader = DOM.$(loaderSelector);
                if (!loader) return reject(new Error("Loader not found"));
                
                loader.style.display = 'flex';
                
                // [FIX] 에디터 로딩 로직 수정
                const attempt = (retries = 20) => { // 500ms * 20 = 10초 대기
                    if (retries <= 0) {
                        loader.innerHTML = '<p class="text-red-500 font-bold p-4 text-center">에디터를 불러오지 못했습니다.<br>페이지를 새로고침 해주세요.</p>';
                        // [FIX] 에러 메시지를 Quill/BetterTable 로드 실패로 변경
                        return reject(new Error("Quill/QuillBetterTable 스크립트 로드 실패"));
                    }

                    // [FIX] 1. Quill이 로드되었는지 먼저 확인합니다.
                    if (typeof Quill === 'undefined') {
                        console.log('Waiting for Quill.js...');
                        setTimeout(() => attempt(retries - 1), 500);
                        return; // Quill이 없으면 재시도
                    }

                    // [FIX] 2. Quill 로드됨. 이제 QuillBetterTable을 확인합니다.
                    // QuillBetterTable 스크립트가 로드되면 window.QuillBetterTable을 생성합니다.
                    if (typeof window.QuillBetterTable === 'undefined') {
                        // BetterTable이 아직 로드되지 않았습니다.
                        console.log('Waiting for QuillBetterTable.js...');
                        setTimeout(() => attempt(retries - 1), 500);
                        return; // 재시도
                    }

                    // [FIX] 3. Quill과 QuillBetterTable 모두 로드되었습니다.
                    try {
                        console.log('Quill and QuillBetterTable are loaded.');

                        // [SOLUTION START]
                        // Quill.import('delta')가 준비되었는지 확인합니다.
                        // 이 모듈이 준비되지 않으면 492, 507, 519번 라인에서 모두 오류가 발생합니다.
                        if (typeof Quill.import !== 'function' || !Quill.import('delta')) {
                            console.log('Quill.import("delta") is not ready yet. Retrying...');
                            setTimeout(() => attempt(retries - 1), 500); // 재시도
                            return; // 현재 시도 중단
                        }
                        // [SOLUTION END]
                    
                        // BetterTable 모듈을 등록합니다.
                        if (!Quill.imports || !Quill.imports['modules/better-table']) {
                            Quill.register({ 'modules/better-table': window.QuillBetterTable }, true);
                            console.log('QuillBetterTable registered successfully.');
                        }

                        // Delta 모듈을 임포트합니다.
                        // const Delta = Quill.import('delta'); // -> 이 변수는 이제 사용되지 않습니다 (클립보드 매처가 직접 import 호출).
                        // if (!Delta) { // -> 이 검사는 [SOLUTION] 블록에서 위로 이동하여 재시도 로직으로 변경되었습니다.
                        //     // Quill은 로드됐지만 Delta 모듈 임포트 실패
                        //     throw new Error("Quill Delta module could not be imported.");
                        // }
                        
                        const modules = {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }], 
                                ['bold', 'italic', 'underline', 'strike'], 
                                [{ 'color': [] }, { 'background': [] }], // 색상, 배경색 추가
                                ['blockquote', 'code-block'], 
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                                [{ 'align': [] }], // 정렬 추가
                                [{ 'indent': '-1'}, { 'indent': '+1' }], 
                                ['link', 'image'], 
                                ['clean']
                            ],
                            history: { delay: 5000, userOnly: true },
                            clipboard: {
                                matchers: [
                                    ['span', (node, delta) => {
                                        const attributes = {};
                                        if (node.style.color) attributes.color = node.style.color;
                                        if (node.style.backgroundColor) attributes.background = node.style.backgroundColor;
                                        
                                        if (Object.keys(attributes).length > 0) {
                                            // [FIX] const Delta 변수 대신 Quill.import('delta')를 직접 사용 (이 코드는 이미 올바르게 수정되어 있습니다)
                                            return delta.compose(new (Quill.import('delta'))().retain(delta.length(), attributes));
                                        }
                                        return delta;
                                    }],
                                    ['p, h1, h2, h3, h4, li, div', (node, delta) => {
                                        if (node.style.textAlign) {
                                            const align = node.style.textAlign.toLowerCase();
                                            if (['center', 'right', 'justify'].includes(align)) {
                                                // [FIX] const Delta 변수 대신 Quill.import('delta')를 직접 사용 (이 코드는 이미 올바르게 수정되어 있습니다)
                                                return delta.compose(new (Quill.import('delta'))().retain(delta.length(), { align: align }));
                                            }
                                        }
                                        return delta;
                                    }]
                                ]
                            }
                        };

                        // [FIX] 모듈 등록 여부를 다시 확인
                        if (Quill.imports && Quill.imports['modules/better-table']) {
                            modules['better-table'] = {
                                operationMenu: {
                                    items: {
                                        unmergeCells: { text: '셀 병합 해제' },
                                        deleteRow: { text: '행 삭제' },
                                        deleteColumn: { text: '열 삭제' },
                                        insertRowAbove: { text: '위에 행 삽입' },
                                        insertRowBelow: { text: '아래에 행 삽입' },
                                        insertColumnLeft: { text: '왼쪽에 열 삽입' },
                                        insertColumnRight: { text: '오른쪽에 열 삽입' },
                                        deleteTable: { text: '표 삭제' }
                                    }
                                }
                            };
                            // [FIX] window.QuillBetterTable을 사용
                            modules.keyboard = { bindings: window.QuillBetterTable.keyboardBindings };
                        } else {
                            console.warn('quill-better-table module failed to load. Table button will be hidden.');
                        }

                        QuillEditor.instance = new Quill(containerSelector, {
                            theme: 'snow',
                            modules
                        });
                        
                        QuillEditor.instance.getModule('toolbar').addHandler('image', QuillEditor.imageHandler);
                        
                        loader.style.display = 'none'; // 성공 시 로더 숨김
                        resolve(QuillEditor.instance);

                    } catch (e) {
                        // Delta 임포트 실패 또는 모듈 구성 오류
                        console.error("Quill init failed inside attempt:", e);
                        loader.innerHTML = `<p class="text-red-500 font-bold p-4 text-center">에디터 모듈 구성 오류.<br>새로고침 해주세요.</p>`;
                        return reject(e); // Promise 거부
                    }

                };
                
                attempt();
            }),


            destroy: () => {
                if (QuillEditor.instance) {
                    QuillEditor.instance = null;
                }
            },

            // [FIX] 본문 로딩 오류 수정
            setContent: (html) => {
                const quill = QuillEditor.instance;
                if (!quill) return;
                try {
                    // `dangerouslyPasteHTML` 대신 `innerHTML`을 사용해야
                    // 외부 붙여넣기 로직(matcher)을 타지 않고 저장된 내용을 그대로 로드합니다.
                    quill.root.innerHTML = html; 
                    quill.setSelection(quill.getLength(), 0, 'silent');
                } catch (e) { 
                    console.error("Error setting content:", e); 
                    quill.root.innerHTML = `<p style="color: red; font-weight: bold;">[오류] 본문을 불러오는 데 실패했습니다.</p>`;
                }
            },

            imageHandler: () => {
                const quill = QuillEditor.instance;
                if (!quill) return DOM.showToast('에디터가 준비되지 않았습니다.', true);

                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*'; input.click();
                
                input.onchange = async () => {
                    const file = input.files[0];
                    if (!file) return;

                    DOM.showToast('이미지 업로드 중...');
                    const range = quill.getSelection(true);
                    quill.enable(false);

                    try {
                        const supportedTypesForConversion = ['image/jpeg', 'image/png', 'image/bmp'];
                        let fileToUpload;

                        if (supportedTypesForConversion.includes(file.type)) {
                            DOM.showToast('이미지 최적화 중...');
                            fileToUpload = await QuillEditor.convertToWebP(file);
                        } else {
                            fileToUpload = file;
                        }

                        const url = await Services.uploadImage(fileToUpload);
                        quill.enable(true);
                        quill.insertEmbed(range.index, 'image', url);
                        quill.setSelection(range.index + 1, 'silent');
                        DOM.showToast('업로드 완료!', false);
                    } catch (e) {
                        console.error('Upload failed:', e);
                        DOM.showToast(`이미지 업로드 실패: ${e.message}`, true);
                        quill.enable(true);
                    }
                };
            },

            getOrientation: (file) => new Promise((res) => {
                if (typeof EXIF === 'undefined') { res(1); return; }
                EXIF.getData(file, function() { 
                    res(EXIF.getTag(this, 'Orientation') || 1);
                });
            }),

            convertToWebP: (file, quality = 0.8) => new Promise((res) => {
                if (typeof FileReader === 'undefined' || typeof Image === 'undefined' || typeof EXIF === 'undefined') {
                    console.warn('WebP 변환 API 미지원. 원본 파일 사용.');
                    res(file);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async (e) => {
                    const img = new Image(); 
                    img.src = e.target.result;
                    img.onload = async () => {
                        const orient = await QuillEditor.getOrientation(file);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height;
                        if (orient >= 5 && orient <= 8) { [w, h] = [h, w]; }
                        canvas.width = w; canvas.height = h;
                        const transforms = {2: [-1,0,0,1,w,0], 3: [-1,0,0,-1,w,h], 4: [1,0,0,-1,0,h], 5: [0,1,1,0,0,0], 6: [0,1,-1,0,h,0], 7: [0,-1,-1,0,h,w], 8: [0,-1,1,0,0,w]};
                        ctx.transform(...(transforms[orient] || [1,0,0,1,0,0]));
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                let baseName = file.name ? file.name.split('.').slice(0, -1).join('.') : 'image';
                                const webpFile = new File([blob], `${baseName}.webp`, { type: 'image/webp' });
                                res(webpFile);
                            } else {
                                 res(file); // 변환 실패 시 원본
                            }
                        }, 'image/webp', quality);
                    };
                    img.onerror = () => res(file); // 이미지 로드 실패 시 원본
                };
                reader.onerror = () => res(file); // 리더 실패 시 원본
            })
        };

        /**
         * [Module: ViewRenderer]
         * 각 뷰(페이지)의 HTML 렌더링을 담당합니다.
         */
        const ViewRenderer = {
            _templates: {
                nav: (user) => `
                    <nav class="w-full flex items-center justify-between py-2 px-4 sm:py-3 sm:px-5 bg-white/50 backdrop-blur-xl border border-black/10 rounded-3xl shadow-lg" role="banner">
                        <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter" aria-label="InsureLog 홈으로 이동">InsureLog</a>
                        <div class="flex items-center space-x-3">
                            ${user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="대시보드로 이동">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="로그아웃">로그아웃</button>` : `<button data-action="auth" aria-label="로그인 또는 회원가입" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition">로그인 / 가입</button>`}
                        </div>
                    </nav>`,
                categoryBtns: (category) => ['전체', ...Config.CATEGORIES].map(cat => `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}" aria-pressed="${cat === category}">${cat}</button>`).join(''),
                pagination: (page, total, basePath, params) => {
                    const totalPages = Math.ceil(total / Config.POSTS_PER_PAGE);
                    if (totalPages <= 1) return '';
                    const prevUrl = page > 1 ? DOM.buildUrl(basePath, { ...params, page: page - 1 }) : '#';
                    const nextUrl = page < totalPages ? DOM.buildUrl(basePath, { ...params, page: page + 1 }) : '#';
                    return `<div class="flex justify-center items-center gap-4 mt-12" role="navigation" aria-label="페이지 탐색"><a href="${prevUrl}" data-route aria-label="이전 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${page} / ${totalPages}</span><a href="${nextUrl}" data-route aria-label="다음 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
                }
            },

            renderNav: () => {
                DOM.$('#main-nav-container').innerHTML = ViewRenderer._templates.nav(State.user);
            },

            renderLibrary: async (container, page, category) => {
                ViewRenderer.updateMetaTags();
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                        <div class="flex items-center justify-center gap-2 mb-8 flex-wrap" role="tablist">${ViewRenderer._templates.categoryBtns(category)}</div>
                        <div id="post-list-container" class="border border-gray-200/80 rounded-2xl overflow-hidden min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>
                    </div>`;
                
                const { data: posts, error, count } = await Services.getPosts(page, category);
                const listContainer = DOM.$('#post-list-container');
                if (error) {
                    console.error("Error fetching posts:", error);
                    listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                    return;
                }
                
                const total = count ?? 0;
                const safePosts = Array.isArray(posts) ? posts : [];
                const postsHtml = safePosts.length > 0
                    ? `<div class="divide-y divide-gray-200/80">${safePosts.map(post => {
                        const thumb = post.thumbnail_url ? `<div class="w-24 h-16 sm:w-32 sm:h-20 flex-shrink-0 mr-4 sm:mr-5"><img src="${post.thumbnail_url}" alt="${post.title} 썸네일" class="w-full h-full object-cover rounded-lg bg-gray-100 post-thumbnail"></div>` : '';
                        return `<a href="/post/${post.slug}" data-route class="flex items-center p-4 transition-all duration-300 bg-transparent hover:bg-gray-50/80" role="article">${thumb}<div class="flex-grow"><p class="text-xs font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-sm font-bold">${post.title}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-2">${post.summary || ''}</p></div></a>`;
                    }).join('')}</div>`
                    : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${State.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
                
                listContainer.innerHTML = `${postsHtml}${ViewRenderer._templates.pagination(page, total, '/', { category })}`;
                listContainer.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
            },

            renderPost: async (container, slug) => {
                const { data: post, error } = await Services.getPostBySlug(slug);
                if (error || !post) {
                    console.error("Error fetching post:", slug, error);
                    DOM.showToast('글을 찾을 수 없습니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                Services.incrementViewCount(slug); // 조회수 증가 (id 대신 slug)

                const { data: popular } = await Services.getRelatedPosts(slug);
                const [{ data: prev }, { data: next }] = await Services.getAdjacentPosts(post.created_at);

                const popularHtml = popular?.length > 0 ? `<div class="mt-20"><h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2><div class="border-t border-gray-200">${popular.map(p => `<a href="/post/${p.slug}" data-route class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50" role="link"><h4 class="font-semibold text-gray-800 text-base">${p.title}</h4></a>`).join('')}</div></div>` : '';
                const navHtml = `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10" role="navigation" aria-label="이전/다음 글 탐색"><div>${prev ? `<a href="/post/${prev.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${prev.title}</h4></a>` : ''}</div><div class="text-left md:text-right">${next ? `<a href="/post/${next.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${next.title}</h4></a>` : ''}</div></nav>`;
                
                ViewRenderer.updateMetaTags(post);
                const editBtn = (State.user && State.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200" aria-label="글 수정">수정</a>` : '';
                
                const adTestAttr = ['localhost','127.0.0.1'].includes(window.location.hostname) ? ' data-adtest="on"' : '';
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <article role="article">
                            <header class="mb-8 sm:mb-12">
                                <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                                <h1 class="text-3xl sm:text-4xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    ${editBtn}
                                </div>
                            </header>
                            <div id="post-content" class="prose-custom max-w-none"></div>
                        </article>
                        <div class="my-16"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"${adTestAttr}></ins></div>
                        ${popularHtml}${navHtml}
                    </div>`;
                
                // [FIX] DOMPurify 테이블 스타일 허용
                if (typeof DOMPurify !== 'undefined') {
                    if (!window.__dompurifyHooked) {
                        DOMPurify.addHook('uponSanitizeAttribute', function(node, data) {
                            if (data.attrName === 'style') {
                                try {
                                    const style = (data.attrValue || '').toLowerCase();
                                    const allowedStyles = [];
                                    
                                    const mAlign = style.match(/text-align\s*:\s*(left|center|right|justify)/);
                                    if (mAlign) allowedStyles.push(`text-align:${mAlign[1]}`);
                                    
                                    const mWidth = style.match(/(?:^|;|\s)width\s*:\s*([0-9]+(?:\.[0-9]+)?)(px|%)/);
                                    if (mWidth) allowedStyles.push(`width:${mWidth[1]}${mWidth[2]}`);

                                    const mBgColor = style.match(/background-color\s*:\s*(#[0-9a-f]{3,8}|rgb\([0-9,\s]+\)|rgba\([0-9,.\s]+\))/);
                                    if (mBgColor) allowedStyles.push(`background-color:${mBgColor[1]}`);

                                    const mBorder = style.match(/border\s*:\s*([0-9]+px\s+(solid|dotted|dashed)\s+(#[0-9a-f]{3,8}|rgb\([0-9,\s]+\)|rgba\([0-9,.\s]+\)))/);
                                    if (mBorder) allowedStyles.push(`border:${mBorder[1]}`);

                                    const mPadding = style.match(/padding\s*:\s*([0-9]+(px|em|rem)(\s+[0-9]+(px|em|rem))?)/);
                                    if (mPadding) allowedStyles.push(`padding:${mPadding[1]}`);
                                    
                                    // [FIX] 붙여넣기 기능 강화에 맞춰 color 속성 허용
                                    const mColor = style.match(/color\s*:\s*(#[0-9a-f]{3,8}|rgb\([0-9,\s]+\)|rgba\([0-9,.\s]+\))/);
                                    if (mColor) allowedStyles.push(`color:${mColor[1]}`);

                                    data.attrValue = allowedStyles.join(';');
                                    if (!data.attrValue) data.keepAttr = false;
                                } catch (_) { data.keepAttr = false; }
                            }
                        });
                        window.__dompurifyHooked = true;
                    }
                    const safeContent = DOMPurify.sanitize(post.refined_content || '', { 
                        ADD_TAGS: ["iframe", "table", "tr", "td", "th", "tbody", "thead", "tfoot", "col", "colgroup", "span"], 
                        ADD_ATTR: ["rowspan","colspan","style","class","width","height","align"] 
                    });
                    DOM.$('#post-content').innerHTML = safeContent;
                } else {
                    DOM.$('#post-content').innerHTML = post.refined_content || ''; // DOMPurify 로드 실패 시
                }
                
                try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.warn("Adsense error:", e); }
                
                setTimeout(() => {
                    if (typeof hljs !== 'undefined') {
                        DOM.$('#post-content').querySelectorAll('pre code').forEach(hljs.highlightElement);
                    }
                    DOM.$('#post-content').querySelectorAll('img').forEach(img => { img.loading = 'lazy'; img.decoding = 'async'; });
                    DOM.$('#post-content').querySelectorAll('a[target="_blank"]').forEach(a => { a.rel = 'noopener noreferrer'; });
                }, 100);
            },

            renderDashboard: async (container) => {
                ViewRenderer.updateMetaTags({ title: '대시보드' });
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><div class="flex justify-between items-center mb-8 sm:mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]" aria-label="새 글 작성">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2 min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div>`;
                
                if (!State.user) return;
                const { data: posts, error } = await Services.getDashboardPosts(State.user.id);
                const list = DOM.$('#dashboard-post-list');
                
                if (error) {
                    list.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>';
                    return;
                }
                if (!posts?.length) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>';
                    return;
                }
                list.innerHTML = `<ul class="w-full" role="list">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors" role="listitem"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" data-route class="font-bold text-black hover:text-[#D946EF]" aria-label="글 보기: ${post.title}">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black" aria-label="글 수정: ${post.title}">수정</a></li>`).join('')}</ul>`;
                list.classList.remove('min-h-[200px]', 'flex', 'items-center', 'justify-center');
            },

            renderWriter: async (container, slug) => {
                QuillEditor.destroy(); // 이전 인스턴스 파괴
                ViewRenderer.updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

                let post = { id: null, title: '', summary: '', refined_content: '', slug: '', category: Config.CATEGORIES[0] };
                if (slug) {
                    const { data, error } = await Services.getPostBySlug(slug);
                    if (error || !data || data.author_id !== State.user.id) {
                        DOM.showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true);
                        Router.navigateTo('/dashboard');
                        return;
                    }
                    post = data;
                }
                
                const categoryOpts = Config.CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><form id="writer-form" class="space-y-8 sm:pb-0 pb-20" novalidate><input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}"><div><select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4" required aria-label="카테고리 선택">${categoryOpts}</select><textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required aria-label="제목 입력" maxlength="200">${post.title || ''}</textarea></div><div><label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label><textarea id="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)" aria-label="요약 입력">${post.summary || ''}</textarea></div><div><label for="quill-editor" class="block text-lg font-bold text-black mb-3">본문 (Content)</label><div id="quill-editor-container"><div id="quill-editor" aria-label="본문 에디터"></div><div id="quill-loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-b-xl" style="display: none; min-height: 400px; z-index: 10;"><div class="loader-spinner"></div></div></div></div><div class="flex justify-between items-center pt-8 sm:pt-5 writer-controls-sticky"><div class="flex items-center gap-2"><button type="button" id="insert-table-btn" class="px-3 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition" aria-label="표 삽입">표 삽입</button><button type="button" data-action="table-help" class="px-3 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-100 text-black hover:bg-gray-200 transition" aria-label="표 안내">표 안내</button>${post.id ? `<button type="button" data-action="delete" class="px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition" aria-label="글 삭제">삭제하기</button>` : ''}</div><div class="flex items-center space-x-3"><button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button><button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button></div></div></form></div>`;
                
                // Quill 초기화
                try {
                    const quill = await QuillEditor.init('#quill-editor', '#quill-loader');
                    
                    // [FIX] 수정된 로직으로 콘텐츠 로드
                    if (post.refined_content) {
                        QuillEditor.setContent(post.refined_content);
                    }
                    
                    // 모듈 로드 실패 시 버튼 숨김
                    if (!quill.getModule('better-table')) {
                        const insertBtn = DOM.$('#insert-table-btn');
                        const helpBtn = DOM.$('[data-action="table-help"]');
                        if (insertBtn) insertBtn.style.display = 'none';
                        if (helpBtn) helpBtn.style.display = 'none';
                    }

                } catch (error) {
                    console.error("에디터 초기화 실패:", error);
                    // QuillEditor.init 내부에서 이미 로더에 오류 메시지를 표시함
                }

                // 이벤트 리스너 바인딩
                ViewRenderer._bindWriterEvents(post);
            },
            
            _bindWriterEvents: (post) => {
                const form = DOM.$('#writer-form');
                if (!form) return;

                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (!ViewRenderer._validateForm()) return;
                    if (e.submitter?.dataset.action) App.handlePostSave(e.submitter.dataset.action, e.submitter);
                };

                const delBtn = form.querySelector('[data-action="delete"]');
                if (delBtn) delBtn.onclick = (e) => { e.preventDefault(); App.handlePostDelete(post.id); };
                
                const insertTableBtn = DOM.$('#insert-table-btn');
                if (insertTableBtn) insertTableBtn.onclick = () => {
                    const bt = QuillEditor.instance?.getModule('better-table');
                    if (bt && typeof bt.insertTable === 'function') {
                        bt.insertTable(3, 3);
                    } else {
                        DOM.showToast('표 모듈을 불러오지 못했습니다.', true);
                    }
                };

                const tableHelpBtn = form.querySelector('[data-action="table-help"]');
                if(tableHelpBtn) tableHelpBtn.onclick = ViewRenderer.showTableHelpModal;
                
                const titleEl = DOM.$('#title');
                if (titleEl) titleEl.oninput = DOM.debounce(() => {
                    const slugEl = DOM.$('#post-slug');
                    if (slugEl && !slugEl.value) { // slug가 이미 있는 글은 자동생성 안함
                        // (옵션) 자동 생성된 slug를 사용자에게 표시할 수 있음
                    }
                }, 300);
            },

            _validateForm: () => {
                const title = DOM.$('#title')?.value.trim();
                const cat = DOM.$('#category')?.value;
                if (!title) { DOM.showToast('제목은 필수 항목입니다.', true); DOM.$('#title')?.focus(); return false; }
                if (!cat) { DOM.showToast('카테고리를 선택해주세요.', true); DOM.$('#category')?.focus(); return false; }
                return true;
            },

            showAuthModal: () => {
                const modalId = 'auth-modal';
                const html = `<div id="auth-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative" role="document">
                    <button data-action="close-modal" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button>
                    <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2>
                    <p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p>
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500" aria-label="이메일 입력" autocomplete="email">
                        <button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button>
                    </form>
                </div>`;
                
                const modal = DOM.showModal(modalId, html);
                if (!modal) return;

                modal.querySelector('#auth-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const email = DOM.$('#email-input').value.trim();
                    if (!email) { DOM.showToast('이메일 입력해주세요.', true); return; }
                    const btn = e.target.querySelector('button');
                    btn.disabled = true; btn.textContent = '전송 중...';
                    
                    const { error } = await Services.signIn(email);
                    if (error) { 
                        DOM.showToast(`오류: ${error.message}`, true); 
                        btn.disabled = false; btn.textContent = '매직 링크 받기';
                    } else { 
                        DOM.showToast('이메일 확인해주세요!'); 
                        DOM.closeModal(modalId); 
                    }
                };
            },
            
            showDeleteConfirmModal: (msg) => new Promise(res => {
                const modalId = 'delete-confirm-modal';
                const html = `<div id="delete-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8" role="document">
                    <h3 id="delete-modal-title" class="sr-only">삭제 확인</h3>
                    <p class="text-center text-black text-lg mb-8">${msg}</p>
                    <div class="flex justify-center gap-4">
                        <button data-action="delete-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button>
                        <button data-action="delete-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button>
                    </div>
                </div>`;

                const modal = DOM.showModal(modalId, html);
                if (!modal) return res(false);

                modal.querySelector('[data-action="delete-yes"]').onclick = () => { DOM.closeModal(modalId); res(true); };
                modal.querySelector('[data-action="delete-no"]').onclick = () => { DOM.closeModal(modalId); res(false); };
            }),

            showTableHelpModal: () => {
                const modalId = 'table-help-modal';
                const html = `<div class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-md p-6 relative" role="document">
                    <button data-action="close-modal" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button>
                    <h2 id="table-help-title" class="text-2xl font-bold mb-4 text-black">표 사용 안내</h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <p>이제 외부에서 복사한 표, 텍스트 색상, 배경색, 정렬이 대부분 유지됩니다.</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li><b>Tab / Shift+Tab</b>: 다음/이전 셀 이동</li>
                            <li><b>Enter</b>: 셀 내 줄바꿈</li>
                        </ul>
                        <p class="text-xs text-gray-500">툴바에 새로 추가된 색상, 정렬 버튼을 사용해 직접 수정할 수도 있습니다.</p>
                    </div>
                </div>`;
                DOM.showModal(modalId, html);
            },

            updateMetaTags: (post = null) => {
                const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
                const desc = post ? post.summary : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
                const url = post ? `${Config.SITE_URL}/post/${post.slug}` : Config.SITE_URL;
                const img = post?.thumbnail_url || null;
                const updatedIso = post ? new Date(post.updated_at || post.created_at || Date.now()).toISOString() : new Date().toISOString();
                
                document.title = title;
                DOM.$('meta[name="description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:title"]')?.setAttribute('content', title);
                DOM.$('meta[property="og:description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:url"]')?.setAttribute('content', url);
                DOM.$('link[rel="canonical"]')?.setAttribute('href', url);

                let ogImg = DOM.$('meta[property="og:image"]');
                if (img) {
                    if (ogImg) ogImg.setAttribute('content', img);
                    else {
                        ogImg = document.createElement('meta');
                        ogImg.setAttribute('property', 'og:image');
                        ogImg.setAttribute('content', img);
                        document.head.appendChild(ogImg);
                    }
                }
                
                const ld = DOM.$('#ld-json') || document.createElement('script');
                ld.type = 'application/ld+json';
                ld.id = 'ld-json';
                ld.textContent = JSON.stringify(post ? {
                    "@context": "https://schema.org", "@type": "BlogPosting",
                    "headline": post.title, "datePublished": post.created_at,
                    "dateModified": post.updated_at || post.created_at,
                    "author": { "@type": "Organization", "name": "InsureLog" },
                    "image": img ? [img] : undefined,
                    "mainEntityOfPage": { "@type": "WebPage", "@id": url },
                    "description": desc
                } : {
                    "@context": "https://schema.org", "@type": "WebSite",
                    "name": "InsureLog", "url": Config.SITE_URL, "description": desc
                });
                if (!DOM.$('#ld-json')) document.head.appendChild(ld);
            }
        };

        /**
         * [Module: Router]
         * 브라우저 히스토리 및 뷰 전환을 관리합니다.
         */
        const Router = {
            init: () => {
                window.addEventListener('popstate', Router.handleRouting);
                Router.handleRouting(); // 초기 라우팅
            },

            navigateTo: (path, replace = false) => {
                const newPath = path || '/';
                const action = replace ? 'replaceState' : 'pushState';
                if (window.location.pathname + window.location.search !== newPath) {
                    history[action]({ path: newPath }, '', newPath);
                }
                Router.handleRouting();
            },

            switchView: async (viewId, callback) => {
                const current = DOM.$('.app-view.active');
                if (current) {
                    await DOM.animateSwitch(current, false);
                    current.classList.remove('active');
                    current.innerHTML = '';
                }
                const next = DOM.$(`#${viewId}`);
                if (next) {
                    next.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                    next.classList.add('active');
                    await DOM.animateSwitch(next);
                    try {
                        await callback(next); // 뷰 렌더링 함수 실행
                    } catch (error) {
                        console.error(`Error rendering ${viewId}:`, error);
                        next.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                    }
                    window.scrollTo(0, 0);
                }
            },

            handleRouting: () => {
                if (!State.isAuthReady) return; // 인증 상태 확인 전에는 라우팅 금지
                
                const path = window.location.pathname;
                const params = new URLSearchParams(window.location.search);
                const parts = path.split('/').filter(Boolean);
                const route = parts[0] || 'library';
                const param = parts[1] || null;
                
                if (!State.user && ['dashboard', 'writer'].includes(route)) {
                    DOM.showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                switch (route) {
                    case 'post': 
                        return Router.switchView('view-post', el => ViewRenderer.renderPost(el, param));
                    case 'dashboard': 
                        return Router.switchView('view-dashboard', el => ViewRenderer.renderDashboard(el));
                    case 'writer': 
                        return Router.switchView('view-writer', el => ViewRenderer.renderWriter(el, param));
                    default: 
                        const page = parseInt(params.get('page'), 10) || 1;
                        State.currentCategory = params.get('category') || '전체';
                        return Router.switchView('view-library', el => ViewRenderer.renderLibrary(el, page, State.currentCategory));
                }
            }
        };

        /**
         * [Module: App]
         * 애플리케이션의 메인 진입점. 초기화 및 전역 이벤트 핸들러를 관리합니다.
         */
        const App = {
            init: () => {
                // 1. 서비스 초기화 (Supabase)
                Services.init();
                
                // 2. 전역 이벤트 리스너 바인딩
                App.bindGlobalListeners();

                // 3. 인증 상태 변경 감지
                Services.onAuthChange((user) => {
                    const authChanged = State.user?.id !== user?.id;
                    State.user = user;

                    if (!State.isAuthReady) {
                        // 최초 로드
                        State.isAuthReady = true;
                        ViewRenderer.renderNav();
                        Router.init(); // 인증 준비 후 라우터 시작
                        DOM.animateSwitch(DOM.$('#app-loader'), false).then(() => DOM.$('#app-loader').remove());
                    } else if (authChanged) {
                        // 사용자 변경 (로그인/로그아웃)
                        ViewRenderer.renderNav();
                        Router.handleRouting(); // 현재 뷰 새로고침 (권한 등)
                    }
                });
            },

            bindGlobalListeners: () => {
                document.addEventListener('click', (e) => {
                    // 1. 라우팅 (data-route)
                    const route = e.target.closest('[data-route]');
                    if (route && route.href !== '#') { 
                        e.preventDefault(); 
                        Router.navigateTo(route.href); 
                        return; 
                    }
                    
                    // 2. 액션 (data-action)
                    const action = e.target.closest('[data-action]');
                    if (action && !action.closest('form')) {
                        e.preventDefault();
                        const act = action.dataset.action;
                        switch (act) {
                            case 'auth': return ViewRenderer.showAuthModal();
                            case 'logout': return App.handleLogout();
                            case 'filter-category': 
                                return Router.navigateTo(DOM.buildUrl('/', { page: 1, category: action.dataset.category }));
                            case 'close-modal':
                                return DOM.closeModal(action.closest('[role="dialog"]').id);
                            // writer 뷰 내부의 버튼들은 _bindWriterEvents에서 처리
                        }
                    }
                });

                // 3. ESC 키로 모달 닫기
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = DOM.$('[role="dialog"]');
                        if (modal) DOM.closeModal(modal.id);
                    }
                });
            },

            handleLogout: async () => {
                try { 
                    await Services.signOut(); 
                    DOM.showToast('로그아웃되었습니다.'); 
                } catch (e) { 
                    console.error('Logout error:', e); 
                    DOM.showToast('로그아웃 실패.', true);
                }
                Router.navigateTo('/', true); // 홈으로 강제 이동
            },

            handlePostSave: async (action, btn) => {
                if (!QuillEditor.instance) {
                    DOM.showToast('에디터가 준비되지 않았습니다.', true);
                    return;
                }
                
                const origText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;
                
                try {
                    const title = DOM.$('#title').value.trim();
                    const status = action === 'publish' ? 'published' : 'draft';
                    const content = QuillEditor.instance.root.innerHTML;
                    
                    if (content === '<p><br></p>' || QuillEditor.instance.getLength() < 2) {
                        throw new Error('본문이 비어있습니다.');
                    }
                    
                    let summary = DOM.$('#summary').value.trim() || QuillEditor.instance.getText().trim().replace(/\s+/g, ' ').slice(0, 150) + '...';
                    
                    const temp = document.createElement('div'); temp.innerHTML = content;
                    const thumb = temp.querySelector('img')?.src || null;
                    
                    const id = DOM.$('#post-id').value || null;
                    let slug = DOM.$('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    
                    if (!id) { // 새 글일 때만 slug 중복 검사
                        const { data } = await Services.checkSlugExists(slug);
                        if (data) slug += `-${Date.now().toString().slice(-6)}`;
                    }
                    
                    const postData = { 
                        id: id,
                        title, slug, status, summary, 
                        author_id: State.user.id, 
                        refined_content: content, 
                        category: DOM.$('#category').value, 
                        thumbnail_url: thumb 
                    };
                    
                    const { data: savedPost, error } = await Services.savePost(postData);
                    if (error) throw error;
                    
                    DOM.showToast(status === 'published' ? '발행되었습니다!' : '저장되었습니다.');
                    Router.navigateTo(status === 'published' ? `/post/${savedPost.slug}` : '/dashboard');

                } catch (e) {
                    console.error("Save error:", e);
                    DOM.showToast(`저장 실패: ${e.message}`, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = origText;
                }
            },

            handlePostDelete: async (id) => {
                if (!id) return;
                const confirm = await ViewRenderer.showDeleteConfirmModal('정말 삭제하시겠습니까? 되돌릴 수 없습니다.');
                if (!confirm) return;
                
                DOM.showToast('삭제 중...');
                const { error } = await Services.deletePost(id);
                if (error) {
                    DOM.showToast(`삭제 실패: ${error.message}`, true);
                } else {
                    DOM.showToast('삭제되었습니다.');
                    Router.navigateTo('/dashboard');
                }
            }
        };

        // --- [APP START] ---
        // DOM이 준비되면 애플리케이션을 초기화합니다.
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', App.init);
        } else {
            App.init();
        }

    </script>
</body>
</html>

