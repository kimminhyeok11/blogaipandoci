<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    
    <!-- Scripts & Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- ADDED: Quill.js and Highlight.js for Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 17px;
            line-height: 1.8;
        }
        main#app-container {
            flex-grow: 1; 
        }
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }

        /* Prose styling for rendered HTML content */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom p { margin-bottom: 1.25em; color: var(--text-secondary); }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.25em; }
        .prose-custom ul, .prose-custom ol { margin-bottom: 1.25em; padding-left: 1.5em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        .prose-custom img { max-width: 100%; height: auto; border-radius: 12px; margin-top: 2em; margin-bottom: 2em; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .category-btn { 
            transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem;
            font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent;
        }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner {
            width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color);
            border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Quill Editor Styles */
        #quill-editor { min-height: 400px; font-size: 16px; }
        .ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #D1D5DB; }
        .ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #D1D5DB; }
    </style>
</head>
<body>
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    <main id="app-container" class="w-full px-4">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>
    <footer class="text-center py-8 px-4 border-t border-gray-200 mt-24">
        <p class="text-sm text-gray-600">
            © 2024 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- App State and Config ---
        const SITE_URL = 'https://blogaipandoci.vercel.app';
        const SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        
        // --- FIX ---
        // Corrected the bucket name as you instructed.
        const IMAGE_BUCKET_NAME = 'thought-images'; 
        
        const DB_TABLE_NAME = 'posts'; 
        const POSTS_PER_PAGE = 10;
        const CATEGORIES = ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"];
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const state = { 
            user: null, 
            isAuthReady: false, 
            currentCategory: '전체',
            quill: null, // To hold the Quill editor instance
        };
        const $ = (selector) => document.querySelector(selector);
        
        // --- Core App Logic ---
        function navigateTo(path, replace = false) {
            const newPath = path || '/';
            const historyAction = replace ? 'replaceState' : 'pushState';
            if (window.location.pathname + window.location.search !== newPath) {
                history[historyAction]({ path: newPath }, '', newPath);
            }
            handleRouting();
        }

        async function switchView(viewId, callback) {
            if (state.quill) { state.quill = null; }
            const currentView = $('.app-view.active');
            if (currentView) {
                await anime({ targets: currentView, opacity: 0, duration: 200, easing: 'easeInQuad' }).finished;
                currentView.classList.remove('active');
                currentView.innerHTML = '';
            }
            const nextView = $(`#${viewId}`);
            if (nextView) {
                nextView.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                nextView.classList.add('active');
                anime({ targets: nextView, opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' });
                try {
                    await callback(nextView);
                } catch (error) {
                    console.error(`Error rendering view ${viewId}:`, error);
                    nextView.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                }
                window.scrollTo(0, 0);
            }
        }
        
        function handleRouting() {
            if (!state.isAuthReady) return;
            const path = window.location.pathname;
            const params = new URLSearchParams(window.location.search);
            const [_, route = 'library', param = null] = path.split('/');
            
            if (!state.user && ['dashboard', 'writer'].includes(route)) {
                showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                navigateTo('/');
                return;
            }
            
            switch (route) {
                case 'post': switchView('view-post', el => renderPostView(el, param)); break;
                case 'dashboard': switchView('view-dashboard', el => renderDashboardView(el)); break;
                case 'writer': switchView('view-writer', el => renderWriterView(el, param)); break;
                default: 
                    const page = parseInt(params.get('page'), 10) || 1;
                    state.currentCategory = params.get('category') || '전체';
                    switchView('view-library', el => renderLibraryView(el, page, state.currentCategory));
            }
        }
        
        // --- View Rendering ---
        function renderNav() {
            $('#main-nav-container').innerHTML = `
                <nav class="w-full flex items-center justify-between py-3 px-5 bg-white/50 backdrop-blur-xl border border-black/10 rounded-3xl shadow-lg">
                    <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter">InsureLog</a>
                    <div class="flex items-center space-x-3">
                        ${state.user 
                            ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition">로그아웃</button>` 
                            : `<button data-action="auth" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition">로그인 / 가입</button>`
                        }
                    </div>
                </nav>`;
        }
        
        async function renderLibraryView(container, page, category) {
            updateMetaTags();
            const categoryButtons = ['전체', ...CATEGORIES].map(cat => 
                `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}">${cat}</button>`
            ).join('');
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto py-12 sm:py-16">
                    <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                    <div class="flex items-center justify-center gap-2 mb-8 flex-wrap">${categoryButtons}</div>
                    <div id="post-list-container" class="space-y-1"></div>
                </div>`;
            
            await renderPostList(page, category);
        }

        async function renderPostList(page, category) {
            const listContainer = $('#post-list-container');
            if (!listContainer) return;
            listContainer.innerHTML = `<div class="min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;

            const { from, to } = { from: (page - 1) * POSTS_PER_PAGE, to: page * POSTS_PER_PAGE - 1 };
            let query = supabase.from(DB_TABLE_NAME).select('id, title, slug, summary, category', { count: 'exact' });
            if (category && category !== '전체') query = query.eq('category', category);
            query = query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);

            const { data: posts, error, count: totalPosts } = await query;

            if (error) {
                console.error("Error fetching post list:", error);
                listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                return;
            }

            const postsHtml = posts.length > 0
                ? `<div class="space-y-1">${posts.map(post => `<a href="/post/${post.slug}" data-route class="block p-4 transition-all duration-300 rounded-2xl bg-transparent hover:bg-gray-50"><p class="text-sm font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-lg font-bold">${post.title}</h3><p class="text-sm text-gray-500 mt-1">${post.summary || ''}</p></a>`).join('')}</div>`
                : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${state.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
            
            listContainer.innerHTML = `${postsHtml}${renderPaginationControls(page, totalPosts, '/', { category })}`;
        }
        
        async function renderPostView(container, slug) { 
            if (!slug) { navigateTo('/'); return; } 
            
            const { data: post, error } = await supabase.from(DB_TABLE_NAME).select('*').eq('slug', slug).single(); 
            if (error || !post) { 
                console.error("Error fetching post:", slug, error);
                showToast('글을 찾을 수 없습니다.', true); 
                navigateTo('/'); 
                return; 
            } 
             (async () => { 
                const viewedPosts = JSON.parse(sessionStorage.getItem('viewed_posts')) || []; 
                if (!viewedPosts.includes(post.id)) { 
                    await supabase.rpc('increment_post_view', { post_slug: slug }); 
                    viewedPosts.push(post.id); 
                    sessionStorage.setItem('viewed_posts', JSON.stringify(viewedPosts)); 
                } 
            })();

            const { data: popularPosts } = await supabase
                .from(DB_TABLE_NAME)
                .select('title, slug')
                .eq('status', 'published')
                .neq('slug', slug)
                .order('view_count', { ascending: false, nullsFirst: false })
                .limit(5);

            let popularPostsHtml = popularPosts?.length > 0 ? `
                <div class="mt-20">
                    <h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2>
                    <div class="border-t border-gray-200">${popularPosts.map(p => `
                        <a href="/post/${p.slug}" data-route class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50">
                            <h4 class="font-semibold text-gray-800">${p.title}</h4>
                        </a>`).join('')}
                    </div>
                </div>` : '';
            
            const { data: prevPost } = await supabase.from(DB_TABLE_NAME).select('title, slug').lt('created_at', post.created_at).eq('status', 'published').order('created_at', { ascending: false }).limit(1).single();
            const { data: nextPost } = await supabase.from(DB_TABLE_NAME).select('title, slug').gt('created_at', post.created_at).eq('status', 'published').order('created_at', { ascending: true }).limit(1).single();

            const nextPrevLinksHtml = `
                <nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10">
                    <div>${prevPost ? `<a href="/post/${prevPost.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-lg">${prevPost.title}</h4></a>` : ''}</div>
                    <div class="text-left md:text-right">${nextPost ? `<a href="/post/${nextPost.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-lg">${nextPost.title}</h4></a>` : ''}</div>
                </nav>`;
            
            updateMetaTags(post); 
            const editButtonHtml = (state.user && state.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200">수정</a>` : ''; 
            
            container.innerHTML = `
                <div class="max-w-4xl mx-auto py-12 sm:py-16">
                    <article>
                        <header class="mb-12">
                             <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                            <h1 class="text-4xl sm:text-5xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                            <div class="flex items-center justify-between text-sm text-gray-500">
                                <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                ${editButtonHtml}
                            </div>
                        </header>
                        <div id="post-content" class="prose-custom max-w-none"></div>
                    </article>
                    
                    <div class="my-16"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"></ins></div>
                    
                    ${popularPostsHtml}
                    
                    ${nextPrevLinksHtml}
                </div>`; 
            
            $('#post-content').innerHTML = post.refined_content || '';

            try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.error("Adsense push error:", e); }
            
            setTimeout(() => hljs.highlightAll(), 0);
        }
        
        async function renderDashboardView(container) {
            updateMetaTags({ title: '대시보드' });
            container.innerHTML = `<div class="max-w-4xl mx-auto py-12"><div class="flex justify-between items-center mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2"><div class="min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div></div>`;
            const listContainer = $('#dashboard-post-list');
            if (!state.user) return;

            const { data: posts, error } = await supabase.from(DB_TABLE_NAME).select('id, title, slug, status, created_at').eq('author_id', state.user.id).order('created_at', { ascending: false });
            
            if (error) { 
                console.error("Error fetching dashboard posts:", error);
                listContainer.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>'; 
                return; 
            }
            if (posts.length === 0) { listContainer.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>'; return; }
            
            const postsHtml = `<ul class="w-full">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" data-route class="font-bold text-black hover:text-[#D946EF]">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black">수정</a></li>`).join('')}</ul>`;
            listContainer.innerHTML = postsHtml;
        }

        async function renderWriterView(container, slug) {
            if (!state.user) { navigateTo('/'); return; }
            updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', category: CATEGORIES[0] };

            if (slug) {
                const { data, error } = await supabase.from(DB_TABLE_NAME).select('*').eq('slug', slug).single();
                if (error || !data || data.author_id !== state.user.id) {
                    console.error("Error fetching post to edit or auth error:", error);
                    showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true); 
                    navigateTo('/dashboard'); 
                    return;
                }
                post = data;
            }
            
            const categoryOptions = CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
            
            container.innerHTML = `<div class="max-w-4xl mx-auto py-12">
                <form id="writer-form" class="space-y-8">
                    <input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}">
                    <div>
                        <select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4">${categoryOptions}</select>
                        <textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required>${post.title || ''}</textarea>
                    </div>
                    <div>
                       <label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label>
                       <textarea id="summary" name="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)">${post.summary || ''}</textarea>
                    </div>
                    <div>
                       <label for="quill-editor" class="block text-lg font-bold text-black mb-3">본문 (Content)</label>
                       <div id="quill-editor"></div>
                    </div>
                    <div class="flex justify-between items-center pt-5">
                        <div>
                            ${post.id ? `<button type="button" data-action="delete" class="px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition">삭제하기</button>` : ''}
                        </div>
                        <div class="flex items-center space-x-3">
                            <button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button>
                            <button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button>
                        </div>
                    </div>
                </form>
            </div>`;
            
            setTimeout(() => initQuillEditor(post.refined_content || ''), 0);

            const writerForm = $('#writer-form');
            if (writerForm) {
                writerForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    if (e.submitter?.dataset.action) {
                        handlePostSave(e.submitter.dataset.action, e.submitter); 
                    }
                });

                const deleteButton = writerForm.querySelector('[data-action="delete"]');
                if (deleteButton) {
                    deleteButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        handlePostDelete(post.id);
                    });
                }
            }
        }
        
        // --- Editor and Image Handling Functions ---
        function initQuillEditor(initialContent) {
            if ($('#quill-editor')) {
                state.quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                ['blockquote', 'code-block'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            handlers: { 'image': quillImageHandler }
                        },
                        syntax: true
                    }
                });
                if (initialContent) {
                    state.quill.root.innerHTML = initialContent;
                }
            }
        }

        function quillImageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (file) {
                    showToast('이미지 업로드 중...');
                    const range = state.quill.getSelection(true);
                    state.quill.enable(false);

                    try {
                        const webpBlob = await convertToWebP(file);
                        const publicUrl = await uploadImageToSupabase(webpBlob);
                        state.quill.enable(true);
                        state.quill.insertEmbed(range.index, 'image', publicUrl);
                        state.quill.setSelection(range.index + 1, Quill.sources.SILENT);
                        showToast('업로드 완료!', false);
                    } catch (error) {
                        console.error('Image upload failed:', error);
                        showToast(`이미지 업로드 실패: ${error.message}`, true);
                        state.quill.enable(true);
                    }
                }
            };
        }

        async function uploadImageToSupabase(file) {
            const filePath = `public/${state.user.id}/${Date.now()}.webp`;
            const { error: uploadError } = await supabase.storage
                .from(IMAGE_BUCKET_NAME)
                .upload(filePath, file);

            if (uploadError) throw uploadError;

            const { data } = supabase.storage
                .from(IMAGE_BUCKET_NAME)
                .getPublicUrl(filePath);

            return data.publicUrl;
        }

        function convertToWebP(file, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed'));
                            }
                        }, 'image/webp', quality);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        async function handlePostSave(action, button) {
            if (!state.quill) {
                showToast('에디터가 초기화되지 않았습니다.', true);
                return;
            }
            const originalBtnText = button.textContent;
            button.disabled = true;
            button.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;

            try {
                const title = $('#title').value.trim();
                if (!title) throw new Error('제목은 필수 항목입니다.');

                const status = action === 'publish' ? 'published' : 'draft';
                const contentHTML = state.quill.root.innerHTML; 
                if (contentHTML === '<p><br></p>') throw new Error('본문 내용이 비어있습니다.');
                
                let summary = $('#summary').value.trim();
                if (!summary) {
                    const textContent = state.quill.getText().trim().replace(/\s+/g, ' ');
                    summary = textContent.slice(0, 150) + (textContent.length > 150 ? '...' : '');
                }

                const id = $('#post-id').value;
                let slug = $('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                if (!id) {
                    const { data: existingSlug } = await supabase.from(DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
                    if (existingSlug) slug = `${slug}-${Date.now().toString().slice(-6)}`;
                }
                
                const postData = { 
                    title, slug, status, summary, 
                    author_id: state.user.id, 
                    refined_content: contentHTML,
                    category: $('#category').value, 
                };

                const query = id ? supabase.from(DB_TABLE_NAME).update(postData).eq('id', id) : supabase.from(DB_TABLE_NAME).insert(postData);
                const { data, error } = await query.select().single();
                if (error) throw error;

                showToast(status === 'published' ? '글이 발행되었습니다!' : '초안이 저장되었습니다.');
                navigateTo(status === 'published' ? `/post/${data.slug}` : '/dashboard');

            } catch (error) { 
                console.error("Error saving post:", error);
                showToast(`저장 실패: ${error.message}`, true);
            } finally { button.disabled = false; button.textContent = originalBtnText; }
        }

        // --- Other Utilities & Auth ---
        async function handlePostDelete(postId) {
            if (!postId) return;
            const confirmed = await showDeleteConfirmationModal('정말로 이 글을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');
            
            if (confirmed) {
                showToast('글을 삭제하는 중...');
                const { error } = await supabase.from(DB_TABLE_NAME).delete().eq('id', postId);
                if (error) {
                    console.error("Error deleting post:", error);
                    showToast(`삭제 실패: ${error.message}`, true);
                } else {
                    showToast('글이 삭제되었습니다.');
                    navigateTo('/dashboard');
                }
            }
        }
        
        async function showDeleteConfirmationModal(message) {
            return new Promise(resolve => {
                if ($('#delete-confirm-modal')) return;
                const modalHtml = `
                    <div id="delete-confirm-modal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4">
                        <div id="delete-modal-content" class="bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8">
                            <p class="text-center text-black text-lg mb-8">${message}</p>
                            <div class="flex justify-center gap-4">
                                <button id="delete-btn-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button>
                                <button id="delete-btn-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button>
                            </div>
                        </div>
                    </div>`;
                $('#modal-container').innerHTML = modalHtml;
                const closeModal = (result) => {
                    const modal = $('#delete-confirm-modal');
                    if (!modal) return;
                    anime({ targets: modal, opacity: 0, duration: 200, easing: 'easeInQuad', complete: () => { $('#modal-container').innerHTML = ''; resolve(result); } });
                };
                anime({ targets: '#delete-confirm-modal', opacity: [0, 1], duration: 200 });
                anime({ targets: '#delete-modal-content', scale: [0.9, 1], opacity: [0, 1], duration: 300, easing: 'easeOutQuad' });
                $('#delete-btn-yes').addEventListener('click', () => closeModal(true));
                $('#delete-btn-no').addEventListener('click', () => closeModal(false));
            });
        }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.textContent = message; $('#toast-container').appendChild(toast);
            anime({ targets: toast, opacity: [0, 1], translateY: [10, 0], duration: 300 });
            setTimeout(() => anime({ targets: toast, opacity: 0, duration: 300, complete: () => toast.remove() }), 3000);
        }

        function buildUrl(path, params) {
            const url = new URL(path, SITE_URL);
            Object.entries(params).forEach(([key, value]) => { if (value && value !== '전체') url.searchParams.append(key, value); });
            return url.pathname + url.search;
        }

        function renderPaginationControls(currentPage, totalItems, basePath, params) {
            const totalPages = Math.ceil(totalItems / POSTS_PER_PAGE);
            if (totalPages <= 1) return '';
            const prevUrl = currentPage > 1 ? buildUrl(basePath, { ...params, page: currentPage - 1 }) : '#';
            const nextUrl = currentPage < totalPages ? buildUrl(basePath, { ...params, page: currentPage + 1 }) : '#';
            return `<div class="flex justify-center items-center gap-4 mt-12"><a href="${prevUrl}" data-route class="px-4 py-2 text-sm rounded-full bg-gray-100 ${currentPage === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${currentPage} / ${totalPages}</span><a href="${nextUrl}" data-route class="px-4 py-2 text-sm rounded-full bg-gray-100 ${currentPage >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
        }

        async function handleLogout() { 
            await supabase.auth.signOut(); showToast('로그아웃되었습니다.'); navigateTo('/', true); 
        }
        
        function showAuthModal() {
            if ($('#auth-modal')) return;
            const modalHtml = `<div id="auth-modal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4"><div id="auth-modal-content" class="bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative"><button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button><h2 class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2><p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p><form id="auth-form" class="space-y-4"><input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500"><button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button></form></div></div>`;
            $('#modal-container').innerHTML = modalHtml;
            const closeModal = () => anime({ targets: '#auth-modal', opacity: 0, duration: 200, easing: 'easeInQuad', complete: () => $('#modal-container').innerHTML = '' });
            anime({ targets: '#auth-modal', opacity: [0, 1], duration: 200 });
            anime({ targets: '#auth-modal-content', scale: [0.9, 1], opacity: [0, 1], duration: 300, easing: 'easeOutQuad' });
            $('#auth-form').addEventListener('submit', async (e) => {
                e.preventDefault(); const email = $('#email-input').value; const button = e.target.querySelector('button');
                button.disabled = true; button.textContent = '전송 중...';
                const { error } = await supabase.auth.signInWithOtp({ email: email, options: { emailRedirectTo: SITE_URL } });
                if (error) { showToast(`오류: ${error.message}`, true); button.disabled = false; button.textContent = '매직 링크 받기'; } 
                else { showToast('이메일을 확인해주세요! 로그인 링크를 보냈습니다.'); closeModal(); }
            });
            $('#close-modal-btn').addEventListener('click', closeModal);
            $('#auth-modal').addEventListener('click', (e) => { if (e.target.id === 'auth-modal') closeModal(); });
        }
        
        function updateMetaTags(post = null) {
            const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
            const description = post ? post.summary : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
            const url = post ? `${SITE_URL}/post/${post.slug}` : SITE_URL;
            document.title = title; $('meta[name="description"]')?.setAttribute('content', description); $('meta[property="og:title"]')?.setAttribute('content', title);
            $('meta[property="og:description"]')?.setAttribute('content', description); $('meta[property="og:url"]')?.setAttribute('content', url);
        }

        // --- App Initialization ---
        function initializeApp() {
            supabase.auth.onAuthStateChange((event, session) => {
                const userJustChanged = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                
                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav(); 
                    handleRouting();
                    anime({ targets: '#app-loader', opacity: 0, duration: 400, complete: (anim) => anim.animatables[0].target.remove() });
                } else if (userJustChanged) {
                    renderNav();
                    handleRouting();
                }
            });

            document.addEventListener('click', (e) => {
                const routeTarget = e.target.closest('[data-route]');
                if (routeTarget && routeTarget.getAttribute('href') !== '#') { e.preventDefault(); navigateTo(routeTarget.getAttribute('href')); return; }
                
                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget && !actionTarget.closest('form')) { 
                    e.preventDefault();
                    const action = actionTarget.dataset.action;
                    switch (action) {
                        case 'auth': showAuthModal(); break;
                        case 'logout': handleLogout(); break;
                        case 'filter-category': 
                            const category = actionTarget.dataset.category;
                            navigateTo(buildUrl('/', { page: 1, category: category })); 
                            break;
                    }
                }
            });
            window.addEventListener('popstate', handleRouting);
        }
        
        initializeApp();
    </script>
</body>
</html>


