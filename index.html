<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    <meta property="og:site_name" content="InsureLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Scripts & Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
      [WORKFLOW CHANGE]
      - Markdown(marked.js) 관련 스크립트 제거
      - Editor.js 및 관련 도구, 렌더러 스크립트 추가
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer nonce="r4nd0m"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>

    <!-- [NEW] Editor.js Core -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <!-- [NEW] Editor.js Tools -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <!-- [NEW] Editor.js JSON to HTML Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/editorjs-html@latest" defer crossorigin="anonymous" nonce="r4nd0m"></script>


    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            line-height: 1.7;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; line-height: 1.75; }
        }
        main#app-container {
            padding-left: 0.75rem; padding-right: 0.75rem; flex-grow: 1;
        }
        @media (min-width: 640px) {
            main#app-container { padding-left: 1rem; padding-right: 1rem; }
        }
        /* [View] 뷰 전환을 위한 기본 클래스 */
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }

        /* * [Prose] 블로그 포스트 콘텐츠 스타일 (Editor.js + edjsHTML 출력 대응)
         * .prose-custom은 이제 방문자 뷰와 에디터 뷰 양쪽에서 사용됩니다.
         */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom h1 { font-size: 2.25rem; } /* 36px */
        .prose-custom h2 { font-size: 1.875rem; } /* 30px */
        .prose-custom h3 { font-size: 1.5rem; } /* 24px */
        
        .prose-custom p { margin: 0 0 1.3em; color: var(--text-secondary); }
        .prose-custom div { margin-bottom: 1.3em; }
        .prose-custom p br { display: block; margin-bottom: 0.75em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.3em; }
        .prose-custom ul { list-style-type: disc; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom ol { list-style-type: decimal; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { margin-top: 0.5em; margin-bottom: 0.5em; margin-left: 1.25em; }
        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        
        /* edjsHTML은 img 태그를 figure로 감쌀 수 있습니다. */
        .prose-custom img, .prose-custom figure { 
            max-width: 90%; 
            height: auto; 
            border-radius: 12px; 
            margin-top: 2em; 
            margin-bottom: 2em; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            display: block; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .prose-custom figure { max-width: 100%; } /* Figure는 컨테이너 역할 */
        .prose-custom figure img { max-width: 100%; margin-top:0; margin-bottom: 0.5em; } /* Figure 내부 이미지는 100% */
        .prose-custom figcaption { text-align: center; font-size: 0.9em; color: var(--text-secondary); }
        
        .prose-custom table { width: 100%; border-collapse: collapse; margin-top: 2em; margin-bottom: 2em; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-radius: 8px; overflow: hidden; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 0.75em 1em; text-align: left; }
        .prose-custom th { background-color: var(--bg-content-secondary); font-weight: 700; color: var(--text-primary); }
        .prose-custom tr:nth-child(odd) { background-color: var(--bg-main); }
        .prose-custom tr:nth-child(even) { background-color: var(--bg-content-secondary); }

        /* [Components] 재사용 가능한 UI 요소 */
        .category-btn { transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem; font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent; }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* [NEW] Editor.js 스타일 오버라이드 */
        #editorjs-holder {
            width: 100%;
            min-height: 600px;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-main); /* 일반 배경색 */
            color: var(--text-primary);
        }
        #editorjs-holder:focus-within {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }
        /* Editor.js 내부 폰트 및 스타일을 .prose-custom과 일치시킵니다. */
        .codex-editor__redactor {
            padding-bottom: 100px !important; /* 편집기 하단 여백 */
        }
        .ce-block__content, .ce-toolbar__content {
            max-width: 100%; /* prose-custom과 맞춤 */
            margin-left: 0;
            margin-right: 0;
        }
        .ce-toolbar__actions {
            left: -12px !important;
        }
        .ce-inline-toolbar {
            color: #333; /* 인라인 툴바 색상 */
        }
        /* 이미지 업로드 UI */
        .image-tool__image-picture {
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }


        /* [Responsive] 모바일 반응형 */
        @media (max-width: 639px) {
            .writer-controls-sticky { 
                position: sticky; bottom: 0; background-color: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
                padding: 1rem; border-top: 1px solid #E5E7EB; 
                margin-left: -0.75rem; margin-right: -0.75rem; 
                padding-top: 1rem !important; z-index: 30; 
            }
            .prose-custom img, .prose-custom figure { 
                width: calc(100% + 1.5rem); 
                margin-left: -0.75rem; 
                margin-right: -0.75rem; 
                max-width: none;
                border-radius: 0; 
                box-shadow: none; 
            }
        }
        .post-thumbnail img { loading: lazy; }

        /* [Accessibility] 포커스 링 */
        button:focus, a:focus, input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--accent); outline-offset: 2px; 
        }
        /* Editor.js 포커스 링은 자체적으로 처리하나, 홀더에 적용 */
        #editorjs-holder:focus, #editorjs-holder:focus-within {
             outline: 2px solid var(--accent); outline-offset: 2px; 
        }

        /* [Motion] 접근성 - 움직임 최소화 */
        @media (prefers-reduced-motion: reduce) { 
            *, *::before, *::after { 
                animation-duration: 0.01ms !important; 
                animation-iteration-count: 1 !important; 
                transition-duration: 0.01ms !important; 
            } 
        }

        /* [Layout] 푸터 여백 */
        footer { margin-top: 16px; } 
        @media (min-width: 640px) { footer { margin-top: 24px; } }
    </style>
</head>
<body class="antialiased">
    <!-- 앱 로더 -->
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    
    <!-- 헤더 (네비게이션) -->
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    
    <!-- 메인 콘텐츠 (뷰가 렌더링되는 곳) -->
    <main id="app-container" class="w-full">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>

    <!-- 푸터 -->
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>

    <!-- 모달 및 토스트 컨테이너 -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <!-- 
      ==================================================================
      [APP SCRIPT] - 메인 애플리케이션 (Editor.js 기반으로 리팩터링)
      ==================================================================
    -->

    <script type="module" nonce="r4nd0m">
        // [Supabase] ES 모듈 임포트
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        /**
         * [Module: Config]
         * 애플리케이션의 모든 설정을 관리합니다.
         */
        const Config = {
            SITE_URL: 'https://blogaipandoci.vercel.app',
            SUPABASE_URL: 'https://ddehwkwzmmvcxltlplua.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To',
            IMAGE_BUCKET_NAME: 'thought-images', 
            DB_TABLE_NAME: 'posts', 
            POSTS_PER_PAGE: 10,
            CATEGORIES: ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"]
        };

        /**
         * [Module: State]
         * 전역 상태를 관리합니다. (Editor.js 인스턴스 추가)
         */
        const State = {
            user: null,
            isAuthReady: false,
            currentCategory: '전체',
            supabase: null,
            editorInstance: null, // [NEW] Editor.js 인스턴스를 상태로 관리
        };

        /**
         * [Module: DOM]
         * DOM 조작과 관련된 헬퍼 함수들을 관리합니다. (변경 없음)
         */
        const DOM = {
            $: document.querySelector.bind(document),
            
            animateSwitch: (el, show = true) => {
                if (!el) return Promise.resolve();
                const opts = show ? { opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' } : { opacity: 0, duration: 200, easing: 'easeInQuad' };
                if (typeof anime === 'function') {
                    return anime({ targets: el, ...opts }).finished;
                } else {
                    console.warn('anime.js is not loaded.');
                    el.style.opacity = show ? 1 : 0;
                    return Promise.resolve();
                }
            },

            showToast: (msg, err = false) => {
                const toast = document.createElement('div');
                toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${err ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
                toast.textContent = msg;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'polite');
                DOM.$('#toast-container').appendChild(toast);
                DOM.animateSwitch(toast, true);
                setTimeout(() => DOM.animateSwitch(toast, false).then(() => toast.remove()), 3000);
            },

            showModal: (id, html) => {
                if (DOM.$(`#${id}`)) return;
                const container = DOM.$('#modal-container');
                const modalWrapper = document.createElement('div');
                modalWrapper.id = id;
                modalWrapper.className = "fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4";
                modalWrapper.setAttribute('role', 'dialog');
                modalWrapper.setAttribute('aria-modal', 'true');
                modalWrapper.innerHTML = html;
                container.appendChild(modalWrapper);
                
                const content = modalWrapper.querySelector('.modal-content');
                
                DOM.animateSwitch(modalWrapper);
                if (content) DOM.animateSwitch(content, true);

                return modalWrapper;
            },

            closeModal: (id) => {
                const modal = DOM.$(`#${id}`);
                if (!modal) return Promise.resolve();
                return DOM.animateSwitch(modal, false).then(() => modal.remove());
            },

            buildUrl: (path, params) => {
                const url = new URL(path, Config.SITE_URL);
                Object.entries(params).forEach(([k, v]) => {
                    if (v !== undefined && v !== null && v !== '전체' && v !== '') url.searchParams.append(k, v);
                });
                return url.pathname + url.search;
            },

            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }
        };

        /**
         * [Module: Services]
         * Supabase API 호출 등 백엔드 통신을 관리합니다. (uploadImage 로직 개선)
         */
        const Services = {
            init: () => {
                State.supabase = createClient(Config.SUPABASE_URL, Config.SUPABASE_ANON_KEY);
            },

            onAuthChange: (callback) => {
                return State.supabase.auth.onAuthStateChange((_, session) => {
                    callback(session?.user || null);
                });
            },

            signIn: (email) => {
                return State.supabase.auth.signInWithOtp({ 
                    email, 
                    options: { emailRedirectTo: Config.SITE_URL } 
                });
            },

            signOut: () => {
                return State.supabase.auth.signOut();
            },

            getPosts: (page, category) => {
                const { from, to } = { from: (page - 1) * Config.POSTS_PER_PAGE, to: page * Config.POSTS_PER_PAGE - 1 };
                let query = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, summary, category, thumbnail_url', { count: 'exact' });
                if (category !== '전체') query = query.eq('category', category);
                return query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);
            },

            getPostBySlug: (slug) => {
                // [DB CHANGE] `refined_content`는 이제 JSON 텍스트입니다.
                return State.supabase.from(Config.DB_TABLE_NAME).select('*').eq('slug', slug).single();
            },

            getDashboardPosts: (userId) => {
                return State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, status, created_at')
                    .eq('author_id', userId)
                    .order('created_at', { ascending: false });
            },

            getRelatedPosts: (slug) => {
                const popular = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .eq('status', 'published')
                    .neq('slug', slug)
                    .order('view_count', { ascending: false, nullsFirst: false })
                    .limit(5);
                return popular;
            },

            getAdjacentPosts: (createdAt) => {
                 const prev = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .lt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false })
                    .limit(1).single();
                const next = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .gt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: true })
                    .limit(1).single();
                return Promise.all([prev, next]);
            },

            incrementViewCount: (slug) => {
                try {
                    const viewed = JSON.parse(sessionStorage.getItem('viewed_posts') || '[]');
                    if (!viewed.includes(slug)) {
                        State.supabase.rpc('increment_post_view', { post_slug: slug }).then(({error}) => {
                           if(error) console.warn("View count RPC error:", error);
                           else {
                                viewed.push(slug);
                                sessionStorage.setItem('viewed_posts', JSON.stringify(viewed));
                           }
                        });
                    }
                } catch (e) { console.warn('View count error:', e); }
            },
            
            savePost: (data) => {
                // [DB CHANGE] `refined_content`는 이제 JSON 문자열입니다.
                const id = data.id;
                delete data.id; 
                if (id) {
                    return State.supabase.from(Config.DB_TABLE_NAME).update(data).eq('id', id).select().single();
                } else {
                    return State.supabase.from(Config.DB_TABLE_NAME).insert(data).select().single();
                }
            },

            checkSlugExists: (slug) => {
                return State.supabase.from(Config.DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
            },

            deletePost: (id) => {
                return State.supabase.from(Config.DB_TABLE_NAME).delete().eq('id', id);
            },

            /**
             * [REFACTOR]
             * 이미지 업로드 로직을 WebP 변환과 통합하여 Editor.js에서 사용하기 쉽게 만듭니다.
             */
            uploadImage: async (file) => {
                // 1. WebP로 변환 시도 (App 모듈의 헬퍼 사용)
                const optimizedFile = await App.convertToWebP(file);
                
                // 2. 파일 이름 및 경로 생성
                let baseName = 'upload';
                let ext = 'webp'; // 기본 확장자를 webp로 설정

                if (optimizedFile.name) {
                    const parts = optimizedFile.name.split('.');
                    if (parts.length > 1) {
                        ext = parts.pop().toLowerCase();
                        baseName = parts.join('.').replace(/[^\w-]/g, '_');
                    } else {
                        baseName = optimizedFile.name.replace(/[^\w-]/g, '_');
                    }
                }
                if (!baseName) baseName = 'image';
                
                const path = `${State.user.id}/${baseName}-${Date.now()}.${ext}`;

                // 3. 최적화된 파일 업로드
                const { error } = await State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).upload(path, optimizedFile, { upsert: true });
                if (error) throw new Error(`업로드 실패: ${error.message}`);
                
                // 4. Public URL 반환
                const { data } = State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).getPublicUrl(path);
                if (!data?.publicUrl) throw new Error('Public URL 실패');
                return data.publicUrl;
            }
        };

        /**
         * [Module: ViewRenderer]
         * 각 뷰(페이지)의 HTML 렌더링을 담당합니다.
         */
        const ViewRenderer = {
            _templates: {
                nav: (user) => `
                    <nav class="w-full flex items-center justify-between py-2 px-4 sm:py-3 sm:px-5 bg-white/50 backdrop-blur-xl border border-black/10 rounded-3xl shadow-lg" role="banner">
                        <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter" aria-label="InsureLog 홈으로 이동">InsureLog</a>
                        <div class="flex items-center space-x-3">
                            ${user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="대시보드로 이동">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="로그아웃">로그아웃</button>` : `<button data-action="auth" aria-label="로그인 또는 회원가입" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition">로그인 / 가입</button>`}
                        </div>
                    </nav>`,
                categoryBtns: (category) => ['전체', ...Config.CATEGORIES].map(cat => `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}" aria-pressed="${cat === category}">${cat}</button>`).join(''),
                pagination: (page, total, basePath, params) => {
                    const totalPages = Math.ceil(total / Config.POSTS_PER_PAGE);
                    if (totalPages <= 1) return '';
                    const prevUrl = page > 1 ? DOM.buildUrl(basePath, { ...params, page: page - 1 }) : '#';
                    const nextUrl = page < totalPages ? DOM.buildUrl(basePath, { ...params, page: page + 1 }) : '#';
                    return `<div class="flex justify-center items-center gap-4 mt-12" role="navigation" aria-label="페이지 탐색"><a href="${prevUrl}" data-route aria-label="이전 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${page} / ${totalPages}</span><a href="${nextUrl}" data-route aria-label="다음 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
                }
            },

            renderNav: () => {
                DOM.$('#main-nav-container').innerHTML = ViewRenderer._templates.nav(State.user);
            },

            renderLibrary: async (container, page, category) => {
                ViewRenderer.updateMetaTags();
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                        <div class="flex items-center justify-center gap-2 mb-8 flex-wrap" role="tablist">${ViewRenderer._templates.categoryBtns(category)}</div>
                        <div id="post-list-container" class="border border-gray-200/80 rounded-2xl overflow-hidden min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>
                    </div>`;
                
                const { data: posts, error, count } = await Services.getPosts(page, category);
                const listContainer = DOM.$('#post-list-container');
                if (error) {
                    console.error("Error fetching posts:", error);
                    listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                    return;
                }
                
                const total = count ?? 0;
                const safePosts = Array.isArray(posts) ? posts : [];
                const postsHtml = safePosts.length > 0
                    ? `<div class="divide-y divide-gray-200/80">${safePosts.map(post => {
                        const thumb = post.thumbnail_url ? `<div class="w-24 h-16 sm:w-32 sm:h-20 flex-shrink-0 mr-4 sm:mr-5"><img src="${post.thumbnail_url}" alt="${post.title} 썸네일" class="w-full h-full object-cover rounded-lg bg-gray-100 post-thumbnail"></div>` : '';
                        return `<a href="/post/${post.slug}" data-route class="flex items-center p-4 transition-all duration-300 bg-transparent hover:bg-gray-50/80" role="article">${thumb}<div class="flex-grow"><p class="text-xs font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-sm font-bold">${post.title}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-2">${post.summary || ''}</p></div></a>`;
                    }).join('')}</div>`
                    : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${State.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
                
                listContainer.innerHTML = `${postsHtml}${ViewRenderer._templates.pagination(page, total, '/', { category })}`;
                listContainer.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
            },

            /**
             * [REFACTOR]
             * - renderPost가 marked.js 대신 edjsHTML(Editor.js JSON 렌더러)을 사용합니다.
             * - DOMPurify를 사용해 렌더링된 HTML을 소독합니다.
             * - hljs는 코드 블록을 위해 계속 사용합니다.
             */
            renderPost: async (container, slug) => {
                const { data: post, error } = await Services.getPostBySlug(slug);
                if (error || !post) {
                    console.error("Error fetching post:", slug, error);
                    DOM.showToast('글을 찾을 수 없습니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                Services.incrementViewCount(slug);

                const { data: popular } = await Services.getRelatedPosts(slug);
                const [{ data: prev }, { data: next }] = await Services.getAdjacentPosts(post.created_at);

                const popularHtml = popular?.length > 0 ? `<div class="mt-20"><h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2><div class="border-t border-gray-200">${popular.map(p => `<a href="/post/${p.slug}" class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50" role="link"><h4 class="font-semibold text-gray-800 text-base">${p.title}</h4></a>`).join('')}</div></div>` : '';
                const navHtml = `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10" role="navigation" aria-label="이전/다음 글 탐색"><div>${prev ? `<a href="/post/${prev.slug}" class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${prev.title}</h4></a>` : ''}</div><div class="text-left md:text-right">${next ? `<a href="/post/${next.slug}" class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${next.title}</h4></a>` : ''}</div></nav>`;
                
                ViewRenderer.updateMetaTags(post);
                const editBtn = (State.user && State.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200" aria-label="글 수정">수정</a>` : '';
                
                const adTestAttr = ['localhost','127.0.0.1'].includes(window.location.hostname) ? ' data-adtest="on"' : '';
                
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <article role="article">
                            <header class="mb-8 sm:mb-12">
                                <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                                <h1 class="text-3xl sm:text-4xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    ${editBtn}
                                </div>
                            </header>
                            
                            <!-- 렌더링 전 로더 표시 -->
                            <div id="post-content" class="prose-custom max-w-none min-h-[300px] flex items-center justify-center">
                                <div class="loader-spinner"></div>
                            </div>

                        </article>
                        <div class="my-16"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"${adTestAttr}></ins></div>
                        ${popularHtml}${navHtml}
                    </div>`;
                
                // [FIX] 렌더링 라이브러리 (edjsHTML, DOMPurify, hljs) 로드를 기다립니다.
                try {
                    await App.waitForGlobals(['edjsHTML', 'DOMPurify', 'hljs'], 5000); 

                    if (typeof edjsHTML === 'undefined' || typeof DOMPurify === 'undefined') {
                        throw new Error('Content rendering libraries are not available.');
                    }

                    // 1. edjsHTML 파서 인스턴스 생성
                    const parser = edjsHTML();
                    
                    // 2. DB에서 가져온 JSON 파싱 (없으면 빈 객체)
                    let savedData = { blocks: [] };
                    if(post.refined_content) {
                        try {
                            savedData = JSON.parse(post.refined_content);
                        } catch(e) { console.warn("Could not parse post content JSON.", e); }
                    }

                    // 3. JSON을 HTML 블록 배열로 변환
                    const htmlBlocks = parser.parse(savedData);
                    
                    // 4. HTML 블록을 단일 문자열로 결합
                    const rawHtml = htmlBlocks.join('');

                    // 5. DOMPurify로 HTML 소독
                    if (!window.__dompurifyHooked) { // 훅 설정 (renderPost에서만 필요)
                        DOMPurify.addHook('uponSanitizeAttribute', function(node, data) {
                            if (data.attrName === 'style') {
                                try {
                                    const style = (data.attrValue || '').toLowerCase();
                                    const allowedStyles = [];
                                    const mAlign = style.match(/text-align\s*:\s*(left|center|right|justify)/);
                                    if (mAlign) allowedStyles.push(`text-align:${mAlign[1]}`);
                                    const mWidth = style.match(/(?:^|;|\s)width\s*:\s*([0-9]+(?:\.[0-9]+)?)(px|%)/);
                                    if (mWidth) allowedStyles.push(`width:${mWidth[1]}${mWidth[2]}`);
                                    data.attrValue = allowedStyles.join(';');
                                    if (!data.attrValue) data.keepAttr = false;
                                } catch (_) { data.keepAttr = false; }
                            }
                        });
                        window.__dompurifyHooked = true;
                    }
                    const safeContent = DOMPurify.sanitize(rawHtml, { 
                        ADD_TAGS: ["iframe", "table", "tr", "td", "th", "tbody", "thead", "tfoot", "col", "colgroup", "span", "figure", "figcaption"], 
                        ADD_ATTR: ["rowspan","colspan","style","class","width","height","align", "frameborder", "allow", "allowfullscreen"] 
                    });
                    
                    const contentEl = DOM.$('#post-content');
                    if(contentEl) {
                        // 6. DOM에 삽입 (로더 제거)
                        contentEl.innerHTML = safeContent;
                        contentEl.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');

                        // 7. 구문 강조 (hljs가 로드된 것이 보장됨)
                        if (typeof hljs !== 'undefined') {
                            contentEl.querySelectorAll('pre code').forEach(hljs.highlightElement);
                        }
                        
                        // 8. 기타 후처리
                        contentEl.querySelectorAll('img').forEach(img => { img.loading = 'lazy'; img.decoding = 'async'; });
                        contentEl.querySelectorAll('a[target="_blank"]').forEach(a => { a.rel = 'noopener noreferrer'; });
                    }

                } catch (libError) {
                    console.error(libError);
                    const contentEl = DOM.$('#post-content');
                    if(contentEl) {
                        contentEl.innerHTML = `<p class="text-red-500">콘텐츠를 렌더링하는 중 오류가 발생했습니다.</p>`;
                        contentEl.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
                    }
                }
                
                // 애드센스 로드
                try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.warn("Adsense error:", e); }
            },


            renderDashboard: async (container) => {
                ViewRenderer.updateMetaTags({ title: '대시보드' });
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><div class="flex justify-between items-center mb-8 sm:mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]" aria-label="새 글 작성">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2 min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div>`;
                
                if (!State.user) return;
                const { data: posts, error } = await Services.getDashboardPosts(State.user.id);
                const list = DOM.$('#dashboard-post-list');
                
                if (error) {
                    list.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>';
                    return;
                }
                if (!posts?.length) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>';
                    return;
                }
                list.innerHTML = `<ul class="w-full" role="list">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors" role="listitem"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" class="font-bold text-black hover:text-[#D946EF]" aria-label="글 보기: ${post.title}">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black" aria-label="글 수정: ${post.title}">수정</a></li>`).join('')}</ul>`;
                list.classList.remove('min-h-[200px]', 'flex', 'items-center', 'justify-center');
            },

            /**
             * [REFACTOR]
             * - renderWriter가 Editor.js를 초기화합니다.
             * - <textarea>를 <div id="editorjs-holder">로 대체합니다.
             * - 불필해진 버튼(이미지 업로드, 마크다운 가이드)을 제거합니다.
             */
            renderWriter: async (container, slug) => {
                // SPA 이동 시 기존 에디터 인스턴스 파괴
                if (State.editorInstance) {
                    try {
                        State.editorInstance.destroy();
                    } catch(e) { console.warn("Editor.js destroy error", e); }
                    State.editorInstance = null;
                }
                
                ViewRenderer.updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

                let post = { id: null, title: '', summary: '', refined_content: null, slug: '', category: Config.CATEGORIES[0] };
                if (slug) {
                    const { data, error } = await Services.getPostBySlug(slug);
                    if (error || !data || data.author_id !== State.user.id) {
                        DOM.showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true);
                        Router.navigateTo('/dashboard');
                        return;
                    }
                    post = data;
                }
                
                const categoryOpts = Config.CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
                
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><form id="writer-form" class="space-y-8 sm:pb-0 pb-20" novalidate><input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}"><div><select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4" required aria-label="카테고리 선택">${categoryOpts}</select><textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required aria-label="제목 입력" maxlength="200">${post.title || ''}</textarea></div><div><label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label><textarea id="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)" aria-label="요약 입력">${post.summary || ''}</textarea></div><div><label for="editorjs-holder" class="block text-lg font-bold text-black mb-3">본문</label>
                    
                    <!-- [REPLACE] <textarea> -> <div id="editorjs-holder"> -->
                    <div id="editorjs-holder" class="prose-custom max-w-none"></div> 

                </div><div class="flex justify-between items-center pt-8 sm:pt-5 writer-controls-sticky">
                    <!-- [REPLACE] 이미지 업로드 버튼 등 제거 (에디터 내장) -->
                    <div></div> 
                    <div class="flex items-center space-x-3"><button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button><button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button>${post.id ? `<button type="button" data-action="delete" class="ml-4 px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition" aria-label="글 삭제">삭제</button>` : ''}</div></div></form></div>`;
                
                // [NEW] Editor.js 초기화
                try {
                    // 에디터 라이브러리 로드 대기
                    await App.waitForGlobals(['EditorJS', 'Header', 'List', 'ImageTool', 'Quote', 'CodeTool', 'Table', 'Delimiter'], 10000);
                    
                    let editorData = { blocks: [] };
                    if (post.refined_content) {
                        try { editorData = JSON.parse(post.refined_content); }
                        catch(e) { console.warn("Failed to parse editor JSON, starting fresh.", e); }
                    }

                    State.editorInstance = new EditorJS({
                        holder: 'editorjs-holder',
                        autofocus: false,
                        placeholder: '여기에 이야기를 작성하세요...',
                        data: editorData, // DB에서 불러온 JSON 데이터
                        tools: {
                            header: { class: Header, inlineToolbar: true },
                            list: { class: List, inlineToolbar: true },
                            quote: { class: Quote, inlineToolbar: true },
                            delimiter: Delimiter,
                            code: CodeTool,
                            table: { class: Table, inlineToolbar: true },
                            image: {
                                class: ImageTool,
                                config: {
                                    // [NEW] WebP 변환 업로더 연결
                                    uploader: {
                                        uploadByFile: (file) => App.uploadImageForEditor(file)
                                    }
                                }
                            }
                        },
                        // 붙여넣기 시 HTML/Markdown 자동 변환 활성화
                        onReady: () => {
                            console.log('Editor.js is ready!');
                        },
                        onChange: (api, event) => {
                            // console.log('Editor.js changed:', event);
                        }
                    });

                } catch (libError) {
                    console.error(libError);
                    DOM.$('#editorjs-holder').innerHTML = `<p class="text-red-500">에디터를 불러오는 데 실패했습니다. 페이지를 새로고침해주세요.</p>`;
                }

                // 폼 이벤트 바인딩
                ViewRenderer._bindWriterEvents(post);
            },
            
            _bindWriterEvents: (post) => {
                const form = DOM.$('#writer-form');
                if (!form) return;

                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (!ViewRenderer._validateForm()) return;
                    if (e.submitter?.dataset.action) App.handlePostSave(e.submitter.dataset.action, e.submitter);
                };

                const delBtn = form.querySelector('[data-action="delete"]');
                if (delBtn) delBtn.onclick = (e) => { e.preventDefault(); App.handlePostDelete(post.id); };
                
                // [REMOVED] 이미지 업로드, 마크다운 가이드 버튼 관련 로직 제거
            },

            _validateForm: () => {
                const title = DOM.$('#title')?.value.trim();
                const cat = DOM.$('#category')?.value;
                if (!title) { DOM.showToast('제목은 필수 항목입니다.', true); DOM.$('#title')?.focus(); return false; }
                if (!cat) { DOM.showToast('카테고리를 선택해주세요.', true); DOM.$('#category')?.focus(); return false; }
                if (!State.editorInstance) { DOM.showToast('에디터가 아직 로드되지 않았습니다.', true); return false; }
                // [FIX] 본문 유효성 검사는 handlePostSave에서 editor.save() 후로 이동
                return true;
            },

            showAuthModal: () => {
                const modalId = 'auth-modal';
                const html = `<div id="auth-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative" role="document">
                    <button data-action="close-modal" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button>
                    <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2>
                    <p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p>
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500" aria-label="이메일 입력" autocomplete="email">
                        <button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button>
                    </form>
                </div>`;
                
                const modal = DOM.showModal(modalId, html);
                if (!modal) return;

                modal.querySelector('#auth-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const email = DOM.$('#email-input').value.trim();
                    if (!email) { DOM.showToast('이메일 입력해주세요.', true); return; }
                    const btn = e.target.querySelector('button');
                    btn.disabled = true; btn.textContent = '전송 중...';
                    
                    const { error } = await Services.signIn(email);
                    if (error) { 
                        DOM.showToast(`오류: ${error.message}`, true); 
                        btn.disabled = false; btn.textContent = '매직 링크 받기';
                    } else { 
                        DOM.showToast('이메일 확인해주세요!'); 
                        DOM.closeModal(modalId); 
                    }
                };
            },
            
            showDeleteConfirmModal: (msg) => new Promise(res => {
                const modalId = 'delete-confirm-modal';
                const html = `<div id="delete-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8" role="document">
                    <h3 id="delete-modal-title" class="sr-only">삭제 확인</h3>
                    <p class="text-center text-black text-lg mb-8">${msg}</p>
                    <div class="flex justify-center gap-4">
                        <button data-action="delete-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button>
                        <button data-action="delete-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button>
                    </div>
                </div>`;

                const modal = DOM.showModal(modalId, html);
                if (!modal) return res(false);

                modal.querySelector('[data-action="delete-yes"]').onclick = () => { DOM.closeModal(modalId); res(true); };
                modal.querySelector('[data-action="delete-no"]').onclick = () => { DOM.closeModal(modalId); res(false); };
            }),

            updateMetaTags: (post = null) => {
                const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
                const desc = post ? post.summary : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
                const url = post ? `${Config.SITE_URL}/post/${post.slug}` : Config.SITE_URL;
                const img = post?.thumbnail_url || null;
                
                document.title = title;
                DOM.$('meta[name="description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:title"]')?.setAttribute('content', title);
                DOM.$('meta[property="og:description"]')?.setAttribute('content', desc);
                DOM.$('meta[property="og:url"]')?.setAttribute('content', url);
                DOM.$('link[rel="canonical"]')?.setAttribute('href', url);

                let ogImg = DOM.$('meta[property="og:image"]');
                if (img) {
                    if (ogImg) ogImg.setAttribute('content', img);
                    else {
                        ogImg = document.createElement('meta');
                        ogImg.setAttribute('property', 'og:image');
                        ogImg.setAttribute('content', img);
                        document.head.appendChild(ogImg);
                    }
                }
                
                const ld = DOM.$('#ld-json') || document.createElement('script');
                ld.type = 'application/ld+json';
                ld.id = 'ld-json';
                ld.textContent = JSON.stringify(post ? {
                    "@context": "https://schema.org", "@type": "BlogPosting",
                    "headline": post.title, "datePublished": post.created_at,
                    "dateModified": post.updated_at || post.created_at,
                    "author": { "@type": "Organization", "name": "InsureLog" },
                    "image": img ? [img] : undefined,
                    "mainEntityOfPage": { "@type": "WebPage", "@id": url },
                    "description": desc
                } : {
                    "@context": "https://schema.org", "@type": "WebSite",
                    "name": "InsureLog", "url": Config.SITE_URL, "description": desc
                });
                if (!DOM.$('#ld-json')) document.head.appendChild(ld);
            }
        };

        /**
         * [Module: Router]
         * 브라우저 히스토리 및 뷰 전환을 관리합니다.
         */
        const Router = {
            init: () => {
                window.addEventListener('popstate', Router.handleRouting);
                Router.handleRouting(); // 초기 라우팅
            },

            navigateTo: (path, replace = false) => {
                let relativePath;
                try {
                    const url = new URL(path);
                    if (url.origin === window.location.origin) {
                        relativePath = url.pathname + url.search + url.hash;
                    } else {
                        window.location.href = path;
                        return;
                    }
                } catch (e) {
                    relativePath = path || '/';
                }
                
                const action = replace ? 'replaceState' : 'pushState';
                const currentPath = window.location.pathname + window.location.search + window.location.hash;

                if (currentPath !== relativePath) {
                    history[action]({ path: relativePath }, '', relativePath);
                }
                
                Router.handleRouting();
            },


            switchView: async (viewId, callback) => {
                const current = DOM.$('.app-view.active');
                if (current) {
                    await DOM.animateSwitch(current, false);
                    current.classList.remove('active');
                    current.innerHTML = '';
                }
                const next = DOM.$(`#${viewId}`);
                if (next) {
                    next.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                    next.classList.add('active');
                    await DOM.animateSwitch(next);
                    try {
                        await callback(next); // 뷰 렌더링 함수 실행
                    } catch (error) {
                        console.error(`Error rendering ${viewId}:`, error);
                        next.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                    }
                    window.scrollTo(0, 0);
                }
            },

            handleRouting: () => {
                if (!State.isAuthReady) return; 
                
                const path = window.location.pathname;
                const params = new URLSearchParams(window.location.search);
                const parts = path.split('/').filter(Boolean);
                const route = parts[0] || 'library';
                const param = parts[1] || null;
                
                if (!State.user && ['dashboard', 'writer'].includes(route)) {
                    DOM.showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                switch (route) {
                    case 'post': 
                        return Router.switchView('view-post', el => ViewRenderer.renderPost(el, param));
                    case 'dashboard': 
                        return Router.switchView('view-dashboard', el => ViewRenderer.renderDashboard(el));
                    case 'writer': 
                        return Router.switchView('view-writer', el => ViewRenderer.renderWriter(el, param));
                    default: 
                        const page = parseInt(params.get('page'), 10) || 1;
                        State.currentCategory = params.get('category') || '전체';
                        return Router.switchView('view-library', el => ViewRenderer.renderLibrary(el, page, State.currentCategory));
                }
            }
        };

        /**
         * [Module: App]
         * 애플리케이션의 메인 진입점. 초기화 및 전역 이벤트 핸들러를 관리합니다.
         */
        const App = {
            init: () => {
                Services.init();
                App.bindGlobalListeners();

                Services.onAuthChange((user) => {
                    const authChanged = State.user?.id !== user?.id;
                    State.user = user;

                    if (!State.isAuthReady) {
                        State.isAuthReady = true;
                        ViewRenderer.renderNav();
                        Router.init(); 
                        DOM.animateSwitch(DOM.$('#app-loader'), false).then(() => DOM.$('#app-loader').remove());
                    } else if (authChanged) {
                        ViewRenderer.renderNav();
                        Router.handleRouting(); 
                    }
                });
            },

            bindGlobalListeners: () => {
                document.addEventListener('click', (e) => {
                    const action = e.target.closest('[data-action]');
                    if (action && !action.closest('form')) {
                        e.preventDefault();
                        const act = action.dataset.action;
                        switch (act) {
                            case 'auth': return ViewRenderer.showAuthModal();
                            case 'logout': return App.handleLogout();
                            case 'filter-category': 
                                return Router.navigateTo(DOM.buildUrl('/', { page: 1, category: action.dataset.category }));
                            case 'close-modal':
                                return DOM.closeModal(action.closest('[role="dialog"]').id);
                        }
                    }
                    
                    const link = e.target.closest('a');
                    if (link && 
                        link.href &&
                        link.origin === window.location.origin &&
                        !link.dataset.action &&
                        !link.href.endsWith('#') &&
                        link.target !== '_blank' &&
                        !e.ctrlKey && !e.metaKey
                    ) {
                        e.preventDefault();
                        Router.navigateTo(link.href);
                        return; 
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = DOM.$('[role="dialog"]');
                        if (modal) DOM.closeModal(modal.id);
                    }
                });
            },

            waitForGlobals: (globals, timeout = 3000) => {
                return new Promise((resolve, reject) => {
                    const startTime = Date.now();
                    function check() {
                        const missing = globals.filter(g => typeof window[g] === 'undefined');
                        if (missing.length === 0) {
                            return resolve(true);
                        }
                        if (Date.now() - startTime > timeout) {
                            console.warn('Library timeout:', missing);
                            return reject(new Error(`Libraries failed to load: ${missing.join(', ')}`));
                        }
                        setTimeout(check, 50); // 50ms 마다 확인
                    }
                    check();
                });
            },

            handleLogout: async () => {
                try { 
                    await Services.signOut(); 
                    DOM.showToast('로그아웃되었습니다.'); 
                } catch (e) { 
                    console.error('Logout error:', e); 
                    DOM.showToast('로그아웃 실패.', true);
                }
                Router.navigateTo('/', true);
            },

            /**
             * [REFACTOR]
             * - handlePostSave가 Editor.js 인스턴스에서 데이터를 가져옵니다.
             * - editor.save()를 호출하여 JSON 데이터를 받습니다.
             * - JSON 데이터를 기반으로 요약(summary)과 썸네일(thumb)을 생성합니다.
             * - JSON을 문자열화하여 `refined_content`로 저장합니다.
             */
            handlePostSave: async (action, btn) => {
                if (!State.editorInstance) {
                    DOM.showToast('에디터가 준비되지 않았습니다.', true);
                    return;
                }

                const origText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;
                
                try {
                    const savedData = await State.editorInstance.save();

                    if (savedData.blocks.length === 0) {
                        DOM.showToast('본문은 필수 항목입니다.', true);
                        throw new Error('Content is empty.');
                    }
                    
                    const title = DOM.$('#title').value.trim();
                    const status = action === 'publish' ? 'published' : 'draft';
                    
                    // [NEW] JSON 기반 요약 생성
                    let summary = DOM.$('#summary').value.trim();
                    if (!summary) {
                        const firstP = savedData.blocks.find(b => b.type === 'paragraph');
                        summary = firstP ? firstP.data.text.replace(/&nbsp;/g, ' ').slice(0, 150) + '...' : '';
                    }

                    // [NEW] JSON 기반 썸네일 생성
                    const firstImg = savedData.blocks.find(b => b.type === 'image');
                    const thumb = firstImg ? firstImg.data.file.url : null;
                    
                    const id = DOM.$('#post-id').value || null;
                    let slug = DOM.$('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    
                    if (!id) { // 새 글일 때만 slug 중복 검사
                        const { data } = await Services.checkSlugExists(slug);
                        if (data) slug += `-${Date.now().toString().slice(-6)}`;
                    }
                    
                    const postData = { 
                        id: id,
                        title, slug, status, summary, 
                        author_id: State.user.id, 
                        refined_content: JSON.stringify(savedData), // [NEW] JSON을 문자열로 저장
                        category: DOM.$('#category').value, 
                        thumbnail_url: thumb // [NEW] JSON에서 추출한 썸네일
                    };
                    
                    const { data: savedPost, error } = await Services.savePost(postData);
                    if (error) throw error;
                    
                    DOM.showToast(status === 'published' ? '발행되었습니다!' : '저장되었습니다.');
                    Router.navigateTo(status === 'published' ? `/post/${savedPost.slug}` : '/dashboard');

                } catch (e) {
                    console.error("Save error:", e);
                    // 'Content is empty.' 오류는 사용자에게 표시하지 않음 (이미 토스트로 처리됨)
                    if (e.message !== 'Content is empty.') {
                        DOM.showToast(`저장 실패: ${e.message}`, true);
                    }
                } finally {
                    btn.disabled = false;
                    btn.textContent = origText;
                }
            },

            handlePostDelete: async (id) => {
                if (!id) return;
                const confirm = await ViewRenderer.showDeleteConfirmModal('정말 삭제하시겠습니까? 되돌릴 수 없습니다.');
                if (!confirm) return;
                
                DOM.showToast('삭제 중...');
                const { error } = await Services.deletePost(id);
                if (error) {
                    DOM.showToast(`삭제 실패: ${error.message}`, true);
                } else {
                    DOM.showToast('삭제되었습니다.');
                    Router.navigateTo('/dashboard');
                }
            },

            /**
             * [NEW]
             * Editor.js 이미지 업로더를 위한 래퍼 함수입니다.
             * WebP 변환 및 Supabase 업로드를 처리하고 Editor.js가 요구하는 형식으로 반환합니다.
             */
            uploadImageForEditor: async (file) => {
                try {
                    DOM.showToast('이미지 업로드 및 변환 중...');
                    // Services.uploadImage는 WebP 변환을 포함합니다.
                    const url = await Services.uploadImage(file); 
                    DOM.showToast('업로드 완료!', false);
                    return {
                        success: 1,
                        file: { url: url }
                    };
                } catch (e) {
                    console.error('Editor image upload failed:', e);
                    DOM.showToast(`이미지 업로드 실패: ${e.message}`, true);
                    return { success: 0 };
                }
            },

            /**
             * [REFACTOR]
             * 이미지 최적화 헬퍼 함수 (WebP 변환)
             */
            getOrientation: (file) => new Promise((res) => {
                if (typeof EXIF === 'undefined') { 
                    console.warn('EXIF.js not loaded. Assuming orientation 1.');
                    res(1); 
                    return; 
                }
                EXIF.getData(file, function() { 
                    res(EXIF.getTag(this, 'Orientation') || 1);
                });
            }),

            convertToWebP: (file, quality = 0.8) => new Promise((res) => {
                // WebP 변환을 지원하지 않거나, 이미 WebP이거나, GIF인 경우 원본 반환
                if (typeof FileReader === 'undefined' || typeof Image === 'undefined' || typeof EXIF === 'undefined' || file.type === 'image/webp' || file.type === 'image/gif') {
                    console.warn('WebP 변환 API 미지원 또는 불필요. 원본 파일 사용.');
                    res(file);
                    return;
                }
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async (e) => {
                    const img = new Image(); 
                    img.src = e.target.result;
                    img.onload = async () => {
                        const orient = await App.getOrientation(file);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height;
                        
                        // EXIF 방향에 따라 캔버스 회전
                        if (orient >= 5 && orient <= 8) { [w, h] = [h, w]; }
                        canvas.width = w; canvas.height = h;
                        const transforms = {2: [-1,0,0,1,w,0], 3: [-1,0,0,-1,w,h], 4: [1,0,0,-1,0,h], 5: [0,1,1,0,0,0], 6: [0,1,-1,0,h,0], 7: [0,-1,-1,0,h,w], 8: [0,-1,1,0,0,w]};
                        ctx.transform(...(transforms[orient] || [1,0,0,1,0,0]));
                        if (orient >= 5 && orient <= 8) {
                             ctx.drawImage(img, 0, 0, img.height, img.width);
                        } else {
                             ctx.drawImage(img, 0, 0, img.width, img.height);
                        }
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                let baseName = file.name ? file.name.split('.').slice(0, -1).join('.') : 'image';
                                const webpFile = new File([blob], `${baseName}.webp`, { type: 'image/webp' });
                                res(webpFile);
                            } else {
                                 res(file); // 변환 실패 시 원본
                            }
                        }, 'image/webp', quality);
                    };
                    img.onerror = () => res(file); // 이미지 로드 실패 시 원본
                };
                reader.onerror = () => res(file); // 리더 실패 시 원본
            })
        };

        // --- [APP START] ---
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>


