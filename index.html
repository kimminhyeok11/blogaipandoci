<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KQ8THNV2');</script>
    <!-- End Google Tag Manager -->

    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app/" />
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app/">
    <meta property="og:title" content="InsureLog">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://blogaipandoci.vercel.app/">
    <meta property="twitter:title" content="InsureLog">
    <meta property="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #111827; --bg-content: #1F2937; --bg-content-secondary: #374151;
            --bg-editor-toolbar: #2c3a4f; --bg-editor-main: #243041;
            --border-color: #374151; --text-primary: #F0F2F5; --text-secondary: #b0b8c4;
            --text-tertiary: #8a93a2; --accent: #3B82F6; --accent-hover: #2563EB;
            --danger: #EF4444; --danger-hover: #DC2626; --font-heading: 'Noto Sans KR', sans-serif;
            --font-body: 'Noto Sans KR', sans-serif; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        html{scroll-behavior:smooth}
        body{font-family:var(--font-body);background-color:var(--bg-main);color:var(--text-primary);font-size:15px;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;display:flex;flex-direction:column;min-height:100vh}
        #app-container{flex-grow:1}
        #app-loader{position:fixed;top:0;left:0;width:100%;height:100%;z-index:100;background-color:var(--bg-main);display:flex;align-items:center;justify-content:center;transition:opacity .5s ease}
        .loader-spinner{width:28px;height:28px;border:3px solid var(--border-color);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .app-view{display:none}.app-view.active{display:block}
        .brand-logo{font-family:var(--font-heading);font-weight:700;font-size:1rem;color:var(--text-primary);letter-spacing:-.5px}
        .btn{padding:.4rem .8rem;font-size:.8125rem;font-weight:500;border-radius:6px;transition:all .25s ease;display:inline-flex;align-items:center;justify-content:center;gap:.4rem;border:1px solid var(--border-color);background-color:var(--bg-content);color:var(--text-secondary);cursor:pointer;box-shadow:var(--shadow-sm)}
        .btn:hover{background-color:var(--bg-content-secondary);color:var(--text-primary);transform:translateY(-1px);box-shadow:var(--shadow-md)}
        .btn.active{background-color:var(--accent); color:white; border-color:var(--accent)}
        .form-input,.form-textarea{font-size:.875rem;padding:.5rem .75rem;border:1px solid var(--border-color);border-radius:6px;width:100%;background-color:var(--bg-content);color:var(--text-primary);transition:all .2s ease;box-shadow:var(--shadow-sm)}
        .form-input:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px #3b82f633}
        .prose-custom{color:var(--text-secondary);line-height:1.75;font-size:0.95rem}
        .prose-custom>*:not(:first-child){margin-top:1.25em}
        .prose-custom p{margin-bottom:1.25em}
        .prose-custom h1,.prose-custom h2,.prose-custom h3{color:var(--text-primary);font-family:var(--font-heading);font-weight:700;margin-top:2em;margin-bottom:.8em}
        .prose-custom h1{font-size:1.8rem;border-bottom:1px solid var(--border-color);padding-bottom:.4em}
        .prose-custom h2{font-size:1.4rem}
        .prose-custom h3{font-size:1.2rem}
        .prose-custom a{color:var(--accent);text-decoration:none;font-weight:500;border-bottom:1px solid #93c5fd;transition:all .2s ease}
        .prose-custom ul, .prose-custom ol { padding-left: 1.5em; margin-bottom: 1.25em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom ul { list-style-type: disc; }
        .prose-custom ol { list-style-type: decimal; }
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { margin-top: 0.5em; margin-bottom: 0.5em;}
        .prose-custom table{width:100%;border-collapse:collapse;margin:2em 0;border:1px solid var(--border-color);box-shadow:var(--shadow-sm);border-radius:8px;overflow:hidden}
        .prose-custom th,.prose-custom td{border:1px solid var(--border-color);padding:.6rem .8rem;text-align:left}
        .prose-custom th{background-color:var(--bg-content-secondary);font-weight:600;color:var(--text-primary)}
        .prose-custom hr { border: 0; border-top: 1px solid var(--border-color); margin: 2em 0; }
        #editor-container, #raw-editor-container{background-color:var(--bg-editor-main);border:1px solid var(--border-color);border-radius:8px;box-shadow:var(--shadow-sm)}
        #editor-container .ql-toolbar{border:none;border-bottom:1px solid var(--border-color);border-radius:8px 8px 0 0;background-color:var(--bg-editor-toolbar);padding:6px}
        #editor-container .ql-snow .ql-stroke{stroke:var(--text-secondary)}
        #editor-container .ql-editor{min-height:450px;font-size:0.95rem;line-height:1.75;color:var(--text-primary);padding:1.2rem}
        #raw-editor{width:100%;min-height:450px;background:transparent;border:none;padding:1.2rem;color:var(--text-primary);font-family:monospace;font-size:0.9rem;line-height:1.6;resize:vertical;}
        #raw-editor:focus{outline:none}
        .tag-badge { display: inline-block; background-color: var(--bg-content-secondary); color: var(--text-secondary); padding: 0.2rem 0.6rem; font-size: 0.75rem; border-radius: 9999px; margin-right: 0.4rem; margin-top: 0.4rem; }
        .sidebar-nav-btn { background-color: var(--accent) !important; color: white !important; border-color: var(--accent-hover) !important; padding: 0.2rem 0.5rem !important; font-size: 0.7rem !important; }
        .sidebar-nav-btn:hover { background-color: var(--accent-hover) !important; }
        #sidebar-container ul li a { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        @media (max-width:768px){body{font-size:14px}header{padding: .5rem .75rem !important;}.prose-custom h1{font-size:1.6rem}.btn{padding:.4rem .6rem;font-size:.75rem}.brand-logo{font-size:1rem}}
    </style>
</head>
<body class="antialiased">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ8THNV2"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <div id="app-loader"><div class="loader-spinner"></div></div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-3"></header>
    
    <div id="app-container" class="w-full max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
        <main id="main-content">
            <div id="view-library" class="app-view"></div>
            <div id="view-post" class="app-view"></div>
            <div id="view-dashboard" class="app-view max-w-5xl mx-auto"></div>
            <div id="view-writer" class="app-view max-w-4xl mx-auto"></div>
        </main>
    </div>

    <footer class="text-center py-6 px-4 border-t border-gray-800 mt-16">
        <p class="text-sm text-gray-500">
            © 2024 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.com/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-400 hover:text-white transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
        
    <div id="structured-data-container"></div>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-3 right-3 z-50 space-y-2"></div>
    
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- CONFIGURATION & STATE---
        const SITE_URL = 'https://blogaipandoci.vercel.app';
        const SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        const IMAGE_BUCKET_NAME = 'thought-images';
        const POSTS_PER_PAGE = 8;
        const defaultMeta = {
            title: "InsureLog",
            description: "AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.",
            image: 'https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp'
        };
        const AD_CLIENT = "ca-pub-5239497835591112";
        const AD_SLOT_ID = "2069100221";
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const state = { 
            user: null, 
            quill: null, 
            isAuthReady: false, 
            currentEditorMode: 'normal',
            sidebar: { posts: [], page: 0, postsPerPage: 5, isLoading: false }
        };
        const $ = (selector) => document.querySelector(selector);
        const turndownService = new TurndownService();

        // --- CORE APP LOGIC ---
        function navigateTo(path) { if (window.location.pathname !== path) history.pushState({ path }, '', path); handleRouting(); }
        async function switchView(viewId, callback) { if(state.quill) state.quill = null; const currentView = $('.app-view.active'); if (currentView) { await anime({ targets: currentView, translateY: [0, -10], opacity: [1, 0], duration: 250, easing: 'easeInCubic' }).finished; currentView.classList.remove('active'); currentView.innerHTML = ''; } const nextView = $(`#${viewId}`); if (nextView) { if (callback) await callback(nextView); nextView.classList.add('active'); anime({ targets: nextView, translateY: [10, 0], opacity: [0, 1], duration: 350, easing: 'easeOutCubic' }); window.scrollTo(0, 0); } }
        function handleRouting() { if (!state.isAuthReady) return; const path = window.location.pathname; const parts = path.substring(1).split('/'); let route = parts[0] || 'library'; let param = parts[1] || null; let page = 1; if (route === 'page') { page = parseInt(param, 10) || 1; route = 'library'; } else if (route === 'dashboard' && parts[1] === 'page') { page = parseInt(parts[2], 10) || 1; } if (!state.user && ['dashboard', 'writer'].includes(route)) { showToast('이 기능을 사용하려면 로그인이 필요합니다.', true); navigateTo('/'); return; } switch (route) { case 'post': switchView('view-post', el => renderPostView(el, param)); break; case 'dashboard': switchView('view-dashboard', el => renderDashboardView(el, page)); break; case 'writer': switchView('view-writer', el => renderWriterView(el, param)); break; default: switchView('view-library', el => renderLibraryView(el, page)); } }
        
        // --- VIEW RENDERING ---
        function renderNav() { $('#main-nav-container').innerHTML = `<nav class="w-full max-w-7xl flex items-center justify-between py-2 px-3 bg-gray-800/60 backdrop-blur-lg border border-gray-700 rounded-xl shadow-sm"><a href="/" data-route class="brand-logo">InsureLog</a><div class="flex items-center space-x-2">${state.user ? `<a href="/dashboard" data-route class="btn !px-3 !py-1.5">대시보드</a><button data-action="logout" class="btn !px-3 !py-1.5">로그아웃</button>` : `<button data-action="auth" class="btn btn-primary !px-3 !py-1.5">로그인 / 가입</button>`}</div></nav>`; }
        async function renderLibraryView(container, page = 1) { updateMetaTags(); if (!sessionStorage.getItem('site_visited')) { supabase.from('site_visits').insert({}).then(); sessionStorage.setItem('site_visited', 'true'); } const { from, to } = { from: (page - 1) * POSTS_PER_PAGE, to: page * POSTS_PER_PAGE - 1 }; const [{ count: totalVisits }, { data: posts, error, count: totalPosts }] = await Promise.all([supabase.from('site_visits').select('*', { count: 'exact', head: true }), supabase.from('posts').select('*, view_count', { count: 'exact' }).eq('status', 'published').order('created_at', { ascending: false }).range(from, to)]); if (error) { console.error("Error fetching posts:", error); container.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`; return; } 
        const postsHtml = posts.length > 0 ? posts.map(post => `<a href="/post/${post.slug}" data-route class="block p-4 bg-gray-800 border border-gray-700 hover:border-blue-600 rounded-lg shadow-sm hover:shadow-lg transition-all duration-300 group transform hover:-translate-y-1"><h2 class="text-base font-bold font-heading mb-1.5 text-gray-100 group-hover:text-white transition-colors line-clamp-2">${post.title}</h2><div class="flex justify-between items-center text-xs text-gray-500 mt-3"><span>${new Date(post.created_at).toLocaleDateString('ko-KR')}</span><span>조회수 ${(post.view_count || 0).toLocaleString()}</span></div></a>`).join('') : `<div class="text-center py-20 text-gray-400 col-span-full"><p class="mb-5">아직 작성된 글이 없습니다.</p>${state.user ? '<a href="/writer" data-route class="btn btn-primary">첫 글 작성하기</a>' : ''}</div>`; 
        container.innerHTML = `<div class="py-8"><div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8"><div class="lg:col-span-2"><div class="text-center mb-10"><h1 class="text-3xl sm:text-4xl font-extrabold font-heading mb-2 tracking-tight text-white">InsureLog</h1><p class="text-gray-400 text-base mb-3">AI, 기술, 그리고 보험에 대한 기록들</p><div class="text-xs text-gray-500">총 방문자: ${(totalVisits || 0).toLocaleString()}</div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${postsHtml}</div>${renderPaginationControls(page, totalPosts, '/page/')}</div><aside class="lg:col-span-1 lg:block mt-16 lg:mt-0" id="sidebar-container"></aside></div></div>`; renderSidebar(container.querySelector('#sidebar-container')); }
        async function renderPostView(container, slug) { if (!slug) { navigateTo('/'); return; } const { data: post, error } = await supabase.from('posts').select('*').eq('slug', slug).single(); if (error || !post) { showToast('글을 찾을 수 없습니다.', true); navigateTo('/'); return; } (async () => { const viewedPosts = JSON.parse(sessionStorage.getItem('viewed_posts')) || []; if (!viewedPosts.includes(post.id)) { await supabase.rpc('increment_post_view', { post_slug: slug }); viewedPosts.push(post.id); sessionStorage.setItem('viewed_posts', JSON.stringify(viewedPosts)); } })(); if (post.status === 'draft' && (!state.user || post.author_id !== state.user.id)) { showToast('초안 상태의 글은 작성자만 볼 수 있습니다.', true); navigateTo('/'); return; } updateMetaTags(post); const editButtonHtml = (state.user && state.user.id === post.author_id) ? `<a href="/writer/${post.slug}" class="btn" data-route>수정하기</a>` : ''; 
        const tagsHtml = (post.tags && post.tags.length > 0) ? `<div class="mt-4">${(post.tags || []).map(tag => `<span class="tag-badge">#${tag}</span>`).join('')}</div>` : '';
        container.innerHTML = `<div class="py-8"><div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8"><div class="lg:col-span-2"><div class="bg-gray-800 border border-gray-700 rounded-xl shadow-sm p-5 sm:p-8"><article class="prose-custom max-w-none"><div class="flex justify-between items-center mb-6"><div class="text-sm text-gray-400">${new Date(post.created_at).toLocaleDateString('ko-KR')} · 조회수 ${(post.view_count || 0).toLocaleString()}</div>${editButtonHtml}</div><h1 class="!mt-0">${post.title}</h1><div id="in-article-ad-container" class="my-6 min-h-[100px] flex items-center justify-center text-sm text-gray-600"></div><div id="post-content">${post.refined_content || ''}</div>${tagsHtml}</article></div></div><aside class="lg:col-span-1 lg:block mt-16 lg:mt-0" id="sidebar-container"></aside></div></div>`; renderSidebar(container.querySelector('#sidebar-container')); lazyLoadImages(); if (window.PR) PR.prettyPrint(); renderAdSlot(container.querySelector('#in-article-ad-container')); }
        async function renderDashboardView(container, page = 1) { updateMetaTags(); const { from, to } = { from: (page - 1) * POSTS_PER_PAGE, to: page * POSTS_PER_PAGE - 1 }; const { data, error, count } = await supabase.from('posts').select('*, view_count', { count: 'exact' }).eq('author_id', state.user.id).order('created_at', { ascending: false }).range(from, to); if (error) { container.innerHTML = `<p>내가 작성한 글을 불러올 수 없습니다.</p>`; return; } const listHtml = data.length > 0 ? data.map(post => `<li class="p-3 flex flex-col sm:flex-row justify-between sm:items-center hover:bg-gray-800/50 rounded-lg transition-colors"><div class="mb-3 sm:mb-0"><a href="/post/${post.slug}" data-route class="font-semibold text-gray-200 hover:text-white">${post.title}</a>${post.status === 'draft' ? '<span class="ml-2 text-xs font-semibold bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">초안</span>' : '<span class="ml-2 text-xs font-semibold bg-green-200 text-green-800 px-2 py-0.5 rounded-full">발행됨</span>'}<p class="text-xs text-gray-400 mt-1">${new Date(post.created_at).toLocaleString('ko-KR')} / 조회수 ${(post.view_count || 0).toLocaleString()}</p></div><div class="flex-shrink-0 space-x-2"><a href="/writer/${post.slug}" class="btn !text-xs" data-route>수정</a><button class="btn !text-xs !bg-red-800/50 !border-red-700/50 hover:!bg-red-700 text-white" data-action="delete" data-id="${post.id}">삭제</button></div></li>`).join('') : '<li class="p-8 text-center text-gray-400">작성된 글이 없습니다.</li>'; container.innerHTML = `<div class="py-8"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6"><div><h1 class="text-xl sm:text-2xl font-bold font-heading">내 글 관리</h1><p class="text-gray-400 mt-1 text-sm">작성한 글을 수정하거나 삭제할 수 있습니다.</p></div><a href="/writer" class="btn btn-primary mt-4 sm:mt-0" data-route>새 글 작성</a></div><div class="bg-gray-800 border border-gray-700 rounded-xl shadow-sm"><ul class="divide-y divide-gray-700">${listHtml}</ul></div>${renderPaginationControls(page, count, '/dashboard/page/')}</div>`; }
        
        // This function handles both creating a new post and editing an existing one
        async function renderWriterView(container, slug) { 
            updateMetaTags({title: 'Editor'}); 
            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', tags: [] }; 
            // If a slug exists in the URL, it's an edit, so fetch the post data
            if (slug) { 
                const { data, error } = await supabase.from('posts').select('*').eq('slug', slug).single(); 
                if (error || !data || data.author_id !== state.user.id) { 
                    showToast(error ? '글 정보를 가져오지 못했습니다.' : '자신이 작성한 글만 수정할 수 있습니다.', true); 
                    navigateTo('/dashboard'); return; 
                } 
                post = data; 
            } 
            // Render the form, populating it with post data if editing
            container.innerHTML = `<div class="py-6"><div class="mb-5 flex justify-between items-center"><button class="btn" data-action="back">← 대시보드로</button><div id="editor-mode-switcher" class="flex items-center space-x-1 bg-gray-900/50 p-1 rounded-lg"><button data-mode="normal" class="btn !px-3 !py-1 !text-xs active">일반</button><button data-mode="markdown" class="btn !px-3 !py-1 !text-xs">마크다운</button><button data-mode="html" class="btn !px-3 !py-1 !text-xs">HTML</button></div></div><h1 class="text-xl sm:text-2xl font-bold font-heading mb-5">${post.id ? '글 수정하기' : '새 글 작성하기'}</h1><form id="writer-form" class="space-y-5"><input type="hidden" id="post-id" value="${post.id || ''}"><input type="hidden" id="post-slug" value="${post.slug || ''}"><div><label for="title" class="block text-sm font-medium text-gray-300 mb-1">제목</label><input type="text" id="title" class="form-input" required value="${post.title}"></div><div><label for="summary" class="block text-sm font-medium text-gray-300 mb-1">요약</label><textarea id="summary" class="form-textarea" rows="2">${post.summary}</textarea></div><div><label for="tags" class="block text-sm font-medium text-gray-300 mb-1">태그 (쉼표로 구분)</label><input type="text" id="tags" class="form-input" value="${(post.tags || []).join(', ')}"></div><div><label class="block text-sm font-medium text-gray-300 mb-1">본문</label><div id="editor-container"><div id="editor"></div></div><div id="raw-editor-container" class="hidden"><textarea id="raw-editor"></textarea></div></div><div class="flex justify-end items-center space-x-2 pt-3"><button type="button" data-action="save-draft" class="btn">초안으로 저장</button><button type="button" data-action="publish" class="btn btn-primary">발행하기</button></div></form></div>`; 
            initQuillEditor(post.refined_content || ''); 
            addEditorModeSwitcherListeners(); 
        }

        // --- SIDEBAR LOGIC ---
        async function fetchSidebarPosts() { if (state.sidebar.posts.length > 0 || state.sidebar.isLoading) return; state.sidebar.isLoading = true; const { data } = await supabase.from('posts').select('title, slug').eq('status', 'published').order('created_at', { ascending: false }).limit(20); state.sidebar.posts = data || []; state.sidebar.isLoading = false; }
        function renderSidebar(container) { if (!container) return; const { posts, page, postsPerPage } = state.sidebar; const totalPages = Math.ceil(posts.length / postsPerPage); const start = page * postsPerPage; const end = start + postsPerPage; const paginatedPosts = posts.slice(start, end); const recentPostsHtml = paginatedPosts.length > 0 ? paginatedPosts.map(post => `<li><a href="/post/${post.slug}" data-route class="block py-2 text-sm text-gray-400 hover:text-white transition-colors font-medium">${post.title}</a></li>`).join('') : '<li class="text-sm text-gray-500 py-2">최신 글이 없습니다.</li>'; const navControlsHtml = totalPages > 1 ? `<div class="flex justify-between items-center mt-3"><button data-action="sidebar-prev" class="btn sidebar-nav-btn ${page === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 0 ? 'disabled' : ''}>이전</button><span class="text-xs text-gray-500">${page + 1} / ${totalPages}</span><button data-action="sidebar-next" class="btn sidebar-nav-btn ${page + 1 >= totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page + 1 >= totalPages ? 'disabled' : ''}>다음</button></div>` : ''; container.innerHTML = `<div class="lg:sticky lg:top-20 space-y-6"><div class="bg-gray-800 border border-gray-700 rounded-xl shadow-sm p-4"><h3 class="font-bold font-heading mb-1 text-white text-base">최신 글</h3><ul class="divide-y divide-gray-700">${recentPostsHtml}</ul>${navControlsHtml}</div><div class="bg-gray-800 border border-gray-700 rounded-xl shadow-sm p-4"><span class="text-xs text-gray-500">Advertisement</span><div id="sidebar-ad-container" class="mt-2 min-h-[250px] flex items-center justify-center"></div></div></div>`; renderAdSlot(container.querySelector('#sidebar-ad-container'), { format: 'auto', fullWidthResponsive: true }); }

        // --- EDITOR LOGIC ---
        function initQuillEditor(initialContent) { const editorElement = $('#editor'); if (!editorElement) return; const BlockEmbed = Quill.import('blots/block/embed'); class DividerBlot extends BlockEmbed {} DividerBlot.blotName = 'divider'; DividerBlot.tagName = 'hr'; Quill.register(DividerBlot); const toolbarOptions = [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'color': [] }, { 'background': [] }], [{ 'align': [] }], ['blockquote', 'code-block'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'script': 'sub'}, { 'script': 'super' }], [{ 'indent': '-1'}, { 'indent': '+1' }], ['link', 'image'], 'divider', ['clean'] ]; state.quill = new Quill('#editor', { modules: { toolbar: { container: toolbarOptions, handlers: { 'image': quillImageHandler, 'divider': function() { const range = this.quill.getSelection(true); this.quill.insertText(range.index, '\n', Quill.sources.USER); this.quill.insertEmbed(range.index + 1, 'divider', true, Quill.sources.USER); this.quill.setSelection(range.index + 2, Quill.sources.SILENT); } } }, history: { delay: 2000, maxStack: 500, userOnly: true } }, placeholder: '여기에 글을 작성하세요...', theme: 'snow' }); if (initialContent) state.quill.clipboard.dangerouslyPasteHTML(0, initialContent); }
        function addEditorModeSwitcherListeners() { const switcher = $('#editor-mode-switcher'); if(!switcher) return; const quillContainer = $('#editor-container'); const rawContainer = $('#raw-editor-container'); const rawEditor = $('#raw-editor'); switcher.addEventListener('click', e => { const button = e.target.closest('button'); if (!button) return; const mode = button.dataset.mode; if (mode === state.currentEditorMode) return; try { if (state.currentEditorMode === 'normal') { const html = state.quill.root.innerHTML; if (mode === 'markdown') rawEditor.value = turndownService.turndown(html); else if (mode === 'html') rawEditor.value = html; } else { const rawValue = rawEditor.value; if (mode === 'normal') { const html = state.currentEditorMode === 'markdown' ? marked.parse(rawValue) : rawValue; state.quill.clipboard.dangerouslyPasteHTML(0, html); } } } catch (err) { showToast('콘텐츠 변환 중 오류가 발생했습니다.', true); console.error("Editor mode switch error:", err); return; } quillContainer.classList.toggle('hidden', mode !== 'normal'); rawContainer.classList.toggle('hidden', mode === 'normal'); switcher.querySelector('.active').classList.remove('active'); button.classList.add('active'); state.currentEditorMode = mode; }); }
        
        // This function handles saving data for both new and edited posts
        async function handlePostSave(status, button) { 
            let title = $('#title').value.trim(); 
            let summary = $('#summary').value.trim(); 
            if (!title) { showToast('제목은 필수 항목입니다.', true); return; } 
            
            let contentHtml = ''; 
            try { 
                switch(state.currentEditorMode) { 
                    case 'markdown': contentHtml = marked.parse($('#raw-editor').value); break; 
                    case 'html': contentHtml = $('#raw-editor').value; break; 
                    default: contentHtml = state.quill.root.innerHTML; break; 
                } 
            } catch (err) { showToast('콘텐츠 변환 오류로 저장할 수 없습니다.', true); return; } 
            
            if (!summary) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = contentHtml; const text = tempDiv.textContent || tempDiv.innerText || ""; summary = text.trim().substring(0, 150) + (text.length > 150 ? '...' : ''); } 
            if (!summary && status === 'published') { showToast('요약은 필수 항목입니다. 본문을 작성하시면 자동으로 생성됩니다.', true); return; } 
            
            const originalBtnText = button.textContent; 
            button.disabled = true; button.innerHTML = `<div class="loader-spinner !w-4 !h-4 !border-2"></div>`; 
            
            try { 
                const id = $('#post-id').value; 
                let slug = $('#post-slug').value || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, ''); 
                
                // If it's a new post, check for duplicate slug and append a timestamp if needed
                if (!id) { 
                    const { data } = await supabase.from('posts').select('id').eq('slug', slug).maybeSingle(); 
                    if (data) slug = `${slug}-${Date.now().toString().slice(-4)}`; 
                } 
                
                const postData = { title, summary, slug, status, author_id: state.user.id, refined_content: contentHtml, tags: $('#tags').value.split(',').map(t => t.trim()).filter(Boolean) }; 
                
                // If an ID exists, update the post. Otherwise, insert a new one.
                const { data, error } = id 
                    ? await supabase.from('posts').update(postData).eq('id', id).select().single() 
                    : await supabase.from('posts').insert(postData).select().single(); 
                
                if (error) throw error; 
                showToast(status === 'published' ? '글이 발행되었습니다!' : '초안이 저장되었습니다.'); 
                navigateTo(status === 'published' ? `/post/${data.slug}` : '/dashboard'); 
            } catch (error) { 
                showToast(`저장 실패: ${error.message}`, true); 
                console.error("Save post error: ", error);
            } finally { 
                button.disabled = false; button.textContent = originalBtnText; 
            } 
        }

        // --- UTILITIES ---
        function renderAdSlot(container, options = {}) { if (!container) return; container.innerHTML = ''; const ins = document.createElement('ins'); ins.className = 'adsbygoogle'; ins.style.display = 'block'; ins.dataset.adClient = AD_CLIENT; ins.dataset.adSlot = AD_SLOT_ID; if (options.format) ins.dataset.adFormat = options.format; if (options.fullWidthResponsive) ins.dataset.fullWidthResponsive = String(options.fullWidthResponsive); container.appendChild(ins); try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.error(`AdSense push error for slot ${AD_SLOT_ID}:`, e); } }
        function quillImageHandler() { if (!state.user) { showToast('이미지를 업로드하려면 로그인이 필요합니다.', true); return; } const input = document.createElement('input'); input.setAttribute('type', 'file'); input.setAttribute('accept', 'image/*'); input.click(); input.onchange = async () => { const file = input.files[0]; if (!file) return; const buttons = $('#writer-form').querySelectorAll('button'); buttons.forEach(b => b.disabled = true); showToast('이미지 업로드 및 변환 중...'); try { const webpBlob = await convertToWebP(file); const imageUrl = await uploadImageFile(webpBlob); const range = state.quill.getSelection(true); state.quill.insertEmbed(range.index, 'image', imageUrl, 'user'); state.quill.setSelection(range.index + 1, 'silent'); showToast('이미지 업로드 완료!'); } catch (error) { showToast(`이미지 업로드 실패: ${error.message}`, true); } finally { buttons.forEach(b => b.disabled = false); } }; }
        function updateMetaTags(post = null) { const title = post ? `${post.title} | InsureLog` : defaultMeta.title; const description = post ? (post.summary || defaultMeta.description) : defaultMeta.description; const url = post ? `${SITE_URL}/post/${post.slug}` : SITE_URL; let imageUrl = defaultMeta.image; if (post && post.refined_content) { const match = post.refined_content.match(/<img[^>]+src="([^">]+)"/); if (match && match[1]) imageUrl = match[1]; } document.title = title; $('meta[name="description"]').setAttribute('content', description); $('link[rel="canonical"]').setAttribute('href', url); ['og:title', 'twitter:title'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', title)); ['og:description', 'twitter:description'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', description)); ['og:url', 'twitter:url'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', url)); ['og:image', 'twitter:image'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content',imageUrl)); generateStructuredData(post ? 'Article' : 'WebSite', post); }
        function generateStructuredData(type, data = {}) { let schema = {}; if (type === 'WebSite') { schema = { "@context": "https://schema.org", "@type": "WebSite", "url": SITE_URL, "name": "InsureLog" }; } else if (type === 'Article' && data && data.refined_content) { const imageUrl = (data.refined_content.match(/<img[^>]+src="([^">]+)"/) || [])[1] || defaultMeta.image; schema = { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": `${SITE_URL}/post/${data.slug}` }, "headline": data.title, "description": data.summary, "image": imageUrl, "author": { "@type": "Person", "name": "InsureLog Admin" }, "publisher": { "@type": "Organization", "name": "InsureLog", "logo": { "@type": "ImageObject", "url": defaultMeta.image } }, "datePublished": new Date(data.created_at).toISOString(), "dateModified": new Date(data.updated_at || data.created_at).toISOString() }; } let script = document.getElementById('json-ld-structured-data'); if (!script) { script = document.createElement('script'); script.type = 'application/ld+json'; script.id = 'json-ld-structured-data'; $('#structured-data-container').appendChild(script); } script.textContent = JSON.stringify(schema); }
        function showToast(message, isError = false) { const toast = document.createElement('div'); toast.className = `py-2 px-3 rounded-md shadow-lg text-sm font-medium border ${isError ? 'bg-red-900/80 border-red-700 text-red-100' : 'bg-gray-700/80 border-gray-600 text-gray-100'}`; toast.textContent = message; $('#toast-container').appendChild(toast); anime({ targets: toast, translateX: [20, 0], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' }); setTimeout(async () => { await anime({ targets: toast, translateX: [0, 20], opacity: [1, 0], duration: 400, easing: 'easeInCubic' }).finished; toast.remove(); }, 3000); }
        function renderModal({ title, content, confirmText, onConfirm, cancelText = '취소', onCancel = closeModal }) { const modalId = `modal-${Date.now()}`; const modalHtml = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div class="modal-content relative bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-md p-6"><h3 class="text-base font-bold font-heading mb-3 text-white">${title}</h3><div class="text-gray-400 mb-5 text-sm">${content}</div><div class="flex justify-end space-x-2"><button type="button" class="btn" id="modal-cancel-btn">${cancelText}</button>${confirmText ? `<button type="button" class="btn btn-primary" id="modal-confirm-btn">${confirmText}</button>` : ''}</div></div></div>`; $('#modal-container').innerHTML = modalHtml; const modalEl = $(`#${modalId}`); if (onConfirm) $('#modal-confirm-btn').addEventListener('click', onConfirm); $('#modal-cancel-btn').addEventListener('click', onCancel); modalEl.querySelector('.modal-backdrop').addEventListener('click', onCancel); anime({ targets: modalEl.querySelector('.modal-backdrop'), opacity: [0, 1], duration: 400, easing: 'easeOutCubic' }); anime({ targets: modalEl.querySelector('.modal-content'), translateY: [20, 0], scale: [0.98, 1], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' }); }
        async function closeModal() { const modal = $('#modal-container').firstElementChild; if (!modal) return; await Promise.all([anime({ targets: modal.querySelector('.modal-backdrop'), opacity: 0, duration: 300, easing: 'easeInCubic' }).finished, anime({ targets: modal.querySelector('.modal-content'), translateY: 20, scale: 0.98, opacity: 0, duration: 300, easing: 'easeInCubic' }).finished]); $('#modal-container').innerHTML = ''; }
        function renderPaginationControls(currentPage, totalItems, baseLink) { const totalPages = Math.ceil(totalItems / POSTS_PER_PAGE); if (totalPages <= 1) return ''; return `<div class="flex justify-center items-center gap-2 mt-10 pagination-controls"><a href="${baseLink}${currentPage - 1}" data-route class="btn !py-1 !px-2.5 !text-xs ${currentPage === 1 ? 'pointer-events-none opacity-50' : ''}">이전</a><span class="text-xs font-medium text-gray-400">${currentPage} / ${totalPages}</span><a href="${baseLink}${currentPage + 1}" data-route class="btn !py-1 !px-2.5 !text-xs ${currentPage >= totalPages ? 'pointer-events-none opacity-50' : ''}">다음</a></div>`; }
        function lazyLoadImages() { const images = document.querySelectorAll('#post-content img'); const placeholderSrc = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; const observer = new IntersectionObserver((entries, obs) => { entries.forEach(entry => { if (entry.isIntersecting) { const img = entry.target; img.src = img.dataset.src; img.onload = () => { img.style.opacity = '1'; img.classList.remove('lazy'); }; obs.unobserve(img); } }); }, { rootMargin: '0px 0px 200px 0px' }); images.forEach(image => { if (image.src && !image.dataset.src) { image.dataset.src = image.src; image.src = placeholderSrc; image.style.transition = 'opacity 0.3s'; image.style.opacity = '0'; image.classList.add('lazy'); } observer.observe(image); }); }
        function showAuthModal() { const content = `<form id="auth-form" novalidate class="space-y-4"><div><label for="email" class="block text-sm font-medium text-gray-300 mb-1">이메일</label><input type="email" id="email" class="form-input !bg-gray-700 !text-white" required autocomplete="email"></div><div><label for="password" class="block text-sm font-medium text-gray-300 mb-1">비밀번호 (6자 이상)</label><input type="password" id="password" class="form-input !bg-gray-700 !text-white" required autocomplete="current-password" minlength="6"></div><div id="auth-error" class="text-red-400 text-xs h-3"></div></form>`; renderModal({ title: '시작하기', content, confirmText: '로그인', onConfirm: () => handleAuth('login') }); const signUpBtn = document.createElement('button'); signUpBtn.type = 'button'; signUpBtn.className = 'btn'; signUpBtn.textContent = '회원가입'; $('#modal-confirm-btn').insertAdjacentElement('beforebegin', signUpBtn); signUpBtn.addEventListener('click', () => handleAuth('signup')); }
        async function handleAuth(action) { const email = $('#email').value, password = $('#password').value, errorDiv = $('#auth-error'); errorDiv.textContent = ''; const { error } = action === 'login' ? await supabase.auth.signInWithPassword({ email, password }) : await supabase.auth.signUp({ email, password }); if (error) { errorDiv.textContent = "인증 오류: " + error.message; } else { showToast(action === 'signup' ? '가입 완료! 이메일을 확인하여 인증해주세요.' : '로그인되었습니다.'); closeModal(); } }
        async function handleLogout() { await supabase.auth.signOut(); showToast('로그아웃되었습니다.'); navigateTo('/'); }
        async function deletePostAndAssociatedImages(postId) { const { data: post } = await supabase.from('posts').select('refined_content').eq('id', postId).single(); if (post?.refined_content) { const imageUrls = post.refined_content.match(/https:\/\/[^"]+\/storage\/v1\/object\/public\/thought-images\/[^"]+/g) || []; const imagePaths = imageUrls.map(url => url.split('/thought-images/')[1]).filter(Boolean); if (imagePaths.length > 0) await supabase.storage.from(IMAGE_BUCKET_NAME).remove(imagePaths); } await supabase.from('posts').delete().eq('id', postId); }
        async function uploadImageFile(imageFile) { if (!imageFile) throw new Error("이미지 파일이 없습니다."); const fileName = `${state.user.id}/${Date.now()}.webp`; const { error } = await supabase.storage.from(IMAGE_BUCKET_NAME).upload(fileName, imageFile, { contentType: 'image/webp' }); if (error) { throw new Error(`이미지 업로드 실패: ${error.message}`); } const { data } = supabase.storage.from(IMAGE_BUCKET_NAME).getPublicUrl(fileName); return data.publicUrl; }
        function convertToWebP(file, maxWidth = 1200, quality = 0.8) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let { width, height } = img; if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error('Canvas to Blob failed.')), 'image/webp', quality); }; img.onerror = reject; }; reader.onerror = reject; }); }

        // --- APP INITIALIZATION ---
        function initializeApp() {
            fetchSidebarPosts();
            const authTimeout = setTimeout(() => {
                if (!state.isAuthReady) {
                    console.error("Auth check timed out.");
                    const loader = $('#app-loader');
                    if (loader) loader.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">블로그를 불러오는 데 실패했습니다.<br>잠시 후 다시 시도해 주세요.</p>';
                }
            }, 8000);

            document.addEventListener('click', (e) => {
                const routeTarget = e.target.closest('[data-route]');
                if (routeTarget) { e.preventDefault(); navigateTo(routeTarget.getAttribute('href')); return; }
                
                const actionTarget = e.target.closest('[data-action]');
                if (actionTarget) {
                    const action = actionTarget.dataset.action;
                    switch (action) {
                        case 'sidebar-prev': if (state.sidebar.page > 0) { state.sidebar.page--; renderSidebar($('#sidebar-container')); } break;
                        case 'sidebar-next': const totalPages = Math.ceil(state.sidebar.posts.length / state.sidebar.postsPerPage); if (state.sidebar.page + 1 < totalPages) { state.sidebar.page++; renderSidebar($('#sidebar-container')); } break;
                        case 'auth': showAuthModal(); break;
                        case 'logout': handleLogout(); break;
                        case 'back': navigateTo('/dashboard'); break;
                        case 'save-draft': handlePostSave('draft', actionTarget); break;
                        case 'publish': handlePostSave('published', actionTarget); break;
                        case 'delete': renderModal({ title: '정말 삭제하시겠습니까?', content: '이 작업은 되돌릴 수 없습니다. 글에 포함된 이미지도 함께 삭제됩니다.', confirmText: '삭제', onConfirm: async () => { const btn = $('#modal-confirm-btn'); btn.disabled = true; btn.textContent = '삭제 중...'; try { await deletePostAndAssociatedImages(actionTarget.dataset.id); showToast('글이 삭제되었습니다.'); handleRouting(); } catch (error) { showToast(`삭제 중 오류 발생: ${error.message}`, true); } finally { closeModal(); } } }); break;
                    }
                }
            });

            window.addEventListener('popstate', handleRouting);
            
            supabase.auth.onAuthStateChange((_event, session) => {
                clearTimeout(authTimeout); 
                const userChanged = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                
                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav(); 
                    handleRouting();
                    anime({ targets: '#app-loader', opacity: 0, duration: 500, easing: 'easeOutCubic', complete: (anim) => anim.animatables[0].target.remove() });
                } else if (userChanged) {
                    renderNav();
                    handleRouting();
                }
            });
        }
        
        initializeApp();
    </script>
</body>
</html>


