<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.quilljs.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://www.googletagservices.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://cdn.quilljs.com https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    <meta property="og:site_name" content="InsureLog">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Scripts & Stylesheets (OPTIMIZED: Deferred loading where possible) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <!-- quill-better-table CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.css">
    
    <!-- *** FIX: highlight.js BEFORE quill.js *** -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" defer crossorigin="anonymous"></script>
    <!-- quill-better-table JS -->
    <script src="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.js" defer></script>
    
    <!-- DOMPurify & EXIF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" defer crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.quilljs.com" crossorigin>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            line-height: 1.7;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; line-height: 1.75; }
        }
        main#app-container {
            padding-left: 0.75rem; padding-right: 0.75rem; flex-grow: 1;
        }
        @media (min-width: 640px) {
            main#app-container { padding-left: 1rem; padding-right: 1rem; }
        }
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom p { margin: 0 0 1.3em; color: var(--text-secondary); }
        /* Ensure spacing even if paragraphs come as <div> blocks */
        .prose-custom div { margin-bottom: 1.3em; }
        /* Make manual line breaks more readable */
        .prose-custom p br { display: block; margin-bottom: 0.75em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.3em; }
        .prose-custom ul { list-style-type: disc; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom ol { list-style-type: decimal; margin-bottom: 1.3em; padding-left: 1.75em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { margin-top: 0.5em; margin-bottom: 0.5em; margin-left: 1.25em; }
        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        .prose-custom img { max-width: 100%; height: auto; border-radius: 12px; margin-top: 2em; margin-bottom: 2em; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .prose-custom table { width: 100%; border-collapse: collapse; margin-top: 2em; margin-bottom: 2em; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-radius: 8px; overflow: hidden; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 0.75em 1em; text-align: left; }
        .prose-custom th { background-color: var(--bg-content-secondary); font-weight: 700; color: var(--text-primary); }
        .prose-custom tr:nth-child(odd) { background-color: var(--bg-main); }
        .prose-custom tr:nth-child(even) { background-color: var(--bg-content-secondary); }
        .category-btn { transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem; font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent; }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #quill-editor { min-height: 400px; font-size: 16px; }
#quill-editor .ql-editor p, #quill-editor .ql-editor div { margin: 0 0 1em; }
#quill-editor .ql-editor p br { display: block; margin-bottom: 0.6em; }
.ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #D1D5DB; }
.ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #D1D5DB; }
#quill-editor-container { position: relative; }
        @media (max-width: 639px) {
            .writer-controls-sticky { position: sticky; bottom: 0; background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding: 1rem; border-top: 1px solid #E5E7EB; margin-left: -0.75rem; margin-right: -0.75rem; padding-top: 1rem !important; z-index: 30; }
            .prose-custom img { width: calc(100% + 1.5rem); margin-left: -0.75rem; margin-right: -0.75rem; max-width: none; border-radius: 0; box-shadow: none; }
        }
        .post-thumbnail img { loading: lazy; }
        button:focus, a:focus, input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; } }
        footer { margin-top: 16px; } @media (min-width: 640px) { footer { margin-top: 24px; } }
    </style>
</head>
<body class="antialiased">
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    <main id="app-container" class="w-full">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <script type="module" nonce="r4nd0m">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- OPTIMIZED Config & State ---
        const CONFIG = {
            SITE_URL: 'https://blogaipandoci.vercel.app',
            SUPABASE_URL: 'https://ddehwkwzmmvcxltlplua.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To',
            IMAGE_BUCKET_NAME: 'thought-images', 
            DB_TABLE_NAME: 'posts', 
            POSTS_PER_PAGE: 10,
            CATEGORIES: ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"]
        };
        
        const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        const state = { user: null, isAuthReady: false, currentCategory: '전체' };
        const $ = document.querySelector.bind(document); // OPTIMIZED: Cached querySelector
        
        // --- OPTIMIZED: Debounce (memoized) ---
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        };
        
        // --- OPTIMIZED: Animation wrapper (reduce anime calls) ---
        const animateSwitch = (el, show = true) => {
            const opts = show ? { opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' } : { opacity: 0, duration: 200, easing: 'easeInQuad' };
            return anime({ targets: el, ...opts }).finished;
        };
        
        // --- Core Navigation (OPTIMIZED: Single history handler) ---
        const navigateTo = (path, replace = false) => {
            const newPath = path || '/';
            const action = replace ? 'replaceState' : 'pushState';
            if (window.location.pathname + window.location.search !== newPath) {
                history[action]({ path: newPath }, '', newPath);
            }
            handleRouting();
        };
        
        const switchView = async (viewId, callback) => {
            const current = $('.app-view.active');
            if (current) {
                await animateSwitch(current, false);
                current.classList.remove('active');
                current.innerHTML = '';
            }
            const next = $(`#${viewId}`);
            if (next) {
                next.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                next.classList.add('active');
                await animateSwitch(next);
                try {
                    await callback(next);
                } catch (error) {
                    console.error(`Error rendering ${viewId}:`, error);
                    next.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                }
                window.scrollTo(0, 0);
            }
        };
        
        const handleRouting = () => {
            if (!state.isAuthReady) return;
            const path = window.location.pathname;
            const params = new URLSearchParams(window.location.search);
            const parts = path.split('/').filter(Boolean);
            const route = parts[0] || 'library';
            const param = parts[1] || null;
            
            if (!state.user && ['dashboard', 'writer'].includes(route)) {
                showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                navigateTo('/');
                return;
            }
            
            switch (route) {
                case 'post': return switchView('view-post', el => renderPostView(el, param));
                case 'dashboard': return switchView('view-dashboard', el => renderDashboardView(el));
                case 'writer': return switchView('view-writer', el => renderWriterView(el, param));
                default: {
                    const page = parseInt(params.get('page'), 10) || 1;
                    state.currentCategory = params.get('category') || '전체';
                    return switchView('view-library', el => renderLibraryView(el, page, state.currentCategory));
                }
            }
        };
        
        // --- OPTIMIZED: Cached templates & rendering ---
        const templates = {
            nav: (user) => `
                <nav class="w-full flex items-center justify-between py-2 px-4 sm:py-3 sm:px-5 bg-white/50 backdrop-blur-xl border border-black/10 rounded-3xl shadow-lg" role="banner">
                    <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter" aria-label="InsureLog 홈으로 이동">InsureLog</a>
                    <div class="flex items-center space-x-3">
                        ${user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="대시보드로 이동">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="로그아웃">로그아웃</button>` : `<button data-action="auth" aria-label="로그인 또는 회원가입" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition">로그인 / 가입</button>`}
                    </div>
                </nav>`,
            categoryBtns: (category) => ['전체', ...CONFIG.CATEGORIES].map(cat => `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}" aria-pressed="${cat === category}">${cat}</button>`).join(''),
            pagination: (page, total, basePath, params) => {
                const totalPages = Math.ceil(total / CONFIG.POSTS_PER_PAGE);
                if (totalPages <= 1) return '';
                const prevUrl = page > 1 ? buildUrl(basePath, { ...params, page: page - 1 }) : '#';
                const nextUrl = page < totalPages ? buildUrl(basePath, { ...params, page: page + 1 }) : '#';
                return `<div class="flex justify-center items-center gap-4 mt-12" role="navigation" aria-label="페이지 탐색"><a href="${prevUrl}" data-route aria-label="이전 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${page} / ${totalPages}</span><a href="${nextUrl}" data-route aria-label="다음 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
            }
        };
        
        const renderNav = () => { $('#main-nav-container').innerHTML = templates.nav(state.user); };
        
        const renderLibraryView = async (container, page, category) => {
            updateMetaTags();
            container.innerHTML = `
                <div class="max-w-4xl mx-auto py-8 sm:py-16">
                    <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                    <div class="flex items-center justify-center gap-2 mb-8 flex-wrap" role="tablist">${templates.categoryBtns(category)}</div>
                    <div id="post-list-container" class="border border-gray-200/80 rounded-2xl overflow-hidden"></div>
                </div>`;
            await renderPostList(page, category);
        };
        
        const renderPostList = async (page, category) => {
            const container = $('#post-list-container');
            if (!container) return;
            container.innerHTML = `<div class="min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
            
            const { from, to } = { from: (page - 1) * CONFIG.POSTS_PER_PAGE, to: page * CONFIG.POSTS_PER_PAGE - 1 };
            let query = supabase.from(CONFIG.DB_TABLE_NAME).select('id, title, slug, summary, category, thumbnail_url', { count: 'exact' });
            if (category !== '전체') query = query.eq('category', category);
            query = query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);
            
            const { data: posts, error, count } = await query;
            const total = count ?? 0;
            if (error) {
                console.error("Error fetching posts:", error);
                container.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                return;
            }
            
            const safePosts = Array.isArray(posts) ? posts : [];
            const postsHtml = safePosts.length > 0
                ? `<div class="divide-y divide-gray-200/80">${safePosts.map(post => {
                    const thumb = post.thumbnail_url ? `<div class="w-24 h-16 sm:w-32 sm:h-20 flex-shrink-0 mr-4 sm:mr-5"><img src="${post.thumbnail_url}" alt="${post.title} 썸네일" class="w-full h-full object-cover rounded-lg bg-gray-100 post-thumbnail"></div>` : '';
                    return `<a href="/post/${post.slug}" data-route class="flex items-center p-4 transition-all duration-300 bg-transparent hover:bg-gray-50/80" role="article">${thumb}<div class="flex-grow"><p class="text-xs font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-sm font-bold">${post.title}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-2">${post.summary || ''}</p></div></a>`;
                }).join('')}</div>`
                : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${state.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
            
            container.innerHTML = `${postsHtml}${templates.pagination(page, total, '/', { category })}`;
        };
        
        const renderPostView = async (container, slug) => {
            if (!slug) { navigateTo('/'); return; }
            const { data: post, error } = await supabase.from(CONFIG.DB_TABLE_NAME).select('*').eq('slug', slug).single();
            if (error || !post) {
                console.error("Error fetching post:", slug, error);
                showToast('글을 찾을 수 없습니다.', true);
                navigateTo('/');
                return;
            }
            
            // View count (OPTIMIZED: Non-blocking)
            (async () => {
                try {
                    const viewed = JSON.parse(sessionStorage.getItem('viewed_posts') || '[]');
                    if (!viewed.includes(post.id)) {
                        await supabase.rpc('increment_post_view', { post_slug: slug });
                        viewed.push(post.id);
                        sessionStorage.setItem('viewed_posts', JSON.stringify(viewed));
                    }
                } catch (e) { console.warn('View count error:', e); }
            })();
            
            const { data: popular } = await supabase.from(CONFIG.DB_TABLE_NAME).select('title, slug').eq('status', 'published').neq('slug', slug).order('view_count', { ascending: false, nullsFirst: false }).limit(5);
            const popularHtml = popular?.length > 0 ? `<div class="mt-20"><h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2><div class="border-t border-gray-200">${popular.map(p => `<a href="/post/${p.slug}" data-route class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50" role="link"><h4 class="font-semibold text-gray-800 text-base">${p.title}</h4></a>`).join('')}</div></div>` : '';
            
            const { data: prev } = await supabase.from(CONFIG.DB_TABLE_NAME).select('title, slug').lt('created_at', post.created_at).eq('status', 'published').order('created_at', { ascending: false }).limit(1).single();
            const { data: next } = await supabase.from(CONFIG.DB_TABLE_NAME).select('title, slug').gt('created_at', post.created_at).eq('status', 'published').order('created_at', { ascending: true }).limit(1).single();
            const navHtml = `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10" role="navigation" aria-label="이전/다음 글 탐색"><div>${prev ? `<a href="/post/${prev.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${prev.title}</h4></a>` : ''}</div><div class="text-left md:text-right">${next ? `<a href="/post/${next.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${next.title}</h4></a>` : ''}</div></nav>`;
            
            updateMetaTags(post);
            const editBtn = (state.user && state.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200" aria-label="글 수정">수정</a>` : '';
            
            const adTestAttr = ['localhost','127.0.0.1'].includes(window.location.hostname) ? ' data-adtest="on"' : '';
            container.innerHTML = `
                <div class="max-w-4xl mx-auto py-8 sm:py-16">
                    <article role="article">
                        <header class="mb-8 sm:mb-12">
                            <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                            <h1 class="text-3xl sm:text-4xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                            <div class="flex items-center justify-between text-sm text-gray-500">
                                <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                ${editBtn}
                            </div>
                        </header>
                        <div id="post-content" class="prose-custom max-w-none"></div>
                    </article>
                    <div class="my-16"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"${adTestAttr}></ins></div>
                    ${popularHtml}${navHtml}
                </div>`;
            
            // DOMPurify: allow essential table attributes and whitelist limited styles
            const setupDomPurify = () => {
                if (!window.__dompurifyHooked && typeof DOMPurify !== 'undefined') {
                    DOMPurify.addHook('uponSanitizeAttribute', function(node, data) {
                        if (data.attrName === 'style') {
                            try {
                                const style = (data.attrValue || '').toLowerCase();
                                const allowed = [];
                                const mAlign = style.match(/text-align\s*:\s*(left|center|right|justify)/);
                                if (mAlign) allowed.push(`text-align:${mAlign[1]}`);
                                const mWidth = style.match(/(?:^|;|\s)width\s*:\s*([0-9]+(?:\.[0-9]+)?)(px|%)/);
                                if (mWidth) allowed.push(`width:${mWidth[1]}${mWidth[2]}`);
                                data.attrValue = allowed.join(';');
                                if (!data.attrValue) data.keepAttr = false;
                            } catch (_) { data.keepAttr = false; }
                        }
                    });
                    window.__dompurifyHooked = true;
                }
            };
            setupDomPurify();

            const safeContent = (typeof DOMPurify !== 'undefined') ? DOMPurify.sanitize(post.refined_content || '', { ADD_TAGS: ["iframe", "table", "tr", "td", "th", "tbody", "thead", "tfoot", "col", "colgroup"], ADD_ATTR: ["rowspan","colspan","style","class","width","height","align"] }) : (post.refined_content || '');
            $('#post-content').innerHTML = safeContent;
            
            try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.warn("Adsense error:", e); }
            
            setTimeout(() => {
                if (typeof hljs !== 'undefined') $('#post-content').querySelectorAll('pre code').forEach(hljs.highlightElement);
                $('#post-content').querySelectorAll('img').forEach(img => { img.loading = 'lazy'; img.decoding = 'async'; });
                $('#post-content').querySelectorAll('a[target="_blank"]').forEach(a => { a.rel = 'noopener noreferrer'; });
            }, 100);
        };
        
        const renderDashboardView = async (container) => {
            updateMetaTags({ title: '대시보드' });
            container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><div class="flex justify-between items-center mb-8 sm:mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]" aria-label="새 글 작성">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2"><div class="min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div></div>`;
            
            if (!state.user) return;
            const { data: posts, error } = await supabase.from(CONFIG.DB_TABLE_NAME).select('id, title, slug, status, created_at').eq('author_id', state.user.id).order('created_at', { ascending: false });
            const list = $('#dashboard-post-list');
            if (error) {
                console.error("Dashboard error:", error);
                list.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>';
                return;
            }
            if (!posts?.length) {
                list.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>';
                return;
            }
            list.innerHTML = `<ul class="w-full" role="list">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors" role="listitem"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" data-route class="font-bold text-black hover:text-[#D946EF]" aria-label="글 보기: ${post.title}">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black" aria-label="글 수정: ${post.title}">수정</a></li>`).join('')}</ul>`;
        };
        
        // Register quill-better-table JIT within init to avoid race
        let quillInstance = null; // OPTIMIZED: Global Quill instance for reuse
        
        const initQuillEditor = () => {
            const el = $('#quill-editor');
            if (!el) return null;
            if (quillInstance) return quillInstance;

            // JIT registration for quill-better-table to avoid race with external script load
            if (window.Quill && window.QuillBetterTable) {
                try {
                    if (!Quill.imports['modules/better-table']) {
                        Quill.register({ 'modules/better-table': window.QuillBetterTable }, true);
                    }
                } catch (e) {
                    console.warn('Failed to register quill-better-table:', e);
                }
            } else {
                console.warn('QuillBetterTable not found. Table features will be disabled.');
            }
            
            const modules = {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }], 
                    ['bold', 'italic', 'underline', 'strike'], 
                    ['blockquote', 'code-block'], 
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }], 
                    [{ 'indent': '-1'}, { 'indent': '+1' }], 
                    ['link', 'image'], 
                    ['clean']
                ],
                history: { delay: 5000, userOnly: true }
            };

            if (window.Quill && window.QuillBetterTable && Quill.imports['modules/better-table']) {
                modules['better-table'] = {
                    operationMenu: {
                        items: {
                            unmergeCells: { text: '셀 병합 해제' },
                            deleteRow: { text: '행 삭제' },
                            deleteColumn: { text: '열 삭제' },
                            insertRowAbove: { text: '위에 행 삽입' },
                            insertRowBelow: { text: '아래에 행 삽입' },
                            insertColumnLeft: { text: '왼쪽에 열 삽입' },
                            insertColumnRight: { text: '오른쪽에 열 삽입' },
                            deleteTable: { text: '표 삭제' }
                        }
                    }
                };
                modules.keyboard = { bindings: QuillBetterTable.keyboardBindings };
            }

            quillInstance = new Quill(el, {
                theme: 'snow',
                modules
            });
            
            // 이미지 업로드 핸들러
            quillInstance.getModule('toolbar').addHandler('image', quillImageHandler);
            
            // 자동 저장
            let timer;
            const autoSave = debounce(() => {
                if (state.user && quillInstance.getLength() > 1) console.log('Auto-saving...');
            }, 30000);
            quillInstance.on('text-change', () => { 
                clearTimeout(timer); 
                timer = setTimeout(autoSave, 5000); 
            });
            
            return quillInstance;
        };
        
        const renderWriterView = async (container, slug) => {
            if (!state.user) { navigateTo('/'); return; }
            updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });
            
            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', category: CONFIG.CATEGORIES[0] };
            if (slug) {
                const { data, error } = await supabase.from(CONFIG.DB_TABLE_NAME).select('*').eq('slug', slug).single();
                if (error || !data || data.author_id !== state.user.id) {
                    console.error("Edit error:", error);
                    showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true);
                    navigateTo('/dashboard');
                    return;
                }
                post = data;
            }
            
            const categoryOpts = CONFIG.CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
            container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><form id="writer-form" class="space-y-8 sm:pb-0 pb-20" novalidate><input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}"><div><select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4" required aria-label="카테고리 선택">${categoryOpts}</select><textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required aria-label="제목 입력" maxlength="200">${post.title || ''}</textarea></div><div><label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label><textarea id="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)" aria-label="요약 입력">${post.summary || ''}</textarea></div><div><label for="quill-editor" class="block text-lg font-bold text-black mb-3">본문 (Content)</label><div id="quill-editor-container"><div id="quill-editor" aria-label="본문 에디터"></div><div id="quill-loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center rounded-b-xl" style="display: none; min-height: 400px; z-index: 10;"><div class="loader-spinner"></div></div></div></div><div class="flex justify-between items-center pt-8 sm:pt-5 writer-controls-sticky"><div class="flex items-center gap-2"><button type="button" id="insert-table-btn" class="px-3 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition" aria-label="표 삽입">표 삽입</button><button type="button" data-action="table-help" class="px-3 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-100 text-black hover:bg-gray-200 transition" aria-label="표 안내">표 안내</button>${post.id ? `<button type="button" data-action="delete" class="px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition" aria-label="글 삭제">삭제하기</button>` : ''}</div><div class="flex items-center space-x-3"><button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button><button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button></div></div></form></div>`;
            
            const loader = $('#quill-loader');
            loader.style.display = 'flex';
            requestAnimationFrame(() => {
                const quill = initQuillEditor();
                if (quill) {
                    // Graceful degradation: hide table UI if module unavailable
                    if (!quill.getModule('better-table')) {
                        const insertTableBtn = $('#insert-table-btn');
                        if (insertTableBtn) insertTableBtn.style.display = 'none';
                        const tableHelpBtn = container.querySelector('[data-action="table-help"]');
                        if (tableHelpBtn) tableHelpBtn.style.display = 'none';
                    }

                    if (post.refined_content) {
                        try {
                            // Unmount 트릭: 긴 HTML 로딩 최적화
                            const containerEl = quill.container;
                            const parent = containerEl.parentNode;
                            const index = Array.from(parent.children).indexOf(containerEl);
                            parent.removeChild(containerEl);  // Unmount
                            
                            quill.setContents([]);  // 초기화
                            if (quill.clipboard && quill.clipboard.dangerouslyPasteHTML) {
                                quill.clipboard.dangerouslyPasteHTML(post.refined_content);
                            } else if (quill.pasteHTML) {
                                quill.pasteHTML(post.refined_content);
                            }
                            
                            parent.insertBefore(containerEl, parent.children[index]);  // Remount
                        } catch (e) { console.error("Paste error:", e); quill.setText('본문을 불러오는 중 오류가 발생했습니다.'); }
                    }
                }
                loader.style.display = 'none';
            });
            
            const form = $('#writer-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!validateForm()) return;
                if (e.submitter?.dataset.action) handlePostSave(e.submitter.dataset.action, e.submitter);
            });
            
            const delBtn = form.querySelector('[data-action="delete"]');
            if (delBtn) delBtn.addEventListener('click', (e) => { e.preventDefault(); handlePostDelete(post.id); });
            
            const insertTableBtn = $('#insert-table-btn');
            if (insertTableBtn) insertTableBtn.addEventListener('click', () => {
                const quill = initQuillEditor();
                const bt = quill && quill.getModule('better-table');
                if (bt && typeof bt.insertTable === 'function') {
                    bt.insertTable(3, 3);
                } else {
                    showToast('표 모듈을 불러오지 못했습니다.', true);
                }
            });
            
            // OPTIMIZED: Debounced slug update
            const titleEl = $('#title');
            if (titleEl) titleEl.addEventListener('input', debounce(() => {
                const slugEl = $('#post-slug');
                if (slugEl && !slugEl.value) {
                    let slug = titleEl.value.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    // Optional: Display preview
                }
            }, 300));
        };
        
        const validateForm = () => {
            const title = $('#title')?.value.trim();
            const cat = $('#category')?.value;
            if (!title) { showToast('제목은 필수 항목입니다.', true); $('#title')?.focus(); return false; }
            if (!cat) { showToast('카테고리를 선택해주세요.', true); $('#category')?.focus(); return false; }
            return true;
        };
        
        // --- Image Upload (OPTIMIZED: Reused functions) ---
        const quillImageHandler = () => {
            const quill = quillInstance;
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*'; input.click();
            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;
                showToast('이미지 업로드 중...');
                const range = quill.getSelection(true);
                quill.enable(false);
                try {
                    const blob = await convertToWebP(file);
                    const url = await uploadImageToSupabase(blob);
                    quill.enable(true);
                    quill.insertEmbed(range.index, 'image', url);
                    quill.setSelection(range.index + 1, Quill.sources.SILENT);
                    showToast('업로드 완료!', false);
                } catch (e) {
                    console.error('Upload failed:', e);
                    showToast(`이미지 업로드 실패: ${e.message}`, true);
                    quill.enable(true);
                }
            };
        };
        
        // *** MODIFIED FUNCTION (Sanitized filename) ***
        const uploadImageToSupabase = async (file) => {
            let baseName = 'upload';
            let ext = 'bin';

            if (file.name) {
                const parts = file.name.split('.');
                if (parts.length > 1) {
                    ext = parts.pop().toLowerCase(); // 'jpg', 'webp' 등
                    baseName = parts.join('.'); // 'my-photo'
                } else {
                    // 확장자 없는 파일명
                    baseName = file.name;
                    if (file.type === 'image/jpeg') ext = 'jpg';
                    else if (file.type === 'image/png') ext = 'png';
                    else if (file.type === 'image/webp') ext = 'webp';
                }
            } else {
                 // 이름 없는 Blob
                 if (file.type === 'image/jpeg') ext = 'jpg';
                 else if (file.type === 'image/png') ext = 'png';
                 else if (file.type === 'image/webp') ext = 'webp';
            }

            // *** NEW SANITIZATION STEP ***
            // 한글을 포함하여, [영문, 숫자, 하이픈(-)]을 제외한 모든 문자를 밑줄(_)로 변경
            let sanitizedBaseName = baseName.replace(/[^\w-]/g, '_');
            
            // 삭제 후 이름이 비거나 하이픈으로 시작하는 경우 방지
            if (!sanitizedBaseName || sanitizedBaseName.startsWith('-')) {
                sanitizedBaseName = 'upload'; // 기본값으로 대체
            }
            
            // 파일명 중복을 피하기 위해 타임스탬프 추가
            const path = `${state.user.id}/${sanitizedBaseName}-${Date.now()}.${ext}`;

            const { error } = await supabase.storage.from(CONFIG.IMAGE_BUCKET_NAME).upload(path, file, { upsert: true });
            if (error) throw new Error(`업로드 실패: ${error.message}`);
            
            const { data } = supabase.storage.from(CONFIG.IMAGE_BUCKET_NAME).getPublicUrl(path);
            if (!data?.publicUrl) throw new Error('Public URL 실패');
            return data.publicUrl;
        };
        
        const getOrientation = (file) => new Promise((res) => {
            if (typeof EXIF === 'undefined') { res(1); return; }
            EXIF.getData(file, function() { 
                res(EXIF.getTag(this, 'Orientation') || 1);
            });
        });
        
        const convertToWebP = (file, quality = 0.8) => new Promise((res, rej) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = async () => {
                    const orient = await getOrientation(file);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let w = img.width, h = img.height;
                    if (orient >= 5 && orient <= 8) { [w, h] = [h, w]; }
                    canvas.width = w; canvas.height = h;
                    // Transform for orientation
                    const transforms = {2: [-1,0,0,1,w,0], 3: [-1,0,0,-1,w,h], 4: [1,0,0,-1,0,h], 5: [0,1,1,0,0,0], 6: [0,1,-1,0,h,0], 7: [0,-1,-1,0,h,w], 8: [0,-1,1,0,0,w]};
                    ctx.transform(...(transforms[orient] || [1,0,0,1,0,0]));
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            // Blob을 File 객체로 변환. 원본 파일명에서 확장자만 .webp로 변경
                            let baseName = 'image';
                            if (file.name) {
                                const parts = file.name.split('.');
                                if (parts.length > 1) parts.pop(); // 확장자 제거
                                baseName = parts.join('.');
                            }
                            const webpFile = new File([blob], `${baseName}.webp`, { type: 'image/webp' });
                            res(webpFile); // 새 File 객체 반환
                        } else {
                             res(file); // 변환 실패 시 원본 File 객체 반환
                        }
                    }, 'image/webp', quality);
                };
                img.onerror = () => rej(new Error('Image load failed'));
            };
            reader.onerror = rej;
        });
        
        const handlePostSave = async (action, btn) => {
            if (!quillInstance) { showToast('에디터 오류.', true); return; }
            const origText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;
            
            try {
                const title = $('#title').value.trim();
                if (!title) throw new Error('제목 필수');
                const status = action === 'publish' ? 'published' : 'draft';
                const content = quillInstance.root.innerHTML;
                if (content === '<p><br></p>' || quillInstance.getLength() < 2) throw new Error('본문 비어있음');
                
                let summary = $('#summary').value.trim() || quillInstance.getText().trim().replace(/\s+/g, ' ').slice(0, 150) + (quillInstance.getText().length > 150 ? '...' : '');
                
                const temp = document.createElement('div'); temp.innerHTML = content;
                const thumb = temp.querySelector('img')?.src || null;
                
                const id = $('#post-id').value;
                let slug = $('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                if (!id) {
                    const { data } = await supabase.from(CONFIG.DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
                    if (data) slug += `-${Date.now().toString().slice(-6)}`;
                }
                
                const data = { title, slug, status, summary, author_id: state.user.id, refined_content: content, category: $('#category').value, thumbnail_url: thumb };
                const q = id ? supabase.from(CONFIG.DB_TABLE_NAME).update(data).eq('id', id) : supabase.from(CONFIG.DB_TABLE_NAME).insert(data);
                const { error } = await q.select().single();
                if (error) throw error;
                
                showToast(status === 'published' ? '발행되었습니다!' : '저장되었습니다.');
                navigateTo(status === 'published' ? `/post/${slug}` : '/dashboard');
            } catch (e) {
                console.error("Save error:", e);
                showToast(`저장 실패: ${e.message}`, true);
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        };
        
        const handlePostDelete = async (id) => {
            if (!id) return;
            const confirm = await showDeleteConfirmationModal('정말 삭제하시겠습니까? 되돌릴 수 없습니다.');
            if (!confirm) return;
            showToast('삭제 중...');
            const { error } = await supabase.from(CONFIG.DB_TABLE_NAME).delete().eq('id', id);
            if (error) {
                console.error("Delete error:", error);
                showToast(`삭제 실패: ${error.message}`, true);
            } else {
                showToast('삭제되었습니다.');
                navigateTo('/dashboard');
            }
        };
        
        const showDeleteConfirmationModal = (msg) => new Promise(res => {
            if ($('#delete-confirm-modal')) return;
            const html = `<div id="delete-confirm-modal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title"><div id="delete-modal-content" class="bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8"><h3 id="delete-modal-title" class="sr-only">삭제 확인</h3><p class="text-center text-black text-lg mb-8">${msg}</p><div class="flex justify-center gap-4"><button id="delete-btn-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button><button id="delete-btn-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button></div></div></div>`;
            $('#modal-container').innerHTML = html;
            const close = (result) => {
                const modal = $('#delete-confirm-modal');
                if (!modal) return;
                animateSwitch(modal, false).then(() => { $('#modal-container').innerHTML = ''; res(result); });
            };
            animateSwitch($('#delete-confirm-modal'));
            animateSwitch($('#delete-modal-content'), true);
            $('#delete-btn-yes').onclick = () => close(true);
            $('#delete-btn-no').onclick = () => close(false);
        });
        
        const showToast = (msg, err = false) => {
            const toast = document.createElement('div');
            toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${err ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.textContent = msg;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'polite');
            $('#toast-container').appendChild(toast);
            animateSwitch(toast, true);
            setTimeout(() => animateSwitch(toast, false).then(() => toast.remove()), 3000);
        };
        
        const buildUrl = (path, params) => {
            const url = new URL(path, CONFIG.SITE_URL);
            Object.entries(params).forEach(([k, v]) => {
                if (v !== undefined && v !== null && v !== '전체' && v !== '') url.searchParams.append(k, v);
            });
            return url.pathname + url.search;
        };
        
        const handleLogout = async () => {
            try { await supabase.auth.signOut(); showToast('로그아웃되었습니다.'); } catch (e) { console.error('Logout error:', e); }
            navigateTo('/', true);
        };
        
        const showAuthModal = () => {
            if ($('#auth-modal')) return;
            const html = `<div id="auth-modal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title"><div id="auth-modal-content" class="bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative"><button id="close-modal-btn" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button><h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2><p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p><form id="auth-form" class="space-y-4"><input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500" aria-label="이메일 입력" autocomplete="email"><button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button></form></div></div>`;
            $('#modal-container').innerHTML = html;
            const close = () => animateSwitch($('#auth-modal'), false).then(() => $('#modal-container').innerHTML = '');
            animateSwitch($('#auth-modal'));
            animateSwitch($('#auth-modal-content'), true);
            
            $('#auth-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = $('#email-input').value.trim();
                if (!email) { showToast('이메일 입력해주세요.', true); return; }
                const btn = e.target.querySelector('button');
                btn.disabled = true; btn.textContent = '전송 중...';
                const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: CONFIG.SITE_URL } });
                if (error) { showToast(`오류: ${error.message}`, true); btn.disabled = false; btn.textContent = '매직 링크 받기'; } else { showToast('이메일 확인해주세요!'); close(); }
            };
            $('#close-modal-btn').onclick = close;
            $('#auth-modal').onclick = (e) => { if (e.target.id === 'auth-modal') close(); };
        };

        const showTableHelpModal = () => {
            if ($('#table-help-modal')) return;
            const html = `<div id="table-help-modal" class="fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="table-help-title"><div class="bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-md p-6 relative"><button id="close-table-help-btn" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button><h2 id="table-help-title" class="text-2xl font-bold mb-4 text-black">표 사용 안내</h2><div class="space-y-3 text-sm text-gray-700"><p>붙여넣기 시 <code>rowspan</code>/<code>colspan</code>은 보존됩니다. 일부 스타일(<code>text-align</code>, <code>width</code>)만 허용됩니다.</p><ul class="list-disc pl-5 space-y-1"><li><b>Tab / Shift+Tab</b>: 다음/이전 셀 이동</li><li><b>Enter</b>: 셀 내 줄바꿈</li><li><b>Ctrl + B/I</b>: 굵게/기울임 등 기본 서식</li></ul><p class="text-xs text-gray-500">표 관련 컨트롤은 에디터 툴바를 활용하세요. 붙여넣기/서식 적용 후 저장 전 미리보기로 확인해주세요.</p></div></div></div>`;
            $('#modal-container').innerHTML = html;
            const close = () => animateSwitch($('#table-help-modal'), false).then(() => $('#modal-container').innerHTML = '');
            animateSwitch($('#table-help-modal'));
            document.querySelector('#close-table-help-btn').onclick = close;
            $('#table-help-modal').onclick = (e) => { if (e.target.id === 'table-help-modal') close(); };
        };
        
        const updateMetaTags = (post = null) => {
            const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
            const desc = post ? post.summary : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
            const url = post ? `${CONFIG.SITE_URL}/post/${post.slug}` : CONFIG.SITE_URL;
            const img = post?.thumbnail_url || null;
            const updatedIso = post ? new Date(post.updated_at || post.created_at || Date.now()).toISOString() : new Date().toISOString();
            
            // Title & description
            document.title = title;
            $('meta[name="description"]')?.setAttribute('content', desc);
            
            // Open Graph
            $('meta[property="og:title"]')?.setAttribute('content', title);
            $('meta[property="og:description"]')?.setAttribute('content', desc);
            $('meta[property="og:url"]')?.setAttribute('content', url);
            let ogImg = $('meta[property="og:image"]');
            if (img) {
                if (ogImg) ogImg.setAttribute('content', img);
                else {
                    const meta = document.createElement('meta');
                    meta.setAttribute('property', 'og:image');
                    meta.setAttribute('content', img);
                    document.head.appendChild(meta);
                }
            } else if (ogImg) ogImg.remove();
            // site_name (static)
            if (!$('meta[property="og:site_name"]')) { const m = document.createElement('meta'); m.setAttribute('property','og:site_name'); m.setAttribute('content','InsureLog'); document.head.appendChild(m); }
            // updated_time
            let ogUpd = $('meta[property="og:updated_time"]');
            if (!ogUpd) { ogUpd = document.createElement('meta'); ogUpd.setAttribute('property','og:updated_time'); document.head.appendChild(ogUpd); }
            ogUpd.setAttribute('content', updatedIso);
            
            // Canonical
            let canonical = document.querySelector('link[rel="canonical"]');
            if (!canonical) { canonical = document.createElement('link'); canonical.setAttribute('rel','canonical'); document.head.appendChild(canonical); }
            canonical.setAttribute('href', url);
            
            // JSON-LD
            const prevLd = document.getElementById('ld-json');
            if (prevLd) prevLd.remove();
            const ld = document.createElement('script');
            ld.type = 'application/ld+json';
            ld.id = 'ld-json';
            const ldData = post ? {
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                "headline": post.title,
                "datePublished": post.created_at,
                "dateModified": post.updated_at || post.created_at,
                "author": { "@type": "Organization", "name": "InsureLog" },
                "image": img ? [img] : undefined,
                "mainEntityOfPage": { "@type": "WebPage", "@id": url },
                "description": desc
            } : {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "name": "InsureLog",
                "url": CONFIG.SITE_URL,
                "description": desc
            };
            ld.textContent = JSON.stringify(ldData, (k,v) => v === undefined ? undefined : v);
            document.head.appendChild(ld);
        };
        
        // --- Event Listeners (OPTIMIZED: Single listener with delegation) ---
        document.addEventListener('click', (e) => {
            const route = e.target.closest('[data-route]');
            if (route && route.href !== '#') { e.preventDefault(); navigateTo(route.href); return; }
            
            const action = e.target.closest('[data-action]');
            if (action && !action.closest('form')) {
                e.preventDefault();
                const act = action.dataset.action;
                switch (act) {
                    case 'auth': return showAuthModal();
                    case 'logout': return handleLogout();
                    case 'filter-category': return navigateTo(buildUrl('/', { page: 1, category: action.dataset.category }));
                    case 'table-help': return showTableHelpModal();
                }
            }
        });
        window.addEventListener('popstate', handleRouting);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modals = ['#auth-modal', '#delete-confirm-modal'].find(m => $(m));
                if (modals) {/* Close logic */ }
            }
        });
        
        // --- Init (OPTIMIZED: Early auth check) ---
        const initializeApp = () => {
            if (typeof hljs === 'undefined') console.error("hljs missing.");
            supabase.auth.onAuthStateChange((_, session) => {
                const changed = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav();
                    handleRouting();
                    animateSwitch($('#app-loader'), false).then(() => $('#app-loader').remove());
                } else if (changed) {
                    renderNav();
                    handleRouting();
                }
            });
        };
        initializeApp();
    </script>
</body>
</html>


