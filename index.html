<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 
      [SEO 개선]
      - 기본 타이틀과 설명을 설정합니다. 이 값들은 updateMetaTags 함수에 의해 동적으로 변경됩니다.
    -->
    <title>InsureLog - AI, 기술, 그리고 보험</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="author" content="InsureLog">
    <meta name="keywords" content="InsureLog, AI, 보험, 핀테크, 기술, 블로그, 인공지능, 데이터">
    
    <link rel="canonical" href="https://blogaipandoci.vercel.app">
    <meta name="robots" content="index,follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='%23D946EF'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Arial' font-size='140' fill='white'%3EI%3C/text%3E%3C/svg%3E">
    <!-- 
      [CSP] 
      - nonce="r4nd0m"을 메인 스크립트에 적용했습니다.
      - 'unsafe-eval'은 Supabase-js v2의 ES module에서 필요할 수 있습니다.
      - 'unsafe-inline'은 Tailwind CSS의 JIT 엔진에 필요합니다.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-r4nd0m' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://pagead2.googlesyndication.com https://www.googlesyndication.com https://partner.googleadservices.com https://www.google-analytics.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https://*.supabase.co https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://i.ytimg.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://*.google.com https://*.googlesyndication.com https://*.doubleclick.net https://*.g.doubleclick.net https://*.googleadservices.com https://*.gstatic.com https://imasdk.googleapis.com https://*.adtrafficquality.google; frame-src 'self' https://*.youtube.com https://*.youtu.be https://*.vimeo.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;">
    
    <!-- 
      [SEO 개선]
      - Open Graph / Twitter 태그는 updateMetaTags 함수에서 동적으로 관리합니다.
      - 정적 태그는 페이지 로드 시 크롤러가 자바스크립트 실행 전에 볼 수 있는 기본값을 제공합니다.
    -->
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app">
    <meta property="og:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    <meta property="og:site_name" content="InsureLog">
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="InsureLog - AI, 기술, 그리고 보험">
    <meta name="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.">
    <meta name="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Scripts & Stylesheets -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 
      [WORKFLOW CHANGE]
      - Quill.js 관련 CSS/JS 완전 제거
      - Markdown 파서(marked.js) 및 이미지 방향(exif.js) 스크립트 추가
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer nonce="r4nd0m"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12/lib/marked.umd.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer crossorigin="anonymous" nonce="r4nd0m"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin>
    <link rel="preconnect" href="https://googleads.g.doubleclick.net" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>

    <!-- 
      [STYLE]
      - Quill 에디터 관련 스타일 제거
      - Markdown <textarea> 스타일 추가
      - [FIX] 리스트(ul, ol) 스타일 수정
    -->
    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-content-secondary: #F3F4F6;
            --border-color: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #374151;
            --accent: #D946EF;
            --accent-hover: #C026D3;
            --font-body: 'Noto Sans KR', sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        html, body { height: 100%; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 15px;
            line-height: 1.7;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; line-height: 1.75; }
        }
        main#app-container {
            padding-left: 0.75rem; padding-right: 0.75rem; flex-grow: 1;
        }
        @media (min-width: 640px) {
            main#app-container { padding-left: 1rem; padding-right: 1rem; }
        }
        /* [View] 뷰 전환을 위한 기본 클래스 */
        .app-view { display: none; opacity: 0; }
        .app-view.active { display: block; }

        /* [Prose] 블로그 포스트 콘텐츠 스타일 (Marked.js 출력 대응) */
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-weight: 900; margin-top: 2em; margin-bottom: 1em; }
        .prose-custom p { margin: 0 0 1.3em; color: var(--text-secondary); }
        .prose-custom div { margin-bottom: 1.3em; }
        .prose-custom p br { display: block; margin-bottom: 0.75em; }
        .prose-custom a { color: var(--accent); text-decoration: none; border-bottom: 1px solid var(--accent); transition: all 0.2s ease; }
        .prose-custom a:hover { background-color: var(--accent); color: white; border-bottom-color: transparent; }
        .prose-custom blockquote { border-left: 3px solid var(--accent); padding-left: 1.5em; font-style: italic; color: var(--text-primary); background-color: var(--bg-content-secondary); border-radius: 0 8px 8px 0; margin-bottom: 1.3em; }
        
        /* * [FIX] 리스트 스타일 수정
         * 요청하신 대로 중첩 리스트 서열을 명확하게 수정합니다.
         */
        .prose-custom ul, .prose-custom ol { 
            margin-bottom: 1.3em; 
            padding-left: 1.75em; 
        }
        .prose-custom li { 
            margin-bottom: 0.5em; 
        }
        
        /* --- List Styling --- */
        
        /* Top-level lists */
        .prose-custom ol { list-style-type: decimal; /* 1, 2, 3 */ }
        .prose-custom ul { list-style-type: disc;    /* ●, ●, ● */ }

        /* --- Nested lists (Level 2) --- */
        
        /* User's request: <ol> <ul> (numbers -> dots) */
        .prose-custom ol ul { 
            list-style-type: disc; /* ●, ●, ● */
        }
        
        /* Other nested combinations */
        .prose-custom ul ul { 
            list-style-type: circle; /* ○, ○, ○ */
        }
        .prose-custom ol ol {
            list-style-type: lower-alpha; /* a, b, c */
        }
        .prose-custom ul ol {
            list-style-type: lower-alpha; /* a, b, c */
        }

        /* --- Nested lists (Level 3) --- */
        .prose-custom ol ol ol, .prose-custom ul ol ol, .prose-custom ol ul ol, .prose-custom ul ul ol {
            list-style-type: lower-roman; /* i, ii, iii */
        }
        .prose-custom ul ul ul, .prose-custom ol ul ul, .prose-custom ul ol ul, .prose-custom ol ol ul {
            list-style-type: square; /* ■, ■, ■ */
        }
        
        /* --- Nested list margins --- */
        .prose-custom ul ul, .prose-custom ol ol, .prose-custom ul ol, .prose-custom ol ul { 
            margin-top: 0.5em; 
            margin-bottom: 0.5em; 
            margin-left: 1.25em; 
        }
        /* [END FIX] */

        .prose-custom pre { background-color: #282c34; color: #abb2bf; padding: 1.5em; border-radius: 12px; margin-bottom: 1.5em; overflow-x: auto; }
        
        .prose-custom img { 
            max-width: 90%; 
            height: auto; 
            border-radius: 12px; 
            margin-top: 2em; 
            margin-bottom: 2em; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            display: block; 
            margin-left: auto; 
            margin-right: auto; 
        }
        
        .prose-custom table { width: 100%; border-collapse: collapse; margin-top: 2em; margin-bottom: 2em; font-size: 0.9em; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-radius: 8px; overflow: hidden; }
        .prose-custom th, .prose-custom td { border: 1px solid var(--border-color); padding: 0.75em 1em; text-align: left; }
        .prose-custom th { background-color: var(--bg-content-secondary); font-weight: 700; color: var(--text-primary); }
        .prose-custom tr:nth-child(odd) { background-color: var(--bg-main); }
        .prose-custom tr:nth-child(even) { background-color: var(--bg-content-secondary); }

        /* [Components] 재사용 가능한 UI 요소 */
        .category-btn { transition: all 0.2s ease-in-out; border-radius: 9999px; padding: 0.25rem 0.875rem; font-weight: 500; background-color: var(--bg-content-secondary); color: var(--text-primary); border: 1px solid transparent; }
        .category-btn:hover { background-color: #E5E7EB; }
        .category-btn.active { background-color: var(--accent); color: #FFFFFF; font-weight: 700; }
        .loader-spinner { width: 2.5rem; height: 2.5rem; border: 4px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* [WORKFLOW CHANGE] Markdown 에디터 스타일 */
        #content-editor {
            width: 100%;
            min-height: 600px;
            font-family: var(--font-mono);
            font-size: 0.95em;
            line-height: 1.6;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-content-secondary);
            color: var(--text-primary);
            resize: vertical;
        }
        #content-editor:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(217, 70, 239, 0.3);
        }


        /* [Responsive] 모바일 반응형 */
        @media (max-width: 639px) {
            .writer-controls-sticky { 
                position: sticky; bottom: 0; background-color: rgba(255, 255, 255, 0.95); 
                backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
                padding: 1rem; border-top: 1px solid #E5E7EB; 
                margin-left: -0.75rem; margin-right: -0.75rem; 
                padding-top: 1rem !important; z-index: 30; 
            }
            .prose-custom img { 
                width: calc(100% + 1.5rem); 
                margin-left: -0.75rem; 
                margin-right: -0.75rem; 
                max-width: none;
                border-radius: 0; 
                box-shadow: none; 
            }
        }
        .post-thumbnail img { loading: lazy; }

        /* [Accessibility] 포커스 링 */
        button:focus, a:focus, input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--accent); outline-offset: 2px; 
        }

        /* [Motion] 접근성 - 움직임 최소화 */
        @media (prefers-reduced-motion: reduce) { 
            *, *::before, *::after { 
                animation-duration: 0.01ms !important; 
                animation-iteration-count: 1 !important; 
                transition-duration: 0.01ms !important; 
            } 
        }

        /* [Layout] 푸터 여백 */
        footer { margin-top: 16px; } 
        @media (min-width: 640px) { footer { margin-top: 24px; } }
    </style>
</head>
<body class="antialiased">
    <!-- 앱 로더 -->
    <div id="app-loader" class="fixed inset-0 z-50 bg-white flex items-center justify-center"><div class="loader-spinner"></div></div>
    
    <!-- 헤더 (네비게이션) -->
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center p-2 sm:p-4"></header>
    
    <!-- 메인 콘텐츠 (뷰가 렌더링되는 곳) -->
    <main id="app-container" class="w-full">
        <div id="view-library" class="app-view"></div>
        <div id="view-post" class="app-view"></div>
        <div id="view-dashboard" class="app-view"></div>
        <div id="view-writer" class="app-view"></div>
    </main>

    <!-- 푸터 -->
    <footer class="text-center py-8 px-4 border-t border-gray-200">
        <p class="text-sm text-gray-600">
            © 2025 InsureLog. 
            개발 및 문의사항은 <a href="https://www.threads.net/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-500 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>

    <!-- 모달 및 토스트 컨테이너 -->
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>
    
    <!-- 
      ==================================================================
      [APP SCRIPT] - 메인 애플리케이션 (모듈형 리팩터링)
      - [WORKFLOW CHANGE] QuillEditor 모듈 완전 삭제
      - [WORKFLOW CHANGE] App 모듈에 이미지 업로드 및 최적화 로직 추가
      ==================================================================
    -->

    <script type="module" nonce="r4nd0m">
        // [Supabase] ES 모듈 임포트
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        /**
         * [Module: Config]
         * 애플리케이션의 모든 설정을 관리합니다.
         */
        const Config = {
            SITE_URL: 'https://blogaipandoci.vercel.app',
            SUPABASE_URL: 'https://ddehwkwzmmvcxltlplua.supabase.co',
            // [FIX] 'JIUzI1Ni' -> 'HS256'로 오타 수정
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To',
            IMAGE_BUCKET_NAME: 'thought-images', 
            DB_TABLE_NAME: 'posts', 
            POSTS_PER_PAGE: 10,
            CATEGORIES: ["AI 트렌드", "보험 산업", "핀테크", "데이터 과학", "머신러닝", "개발 일지", "규제와 법률", "해외 동향", "고객 경험", "기타"],
            DEFAULT_OG_IMAGE: "https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp"
        };

        /**
         * [Module: State]
         * 전역 상태를 관리합니다. (사용자, 인증 상태, 현재 카테고리 등)
         */
        const State = {
            user: null,
            isAuthReady: false,
            currentCategory: '전체',
            supabase: null,
        };

        /**
         * [Module: DOM]
         * DOM 조작과 관련된 헬퍼 함수들을 관리합니다.
         */
        const DOM = {
            $: document.querySelector.bind(document),
            
            animateSwitch: (el, show = true) => {
                if (!el) return Promise.resolve();
                const opts = show ? { opacity: [0, 1], translateY: [10, 0], duration: 300, easing: 'easeOutQuad' } : { opacity: 0, duration: 200, easing: 'easeInQuad' };
                if (typeof anime === 'function') {
                    return anime({ targets: el, ...opts }).finished;
                } else {
                    console.warn('anime.js is not loaded.');
                    el.style.opacity = show ? 1 : 0;
                    return Promise.resolve();
                }
            },

            showToast: (msg, err = false) => {
                const toast = document.createElement('div');
                toast.className = `py-2.5 px-5 rounded-full shadow-lg text-sm font-medium ${err ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
                toast.textContent = msg;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'polite');
                DOM.$('#toast-container').appendChild(toast);
                DOM.animateSwitch(toast, true);
                setTimeout(() => DOM.animateSwitch(toast, false).then(() => toast.remove()), 3000);
            },

            showModal: (id, html) => {
                if (DOM.$(`#${id}`)) return;
                const container = DOM.$('#modal-container');
                const modalWrapper = document.createElement('div');
                modalWrapper.id = id;
                modalWrapper.className = "fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4";
                modalWrapper.setAttribute('role', 'dialog');
                modalWrapper.setAttribute('aria-modal', 'true');
                modalWrapper.innerHTML = html;
                container.appendChild(modalWrapper);
                
                const content = modalWrapper.querySelector('.modal-content');
                
                DOM.animateSwitch(modalWrapper);
                if (content) DOM.animateSwitch(content, true);

                return modalWrapper;
            },

            closeModal: (id) => {
                const modal = DOM.$(`#${id}`);
                if (!modal) return Promise.resolve();
                return DOM.animateSwitch(modal, false).then(() => modal.remove());
            },

            buildUrl: (path, params) => {
                const url = new URL(path, Config.SITE_URL);
                Object.entries(params).forEach(([k, v]) => {
                    if (v !== undefined && v !== null && v !== '전체' && v !== '') url.searchParams.append(k, v);
                });
                return url.pathname + url.search;
            },

            debounce: (func, wait) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }
        };

        /**
         * [Module: Services]
         * Supabase API 호출 등 백엔드 통신을 관리합니다.
         */
        const Services = {
            init: () => {
                State.supabase = createClient(Config.SUPABASE_URL, Config.SUPABASE_ANON_KEY);
            },

            onAuthChange: (callback) => {
                return State.supabase.auth.onAuthStateChange((_, session) => {
                    callback(session?.user || null);
                });
            },

            signIn: (email) => {
                return State.supabase.auth.signInWithOtp({ 
                    email, 
                    options: { emailRedirectTo: Config.SITE_URL } 
                });
            },

            signOut: () => {
                return State.supabase.auth.signOut();
            },

            getPosts: (page, category) => {
                const { from, to } = { from: (page - 1) * Config.POSTS_PER_PAGE, to: page * Config.POSTS_PER_PAGE - 1 };
                let query = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, summary, category, thumbnail_url', { count: 'exact' });
                if (category !== '전체') query = query.eq('category', category);
                return query.eq('status', 'published').order('created_at', { ascending: false }).range(from, to);
            },

            getPostBySlug: (slug) => {
                return State.supabase.from(Config.DB_TABLE_NAME).select('*').eq('slug', slug).single();
            },

            getDashboardPosts: (userId) => {
                return State.supabase.from(Config.DB_TABLE_NAME)
                    .select('id, title, slug, status, created_at')
                    .eq('author_id', userId)
                    .order('created_at', { ascending: false });
            },

            getRelatedPosts: (slug) => {
                const popular = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .eq('status', 'published')
                    .neq('slug', slug)
                    .order('view_count', { ascending: false, nullsFirst: false })
                    .limit(5);
                return popular;
            },

            getAdjacentPosts: (createdAt) => {
                 const prev = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .lt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: false })
                    .limit(1).single();
                const next = State.supabase.from(Config.DB_TABLE_NAME)
                    .select('title, slug')
                    .gt('created_at', createdAt)
                    .eq('status', 'published')
                    .order('created_at', { ascending: true })
                    .limit(1).single();
                return Promise.all([prev, next]);
            },

            incrementViewCount: (slug) => {
                try {
                    const viewed = JSON.parse(sessionStorage.getItem('viewed_posts') || '[]');
                    if (!viewed.includes(slug)) { // slug 기반으로 변경
                        State.supabase.rpc('increment_post_view', { post_slug: slug }).then(({error}) => {
                           if(error) console.warn("View count RPC error:", error);
                           else {
                                viewed.push(slug);
                                sessionStorage.setItem('viewed_posts', JSON.stringify(viewed));
                           }
                        });
                    }
                } catch (e) { console.warn('View count error:', e); }
            },
            
            savePost: (data) => {
                const id = data.id;
                delete data.id; // insert/update 객체에서 id 제거
                if (id) {
                    // Update
                    return State.supabase.from(Config.DB_TABLE_NAME).update(data).eq('id', id).select().single();
                } else {
                    // Insert
                    return State.supabase.from(Config.DB_TABLE_NAME).insert(data).select().single();
                }
            },

            checkSlugExists: (slug) => {
                return State.supabase.from(Config.DB_TABLE_NAME).select('id').eq('slug', slug).maybeSingle();
            },

            deletePost: (id) => {
                return State.supabase.from(Config.DB_TABLE_NAME).delete().eq('id', id);
            },

            uploadImage: async (file) => {
                let baseName = 'upload';
                let ext = 'bin';

                if (file.name) {
                    const parts = file.name.split('.');
                    if (parts.length > 1) {
                        ext = parts.pop().toLowerCase();
                        baseName = parts.join('.');
                    } else {
                        baseName = file.name;
                    }
                }
                
                // 파일 타입에서 확장자 추론 (이름에 없는 경우)
                if(ext === 'bin' || !file.name) {
                     if (file.type === 'image/jpeg') ext = 'jpg';
                     else if (file.type === 'image/png') ext = 'png';
                     else if (file.type === 'image/webp') ext = 'webp';
                     else if (file.type === 'image/gif') ext = 'gif';
                     else if (file.type === 'image/svg+xml') ext = 'svg';
                }

                let sanitizedBaseName = baseName.replace(/[^\w-]/g, '_');
                if (!sanitizedBaseName || sanitizedBaseName.startsWith('-')) {
                    sanitizedBaseName = 'image';
                }
                
                const path = `${State.user.id}/${sanitizedBaseName}-${Date.now()}.${ext}`;

                const { error } = await State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).upload(path, file, { upsert: true });
                if (error) throw new Error(`업로드 실패: ${error.message}`);
                
                const { data } = State.supabase.storage.from(Config.IMAGE_BUCKET_NAME).getPublicUrl(path);
                if (!data?.publicUrl) throw new Error('Public URL 실패');
                return data.publicUrl;
            }
        };

        /**
         * [WORKFLOW CHANGE]
         * QuillEditor 모듈이 완전히 삭제되었습니다.
         */

        /**
         * [Module: ViewRenderer]
         * 각 뷰(페이지)의 HTML 렌더링을 담당합니다.
         */
        const ViewRenderer = {
            _templates: {
                nav: (user) => `
                    <nav class="w-full flex items-center justify-between py-2 px-4 sm:py-3 sm:px-5 bg-white/50 backdrop-blur-xl border border-black/10 rounded-3xl shadow-lg" role="banner">
                        <a href="/" data-route class="font-black text-xl text-gray-900 tracking-tighter" aria-label="InsureLog 홈으로 이동">InsureLog</a>
                        <div class="flex items-center space-x-3">
                            ${user ? `<a href="/dashboard" data-route class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="대시보드로 이동">대시보드</a><button data-action="logout" class="px-4 py-2 text-sm font-bold rounded-full bg-black/5 text-gray-900 hover:bg-black/10 transition" aria-label="로그아웃">로그아웃</button>` : `<button data-action="auth" aria-label="로그인 또는 회원가입" class="px-4 py-2 text-sm font-bold rounded-full bg-[#D946EF] text-white hover:bg-[#C026D3] transition">로그인 / 가입</button>`}
                        </div>
                    </nav>`,
                categoryBtns: (category) => ['전체', ...Config.CATEGORIES].map(cat => `<button data-action="filter-category" data-category="${cat}" class="category-btn text-sm shrink-0 ${cat === category ? 'active' : ''}" aria-pressed="${cat === category}">${cat}</button>`).join(''),
                pagination: (page, total, basePath, params) => {
                    const totalPages = Math.ceil(total / Config.POSTS_PER_PAGE);
                    if (totalPages <= 1) return '';
                    const prevUrl = page > 1 ? DOM.buildUrl(basePath, { ...params, page: page - 1 }) : '#';
                    const nextUrl = page < totalPages ? DOM.buildUrl(basePath, { ...params, page: page + 1 }) : '#';
                    return `<div class="flex justify-center items-center gap-4 mt-12" role="navigation" aria-label="페이지 탐색"><a href="${prevUrl}" data-route aria-label="이전 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page === 1 ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">이전</a><span class="text-sm font-medium text-gray-500">${page} / ${totalPages}</span><a href="${nextUrl}" data-route aria-label="다음 페이지로 가기" class="px-4 py-2 text-sm rounded-full bg-gray-100 ${page >= totalPages ? 'pointer-events-none opacity-50' : 'hover:bg-gray-200'} text-gray-800">다음</a></div>`;
                }
            },

            /**
             * [SEO 개선]
             * meta 태그를 동적으로 생성, 업데이트 또는 제거하는 헬퍼 함수입니다.
             * @param {string} attrName - 'name' 또는 'property'
             * @param {string} attrValue - 'description', 'og:title' 등
             * @param {string | null} content - 태그에 설정할 content 값. null일 경우 태그 제거
             */
            _setMetaTag: (attrName, attrValue, content) => {
                let tag = DOM.$(`meta[${attrName}="${attrValue}"]`);
                if (content) {
                    if (!tag) {
                        tag = document.createElement('meta');
                        tag.setAttribute(attrName, attrValue);
                        document.head.appendChild(tag);
                    }
                    tag.setAttribute('content', content);
                } else if (tag) {
                    // content가 null이거나 비어있으면 태그를 제거합니다.
                    tag.remove();
                }
            },

            renderNav: () => {
                DOM.$('#main-nav-container').innerHTML = ViewRenderer._templates.nav(State.user);
            },

            renderLibrary: async (container, page, category) => {
                ViewRenderer.updateMetaTags(); // 홈페이지용 메타태그 설정
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <div class="text-center mb-12"><h1 class="text-5xl sm:text-7xl font-black mb-4 text-black tracking-tighter">InsureLog</h1><p class="text-lg text-gray-500">AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.</p></div>
                        <div class="flex items-center justify-center gap-2 mb-8 flex-wrap" role="tablist">${ViewRenderer._templates.categoryBtns(category)}</div>
                        <div id="post-list-container" class="border border-gray-200/80 rounded-2xl overflow-hidden min-h-[300px] flex items-center justify-center"><div class="loader-spinner"></div></div>
                    </div>`;
                
                const { data: posts, error, count } = await Services.getPosts(page, category);
                const listContainer = DOM.$('#post-list-container');
                if (error) {
                    console.error("Error fetching posts:", error);
                    listContainer.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러오는 중 오류가 발생했습니다.</p>`;
                    return;
                }
                
                const total = count ?? 0;
                const safePosts = Array.isArray(posts) ? posts : [];
                const postsHtml = safePosts.length > 0
                    ? `<div class="divide-y divide-gray-200/80">${safePosts.map(post => {
                        const thumb = post.thumbnail_url ? `<div class="w-24 h-16 sm:w-32 sm:h-20 flex-shrink-0 mr-4 sm:mr-5"><img src="${post.thumbnail_url}" alt="${post.title} 썸네일" class="w-full h-full object-cover rounded-lg bg-gray-100 post-thumbnail"></div>` : '';
                        return `<a href="/post/${post.slug}" data-route class="flex items-center p-4 transition-all duration-300 bg-transparent hover:bg-gray-50/80" role="article">${thumb}<div class="flex-grow"><p class="text-xs font-semibold text-fuchsia-500 mb-1">${post.category || '미분류'}</p><h3 class="text-gray-800 text-sm font-bold">${post.title}</h3><p class="text-xs text-gray-500 mt-1 line-clamp-2">${post.summary || ''}</p></div></a>`;
                    }).join('')}</div>`
                    : `<div class="text-center py-20 text-gray-500"><p class="mb-5 text-lg">아직 작성된 글이 없습니다.</p>${State.user ? `<a href="/writer" data-route class="inline-block px-6 py-3 text-base font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">첫 글 작성하기</a>` : ''}</div>`;
                
                listContainer.innerHTML = `${postsHtml}${ViewRenderer._templates.pagination(page, total, '/', { category })}`;
                listContainer.classList.remove('min-h-[300px]', 'flex', 'items-center', 'justify-center');
            },

            renderPost: async (container, slug) => {
                const { data: post, error } = await Services.getPostBySlug(slug);
                if (error || !post) {
                    console.error("Error fetching post:", slug, error);
                    DOM.showToast('글을 찾을 수 없습니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                Services.incrementViewCount(slug); // 조회수 증가 (id 대신 slug)
                ViewRenderer.updateMetaTags(post); // 개별 포스트용 메타태그 설정

                const { data: popular } = await Services.getRelatedPosts(slug);
                const [{ data: prev }, { data: next }] = await Services.getAdjacentPosts(post.created_at);

                const popularHtml = popular?.length > 0 ? `<div class="mt-20"><h2 class="text-2xl font-bold text-black mb-4">많이 본 글</h2><div class="border-t border-gray-200">${popular.map(p => `<a href="/post/${p.slug}" data-route class="block text-left py-4 px-2 border-b border-gray-200 transition-colors hover:bg-gray-50" role="link"><h4 class="font-semibold text-gray-800 text-base">${p.title}</h4></a>`).join('')}</div></div>` : '';
                const navHtml = `<nav class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-20 pt-8 border-t border-black/10" role="navigation" aria-label="이전/다음 글 탐색"><div>${prev ? `<a href="/post/${prev.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">이전 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${prev.title}</h4></a>` : ''}</div><div class="text-left md:text-right">${next ? `<a href="/post/${next.slug}" data-route class="p-6 block rounded-2xl hover:bg-gray-50 transition h-full" role="link"><span class="text-sm text-gray-500">다음 글</span><h4 class="text-gray-900 font-bold mt-2 text-base">${next.title}</h4></a>` : ''}</div></nav>`;
                
                const editBtn = (State.user && State.user.id === post.author_id) ? `<a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs font-bold rounded-full transition bg-gray-100 text-gray-800 hover:bg-gray-200" aria-label="글 수정">수정</a>` : '';
                
                const adTestAttr = ['localhost','127.0.0.1'].includes(window.location.hostname) ? ' data-adtest="on"' : '';
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto py-8 sm:py-16">
                        <article role="article">
                            <header class="mb-8 sm:mb-12">
                                <p class="text-sm font-semibold text-fuchsia-500 mb-3">${post.category || '미분류'}</p>
                                <h1 class="text-3xl sm:text-4xl font-black text-black tracking-tighter !mt-0 !mb-4">${post.title}</h1>
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${new Date(post.created_at).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                    ${editBtn}
                                </div>
                            </header>
                            <div id="post-content" class="prose-custom max-w-none"></div>
                        </article>
                        <div class="my-16"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5239497835591112" data-ad-slot="2069100221" data-ad-format="auto" data-full-width-responsive="true"${adTestAttr}></ins></div>
                        ${popularHtml}${navHtml}
                    </div>`;
                
                /**
                 * [WORKFLOW CHANGE]
                 * DB에서 가져온 Markdown (post.refined_content)을 marked.js로 파싱하고,
                 * DOMPurify로 소독(sanitize)한 후 렌더링합니다.
                 */
                if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    // 1. Markdown을 HTML로 변환
                    const rawHtml = marked.parse(post.refined_content || '');

                    // 2. DOMPurify Hook (기존 로직 재사용, 스타일 허용)
                    if (!window.__dompurifyHooked) {
                        DOMPurify.addHook('uponSanitizeAttribute', function(node, data) {
                            if (data.attrName === 'style') {
                                try {
                                    const style = (data.attrValue || '').toLowerCase();
                                    const allowedStyles = [];
                                    const mAlign = style.match(/text-align\s*:\s*(left|center|right|justify)/);
                                    if (mAlign) allowedStyles.push(`text-align:${mAlign[1]}`);
                                    const mWidth = style.match(/(?:^|;|\s)width\s*:\s*([0-9]+(?:\.[0-9]+)?)(px|%)/);
                                    if (mWidth) allowedStyles.push(`width:${mWidth[1]}${mWidth[2]}`);
                                    // ... (기타 스타일 규칙은 간결성을 위해 생략되었으나, 기존 로직이 여기에 포함됨)
                                    data.attrValue = allowedStyles.join(';');
                                    if (!data.attrValue) data.keepAttr = false;
                                } catch (_) { data.keepAttr = false; }
                            }
                        });
                        window.__dompurifyHooked = true;
                    }
                    
                    // 3. HTML 소독 (iframe, table 등 허용)
                    const safeContent = DOMPurify.sanitize(rawHtml, { 
                        ADD_TAGS: ["iframe", "table", "tr", "td", "th", "tbody", "thead", "tfoot", "col", "colgroup", "span"], 
                        ADD_ATTR: ["rowspan","colspan","style","class","width","height","align", "frameborder", "allow", "allowfullscreen"] 
                    });
                    
                    // 4. DOM에 삽입
                    DOM.$('#post-content').innerHTML = safeContent;

                } else {
                    console.warn('marked.js or DOMPurify.js not loaded.');
                    // 라이브러리 로드 실패 시 원본 텍스트(마크다운)를 그대로 표시
                    DOM.$('#post-content').textContent = post.refined_content || ''; 
                }
                
                try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch (e) { console.warn("Adsense error:", e); }
                
                // 구문 강조(highlight.js)는 marked.js가 생성한 <pre><code> 태그에 적용됩니다.
                setTimeout(() => {
                    if (typeof hljs !== 'undefined') {
                        DOM.$('#post-content').querySelectorAll('pre code').forEach(hljs.highlightElement);
                    } else {
                        console.warn('highlight.js not loaded.');
                    }
                    DOM.$('#post-content').querySelectorAll('img').forEach(img => { img.loading = 'lazy'; img.decoding = 'async'; });
                    DOM.$('#post-content').querySelectorAll('a[target="_blank"]').forEach(a => { a.rel = 'noopener noreferrer'; });
                }, 100);
            },

            renderDashboard: async (container) => {
                ViewRenderer.updateMetaTags({ title: '대시보드' });
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><div class="flex justify-between items-center mb-8 sm:mb-10"><h1 class="text-4xl font-black text-black tracking-tighter">대시보드</h1><a href="/writer" data-route class="px-5 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]" aria-label="새 글 작성">새 글 작성</a></div><div id="dashboard-post-list" class="bg-transparent space-y-2 min-h-[200px] flex items-center justify-center"><div class="loader-spinner"></div></div></div>`;
                
                if (!State.user) return;
                const { data: posts, error } = await Services.getDashboardPosts(State.user.id);
                const list = DOM.$('#dashboard-post-list');
                
                if (error) {
                    list.innerHTML = '<p class="text-center text-gray-400">글 목록을 불러오는 데 실패했습니다.</p>';
                    return;
                }
                if (!posts?.length) {
                    list.innerHTML = '<p class="text-center text-gray-400 py-10">작성한 글이 없습니다.</p>';
                    return;
                }
                list.innerHTML = `<ul class="w-full" role="list">${posts.map(post => `<li class="flex justify-between items-center p-4 rounded-xl hover:bg-gray-100 transition-colors" role="listitem"><div class="flex items-center"><span class="px-3 py-1 mr-4 rounded-full text-xs font-bold text-white ${post.status === 'published' ? 'bg-[#D946EF]' : 'bg-gray-500'}">${post.status === 'published' ? '발행' : '초안'}</span><div><a href="/post/${post.slug}" data-route class="font-bold text-black hover:text-[#D946EF]" aria-label="글 보기: ${post.title}">${post.title}</a><div class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleDateString('ko-KR')}</div></div></div><a href="/writer/${post.slug}" data-route class="px-4 py-2 text-xs rounded-full bg-black/5 hover:bg-black/10 text-black" aria-label="글 수정: ${post.title}">수정</a></li>`).join('')}</ul>`;
                list.classList.remove('min-h-[200px]', 'flex', 'items-center', 'justify-center');
            },

            renderWriter: async (container, slug) => {
                // QuillEditor.destroy(); // Quill이 없으므로 제거
                ViewRenderer.updateMetaTags({ title: slug ? '글 수정' : '새 글 작성' });

                let post = { id: null, title: '', summary: '', refined_content: '', slug: '', category: Config.CATEGORIES[0] };
                if (slug) {
                    const { data, error } = await Services.getPostBySlug(slug);
                    if (error || !data || data.author_id !== State.user.id) {
                        DOM.showToast('수정 권한이 없거나 글을 찾을 수 없습니다.', true);
                        Router.navigateTo('/dashboard');
                        return;
                    }
                    post = data;
                }
                
                const categoryOpts = Config.CATEGORIES.map(c => `<option value="${c}" ${post.category === c ? 'selected' : ''}>${c}</option>`).join('');
                
                /**
                 * [WORKFLOW CHANGE]
                 * Quill 에디터 영역을 단순 <textarea>로 교체합니다.
                 * '표 삽입' 버튼을 '이미지 업로드' 버튼과 '마크다운 안내' 링크로 교체합니다.
                 */
                container.innerHTML = `<div class="max-w-4xl mx-auto py-8 sm:py-12"><form id="writer-form" class="space-y-8 sm:pb-0 pb-20" novalidate><input type="hidden" id="post-id" value="${post.id || ''}"> <input type="hidden" id="post-slug" value="${post.slug || ''}"><div><select id="category" class="w-auto bg-gray-100 border border-gray-300 rounded-full p-2 pl-4 pr-3 text-black text-sm font-bold mb-4" required aria-label="카테고리 선택">${categoryOpts}</select><textarea id="title" class="w-full bg-transparent text-4xl font-black text-black placeholder-gray-400 focus:outline-none resize-none" rows="2" placeholder="제목을 입력하세요..." required aria-label="제목 입력" maxlength="200">${post.title || ''}</textarea></div><div><label for="summary" class="block text-lg font-bold text-black mb-3">요약 (Summary)</label><textarea id="summary" class="w-full bg-gray-50 border border-gray-300 rounded-xl p-4 text-black placeholder-gray-500" rows="3" maxlength="150" placeholder="검색 결과 및 미리보기에 표시됩니다 (150자 이내)" aria-label="요약 입력">${post.summary || ''}</textarea></div><div><label for="content-editor" class="block text-lg font-bold text-black mb-3">본문 (Markdown)</label><textarea id="content-editor" aria-label="본문 에디터 (마크다운)" placeholder="여기에 마크다운 형식으로 본문을 작성하세요...">${post.refined_content || ''}</textarea></div><div class="flex justify-between items-center pt-8 sm:pt-5 writer-controls-sticky"><div class="flex items-center gap-3"><button type="button" data-action="upload-image" class="px-4 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition" aria-label="이미지 업로드">이미지 업로드</button><a href="https://www.markdownguide.org/basic-syntax/" target="_blank" rel="noopener" class="px-4 py-2 text-xs sm:text-sm font-bold rounded-full bg-gray-100 text-black hover:bg-gray-200 transition" aria-label="마크다운 안내">마크다운 안내</a></div><div class="flex items-center space-x-3"><button type="submit" data-action="save-draft" class="px-5 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">초안 저장</button><button type="submit" data-action="publish" class="px-6 py-2.5 text-sm font-bold rounded-full transition bg-[#D946EF] text-white hover:bg-[#C026D3]">발행하기</button>${post.id ? `<button type="button" data-action="delete" class="ml-4 px-5 py-2.5 text-sm font-bold rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition" aria-label="글 삭제">삭제</button>` : ''}</div></div></form></div>`;
                
                // Quill 초기화 코드가 모두 제거되었습니다.
                
                // 이벤트 리스너 바인딩
                ViewRenderer._bindWriterEvents(post);
            },
            
            _bindWriterEvents: (post) => {
                const form = DOM.$('#writer-form');
                if (!form) return;

                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (!ViewRenderer._validateForm()) return;
                    if (e.submitter?.dataset.action) App.handlePostSave(e.submitter.dataset.action, e.submitter);
                };

                const delBtn = form.querySelector('[data-action="delete"]');
                if (delBtn) delBtn.onclick = (e) => { e.preventDefault(); App.handlePostDelete(post.id); };
                
                // [WORKFLOW CHANGE] 이미지 업로드 버튼 바인딩
                const uploadBtn = form.querySelector('[data-action="upload-image"]');
                if (uploadBtn) uploadBtn.onclick = (e) => { 
                    e.preventDefault(); 
                    App.handleImageUpload(e.target); 
                };

                // [NEW] 붙여넣기 이벤트 리스너 바인딩
                const contentEditor = form.querySelector('#content-editor');
                if (contentEditor) {
                    contentEditor.addEventListener('paste', App.handlePaste);
                }
                
                const titleEl = DOM.$('#title');
                if (titleEl) titleEl.oninput = DOM.debounce(() => {
                    const slugEl = DOM.$('#post-slug');
                    if (slugEl && !slugEl.value) { // slug가 이미 있는 글은 자동생성 안함
                        // (옵션) 자동 생성된 slug를 사용자에게 표시할 수 있음
                    }
                }, 300);
            },

            _validateForm: () => {
                const title = DOM.$('#title')?.value.trim();
                const content = DOM.$('#content-editor')?.value.trim();
                const cat = DOM.$('#category')?.value;
                if (!title) { DOM.showToast('제목은 필수 항목입니다.', true); DOM.$('#title')?.focus(); return false; }
                if (!cat) { DOM.showToast('카테고리를 선택해주세요.', true); DOM.$('#category')?.focus(); return false; }
                if (!content) { DOM.showToast('본문은 필수 항목입니다.', true); DOM.$('#content-editor')?.focus(); return false; }
                return true;
            },

            showAuthModal: () => {
                const modalId = 'auth-modal';
                const html = `<div id="auth-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8 relative" role="document">
                    <button data-action="close-modal" aria-label="닫기" class="absolute top-4 right-4 text-gray-400 hover:text-black text-2xl leading-none">&times;</button>
                    <h2 id="auth-modal-title" class="text-2xl font-bold text-center mb-4 text-black">로그인 또는 가입</h2>
                    <p class="text-center text-gray-500 mb-8">이메일을 입력하시면 로그인 링크를 보내드립니다.</p>
                    <form id="auth-form" class="space-y-4">
                        <input type="email" id="email-input" placeholder="you@example.com" required class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 text-black focus:ring-blue-500 focus:border-blue-500" aria-label="이메일 입력" autocomplete="email">
                        <button type="submit" class="w-full px-4 py-3 font-bold rounded-lg transition bg-[#D946EF] text-white hover:bg-[#C026D3]">매직 링크 받기</button>
                    </form>
                </div>`;
                
                const modal = DOM.showModal(modalId, html);
                if (!modal) return;

                modal.querySelector('#auth-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const email = DOM.$('#email-input').value.trim();
                    if (!email) { DOM.showToast('이메일 입력해주세요.', true); return; }
                    const btn = e.target.querySelector('button');
                    btn.disabled = true; btn.textContent = '전송 중...';
                    
                    const { error } = await Services.signIn(email);
                    if (error) { 
                        DOM.showToast(`오류: ${error.message}`, true); 
                        btn.disabled = false; btn.textContent = '매직 링크 받기';
                    } else { 
                        DOM.showToast('이메일 확인해주세요!'); 
                        DOM.closeModal(modalId); 
                    }
                };
            },
            
            showDeleteConfirmModal: (msg) => new Promise(res => {
                const modalId = 'delete-confirm-modal';
                const html = `<div id="delete-modal-content" class="modal-content bg-white border border-gray-200 rounded-2xl shadow-lg w-full max-w-sm p-8" role="document">
                    <h3 id="delete-modal-title" class="sr-only">삭제 확인</h3>
                    <p class="text-center text-black text-lg mb-8">${msg}</p>
                    <div class="flex justify-center gap-4">
                        <button data-action="delete-no" class="px-6 py-2.5 text-sm font-bold rounded-full bg-gray-200 text-black hover:bg-gray-300 transition">취소</button>
                        <button data-action="delete-yes" class="px-6 py-2.5 text-sm font-bold rounded-full bg-red-600 text-white hover:bg-red-700 transition">삭제 확인</button>
                    </div>
                </div>`;

                const modal = DOM.showModal(modalId, html);
                if (!modal) return res(false);

                modal.querySelector('[data-action="delete-yes"]').onclick = () => { DOM.closeModal(modalId); res(true); };
                modal.querySelector('[data-action="delete-no"]').onclick = () => { DOM.closeModal(modalId); res(false); };
            }),

            // [WORKFLOW CHANGE] 테이블 도움말 모달 삭제 (showTableHelpModal)

            /**
             * [SEO 개선]
             * 현재 뷰(post 또는 null)를 기반으로 메타 태그와 JSON-LD 스키마를 동적으로 업데이트합니다.
             * 제공된 "고급 색인 생성" 문서의 권장 사항을 적용합니다.
             * @param {object | null} post - 현재 보고 있는 포스트 객체, 또는 홈페이지의 경우 null
             */
            updateMetaTags: (post = null) => {
                const title = post ? `${post.title} | InsureLog` : 'InsureLog - AI, 기술, 그리고 보험';
                const desc = post ? (post.summary || 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.') : 'AI, 기술, 그리고 보험에 대한 깊이 있는 분석과 기록들.';
                const url = post ? `${Config.SITE_URL}/post/${post.slug}` : Config.SITE_URL;
                const img = post?.thumbnail_url || Config.DEFAULT_OG_IMAGE;
                
                document.title = title;
                DOM.$('link[rel="canonical"]')?.setAttribute('href', url);

                // Standard meta tags
                ViewRenderer._setMetaTag('name', 'description', desc);
                ViewRenderer._setMetaTag('name', 'author', 'InsureLog');

                // Open Graph (Facebook, etc.)
                ViewRenderer._setMetaTag('property', 'og:type', post ? 'article' : 'website');
                ViewRenderer._setMetaTag('property', 'og:title', title);
                ViewRenderer._setMetaTag('property', 'og:description', desc);
                ViewRenderer._setMetaTag('property', 'og:url', url);
                ViewRenderer._setMetaTag('property', 'og:image', img);
                ViewRenderer._setMetaTag('property', 'og:site_name', 'InsureLog');

                // Twitter Card
                ViewRenderer._setMetaTag('name', 'twitter:card', 'summary_large_image');
                ViewRenderer._setMetaTag('name', 'twitter:title', title);
                ViewRenderer._setMetaTag('name', 'twitter:description', desc);
                ViewRenderer._setMetaTag('name', 'twitter:image', img);

                // [SEO 개선] Article-specific tags (문서에서 권장)
                // 포스트 페이지에서는 추가하고, 홈페이지에서는 제거합니다.
                ViewRenderer._setMetaTag('property', 'article:published_time', post ? post.created_at : null);
                ViewRenderer._setMetaTag('property', 'article:modified_time', post ? (post.updated_at || post.created_at) : null);
                ViewRenderer._setMetaTag('property', 'article:section', post ? post.category : null); // 카테고리

                // [SEO 개선] Keywords meta tag
                const keywords = post 
                    ? `InsureLog, ${post.category}, ${post.title.split(' ').slice(0, 3).join(', ')}`
                    : 'InsureLog, AI, 보험, 핀테크, 기술, 블로그, 인공지능, 데이터';
                ViewRenderer._setMetaTag('name', 'keywords', keywords);

                
                // --- [SEO 개선] ENHANCED JSON-LD (Schema.org) ---
                const ld = DOM.$('#ld-json') || document.createElement('script');
                ld.type = 'application/ld+json';
                ld.id = 'ld-json';
                
                // 재사용 가능한 발행인(Publisher) 정보
                const publisherData = { 
                    "@type": "Organization", 
                    "name": "InsureLog", 
                    "logo": { 
                        "@type": "ImageObject", 
                        "url": Config.DEFAULT_OG_IMAGE 
                    } 
                };
                
                let schemaData;
                if (post) {
                    // [SEO 개선] BlogPosting 스키마 (문서 권장 사항 적용)
                    schemaData = {
                        "@context": "https://schema.org",
                        "@type": "BlogPosting",
                        "mainEntityOfPage": { "@type": "WebPage", "@id": url },
                        "headline": post.title,
                        "description": desc,
                        "image": img ? [img] : undefined,
                        "author": publisherData, // 조직을 작성자로 명시
                        "publisher": publisherData, // 발행인 명시 (권장)
                        "datePublished": post.created_at, // 발행일 (문서 권장)
                        "dateModified": post.updated_at || post.created_at, // 수정일 (문서 권장)
                        "articleSection": post.category, // 카테고리 (필터링에 유용)
                        "keywords": `${post.category}, ${post.title}` // 키워드
                    };
                } else {
                    // [SEO 개선] WebSite 스키마 (홈페이지용)
                    schemaData = {
                        "@context": "https://schema.org",
                        "@type": "WebSite",
                        "url": Config.SITE_URL,
                        "name": "InsureLog",
                        "description": desc,
                        "publisher": publisherData
                    };
                }
                ld.textContent = JSON.stringify(schemaData, null, 2); // 가독성을 위해 2칸 들여쓰기

                if (!DOM.$('#ld-json')) {
                    document.head.appendChild(ld);
                }
            }
        };

        /**
         * [Module: Router]
         * 브라우저 히스토리 및 뷰 전환을 관리합니다. (변경 없음)
         */
        const Router = {
            init: () => {
                window.addEventListener('popstate', Router.handleRouting);
                Router.handleRouting(); // 초기 라우팅
            },

            navigateTo: (path, replace = false) => {
                const newPath = path || '/';
                const action = replace ? 'replaceState' : 'pushState';
                if (window.location.pathname + window.location.search !== newPath) {
                    history[action]({ path: newPath }, '', newPath);
                }
                Router.handleRouting();
            },

            switchView: async (viewId, callback) => {
                const current = DOM.$('.app-view.active');
                if (current) {
                    await DOM.animateSwitch(current, false);
                    current.classList.remove('active');
                    current.innerHTML = '';
                }
                const next = DOM.$(`#${viewId}`);
                if (next) {
                    next.innerHTML = `<div class="min-h-[400px] flex items-center justify-center"><div class="loader-spinner"></div></div>`;
                    next.classList.add('active');
                    await DOM.animateSwitch(next);
                    try {
                        await callback(next); // 뷰 렌더링 함수 실행
                    } catch (error) {
                        console.error(`Error rendering ${viewId}:`, error);
                        next.innerHTML = `<p class="text-center text-red-400 py-20">페이지를 표시하는 중 오류가 발생했습니다.</p>`;
                    }
                    window.scrollTo(0, 0);
                }
            },

            handleRouting: () => {
                if (!State.isAuthReady) return; // 인증 상태 확인 전에는 라우팅 금지
                
                const path = window.location.pathname;
                const params = new URLSearchParams(window.location.search);
                const parts = path.split('/').filter(Boolean);
                const route = parts[0] || 'library';
                const param = parts[1] || null;
                
                if (!State.user && ['dashboard', 'writer'].includes(route)) {
                    DOM.showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                    Router.navigateTo('/');
                    return;
                }
                
                switch (route) {
                    case 'post': 
                        return Router.switchView('view-post', el => ViewRenderer.renderPost(el, param));
                    case 'dashboard': 
                        return Router.switchView('view-dashboard', el => ViewRenderer.renderDashboard(el));
                    case 'writer': 
                        return Router.switchView('view-writer', el => ViewRenderer.renderWriter(el, param));
                    default: 
                        const page = parseInt(params.get('page'), 10) || 1;
                        State.currentCategory = params.get('category') || '전체';
                        return Router.switchView('view-library', el => ViewRenderer.renderLibrary(el, page, State.currentCategory));
                }
            }
        };

        /**
         * [Module: App]
         * 애플리케이션의 메인 진입점. 초기화 및 전역 이벤트 핸들러를 관리합니다.
         * [WORKFLOW CHANGE] 이미지 업로드 및 최적화 로직 추가
         */
        const App = {
            init: () => {
                Services.init();
                App.bindGlobalListeners();

                Services.onAuthChange((user) => {
                    const authChanged = State.user?.id !== user?.id;
                    State.user = user;

                    if (!State.isAuthReady) {
                        State.isAuthReady = true;
                        ViewRenderer.renderNav();
                        Router.init(); 
                        DOM.animateSwitch(DOM.$('#app-loader'), false).then(() => DOM.$('#app-loader').remove());
                    } else if (authChanged) {
                        ViewRenderer.renderNav();
                        Router.handleRouting(); 
                    }
                });
            },

            bindGlobalListeners: () => {
                document.addEventListener('click', (e) => {
                    const route = e.target.closest('[data-route]');
                    if (route && route.href !== '#') { 
                        e.preventDefault(); 
                        Router.navigateTo(route.href); 
                        return; 
                    }
                    
                    const action = e.target.closest('[data-action]');
                    if (action && !action.closest('form')) {
                        e.preventDefault();
                        const act = action.dataset.action;
                        switch (act) {
                            case 'auth': return ViewRenderer.showAuthModal();
                            case 'logout': return App.handleLogout();
                            case 'filter-category': 
                                return Router.navigateTo(DOM.buildUrl('/', { page: 1, category: action.dataset.category }));
                            case 'close-modal':
                                return DOM.closeModal(action.closest('[role="dialog"]').id);
                            // 'upload-image' 등 writer 뷰 내의 버튼들은 _bindWriterEvents에서 처리
                        }
                    }
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = DOM.$('[role="dialog"]');
                        if (modal) DOM.closeModal(modal.id);
                    }
                });
            },

            handleLogout: async () => {
                try { 
                    await Services.signOut(); 
                    DOM.showToast('로그아웃되었습니다.'); 
                } catch (e) { 
                    console.error('Logout error:', e); 
                    DOM.showToast('로그아웃 실패.', true);
                }
                Router.navigateTo('/', true);
            },

            handlePostSave: async (action, btn) => {
                const origText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = `<div class="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mx-auto"></div>`;
                
                try {
                    const title = DOM.$('#title').value.trim();
                    const status = action === 'publish' ? 'published' : 'draft';
                    
                    // [WORKFLOW CHANGE] <textarea>에서 마크다운 텍스트 가져오기
                    const content = DOM.$('#content-editor').value; 
                    
                    if (!content || content.trim().length < 10) {
                        throw new Error('본문이 너무 짧습니다.');
                    }
                    
                    // [WORKFLOW CHANGE] 요약 생성 (마크다운 텍스트 기반)
                    let summary = DOM.$('#summary').value.trim();
                    if (!summary) {
                        // 마크다운 제거하고 순수 텍스트 추출 (간단한 버전)
                        const plainText = content.replace(/!\[.*?\]\(.*?\)/g, '') // 이미지 제거
                                              .replace(/\[.*?\]\(.*?\)/g, '$1') // 링크 텍스트만 남김
                                              .replace(/#{1,6}\s/g, '') // 헤더 제거
                                              .replace(/[*_`~>|]/g, '') // 기타 마크다운 문자 제거
                                              .replace(/\s+/g, ' ') // 공백 정규화
                                              .trim();
                        summary = plainText.slice(0, 150) + (plainText.length > 150 ? '...' : '');
                    }
                    
                    // [WORKFLOW CHANGE] 썸네일 생성 (마크다운 파싱 기반)
                    let thumb = null;
                    if (typeof marked !== 'undefined') {
                        const parsedForThumb = marked.parse(content);
                        const temp = document.createElement('div'); 
                        temp.innerHTML = parsedForThumb;
                        thumb = temp.querySelector('img')?.src || null;
                    }
                    
                    const id = DOM.$('#post-id').value || null;
                    let slug = DOM.$('#post-slug').value.trim() || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                    
                    if (!id) { // 새 글일 때만 slug 중복 검사
                        const { data } = await Services.checkSlugExists(slug);
                        if (data) slug += `-${Date.now().toString().slice(-6)}`;
                    }
                    
                    const postData = { 
                        id: id,
                        title, slug, status, summary, 
                        author_id: State.user.id, 
                        refined_content: content, // 마크다운 원본 저장
                        category: DOM.$('#category').value, 
                        thumbnail_url: thumb,
                        updated_at: new Date().toISOString() // [SEO 개선] 수정 시간 갱신
                    };
                    
                    const { data: savedPost, error } = await Services.savePost(postData);
                    if (error) throw error;
                    
                    DOM.showToast(status === 'published' ? '발행되었습니다!' : '저장되었습니다.');
                    Router.navigateTo(status === 'published' ? `/post/${savedPost.slug}` : '/dashboard');

                } catch (e) {
                    console.error("Save error:", e);
                    DOM.showToast(`저장 실패: ${e.message}`, true);
                } finally {
                    btn.disabled = false;
                    btn.textContent = origText;
                }
            },

            handlePostDelete: async (id) => {
                if (!id) return;
                const confirm = await ViewRenderer.showDeleteConfirmModal('정말 삭제하시겠습니까? 되돌릴 수 없습니다.');
                if (!confirm) return;
                
                DOM.showToast('삭제 중...');
                const { error } = await Services.deletePost(id);
                if (error) {
                    DOM.showToast(`삭제 실패: ${error.message}`, true);
                } else {
                    DOM.showToast('삭제되었습니다.');
                    Router.navigateTo('/dashboard');
                }
            },

            /**
             * [NEW] 붙여넣기 이벤트 핸들러
             * 붙여넣기된 텍스트에서 JSON-LD 스키마를 파싱하여 필드를 자동 완성합니다.
             */
            handlePaste: (e) => {
                const textarea = DOM.$('#content-editor');
                if (!textarea) return;
                
                e.preventDefault(); // 기본 붙여넣기 동작 중지
                const pastedText = e.clipboardData.getData('text/plain');
                if (!pastedText) return;

                let contentToInsert = pastedText; // 기본값: 원본 텍스트 전체

                // 붙여넣기된 텍스트가 { ... } JSON으로 시작하는지 확인 (사용자 예시 기준)
                const jsonBlobRegex = /^({[\s\S]*?})([\s\S]*)/m;
                const match = pastedText.match(jsonBlobRegex);

                if (match && match[1]) {
                    const jsonString = match[1].trim();
                    const restOfText = match[2] ? match[2].trim() : '';

                    try {
                        const schema = JSON.parse(jsonString);

                        // schema.org 데이터인지 확인
                        if (schema['@context'] && schema['@context'].includes('schema.org')) {
                            // 제목 자동 완성
                            if (schema.headline) DOM.$('#title').value = schema.headline;
                            
                            // 요약 자동 완성
                            if (schema.description) DOM.$('#summary').value = schema.description;
                            
                            // (보너스) 카테고리 자동 완성 시도
                            const categorySource = schema.articleSection || (Array.isArray(schema.keywords) ? schema.keywords[0] : schema.keywords);
                            if (categorySource) {
                                // Config.CATEGORIES에 일치하는 카테고리가 있는지 확인
                                const matchedCategory = Config.CATEGORIES.find(c => c.toLowerCase() === categorySource.toLowerCase().trim());
                                if (matchedCategory) DOM.$('#category').value = matchedCategory;
                            }

                            // 에디터에 삽입할 텍스트를 JSON 다음의 본문으로 변경
                            contentToInsert = restOfText;
                            DOM.showToast('JSON-LD 스키마를 감지하여 필드를 자동 완성했습니다.', false);
                        }
                    } catch (err) {
                        // JSON 파싱에 실패하면, 원본 텍스트를 그대로 사용
                        console.warn('Pasted content start failed to parse as JSON.', err);
                    }
                }

                // 최종 텍스트(정리되었거나 원본)를 에디터에 삽입
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, start) + contentToInsert + textarea.value.substring(end);
                
                // 삽입된 텍스트 끝으로 커서 이동
                textarea.selectionStart = textarea.selectionEnd = start + contentToInsert.length;
            },

            /**
             * [WORKFLOW CHANGE]
             * 마크다운 에디터를 위한 새 이미지 업로드 핸들러
             */
            handleImageUpload: async (btn) => {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*';
                input.click();
                
                input.onchange = async () => {
                    const file = input.files[0];
                    if (!file) return;

                    const origText = btn.textContent;
                    btn.disabled = true; btn.textContent = '업로드 중...';
                    DOM.showToast('이미지 업로드 중...');

                    try {
                        // 이미지 최적화 (WebP 변환)
                        const fileToUpload = await App.convertToWebP(file);
                        const url = await Services.uploadImage(fileToUpload);
                        
                        // <textarea>에 마크다운 태그 삽입
                        const textarea = DOM.$('#content-editor');
                        if (textarea) {
                            const markdownImage = `\n![이미지 설명](${url})\n`;
                            
                            // 현재 커서 위치에 텍스트 삽입
                            const start = textarea.selectionStart;
                            const end = textarea.selectionEnd;
                            textarea.value = textarea.value.substring(0, start) + markdownImage + textarea.value.substring(end);
                            
                            // 삽입된 태그의 '이미지 설명' 부분으로 커서 이동
                            const newCursorPos = start + markdownImage.indexOf(']') - 4;
                            textarea.selectionStart = newCursorPos;
                            textarea.selectionEnd = newCursorPos + 6;
                            textarea.focus();
                        }

                        DOM.showToast('업로드 완료!', false);
                    } catch (e) {
                        console.error('Upload failed:', e);
                        DOM.showToast(`이미지 업로드 실패: ${e.message}`, true);
                    } finally {
                        btn.disabled = false; btn.textContent = origText;
                    }
                };
            },

            /**
             * [WORKFLOW CHANGE]
             * 이미지 최적화 헬퍼 함수들을 QuillEditor 모듈에서 App 모듈로 이동
             */
            getOrientation: (file) => new Promise((res) => {
                if (typeof EXIF === 'undefined') { 
                    console.warn('EXIF.js not loaded. Assuming orientation 1.');
                    res(1); 
                    return; 
                }
                EXIF.getData(file, function() { 
                    res(EXIF.getTag(this, 'Orientation') || 1);
                });
            }),

            convertToWebP: (file, quality = 0.8) => new Promise((res) => {
                if (typeof FileReader === 'undefined' || typeof Image === 'undefined' || typeof EXIF === 'undefined') {
                    console.warn('WebP 변환 API 미지원. 원본 파일 사용.');
                    res(file);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async (e) => {
                    const img = new Image(); 
                    img.src = e.target.result;
                    img.onload = async () => {
                        const orient = await App.getOrientation(file); // App.getOrientation으로 변경
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let w = img.width, h = img.height;
                        if (orient >= 5 && orient <= 8) { [w, h] = [h, w]; }
                        canvas.width = w; canvas.height = h;
                        const transforms = {2: [-1,0,0,1,w,0], 3: [-1,0,0,-1,w,h], 4: [1,0,0,-1,0,h], 5: [0,1,1,0,0,0], 6: [0,1,-1,0,h,0], 7: [0,-1,-1,0,h,w], 8: [0,-1,1,0,0,w]};
                        ctx.transform(...(transforms[orient] || [1,0,0,1,0,0]));
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                let baseName = file.name ? file.name.split('.').slice(0, -1).join('.') : 'image';
                                const webpFile = new File([blob], `${baseName}.webp`, { type: 'image/webp' });
                                res(webpFile);
                            } else {
                                 res(file); // 변환 실패 시 원본
                            }
                        }, 'image/webp', quality);
                    };
                    img.onerror = () => res(file); // 이미지 로드 실패 시 원본
                };
                reader.onerror = () => res(file); // 리더 실패 시 원본
            })
        };

        // --- [APP START] ---
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>

