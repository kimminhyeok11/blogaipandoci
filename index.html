<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KQ8THNV2');</script>
    <!-- End Google Tag Manager -->

    <!-- AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5239497835591112" crossorigin="anonymous"></script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & Meta Tags -->
    <title>InsureLog</title>
    <meta name="description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <link rel="canonical" href="https://blogaipandoci.vercel.app/" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blogaipandoci.vercel.app/">
    <meta property="og:title" content="InsureLog">
    <meta property="og:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="og:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://blogaipandoci.vercel.app/">
    <meta property="twitter:title" content="InsureLog">
    <meta property="twitter:description" content="AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.">
    <meta property="twitter:image" content="https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

    <!-- Code Highlighting (Prettify) Styles -->
    <style>
        /* Prettify Tomorrow Theme */
        .pln{color:#4d4d4c}.str{color:#718c00}.kwd{color:#8959a8}.com{color:#8e908c}.typ{color:#4271ae}.lit{color:#f5871f}.pun,.opn,.clo{color:#4d4d4c}.tag{color:#c82829}.atn{color:#f5871f}.atv{color:#3e999f}.dec,.var{color:#c82829}.fun{color:#4271ae}
        
        pre.prettyprint {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            border: 1px solid #EAEAEA;
            border-radius: 8px;
            padding: 1.2rem;
            background: #F9FAFB;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
        }
        ol.linenums{margin:0}ol.linenums li{padding-left:10px;color:#999;line-height:1.8;list-style-type:decimal}
    </style>

    <!-- Main Styles -->
    <style>
        :root {
            --bg-main: #F9FAFB;
            --bg-content: #FFFFFF;
            --border-color: #F0F0F0;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --font-heading: 'Open Sans', sans-serif;
            --font-body: 'Open Sans', sans-serif;
        }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-body); 
            background-color: var(--bg-main); 
            color: var(--text-primary); 
            font-size: 14px; 
            overflow-x: hidden; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #app-container {
            flex-grow: 1;
        }
        
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background-color: var(--bg-main); display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        
        .loader-spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .app-view { display: none; } .app-view.active { display: block; }
        .brand-logo { font-family: var(--font-heading); font-weight: 800; font-size: 1rem; color: var(--text-primary); letter-spacing: -0.5px; }
        
        .btn { padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 500; border-radius: 6px; transition: all 0.25s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.25rem; border: 1px solid #D1D5DB; background-color: var(--bg-content); color: #374151; cursor: pointer; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .btn:hover { background-color: #F9FAFB; color: var(--text-primary); transform: translateY(-1px); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background-color: var(--accent-hover); border-color: var(--accent-hover); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background-color: var(--bg-content) !important; color: var(--text-secondary) !important; }
        
        .form-input, .form-textarea { font-size: 0.85rem; padding: 0.5rem 0.75rem; border: 1px solid #D1D5DB; border-radius: 6px; width: 100%; background-color: var(--bg-content); color: var(--text-primary); transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        .prose-custom { color: #374151; line-height: 1.7; font-size: 0.9rem; }
        .prose-custom > *:not(:first-child) { margin-top: 1.25em; }
        .prose-custom p { margin-bottom: 1.25em; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-family: var(--font-heading); font-weight: 600; margin-top: 2em; margin-bottom: 0.8em; }
        .prose-custom h1 { font-size: 1.5rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 0.3em; }
        .prose-custom h2 { font-size: 1.1rem; }
        .prose-custom h3 { font-size: 1.05rem; }
        .prose-custom a { color: var(--accent); text-decoration: none; font-weight: 500; border-bottom: 1px solid #93c5fd; transition: all 0.2s ease; }
        .prose-custom a:hover { border-bottom-color: var(--accent); }
        .prose-custom pre, .prose-custom blockquote { margin-top: 2em; margin-bottom: 2em; }
        .prose-custom code { background-color: #E5E7EB; padding: 0.2em 0.4em; border-radius: 4px; font-size: 0.85em; color: #4B5563; }
        .prose-custom pre code { background-color: transparent; padding: 0; }
        .prose-custom blockquote { border-left: 2px solid #9CA3AF; padding-left: 1rem; color: var(--text-secondary); font-style: normal; }
        .prose-custom img { border-radius: 8px; max-width: 100%; height: auto; margin-top: 2.5em; margin-bottom: 2.5em; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
                
        .pagination-controls a.disabled { pointer-events: none; opacity: 0.5; }
        
        #editor-container { background-color: white; border: 1px solid #D1D5DB; border-radius: 6px; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        #editor-container .ql-toolbar { border: none; border-bottom: 1px solid #D1D5DB; border-top-left-radius: 6px; border-top-right-radius: 6px; background-color: #F9FAFB; padding: 8px; }
        #editor-container .ql-container { border: none; }
        #editor-container .ql-editor { min-height: 300px; font-size: 0.95rem; line-height: 1.7; color: var(--text-primary); padding: 12px; }
        #editor-container .ql-editor.ql-blank::before { color: #adb5bd; font-style: normal; left: 12px; }
        #editor-container .ql-editor img { max-width: 100%; height: auto; border-radius: 8px; margin: 1em 0; }
        #editor-container .ql-editor pre { background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; white-space: pre-wrap; color: #374151; }
        #editor-container .ql-editor blockquote { border-left: 3px solid #d1d5db; margin-left: 0; padding-left: 1rem; color: #6b7280; }

        @media (max-width: 768px) {
            body { font-size: 14px; }
            .prose-custom h1 { font-size: 1.5rem; }
            .btn { padding: 0.4rem 0.6rem; font-size: 0.75rem; }
            .brand-logo { font-size: 1rem; }
            header { padding-top: 0.5rem; padding-bottom: 0.5rem;}
        }
    </style>
</head>
<body class="antialiased">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KQ8THNV2"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="app-loader"><div class="loader-spinner"></div></div>
    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center px-4 py-2"></header>
    <div id="app-container" class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <main id="main-content">
            <div id="view-library" class="app-view max-w-4xl mx-auto"></div>
            <div id="view-post" class="app-view max-w-4xl mx-auto"></div>
            <div id="view-dashboard" class="app-view max-w-5xl mx-auto"></div>
            <div id="view-writer" class="app-view max-w-4xl mx-auto"></div>
        </main>
    </div>
    <footer class="text-center py-6 px-4 border-t border-gray-200 mt-12">
        <p class="text-xs text-gray-500">
            개발 및 문의사항은 <a href="https://www.threads.com/@ilovemom_2026" target="_blank" rel="noopener noreferrer" class="font-semibold text-gray-700 hover:text-black transition-colors underline">Threads</a>로 연락 주세요.
        </p>
    </footer>
        
    <div id="structured-data-container"></div>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?lang=css"></script>

    <script type="module">
        // =================================================================================
        // --- SETUP & STATE MANAGEMENT ---
        // =================================================================================
        const SITE_URL = 'https://blogaipandoci.vercel.app';
        const SUPABASE_URL = 'https://ddehwkwzmmvcxltlplua.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZWh3a3d6bW12Y3hsdGxwbHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MjcyNTgsImV4cCI6MjA3MjIwMzI1OH0.VNK-2RYRvLUr9f4fg59kQEEgjwUBZZQsQsrld9Zg7To';
        const IMAGE_BUCKET_NAME = 'thought-images';
        const POSTS_PER_PAGE = 5;
        const defaultMeta = {
            title: "InsureLog",
            description: "AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트를 탐험하는 공간, InsureLog입니다.",
            image: 'https://ddehwkwzmmvcxltlplua.supabase.co/storage/v1/object/public/thought-images/cortexlog.webp'
        };
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const state = { 
            user: null, 
            quill: null,
            isAuthReady: false,
        };
        const $ = (selector) => document.querySelector(selector);
        
        // =================================================================================
        // --- SEO & META TAGS ---
        // =================================================================================
        function updateMetaTags(post = null) {
            const title = post ? post.title : defaultMeta.title;
            const description = post ? (post.summary || defaultMeta.description) : defaultMeta.description;
            const url = post ? `${SITE_URL}/post/${post.slug}` : SITE_URL;
            let imageUrl = defaultMeta.image;
            if (post && post.refined_content) {
                const match = post.refined_content.match(/<img[^>]+src="([^">]+)"/);
                if (match && match[1]) imageUrl = match[1];
            }
            document.title = title;
            $('meta[name="description"]').setAttribute('content', description);
            $('link[rel="canonical"]').setAttribute('href', url);
            ['og:title', 'twitter:title'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', title));
            ['og:description', 'twitter:description'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', description));
            ['og:url', 'twitter:url'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', url));
            ['og:image', 'twitter:image'].forEach(p => $(`meta[property="${p}"]`).setAttribute('content', imageUrl));

            if(post) {
                generateStructuredData('Article', post);
            } else {
                generateStructuredData('WebSite');
            }
        }

        function generateStructuredData(type, data = {}) {
            let schema = {};
            if (type === 'WebSite') {
                schema = { "@context": "https://schema.org", "@type": "WebSite", "url": SITE_URL, "name": "InsureLog", "description": "AI, 기술, 그리고 보험에 대한 깊이 있는 인사이트" };
            } else if (type === 'Article' && data && data.refined_content) {
                const imageUrl = (data.refined_content.match(/<img[^>]+src="([^">]+)"/) || [])[1] || defaultMeta.image;
                schema = {
                    "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": `${SITE_URL}/post/${data.slug}` },
                    "headline": data.title, "description": data.summary, "image": imageUrl, "author": { "@type": "Person", "name": "InsureLog Admin" },
                    "publisher": { "@type": "Organization", "name": "InsureLog", "logo": { "@type": "ImageObject", "url": defaultMeta.image } },
                    "datePublished": new Date(data.created_at).toISOString(), "dateModified": new Date(data.updated_at || data.created_at).toISOString() 
                };
            }
            let script = document.getElementById('json-ld-structured-data');
            if (!script) {
                script = document.createElement('script'); script.type = 'application/ld+json'; script.id = 'json-ld-structured-data';
                $('#structured-data-container').appendChild(script);
            }
            script.textContent = JSON.stringify(schema);
        }

        // =================================================================================
        // --- UI & ANIMATIONS ---
        // =================================================================================
        const animations = {
            pageEnter: (el) => anime({ targets: el, translateY: [20, 0], opacity: [0, 1], duration: 500, easing: 'easeOutCubic' }),
            pageExit: (el) => anime({ targets: el, translateY: [0, -20], opacity: [1, 0], duration: 300, easing: 'easeInCubic' }).finished,
        };
        
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `py-2 px-4 rounded-lg shadow-lg text-sm font-medium border ${isError ? 'bg-red-50 border-red-300 text-red-800' : 'bg-green-50 border-green-300 text-green-800'}`;
            toast.textContent = message;
            $('#toast-container').appendChild(toast);
            anime({ targets: toast, translateX: [20, 0], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
            setTimeout(async () => {
                await anime({ targets: toast, translateX: [0, 20], opacity: [1, 0], duration: 400, easing: 'easeInCubic' }).finished;
                toast.remove();
            }, 3000);
        }

        function renderModal({ title, content, confirmText, onConfirm, cancelText = '취소', onCancel = closeModal }) {
            const modalId = `modal-${Date.now()}`;
            const modalHtml = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4"><div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div><div class="modal-content relative bg-white border border-gray-200 rounded-xl shadow-xl w-full max-w-lg p-6"><h3 class="text-lg font-bold font-heading mb-4">${title}</h3><div class="text-gray-500 mb-6 text-sm">${content}</div><div class="flex justify-end space-x-3"><button type="button" class="btn" id="modal-cancel-btn">${cancelText}</button>${confirmText ? `<button type="button" class="btn btn-primary" id="modal-confirm-btn">${confirmText}</button>` : ''}</div></div></div>`;
            $('#modal-container').innerHTML = modalHtml;
            const modalEl = $(`#${modalId}`);
            if (onConfirm) $('#modal-confirm-btn').addEventListener('click', onConfirm);
            $('#modal-cancel-btn').addEventListener('click', onCancel);
            modalEl.querySelector('.modal-backdrop').addEventListener('click', onCancel);
            anime({ targets: modalEl.querySelector('.modal-backdrop'), opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
            anime({ targets: modalEl.querySelector('.modal-content'), translateY: [20, 0], scale: [0.98, 1], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
        }
        
        async function closeModal() {
            const modal = $('#modal-container').firstElementChild;
            if (!modal) return;
            await Promise.all([
                anime({ targets: modal.querySelector('.modal-backdrop'), opacity: 0, duration: 300, easing: 'easeInCubic' }).finished,
                anime({ targets: modal.querySelector('.modal-content'), translateY: 20, scale: 0.98, opacity: 0, duration: 300, easing: 'easeInCubic' }).finished
            ]);
            $('#modal-container').innerHTML = '';
        }

        // =================================================================================
        // --- AUTHENTICATION ---
        // =================================================================================
        function showAuthModal() {
            const content = `<form id="auth-form" novalidate class="space-y-4"><div><label for="email" class="block text-sm font-medium text-black mb-1">이메일</label><input type="email" id="email" class="form-input" required autocomplete="email"></div><div><label for="password" class="block text-sm font-medium text-black mb-1">비밀번호 (6자 이상)</label><input type="password" id="password" class="form-input" required autocomplete="current-password" minlength="6"></div><div id="auth-error" class="text-red-500 text-xs h-3"></div></form>`;
            renderModal({ title: '시작하기', content, confirmText: '로그인', onConfirm: () => handleAuth('login') });
            const signUpBtn = document.createElement('button');
            signUpBtn.type = 'button'; signUpBtn.className = 'btn'; signUpBtn.textContent = '회원가입';
            $('#modal-confirm-btn').insertAdjacentElement('beforebegin', signUpBtn);
            signUpBtn.addEventListener('click', () => handleAuth('signup'));
        }
        
        async function handleAuth(action) {
            const email = $('#email').value; const password = $('#password').value;
            const errorDiv = $('#auth-error'); errorDiv.textContent = '';
            const { error } = action === 'login' ? await supabase.auth.signInWithPassword({ email, password }) : await supabase.auth.signUp({ email, password });
            if (error) { errorDiv.textContent = "인증 오류: " + error.message; } 
            else { showToast(action === 'signup' ? '가입 완료! 이메일을 확인하여 인증해주세요.' : '로그인되었습니다.'); closeModal(); }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) showToast('로그아웃 중 오류가 발생했습니다.', true);
            else { showToast('로그아웃되었습니다.'); navigateTo('/'); }
        }
        
        // =================================================================================
        // --- ROUTING & VIEW MANAGEMENT ---
        // =================================================================================
        function navigateTo(path) {
            history.pushState(null, null, path);
            handleRouting();
        }

        async function switchView(viewId, callback) {
            if (state.quill) { state.quill = null; }
            const currentView = $('.app-view.active');
            if (currentView) {
                await animations.pageExit(currentView);
                currentView.classList.remove('active');
                currentView.innerHTML = '';
            }
            const nextView = $(`#${viewId}`);
            if (nextView) {
                if (callback) await callback(nextView);
                nextView.classList.add('active');
                animations.pageEnter(nextView);
                // Use a small timeout to ensure DOM is updated before running Prettify
                setTimeout(() => {
                    if (window.PR) {
                        PR.prettyPrint();
                    }
                }, 50);
            }
        }
        
        function handleRouting() {
            if (!state.isAuthReady) return;
            const path = window.location.pathname;
            // GTM page view tracking
            window.dataLayer.push({ event: 'page_view', page_path: path, page_title: document.title });

            const parts = path.substring(1).split('/');
            let route = parts[0] || 'library';
            let param = parts[1] || null;
            let page = 1;

            if (route === 'page') { page = parseInt(parts[1], 10) || 1; route = 'library'; }
            else if (route === 'dashboard' && parts[1] === 'page') { page = parseInt(parts[2], 10) || 1; route = 'dashboard'; }
            else if (route === '') { route = 'library'; }

            // Simplified routing: Protect dashboard and writer views
            if (!state.user && ['dashboard', 'writer'].includes(route)) {
                showToast('이 기능을 사용하려면 로그인이 필요합니다.', true);
                navigateTo('/');
                return;
            }

            switch (route) {
                case 'post': switchView('view-post', (el) => renderPostView(el, param)); break;
                case 'dashboard': switchView('view-dashboard', (el) => renderDashboardView(el, page)); break;
                case 'writer': switchView('view-writer', (el) => renderWriterView(el, param)); break;
                default: switchView('view-library', (el) => renderLibraryView(el, page));
            }
        }
        
        // =================================================================================
        // --- CORE RENDER FUNCTIONS ---
        // =================================================================================
        function renderNav() {
            $('#main-nav-container').innerHTML = `
                <nav class="w-full max-w-7xl flex items-center justify-between py-2 px-4 bg-white/80 backdrop-blur-lg border border-gray-200 rounded-xl shadow-sm">
                    <a href="/" class="brand-logo" data-action="route">InsureLog</a>
                    <div class="flex items-center space-x-2">
                        ${state.user 
                            ? `<a href="/dashboard" class="btn !px-2 !py-1 !text-xs" data-action="route">대시보드</a>
                               <button data-action="logout" class="btn !px-2 !py-1 !text-xs">로그아웃</button>` 
                            : `<button data-action="show-auth" class="btn btn-primary !px-2 !py-1 !text-xs">로그인 / 가입</button>`
                        }
                    </div>
                </nav>`;
        }
        
        async function renderLibraryView(container, page = 1) {
            updateMetaTags();
            
            const { from, to } = getPaginationRange(page);
            const { data: posts, error, count: totalPosts } = await supabase.from('posts').select('*', { count: 'exact' })
                .eq('status', 'published')
                .order('created_at', { ascending: false })
                .range(from, to);
            
            if (error) { 
                showToast('데이터를 불러오는 데 실패했습니다.', true); 
                container.innerHTML = `<p class="text-center text-gray-500 py-20">글을 불러올 수 없습니다.</p>`; return; 
            }
            
            const postsHtml = posts.length > 0 ? posts.map(post => `
                <a href="/post/${post.slug}" data-action="route" class="block p-4 bg-white border border-gray-200 hover:border-gray-300 rounded-lg shadow-sm hover:shadow-md transition-all duration-300 group">
                    <h2 class="text-base sm:text-lg font-bold font-heading mb-1 text-gray-800 group-hover:text-black transition-colors">${post.title}</h2>
                    <p class="text-gray-600 text-sm mb-3">${post.summary || ''}</p>
                    <div class="flex justify-between items-center text-xs text-gray-400 mt-4">
                        <span>${new Date(post.created_at).toLocaleDateString('ko-KR')}</span>
                        <span>조회수 ${(post.view_count || 0).toLocaleString()}</span>
                    </div>
                </a>`).join('') : `<p class="text-center text-gray-500 py-16">아직 작성된 글이 없습니다.</p>`;

            container.innerHTML = `<div class="py-12">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-center font-heading mb-2">Insurance Insights</h1>
                <p class="text-center text-gray-500 text-sm mb-12">AI, 기술, 그리고 보험에 대한 기록들</p>
                <div class="space-y-4">${postsHtml}</div>
                ${renderPaginationControls(page, totalPosts, '/page/')}
            </div>`;
        }
        
        async function renderPostView(container, slug) {
            if (!slug) { navigateTo('/'); return; }

            const { data: post, error } = await supabase
                .from('posts')
                .select('*')
                .eq('slug', slug)
                .single();

            if (error || !post) {
                showToast('글을 찾을 수 없습니다.', true);
                navigateTo('/');
                return;
            }

            // Increment view count
            (async () => {
                const viewedPostsKey = 'viewed_posts';
                const viewedPosts = JSON.parse(sessionStorage.getItem(viewedPostsKey)) || [];
                if (!viewedPosts.includes(post.id)) {
                    await supabase.rpc('increment_post_view', { post_slug: slug });
                    viewedPosts.push(post.id);
                    sessionStorage.setItem(viewedPostsKey, JSON.stringify(viewedPosts));
                }
            })();

            if (post.status === 'draft' && (!state.user || post.author_id !== state.user.id)) {
                showToast('초안 상태의 글은 작성자만 볼 수 있습니다.', true);
                navigateTo('/');
                return;
            }
            
            updateMetaTags(post);
            
            const editButtonHtml = (state.user && state.user.id === post.author_id) ? `<a href="/writer/${post.slug}" class="btn" data-action="route"><svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="m13.83 2.17 3 3L6.83 15.17H3.83V12.17l10-10ZM15.24 0 .92 14.31A.996.996 0 0 0 0 15v4a.996.996 0 0 0 1 1h4c.27 0 .52-.11.71-.29L19.03 4.4a2.5 2.5 0 0 0 0-3.53l-3-3a2.5 2.5 0 0 0-3.54-.29Z"/></svg><span>수정하기</span></a>` : '';
            
            container.innerHTML = `<div class="py-12">
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-8 md:p-10">
                    <article class="prose-custom max-w-none">
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-sm text-gray-500">
                                ${new Date(post.created_at).toLocaleDateString('ko-KR')} · 조회수 ${(post.view_count || 0).toLocaleString()}
                            </div>
                            ${editButtonHtml}
                        </div>
                        <h1 class="!mt-0">${post.title}</h1>
                        <div id="post-content">${post.refined_content || ''}</div>
                    </article>
                </div>
                
                <!-- AdSense Ad Unit -->
                <div class="my-12 text-center">
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-5239497835591112"
                         data-ad-slot="2069100221"
                         data-ad-format="auto"
                         data-full-width-responsive="true"></ins>
                </div>
            </div>`;
            
            lazyLoadImages();

            // IMPORTANT: This tells the AdSense script to find and fill the new ad unit
            // that was just added to the page. A small delay ensures the DOM is ready.
            setTimeout(() => {
                try {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.error("AdSense push error:", e);
                }
            }, 100);
        }

        async function renderDashboardView(container, page = 1) {
            updateMetaTags();
            const { from, to } = getPaginationRange(page);
            const { data, error, count } = await supabase.from('posts').select('*, view_count', { count: 'exact' }).eq('author_id', state.user.id).order('created_at', { ascending: false }).range(from, to);
            
            if (error) { 
                showToast('내 글 목록 로딩 실패: ' + error.message, true); 
                container.innerHTML = `<p>내가 작성한 글을 불러올 수 없습니다.</p>`; 
                return; 
            }

            const listHtml = data.length > 0 ? data.map(post => {
                const statusBadge = post.status === 'draft' ? '<span class="ml-2 text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">초안</span>' : '';
                return `<li class="p-4 flex justify-between items-center hover:bg-gray-50 rounded-lg">
                    <div>
                        <a href="/post/${post.slug}" data-action="route" class="font-semibold text-gray-800 hover:text-black">${post.title}</a>${statusBadge}
                        <p class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleString('ko-KR')} / 조회수 ${(post.view_count || 0).toLocaleString()}</p>
                    </div>
                    <div class="space-x-2">
                        <a href="/writer/${post.slug}" class="btn text-xs" data-action="route">수정</a>
                        <button class="btn text-xs" data-action="delete-post" data-id="${post.id}">삭제</button>
                    </div>
                </li>`;
            }).join('') : '<li class="p-8 text-center text-gray-500">작성된 글이 없습니다.</li>';

            container.innerHTML = `<div class="py-12">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold font-heading">내 글 관리</h1>
                        <p class="text-gray-500 mt-2">작성한 글을 수정하거나 삭제할 수 있습니다.</p>
                    </div>
                    <a href="/writer" class="btn btn-primary px-3 py-1.5 text-xs sm:px-4 sm:py-2 sm:text-sm" data-action="route">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        <span>새 글 작성</span>
                    </a>
                </div>
                <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
                    <ul class="divide-y divide-gray-200">${listHtml}</ul>
                </div>
                ${renderPaginationControls(page, count, '/dashboard/page/')}
            </div>`;
        }

        async function renderWriterView(container, slug) {
            updateMetaTags();
            let post = { id: null, title: '', summary: '', refined_content: '', slug: '', tags: [] };
            
            if (slug) {
                const { data, error } = await supabase.from('posts').select('*').eq('slug', slug).single();
                if (error || !data || data.author_id !== state.user.id) {
                    showToast(error ? '글 정보를 가져오지 못했습니다.' : '자신이 작성한 글만 수정할 수 있습니다.', true);
                    navigateTo('/dashboard');
                    return;
                }
                post = data;
            }
            container.innerHTML = `<div class="py-8">
                <div class="mb-6">
                    <button class="btn" data-action="go-back">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        대시보드로
                    </button>
                </div>
                <h1 class="text-2xl sm:text-3xl font-bold font-heading mb-6">${post.id ? '글 수정하기' : '새 글 작성하기'}</h1>
                <form id="writer-form" class="space-y-4">
                    <input type="hidden" id="post-id" value="${post.id || ''}">
                    <input type="hidden" id="post-slug" value="${post.slug || ''}">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-600 mb-2">제목</label>
                        <input type="text" id="title" class="form-input" required value="${post.title}">
                    </div>
                    <div>
                        <label for="summary" class="block text-sm font-medium text-gray-600 mb-2">요약</label>
                        <textarea id="summary" class="form-textarea" rows="3" required>${post.summary}</textarea>
                    </div>
                    <div>
                        <label for="tags" class="block text-sm font-medium text-gray-600 mb-2">태그 (쉼표로 구분)</label>
                        <input type="text" id="tags" class="form-input" value="${(post.tags || []).join(', ')}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-2">본문</label>
                        <div id="editor-container"><div id="editor"></div></div>
                    </div>
                    <div class="flex justify-end items-center space-x-3 pt-4">
                        <button type="button" id="save-draft-btn" class="btn">초안으로 저장</button>
                        <button type="button" id="publish-btn" class="btn btn-primary">발행하기</button>
                    </div>
                </form>
            </div>`;
            initQuillEditor(post.refined_content || '');
            $('#save-draft-btn').addEventListener('click', () => handlePostSave('draft'));
            $('#publish-btn').addEventListener('click', () => handlePostSave('published'));
        }
        
        // =================================================================================
        // --- HELPER & UTILITY FUNCTIONS ---
        // =================================================================================
        function getPaginationRange(page) { const from = (page - 1) * POSTS_PER_PAGE; return { from, to: from + POSTS_PER_PAGE - 1 }; }
        
        function renderPaginationControls(currentPage, totalItems, baseLink) {
            const totalPages = Math.ceil(totalItems / POSTS_PER_PAGE);
            if (totalPages <= 1) return '';
            return `<div class="flex justify-center items-center gap-3 mt-12 pagination-controls">
                <a href="${baseLink}${currentPage - 1}" data-action="route" class="btn !py-1.5 !px-3 !text-xs ${currentPage === 1 ? 'disabled' : ''}">이전</a>
                <span class="text-sm font-medium text-gray-600">${currentPage} / ${totalPages} 페이지</span>
                <a href="${baseLink}${currentPage + 1}" data-action="route" class="btn !py-1.5 !px-3 !text-xs ${currentPage === totalPages ? 'disabled' : ''}">다음</a>
            </div>`;
        }

        function quillImageHandler() {
            if (!state.user) {
                showToast('이미지를 업로드하려면 로그인이 필요합니다.', true);
                return;
            }
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();

            input.onchange = async () => {
                const file = input.files[0];
                if (!file) return;
                
                showToast('이미지 업로드 중...');
                try {
                    const webpBlob = await convertToWebP(file);
                    const imageUrl = await uploadImageFile(webpBlob);
                    
                    const range = state.quill.getSelection(true);
                    state.quill.insertEmbed(range.index, 'image', imageUrl, Quill.sources.USER);
                    state.quill.setSelection(range.index + 1, Quill.sources.SILENT);
                    showToast('이미지 업로드 완료!');
                } catch (error) {
                    showToast(`이미지 업로드 실패: ${error.message}`, true);
                }
            };
        }
        
        function initQuillEditor(initialContent) {
            const editorElement = document.querySelector('#editor');
            if (!editorElement) return;

            const toolbarOptions = [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'indent': '-1'}, { 'indent': '+1' }],
                ['link', 'image'],
                ['clean']
            ];

            state.quill = new Quill('#editor', {
                modules: {
                    toolbar: {
                        container: toolbarOptions,
                        handlers: { 'image': quillImageHandler }
                    }
                },
                placeholder: '여기에 글을 작성하세요...',
                theme: 'snow'
            });

            if (initialContent) {
                state.quill.clipboard.dangerouslyPasteHTML(0, initialContent);
            }
        }
        
        async function uploadImageFile(imageFile) {
            if (!imageFile) throw new Error("이미지 파일이 없습니다.");
            const fileName = `${state.user.id}/${Date.now()}.webp`;
            const { error } = await supabase.storage.from(IMAGE_BUCKET_NAME).upload(fileName, imageFile, { contentType: 'image/webp' });
            if (error) {
                console.error('Supabase Storage Error:', error);
                throw new Error(`이미지 업로드 실패: ${error.message}`);
            }
            const { data } = supabase.storage.from(IMAGE_BUCKET_NAME).getPublicUrl(fileName);
            return data.publicUrl;
        }

        function convertToWebP(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        let { width, height } = img;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => {
                            if (blob) resolve(blob); else reject(new Error('Canvas to Blob conversion failed.'));
                        }, 'image/webp', quality);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        
        function lazyLoadImages() {
            const images = document.querySelectorAll('#post-content img');
            const placeholderSrc = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; 

            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.onload = () => { img.style.opacity = '1'; };
                        obs.unobserve(img);
                    }
                });
            }, { rootMargin: '0px 0px 200px 0px' });

            images.forEach(image => {
                if (image.src && !image.dataset.src) {
                    image.dataset.src = image.src;
                    image.src = placeholderSrc;
                    image.style.transition = 'opacity 0.3s';
                    image.style.opacity = '0';
                }
                observer.observe(image);
            });
        }

        // =================================================================================
        // --- WORKFLOW & EVENT HANDLERS ---
        // =================================================================================
        function handleGlobalClick(e, target) { 
            const action = target.dataset.action; 
            if (action === 'route') { e.preventDefault(); navigateTo(target.getAttribute('href')); return; }
            switch (action) { 
                case 'go-back': history.back(); break; 
                case 'show-auth': showAuthModal(); break;
                case 'logout': handleLogout(); break; 
                case 'delete-post': 
                    renderModal({ title: '정말 삭제하시겠습니까?', content: '이 작업은 되돌릴 수 없습니다.', confirmText: '삭제', onConfirm: async () => { 
                        try { 
                            showToast('글 삭제를 시작합니다...'); 
                            await deletePostAndAssociatedImages(target.dataset.id); 
                            showToast('글이 삭제되었습니다.'); 
                            handleRouting(); 
                        } catch (error) { 
                            showToast(`삭제 중 오류 발생: ${error.message}`, true); 
                        } finally { 
                            closeModal(); 
                        } 
                    }}); 
                    break; 
            } 
        }

        async function handlePostSave(status) {
            const id = $('#post-id').value; 
            const title = $('#title').value.trim(); 
            const summary = $('#summary').value.trim();
            const tags = $('#tags').value.split(',').map(tag => tag.trim()).filter(Boolean);
            let refined_content = state.quill.root.innerHTML;
            if (!title || !summary) { 
                showToast('제목과 요약은 필수 항목입니다.', true); 
                return; 
            }

            const button = $(status === 'published' ? '#publish-btn' : '#save-draft-btn'); 
            const originalBtnText = button.textContent;
            button.disabled = true; 
            button.innerHTML = `<div class="loader-spinner" style="width: 1.25rem; height: 1.25rem; border-width: 2px;"></div>`;

            try {
                let finalSlug = $('#post-slug').value || title.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '');
                
                // Check if slug exists for a new post
                if (!id) {
                    const { data, error } = await supabase.from('posts').select('id').eq('slug', finalSlug).single();
                    if (data) {
                        finalSlug = `${finalSlug}-${Date.now().toString().slice(-4)}`;
                    }
                }

                const postData = { title, summary, refined_content, author_id: state.user.id, slug: finalSlug, tags, status };
                
                let result;
                if (id) {
                    result = await supabase.from('posts').update(postData).eq('id', id).select().single();
                } else {
                    result = await supabase.from('posts').insert(postData).select().single();
                }

                if (result.error) throw result.error;
                
                showToast(status === 'published' ? '글이 발행되었습니다!' : '초안이 저장되었습니다.');
                navigateTo(status === 'published' ? `/post/${result.data.slug}` : '/dashboard');

            } catch (error) { 
                showToast(`저장 실패: ${error.message}`, true);
            } finally { 
                button.disabled = false; 
                button.textContent = originalBtnText; 
            }
        }
        
        async function deletePostAndAssociatedImages(postId) { 
            const { data: post } = await supabase.from('posts').select('refined_content').eq('id', postId).single(); 
            if (post && post.refined_content) {
                const content = post.refined_content;
                const imageUrls = content.match(/https:\/\/[^"]+\/storage\/v1\/object\/public\/thought-images\/[^"]+/g) || []; 
                const imagePaths = imageUrls.map(url => url.split('/thought-images/')[1] || '').filter(Boolean); 
                if (imagePaths.length > 0) { 
                    await supabase.storage.from(IMAGE_BUCKET_NAME).remove(imagePaths); 
                } 
            }
            await supabase.from('posts').delete().eq('id', postId); 
        }

        // =================================================================================
        // --- INITIALIZATION ---
        // =================================================================================
        function initializeApp() {
            window.addEventListener('popstate', handleRouting);
            document.addEventListener('click', (e) => { 
                const target = e.target.closest('[data-action]'); 
                if (target) handleGlobalClick(e, target); 
            });
            
            supabase.auth.onAuthStateChange(async (_event, session) => {
                const userJustChanged = state.user?.id !== session?.user?.id;
                state.user = session?.user || null;
                if (userJustChanged) { renderNav(); }
                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    renderNav();
                    const loader = $('#app-loader');
                    anime({ targets: loader, opacity: 0, duration: 500, easing: 'easeOutCubic', complete: () => loader.style.display = 'none' });
                    handleRouting();
                } else if (userJustChanged) {
                    handleRouting();
                }
            });
        }
        
        initializeApp();
    </script>
</body>
</html>

