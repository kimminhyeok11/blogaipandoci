var _=Object.defineProperty;var E=(S,t,e)=>t in S?_(S,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[t]=e;var A=(S,t,e)=>E(S,typeof t!="symbol"?t+"":t,e);try{typeof window!="undefined"&&(window.Config=window.Config||(typeof Config!="undefined"?Config:{}));const S=window.Config}catch(S){}class BlogApp{constructor(){A(this,"state",{user:null,isAuthReady:!1,currentCategory:"\uC804\uCCB4",editorInstance:null,archives:{category:"\uC804\uCCB4",tag:"",page:1,pageSize:20,sort:"latest",total:0}});A(this,"supabase",null);A(this,"_inFlight",new Map);A(this,"_reqTokens",{home:0,archives:0,popular:0});this.handleGlobalClick=this.handleGlobalClick.bind(this),this.handlePopState=this.handlePopState.bind(this),this.init()}async withDedupe(t,e){if(this._inFlight.has(t))return this._inFlight.get(t);const s=(async()=>{try{return await e()}finally{this._inFlight.delete(t)}})();return this._inFlight.set(t,s),s}async init(){var t,e,s;try{if(await this.ensureSupabaseReady(1200),this.bindGlobalListeners(),this.supabase&&this.supabase.auth){const{data:{session:a}}=await this.supabase.auth.getSession();this.state.user=(a==null?void 0:a.user)||null;try{const r=new URL(window.location.href),n=r.searchParams,l=window.location.hash||"",d=n.get("token_hash"),u=(n.get("type")||"").toLowerCase(),c=this._normalizeOtpType(u),h=n.get("code"),g=/access_token=|refresh_token=|type=recovery/.test(l);if(d&&c){this.setLoading(!0);try{const{data:o,error:p}=await this.supabase.auth.verifyOtp({token_hash:d,type:c});if(!p&&((t=o==null?void 0:o.session)!=null&&t.user)){this.state.user=o.session.user,n.delete("token_hash"),n.delete("type");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}else p&&(console.warn("verifyOtp \uC624\uB958:",p),UIComponents.showToast("\uB85C\uADF8\uC778 \uD1A0\uD070 \uD655\uC778\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4. \uB9C1\uD06C\uB97C \uB2E4\uC2DC \uC694\uCCAD\uD574\uC8FC\uC138\uC694.","error"))}catch(o){console.warn("verifyOtp \uC2E4\uD328:",o)}}else if(d&&!c){this.setLoading(!0);try{const{data:o,error:p}=await this.supabase.auth.verifyOtp({token_hash:d,type:"magiclink"});if(!p&&((e=o==null?void 0:o.session)!=null&&e.user)){this.state.user=o.session.user,n.delete("token_hash");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}else p&&(console.warn("verifyOtp(magiclink, fallback) \uC624\uB958:",p),UIComponents.showToast("\uB85C\uADF8\uC778 \uB9C1\uD06C \uD655\uC778 \uC2E4\uD328. \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.","error"))}catch(o){console.warn("verifyOtp(magiclink, fallback) \uC2E4\uD328:",o)}}else if(h){this.setLoading(!0);try{const{data:o,error:p}=await this.supabase.auth.exchangeCodeForSession({code:h});if(!p&&((s=o==null?void 0:o.session)!=null&&s.user)){this.state.user=o.session.user,n.delete("code");const m=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,m),UIComponents.showToast(this.state.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}}catch(o){console.warn("exchangeCodeForSession \uC2E4\uD328:",o)}}else if(g){this.setLoading(!0);const{data:{session:o}}=await this.supabase.auth.getSession();if(o!=null&&o.user){this.state.user=o.user;const p=r.pathname+(n.toString()?"?"+n.toString():"");window.history.replaceState({},document.title,p),UIComponents.showToast(o.user.email+"\uB2D8, \uB85C\uADF8\uC778\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),this.renderNav(),this.navigate("/")}}}catch(r){}}else this.state.user=null;this.state.isAuthReady=!0,this.renderNav(),this.handleRouting(),window.addEventListener("popstate",this.handlePopState);const i=DOM.$("#app-loader");i&&DOM.hide(i,{complete:()=>i.remove()}),this.supabase&&this.supabase.auth&&typeof this.supabase.auth.onAuthStateChange=="function"&&this.supabase.auth.onAuthStateChange((a,r)=>{var d;const n=(r==null?void 0:r.user)||null,l=((d=this.state.user)==null?void 0:d.id)!==(n==null?void 0:n.id);this.state.user=n,l&&(this.renderNav(),n?UIComponents.showToast(n.email+"\uB2D8, \uD658\uC601\uD569\uB2C8\uB2E4!","success"):(UIComponents.showToast("\uB85C\uADF8\uC544\uC6C3\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","info"),this.navigate("/")))});try{this.supabase&&await this.logSiteVisit()}catch(a){console.warn("\uBC29\uBB38 \uB85C\uADF8 \uAE30\uB85D \uC2E4\uD328:",a)}}catch(i){console.error("App initialization failed:",i),UIComponents.showToast("\uC571 \uCD08\uAE30\uD654 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.","error");const a=DOM.$("#app-loader");a&&(a.innerHTML='<div class="text-red-600">\uC571 \uB85C\uB4DC\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.</div>')}}_normalizeOtpType(t=""){switch(String(t||"").toLowerCase()){case"login":case"signin":case"email":return"magiclink";case"register":return"signup";case"recover":return"recovery";case"magiclink":case"signup":case"recovery":case"invite":return t;default:return t||"magiclink"}}async ensureSupabaseReady(t=800){var e,s,i,a;try{if(this.supabase)return!0;const r=Date.now();if(window.supabase&&((e=window.Config)!=null&&e.SUPABASE_URL)&&((s=window.Config)!=null&&s.SUPABASE_ANON_KEY))return this.supabase=window.supabase.createClient(window.Config.SUPABASE_URL,window.Config.SUPABASE_ANON_KEY,{auth:{storageKey:"sb-insurelog-auth-token"}}),!0;for(;Date.now()-r<t;)if(await new Promise(n=>setTimeout(n,50)),window.supabase&&((i=window.Config)!=null&&i.SUPABASE_URL)&&((a=window.Config)!=null&&a.SUPABASE_ANON_KEY))return this.supabase=window.supabase.createClient(window.Config.SUPABASE_URL,window.Config.SUPABASE_ANON_KEY,{auth:{storageKey:"sb-insurelog-auth-token"}}),!0;return!!this.supabase}catch(r){return console.warn("ensureSupabaseReady \uC2E4\uD328:",r),!1}}bindGlobalListeners(){document.addEventListener("click",this.handleGlobalClick),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const e=document.querySelector('[id*="modal"]:not(.hidden)');e&&e.id&&DOM.closeModal(e.id)}})}handleGlobalClick(t){const e=t.target.closest("[data-route]");if(e){t.preventDefault();const s=e.getAttribute("href")||e.getAttribute("data-href");s&&s!=="#"&&this.navigate(s)}if(t.target.classList&&t.target.classList.contains("modal-overlay")){const s=t.target.closest('[id*="modal"]');s&&s.id&&DOM.closeModal(s.id)}}handlePopState(){this.handleRouting()}navigate(t){const e=this.normalizePath(t);window.location.pathname+window.location.search!==e&&window.history.pushState(null,"",e),this.handleRouting(),this.renderNav()}handleRouting(){const t=this.normalizePath(window.location.pathname),e=new URLSearchParams(window.location.search);let s;t==="/"||t==="/home"?s="view-library":t.startsWith("/post/")?s="view-post":t==="/archives"?s="view-archives":t==="/writer"||t.startsWith("/writer/")?s="view-writer":s="view-library";const i=DOM.$(".app-view.active");if(i&&i.id!==s&&(i.classList.remove("active"),DOM.hide(i)),t==="/"||t==="/home")this.renderHome(e);else if(t.startsWith("/post/")){const a=t.split("/post/")[1],r=a?decodeURIComponent(a):"";this.renderPost(r)}else if(t==="/archives")this.renderArchives();else if(t==="/writer"||t.startsWith("/writer/")){const a=t.split("/writer/")[1]||null,r=a?decodeURIComponent(a):null;this.renderWriter(r)}else t==="/login"?this.renderLogin():this.render404()}normalizePath(t){try{const e=new URL(t,window.location.origin);let s=e.pathname||"/";return s==="/index.html"&&(s="/"),s.length>1&&s.endsWith("/")&&(s=s.slice(0,-1)),s=s.replace(/\/+/,"/"),s+(e.search||"")}catch(e){return t==="/index.html"?"/":t.length>1&&t.endsWith("/")?t.slice(0,-1):t||"/"}}renderArchives(){this.switchToView("view-archives");const t=DOM.$("#view-archives");if(!t)return;try{const u=new URLSearchParams(window.location.search),c=u.get("category"),h=u.get("tag"),g=Number(u.get("page")||this.state.archives.page)||1,o=Number(u.get("pageSize")||this.state.archives.pageSize)||20,p=u.get("sort")||this.state.archives.sort||"latest";this.state.archives.category=c||this.state.archives.category||"\uC804\uCCB4",this.state.archives.tag=h||this.state.archives.tag||"",this.state.archives.page=g,this.state.archives.pageSize=o,this.state.archives.sort=["latest","oldest","title"].includes(p)?p:"latest"}catch(u){}const{category:e,tag:s,pageSize:i,sort:a}=this.state.archives;t.innerHTML=`<section class="max-w-4xl mx-auto py-10 px-6"><div class="flex items-center justify-between"><h1 class="text-2xl font-bold">\uC544\uCE74\uC774\uBE0C</h1><div class="text-xs text-gray-500">\uD398\uC774\uC9C0\uB2F9 ${i}\uAC1C</div></div><div class="mt-4 grid grid-cols-1 sm:grid-cols-4 gap-3"><div><label class="block text-xs text-gray-600">\uCE74\uD14C\uACE0\uB9AC</label><select id="archives-filter-category" class="mt-1 w-full border rounded-lg p-2"><option value="\uC804\uCCB4">\uC804\uCCB4</option></select></div><div><label class="block text-xs text-gray-600">\uD0DC\uADF8</label><input id="archives-filter-tag" type="text" class="mt-1 w-full border rounded-lg p-2" placeholder="\uC608: \uBCF4\uD5D8"></div><div><label class="block text-xs text-gray-600">\uC815\uB82C</label><select id="archives-filter-sort" class="mt-1 w-full border rounded-lg p-2"><option value="latest">\uCD5C\uC2E0\uC21C</option><option value="oldest">\uC624\uB798\uB41C\uC21C</option><option value="title">\uC81C\uBAA9\uC21C</option></select></div><div><label class="block text-xs text-gray-600">\uAC1C\uC218</label><select id="archives-filter-pageSize" class="mt-1 w-full border rounded-lg p-2"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select></div><div class="sm:col-span-4 flex items-center justify-end"><button id="archives-filter-apply" class="px-3 py-2 rounded-lg bg-black text-white">\uD544\uD130 \uC801\uC6A9</button></div></div><div id="archives-list" class="mt-6 space-y-6"></div><div id="archives-pagination" class="mt-8 flex items-center justify-center gap-2"></div></section>`,this.updatePageMeta("\uC544\uCE74\uC774\uBE0C - InsureLog","\uC6D4\uBCC4 \uC544\uCE74\uC774\uBE0C\uC640 \uCE74\uD14C\uACE0\uB9AC/\uD0DC\uADF8 \uD544\uD130",window.location.href,"/og-image.svg");const r=DOM.$("#archives-filter-tag");r&&(r.value=s||"");const n=DOM.$("#archives-filter-sort");n&&(n.value=a||"latest");const l=DOM.$("#archives-filter-pageSize");l&&(l.value=String(i||20));const d=DOM.$("#archives-filter-apply");d&&(d.onclick=()=>{const u=DOM.$("#archives-filter-category"),c=DOM.$("#archives-filter-tag"),h=DOM.$("#archives-filter-sort"),g=DOM.$("#archives-filter-pageSize");this.state.archives.category=u?u.value:"\uC804\uCCB4",this.state.archives.tag=c?c.value.trim():"",this.state.archives.sort=h?h.value:"latest",this.state.archives.pageSize=g&&Number(g.value)||20,this.state.archives.page=1;const o=new URLSearchParams({category:this.state.archives.category||"\uC804\uCCB4",tag:this.state.archives.tag||"",sort:this.state.archives.sort||"latest",pageSize:String(this.state.archives.pageSize||20),page:"1"});this.navigate(`/archives?${o.toString()}`)}),this.loadArchives().catch(u=>this.handleError(u,"loadArchives"))}async loadArchives(){const{category:t,tag:e,page:s,pageSize:i,sort:a}=this.state.archives,r=DOM.$("#archives-list");if(!r||!this.supabase)return;const n=window.Config&&window.Config.DB_TABLE_NAME||"posts";let l=this.supabase.from(n).select("id",{count:"exact",head:!0}).eq("status","published");t&&t!=="\uC804\uCCB4"&&(l=l.eq("category",t)),e&&(l=l.contains("tags",[String(e).toLowerCase()]));const{count:d}=await l;this.state.archives.total=d||0;let c=this.supabase.from(n).select("id, title, slug, created_at, category, thumbnail_url").eq("status","published");e&&(c=c.contains("tags",[String(e).toLowerCase()])),a==="latest"?c=c.order("created_at",{ascending:!1}):a==="oldest"?c=c.order("created_at",{ascending:!0}):a==="title"?c=c.order("title",{ascending:!0}):c=c.order("created_at",{ascending:!1}),t&&t!=="\uC804\uCCB4"&&(c=c.eq("category",t));const h=(s-1)*i,g=h+i-1;c=c.range(h,g);const o=Date.now();this._reqTokens.archives=o;const p=`archives:${t}:${e}:${h}-${g}`,{data:m,error:b}=await this.withDedupe(p,()=>c);if(b)throw b;const w=new Set(["\uC804\uCCB4"]);(m||[]).forEach(v=>{v.category&&w.add(v.category)});const $=DOM.$("#archives-filter-category");$&&$.options.length<=1&&($.innerHTML=Array.from(w).map(v=>`<option value="${this.escapeHTML(v)}">${this.escapeHTML(v)}</option>`).join(""),$.value=t||"\uC804\uCCB4");const f=m||[];if(this._reqTokens.archives===o){if(!f||f.length===0)r.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';else{const v=this.renderPostsListHTML(f);r.innerHTML=`<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${v}</div>`}this.renderArchivesPagination();try{const v=(s-1)*i+1,y=Math.min(this.state.archives.total,s*i),x=document.querySelector("#view-archives section .text-xs.text-gray-500");x&&(x.textContent=`\uCD1D ${this.state.archives.total}\uAC1C \xB7 ${v}\u2013${y} \uD45C\uC2DC\uC911`)}catch(v){}}}renderArchivesPagination(){const{page:t,pageSize:e,total:s}=this.state.archives,i=Math.max(1,Math.ceil(s/e)),a=DOM.$("#archives-pagination");if(!a)return;if(i<=1){a.innerHTML="";return}const r=(g,o=null,p=!1)=>`<button data-page="${g}" class="px-3 py-1 rounded border ${p?"bg-black text-white":"hover:bg-black/5"}">${o||g}</button>`,n=t>1?r(t-1,"\uC774\uC804"):'<span class="px-3 py-1 text-gray-400">\uC774\uC804</span>',l=t<i?r(t+1,"\uB2E4\uC74C"):'<span class="px-3 py-1 text-gray-400">\uB2E4\uC74C</span>',d=5,u=Math.max(1,t-Math.floor(d/2)),c=Math.min(i,u+d-1),h=[];for(let g=u;g<=c;g++)h.push(r(g,null,g===t));a.innerHTML=n+h.join("")+l,a.querySelectorAll("button[data-page]").forEach(g=>{g.onclick=()=>{const o=Number(g.getAttribute("data-page"))||1;this.state.archives.page=o;const p=new URLSearchParams({category:this.state.archives.category||"\uC804\uCCB4",tag:this.state.archives.tag||"",sort:this.state.archives.sort||"latest",pageSize:String(this.state.archives.pageSize||20),page:String(o)});this.navigate(`/archives?${p.toString()}`)}})}switchToView(t){const e=DOM.$("#"+t);DOM.$$(".app-view").forEach(s=>{s!==e&&(s.classList.remove("active"),DOM.hide(s))}),e&&(e.style.display="block",e.classList.add("active"),DOM.show(e),window.scrollTo({top:0,behavior:"smooth"}),window.LayoutManager&&typeof window.LayoutManager.onViewRendered=="function"&&window.LayoutManager.onViewRendered(e))}renderNav(){const t=DOM.$("#main-nav-container");if(!t)return;const e=!!this.state.user,s=t.querySelector("#nav-links");if(s&&this._navLogged===e){const c=window.location.pathname;s.querySelectorAll("a[data-route]").forEach(h=>{h.getAttribute("href")===c?h.setAttribute("aria-current","page"):h.removeAttribute("aria-current")});return}const n=['<a href="/" data-route class="nav-link">\uD648</a>','<a href="/archives" data-route class="nav-link">\uC544\uCE74\uC774\uBE0C</a>',e?'<a href="/writer" data-route class="nav-link">\uAE00\uC4F0\uAE30</a>':"",e?'<a href="/dashboard" data-route class="nav-link">\uB300\uC2DC\uBCF4\uB4DC</a>':"",'<a href="/feed.xml" class="nav-link" rel="alternate" type="application/rss+xml">RSS</a>','<a href="/sitemap.xml" class="nav-link">Sitemap</a>',e?'<a id="logout-btn" href="#" class="nav-link">\uB85C\uADF8\uC544\uC6C3</a>':'<a id="login-link" href="/login" data-route class="nav-link">\uB85C\uADF8\uC778</a>'].filter(Boolean).join("");t.innerHTML='<nav class="w-full nav-inner" aria-label="\uC8FC\uC694"><a href="/" data-route class="brand font-extrabold text-xl tracking-tight">InsureLog</a><div id="nav-links" class="header-nav mobile-nav-actions">'+n+"</div></nav>",this._navLogged=e;const l=this.normalizePath(window.location.pathname);t.querySelectorAll("#nav-links a[data-route]").forEach(c=>{const h=c.getAttribute("href")||"/",g=(()=>{try{return this.normalizePath(new URL(h,window.location.origin).pathname)}catch(p){return this.normalizePath(h)}})(),o=g===l||g==="/"&&l==="/home";c.classList.toggle("font-semibold",o),c.setAttribute("aria-current",o?"page":"false")});const u=DOM.$("#logout-btn");u&&(u.onclick=async c=>{var h;try{(h=c==null?void 0:c.preventDefault)==null||h.call(c)}catch(g){}try{this.supabase&&this.supabase.auth&&await this.supabase.auth.signOut(),UIComponents.showToast("\uB85C\uADF8\uC544\uC6C3\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","info"),this.navigate("/")}catch(g){this.navigate("/")}})}renderHome(t=new URLSearchParams){this.switchToView("view-library");const e=DOM.$("#view-library");e&&(e.innerHTML='<section><div class="section-header"><h2 class="section-title">\uCD5C\uADFC \uAE00</h2></div><div id="home-posts" class="grid grid-cols-1 gap-2"></div><div id="home-pagination" class="flex justify-center"></div></section>',this.updatePageMeta("InsureLog - \uCD5C\uADFC \uAE00","\uCD5C\uC2E0 \uAC8C\uC2DC\uAE00 \uBAA9\uB85D",window.location.href,"/og-image.svg"),this.loadHomePosts(t).catch(s=>this.handleError(s,"loadHomePosts")))}renderPost(t){this.switchToView("view-post");const e=DOM.$("#view-post");e&&(e.innerHTML='<article><div class="mb-6"><div class="h-8 w-2/3 bg-gray-200 animate-pulse rounded"></div></div><div class="space-y-3"><div class="h-5 bg-gray-200 animate-pulse rounded"></div><div class="h-5 bg-gray-200 animate-pulse rounded"></div></div></article>',this.loadPostDetail(t).catch(s=>this.handleError(s,"loadPostDetail")))}renderWriter(t){if(!this.checkAuth(!0))return;this.switchToView("view-writer");const e=DOM.$("#view-writer");if(!e)return;const s=!!t;e.innerHTML=`<section class="nav-inner py-10"><div class="flex items-center justify-between"><h1 class="text-2xl font-bold">${s?"\uAE00 \uC218\uC815":"\uAE00 \uC791\uC131"}</h1><button type="button" id="btn-open-post-picker" class="btn btn-outline btn-sm">\uAE30\uC874 \uAE00 \uBD88\uB7EC\uC624\uAE30</button></div><form id="writer-form" class="mt-6 space-y-5 editor-shell"><div id="writer-errors" class="sr-only" role="alert" aria-live="assertive"></div><div><label class="block text-sm font-medium">\uC81C\uBAA9</label><input id="post-title" type="text" class="form-input" placeholder="\uC81C\uBAA9\uC744 \uC785\uB825\uD558\uC138\uC694" required aria-errormessage="writer-errors" aria-invalid="false"></div><div><label class="block text-sm font-medium">\uC694\uC57D</label><textarea id="post-summary" class="form-textarea" placeholder="\uC694\uC57D\uC744 \uC785\uB825\uD558\uC138\uC694"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">\uCE74\uD14C\uACE0\uB9AC</label><input id="post-category" type="text" class="form-input" placeholder="\uC608: \uAE30\uC220"></div><div><label class="block text-sm font-medium">\uC0C1\uD0DC</label><select id="post-status" class="form-select"><option value="draft">\uCD08\uC548</option><option value="published">\uBC1C\uD589</option></select></div></div><div><label class="block text-sm font-medium">\uD0DC\uADF8</label><input id="post-tags" type="text" class="form-input" placeholder="\uD0DC\uADF8\uB97C \uC27C\uD45C\uB85C \uAD6C\uBD84\uD574 \uC785\uB825 (\uC608: \uBCF4\uD5D8,\uC790\uB3D9\uCC28,\uAC00\uC774\uB4DC)"></div><div id="tag-suggestions" class="flex flex-wrap gap-2 mt-2" aria-label="\uCD94\uCC9C \uD0DC\uADF8" aria-live="polite"></div><div><label class="block text-sm font-medium">\uC378\uB124\uC77C \uC774\uBBF8\uC9C0</label><input id="post-thumb" type="file" accept="image/*" class="form-input"/></div><div><label class="block text-sm font-medium">\uCF58\uD150\uCE20 (\uBCF5\uC0AC/\uBD99\uC5EC\uB123\uAE30 \uC9C0\uC6D0)</label><div id="editor-toolbar" class="editor-toolbar btn-group mt-2"><button type="button" data-cmd="bold" class="btn btn-outline btn-sm">\uAD75\uAC8C</button><button type="button" data-cmd="italic" class="btn btn-outline btn-sm">\uAE30\uC6B8\uC784</button><button type="button" data-cmd="underline" class="btn btn-outline btn-sm">\uBC11\uC904</button><button type="button" data-cmd="h2" class="btn btn-outline btn-sm">H2</button><button type="button" data-cmd="p" class="btn btn-outline btn-sm">\uBCF8\uBB38</button><button type="button" data-cmd="ul" class="btn btn-outline btn-sm">\uBAA9\uB85D</button><button type="button" data-cmd="ol" class="btn btn-outline btn-sm">\uBC88\uD638\uBAA9\uB85D</button><button type="button" data-cmd="quote" class="btn btn-outline btn-sm">\uC778\uC6A9</button><button type="button" data-cmd="code" class="btn btn-outline btn-sm">\uCF54\uB4DC</button><button type="button" data-cmd="link" class="btn btn-outline btn-sm">\uB9C1\uD06C</button><button type="button" data-cmd="clear" class="btn btn-outline btn-sm">\uC11C\uC2DD\uD574\uC81C</button></div><div id="post-content-editor" contenteditable="true" class="editor-surface prose-custom" placeholder="\uB2E4\uB978 \uAE00\uC744 \uBCF5\uC0AC\uD574 \uBD99\uC5EC\uB123\uC73C\uBA74 \uD615\uC2DD\uC774 \uC720\uC9C0\uB429\uB2C8\uB2E4."></div><p class="text-xs text-gray-500 mt-1">\uBD99\uC5EC\uB123\uAE30 \uC2DC \uAE30\uBCF8 \uC11C\uC2DD(\uAD75\uAC8C, \uC81C\uBAA9, \uBAA9\uB85D \uB4F1)\uC774 \uC720\uC9C0\uB429\uB2C8\uB2E4. \uC800\uC7A5 \uC2DC \uC548\uC804\uD558\uAC8C \uC815\uC81C\uB41C HTML\uB85C \uC800\uC7A5\uD569\uB2C8\uB2E4.</p></div><div class="flex items-center gap-2"><button type="submit" class="btn btn-primary">\uC800\uC7A5</button><a href="/" data-route class="btn btn-secondary">\uCDE8\uC18C</a></div></form></section>`,this.updatePageMeta(s?"\uAE00 \uC218\uC815 - InsureLog":"\uAE00 \uC791\uC131 - InsureLog",s?"\uAE30\uC874 \uAE00\uC744 \uC218\uC815\uD569\uB2C8\uB2E4.":"\uC0C8 \uAE00\uC744 \uC791\uC131\uD569\uB2C8\uB2E4.",window.location.href,"/og-image.svg"),this.renderPostPickerUI(),s&&this.loadWriterData(t).catch(a=>this.handleError(a,"loadWriterData")),this.loadTagSuggestions().catch(a=>this.handleError(a,"loadTagSuggestions"));const i=DOM.$("#writer-form");i&&i.addEventListener("submit",async a=>{a.preventDefault(),await this.submitWriterForm(s?t:null)},{once:!0}),this.setupContentEditor(s?t:null)}renderPostPickerUI(){const t=DOM.$("#view-writer");if(!t)return;if(!DOM.$("#post-picker-modal")){const n=document.createElement("div");n.id="post-picker-modal",n.className="hidden",n.innerHTML=`
                <div class="modal-overlay">
                    <div class="modal-content modal-content-lg">
                        <div class="modal-header">
                            <h2 class="modal-title">\uAE30\uC874 \uAE00 \uC120\uD0DD</h2>
                            <button class="modal-close" id="post-picker-close" aria-label="\uB2EB\uAE30">\u2715</button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" id="post-picker-query" class="w-full border rounded-lg p-2" placeholder="\uC81C\uBAA9\uC73C\uB85C \uAC80\uC0C9..."/>
                            </div>
                            <div id="post-picker-list" class="space-y-2"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn px-4 py-2 rounded-lg border" id="post-picker-cancel">\uB2EB\uAE30</button>
                        </div>
                    </div>
                </div>`,t.appendChild(n)}const e=DOM.$("#btn-open-post-picker"),s=DOM.$("#post-picker-close"),i=DOM.$("#post-picker-cancel"),a=DOM.$("#post-picker-query");e&&(e.onclick=()=>{DOM.openModal("post-picker-modal"),this.loadPostsForPicker("")});const r=()=>DOM.closeModal("post-picker-modal");s&&(s.onclick=r),i&&(i.onclick=r),a&&(a.oninput=()=>{clearTimeout(this._postPickerTimer),this._postPickerTimer=setTimeout(()=>{this.loadPostsForPicker(a.value.trim())},200)})}async loadPostsForPicker(t=""){try{if(!this.supabase)return;const e=window.Config&&window.Config.DB_TABLE_NAME||"posts";let s=this.supabase.from(e).select("id, title, slug, status, created_at").order("created_at",{ascending:!1}).limit(50);t&&(s=this.supabase.from(e).select("id, title, slug, status, created_at").ilike("title",`%${t}%`).order("created_at",{ascending:!1}).limit(50));const{data:i,error:a}=await s;if(a)throw a;const r=DOM.$("#post-picker-list");if(!r)return;if(!i||i.length===0){r.innerHTML='<div class="text-sm text-gray-600">\uAC80\uC0C9 \uACB0\uACFC\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';return}r.innerHTML=i.map(n=>{const l="/writer/"+n.slug,d=this.formatDateKR(n.created_at),c=`<span class="badge">${this.statusToKor(n.status)}</span>`;return`
                    <div class="post-picker-item">
                        <div class="post-picker-main">
                            <a href="${l}" data-route class="post-picker-title">${this.escapeHTML(n.title||"\uC81C\uBAA9 \uC5C6\uC74C")}</a>
                            <div class="post-picker-meta">\uC791\uC131\uC77C ${d} \xB7 \uC0C1\uD0DC ${c}</div>
                        </div>
                        <div class="post-picker-actions">
                            <a href="${l}" data-route class="btn-xs">\uD3B8\uC9D1</a>
                        </div>
                    </div>`}).join("")}catch(e){this.handleError(e,"loadPostsForPicker")}}statusToKor(t){switch(String(t||"").toLowerCase()){case"published":return"\uACF5\uAC1C";case"private":return"\uBE44\uACF5\uAC1C";case"draft":default:return"\uC784\uC2DC"}}renderLogin(){this.switchToView("view-library");const t=DOM.$("#view-library");if(t){const e=window.Config&&window.Config.SITE_URL||window.location.origin;t.innerHTML=`
                <section class="max-w-md mx-auto py-10 px-6">
                  <h1 class="text-2xl font-extrabold">\uB85C\uADF8\uC778</h1>
                  <p class="text-sm text-gray-600 mt-2">\uC774\uBA54\uC77C\uB85C \uB9E4\uC9C1\uB9C1\uD06C\uB97C \uBC1B\uC544 \uBE60\uB974\uAC8C \uB85C\uADF8\uC778\uD558\uC138\uC694.</p>
                  <form id="magic-form" class="mt-6 space-y-3" novalidate>
                    <div id="login-errors" class="sr-only" role="alert" aria-live="assertive"></div>
                    <label class="form-label" for="magic-email">\uC774\uBA54\uC77C \uC8FC\uC18C</label>
                    <div class="input-group" aria-live="polite">
                      <span class="input-group-addon" aria-hidden="true" title="\uC774\uBA54\uC77C">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path d="M4 6h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2zm0 2l8 5 8-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </span>
                      <input id="magic-email" type="email" class="form-input" placeholder="you@example.com" required autocomplete="email" inputmode="email" aria-describedby="magic-help" aria-errormessage="magic-error">
                    </div>
                    <div id="magic-error" class="form-error" style="display:none;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 9v4m0 4h.01M10.29 3.86l-8.23 14.25A2 2 0 0 0 4 21h16a2 2 0 0 0 1.94-2.89L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      <span>\uC62C\uBC14\uB978 \uC774\uBA54\uC77C \uD615\uC2DD\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694.</span>
                    </div>
                    <button id="magic-send" type="submit" class="btn btn-primary btn-lg w-full">\uB85C\uADF8\uC778 \uB9C1\uD06C \uBCF4\uB0B4\uAE30</button>
                    <p id="magic-help" class="form-help">\uBA54\uC77C\uC758 \uB9C1\uD06C\uB97C \uB204\uB974\uBA74 \uC790\uB3D9 \uB85C\uADF8\uC778\uB429\uB2C8\uB2E4. 1\uBD84 \uB0B4 \uB3C4\uCC29\uD558\uC9C0 \uC54A\uC73C\uBA74 \uC2A4\uD338\uD568\uB3C4 \uD655\uC778\uD574\uC8FC\uC138\uC694.</p>
                  </form>
                  <div id="magic-success" class="mt-4 p-3 border border-green-200 bg-green-50 text-green-700 rounded" style="display:none;">
                    \uC774\uBA54\uC77C\uB85C \uB85C\uADF8\uC778 \uB9C1\uD06C\uB97C \uBCF4\uB0C8\uC2B5\uB2C8\uB2E4. \uBA54\uC77C\uD568\uC744 \uD655\uC778\uD574\uC8FC\uC138\uC694.
                  </div>
                  <div class="mt-8 text-center">
                    <a href="/" data-route class="px-4 py-2 rounded-full bg-black text-white">\uD648\uC73C\uB85C</a>
                  </div>
                </section>`,this.updatePageMeta("\uB85C\uADF8\uC778 - InsureLog","\uACC4\uC815 \uB85C\uADF8\uC778 \uD398\uC774\uC9C0",window.location.href,"/og-image.svg");const s=DOM.$("#magic-form");if(s){const i=DOM.$("#magic-email"),a=DOM.$("#magic-error"),r=DOM.$("#magic-success"),n=DOM.$("#magic-send"),l=u=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(u||"").trim()),d=u=>{if(!a)return;a.style.display=u?"flex":"none",i&&(i.classList.toggle("error",!!u),i.setAttribute("aria-invalid",u?"true":"false"));const c=DOM.$("#login-errors");c&&(c.textContent=u?"\uC62C\uBC14\uB978 \uC774\uBA54\uC77C \uD615\uC2DD\uC744 \uC785\uB825\uD574\uC8FC\uC138\uC694.":"")};i==null||i.addEventListener("input",()=>d(!1)),s.addEventListener("submit",async u=>{var h;u.preventDefault();const c=String((i==null?void 0:i.value)||"").trim();if(!l(c)){d(!0),i==null||i.focus();return}if(!((h=this.supabase)!=null&&h.auth))return UIComponents.showToast("\uC778\uC99D \uBAA8\uB4C8\uC744 \uCD08\uAE30\uD654\uD558\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.","error");try{n==null||n.setAttribute("disabled","true"),n&&(n.textContent="\uBCF4\uB0B4\uB294 \uC911\u2026",n.setAttribute("aria-busy","true"));const{error:g}=await this.supabase.auth.signInWithOtp({email:c,options:{shouldCreateUser:!0,emailRedirectTo:e}});if(g)throw g;UIComponents.showToast("\uB85C\uADF8\uC778 \uB9C1\uD06C\uB97C \uC774\uBA54\uC77C\uB85C \uBCF4\uB0C8\uC2B5\uB2C8\uB2E4.","success"),r&&(r.style.display="block")}catch(g){this._logAuthEvent("login_magic_failed",{email:c}),UIComponents.showToast("\uBA54\uC77C \uBC1C\uC1A1\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.","error");const o=DOM.$("#login-errors");o&&(o.textContent="\uBA54\uC77C \uBC1C\uC1A1\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4. \uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574\uC8FC\uC138\uC694.")}finally{setTimeout(()=>{n==null||n.removeAttribute("disabled"),n&&(n.textContent="\uB85C\uADF8\uC778 \uB9C1\uD06C \uBCF4\uB0B4\uAE30",n.removeAttribute("aria-busy"))},1200)}})}}}render404(){this.switchToView("view-library");const t=DOM.$("#view-library");t&&(t.innerHTML='<section class="max-w-md mx-auto py-20 px-6 text-center"><h1 class="text-2xl font-extrabold">\uD398\uC774\uC9C0\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</h1><p class="text-sm text-gray-600 mt-2">\uC694\uCCAD\uD558\uC2E0 \uD398\uC774\uC9C0\uAC00 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.</p><div class="mt-6"><a href="/" data-route class="px-4 py-2 rounded-full bg-black text-white">\uD648\uC73C\uB85C</a></div></section>',this.updatePageMeta("\uD398\uC774\uC9C0\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4 - InsureLog","\uC694\uCCAD\uD55C \uD398\uC774\uC9C0\uAC00 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.",window.location.href,"/og-image.svg"))}handleError(t,e=""){var i,a,r;console.error("Error in "+e+":",t);let s="\uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.";(i=t.message)!=null&&i.includes("fetch")?s="\uB124\uD2B8\uC6CC\uD06C \uC5F0\uACB0\uC744 \uD655\uC778\uD574\uC8FC\uC138\uC694.":(a=t.message)!=null&&a.includes("auth")?s="\uB85C\uADF8\uC778\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.":(r=t.message)!=null&&r.includes("permission")&&(s="\uAD8C\uD55C\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),UIComponents.showToast(s,"error")}async _logAuthEvent(t,e={}){try{const s={type:t,email_hint:(e.email||"").replace(/(^.).+(@.+$)/,"$1***$2"),provider:e.provider||null,user_agent:navigator&&navigator.userAgent||null,at:new Date().toISOString(),success:!1};this.supabase&&await this.supabase.from("auth_events").insert(s)}catch(s){}}setLoading(t,e="#app-container"){t?DOM.showLoading(e):DOM.hideLoading(e)}checkAuth(t=!0){return this.state.user?!0:(t&&(UIComponents.showToast("\uB85C\uADF8\uC778\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.","warning"),this.navigate("/login")),!1)}updatePageMeta(t,e,s,i=null){document.title=t;const a=DOM.$('meta[name="description"]');a&&(a.content=e||"");const r=s||window.location.href;let n=i||"/og-image.svg";try{n=new URL(n,window.location.origin).href}catch(m){}const l=DOM.$('link[rel="canonical"]');l&&(l.href=r);const d=DOM.$('meta[property="og:title"]'),u=DOM.$('meta[property="og:description"]'),c=DOM.$('meta[property="og:url"]'),h=DOM.$('meta[property="og:image"]');d&&(d.content=t),u&&(u.content=e||""),c&&(c.content=r),h&&(h.content=n);const g=DOM.$('meta[name="twitter:title"]'),o=DOM.$('meta[name="twitter:description"]'),p=DOM.$('meta[name="twitter:image"]');g&&(g.content=t),o&&(o.content=e||""),p&&(p.content=n)}async loadWriterData(t){var r,n;if(!this.supabase)return;const e=window.Config&&window.Config.DB_TABLE_NAME||"posts";let{data:s,error:i}=await this.supabase.from(e).select("*").eq("slug",t).maybeSingle();if(i)throw i;if(!s){const l=await this.supabase.from(e).select("*").eq("id",t).maybeSingle();if(l.error)throw l.error;s=l.data||null}if(!s)return;DOM.$("#post-title").value=s.title||"",DOM.$("#post-summary").value=s.summary||"",DOM.$("#post-category").value=s.category||"",DOM.$("#post-status").value=s.status||"draft";const a=DOM.$("#post-content-editor");if(a){const l=this.renderContentHTML((n=(r=s.refined_content)!=null?r:s.content)!=null?n:"");a.innerHTML=l;const d=Array.isArray(s.tags)&&s.tags.length?s.tags:this.extractTagsFromHTML(s.refined_content),u=DOM.$("#post-tags");u&&d.length&&(u.value=d.join(","))}}async loadTagSuggestions(){try{const t=DOM.$("#tag-suggestions");if(!t)return;t.innerHTML='<span class="text-xs text-gray-500">\uD0DC\uADF8 \uBD88\uB7EC\uC624\uB294 \uC911...</span>';const e=await fetch("/api/tags");if(!e.ok)throw new Error("\uD0DC\uADF8 \uBAA9\uB85D \uC694\uCCAD \uC2E4\uD328");const s=await e.json(),i=Array.isArray(s.tags)?s.tags.slice(0,20):[];if(!i.length){t.innerHTML='<span class="text-xs text-gray-500">\uCD94\uCC9C \uD0DC\uADF8\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</span>';return}const a=(r,n)=>{const l=document.createElement("button");return l.type="button",l.className="px-2 py-1 text-xs rounded-full border border-gray-300 hover:border-black hover:bg-gray-50",l.textContent=`${r}`,l.setAttribute("aria-label",`${r} \uD0DC\uADF8 \uCD94\uAC00 (\uBE48\uB3C4 ${n})`),l.addEventListener("click",()=>{try{const d=DOM.$("#post-tags"),u=(d.value||"").split(",").map(h=>h.trim()).filter(Boolean).map(h=>h.toLowerCase()),c=String(r||"").toLowerCase();u.includes(c)||u.push(c),d.value=u.join(", "),d.dispatchEvent(new Event("input"))}catch(d){}}),l};t.innerHTML="",i.forEach(r=>{t.appendChild(a(r.name,r.count))})}catch(t){const e=DOM.$("#tag-suggestions");e&&(e.innerHTML='<span class="text-xs text-gray-500">\uD0DC\uADF8\uB97C \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</span>')}}async submitWriterForm(t=null){var e,s,i;try{if(!this.supabase)throw new Error("Supabase\uAC00 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4");const a=DOM.$("#writer-form"),r=a==null?void 0:a.querySelector('button[type="submit"]'),n=DOM.$("#writer-errors"),l=DOM.$("#post-title"),d=((e=l==null?void 0:l.value)==null?void 0:e.trim())||"",u=[];if(d?d.length<2&&u.push("\uC81C\uBAA9\uC740 \uCD5C\uC18C 2\uC790 \uC774\uC0C1\uC774\uC5B4\uC57C \uD569\uB2C8\uB2E4."):u.push("\uC81C\uBAA9\uC744 \uC785\uB825\uD558\uC138\uC694."),u.length){n&&(n.textContent=u.join(" "),n.classList.remove("sr-only")),l&&(l.setAttribute("aria-invalid","true"),l.setAttribute("aria-errormessage","writer-errors"),l.focus());return}else n&&(n.textContent="",n.classList.add("sr-only")),l&&l.setAttribute("aria-invalid","false");a&&a.setAttribute("aria-busy","true"),r&&(r.disabled=!0,r.setAttribute("aria-disabled","true"),r.dataset._origText=r.textContent||"",r.textContent="\uC800\uC7A5 \uC911\u2026"),this.setLoading(!0,"#view-writer"),await ScriptLoader.loadUtilities();const c=d,h=DOM.$("#post-summary").value.trim(),g=DOM.$("#post-category").value.trim(),o=DOM.$("#post-status").value,p=DOM.$("#post-thumb");let m=[];const b=DOM.$("#post-tags"),w=((b==null?void 0:b.value)||"").trim();w&&(m=w.split(",").map(T=>T.trim()).filter(Boolean).map(T=>T.toLowerCase()));const $=DOM.$("#post-content-editor");let f="";if($){const T=$.innerHTML||"";f=window.DOMPurify?window.DOMPurify.sanitize(T):T,f=f.replace(/<h1([^>]*)>/gi,"<h2$1>").replace(/<\/h1>/gi,"</h2>"),f=this.ensureImageAltAttributes(f,c);const C=DOM.$("#post-summary");if(C&&!C.value.trim()){const D=$.innerText||"";C.value=D.replace(/\s+/g," ").trim().slice(0,160)}}else{const T=((s=DOM.$("#post-content"))==null?void 0:s.value)||"";try{const C=JSON.parse(T);f=JSON.stringify(C)}catch(C){f=T}}let v=t||this.slugify(c);v=await this.ensureUniqueSlug(v,t);let y=null;if(p&&p.files&&p.files[0]){const T=p.files[0],C=`thumbnails/${v}.webp`;y=await this.uploadImageToBucket(T,C)}const x=window.Config&&window.Config.DB_TABLE_NAME||"posts",M=new Date().toISOString(),k={title:c,summary:h,category:g,status:o,refined_content:f,slug:v,updated_at:M,author_id:((i=this.state.user)==null?void 0:i.id)||null,tags:m};y&&(k.thumbnail_url=y);let L;if(t?L=await this.supabase.from(x).update(k).eq("slug",t).select("id").maybeSingle():(k.created_at=M,k.view_count=0,L=await this.supabase.from(x).insert(k).select("id").maybeSingle()),L.error)throw L.error;UIComponents.showToast("\uAE00\uC774 \uC800\uC7A5\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"),o==="published"?this.navigate("/post/"+encodeURIComponent(v)):this.navigate("/")}catch(a){const r=DOM.$("#writer-errors");r&&(r.textContent=`\uC800\uC7A5 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4: ${a.message||a}`,r.classList.remove("sr-only")),this.handleError(a,"submitWriterForm")}finally{const a=DOM.$("#writer-form"),r=a==null?void 0:a.querySelector('button[type="submit"]');a&&a.setAttribute("aria-busy","false"),r&&(r.disabled=!1,r.removeAttribute("aria-disabled"),r.dataset._origText&&(r.textContent=r.dataset._origText)),this.setLoading(!1,"#view-writer")}}slugify(t){let s=String(t||"").toLowerCase().trim().normalize("NFKD").replace(/\s+/g,"-").replace(/[^\p{L}\p{N}\-]+/gu,"").replace(/-+/g,"-").replace(/^-+|-+$/g,"");return s||(s="post-"+Date.now().toString(36)),s}async ensureUniqueSlug(t,e=null){if(!this.supabase||e&&t===e)return t;const s=window.Config&&window.Config.DB_TABLE_NAME||"posts",{data:i,error:a}=await this.supabase.from(s).select("slug").eq("slug",t).limit(1);if(a||!i||i.length===0)return t;const r=Math.random().toString(36).slice(2,6);return`${t}-${r}`}async loadPostDetail(t){const e=DOM.$("#view-post");if(await this.ensureSupabaseReady(1200),!this.supabase){e.innerHTML='<div class="max-w-3xl mx-auto py-10 px-6 text-gray-600">\uB370\uC774\uD130 \uC18C\uC2A4\uAC00 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.</div>';return}const s=window.Config&&window.Config.DB_TABLE_NAME||"posts";let{data:i,error:a}=await this.supabase.from(s).select("*").eq("slug",t).eq("status","published").maybeSingle();if(a)throw a;if(!i)try{const o=[],p=String(t||"");o.push(p),o.push(p.toLowerCase()),o.push(p.replace(/_/g,"-")),o.push(this.slugify(p));const m=Array.from(new Set(o.filter(b=>b&&typeof b=="string")));if(m.length){const{data:b,error:w}=await this.supabase.from(s).select("*").in("slug",m).eq("status","published").limit(1);i=b&&b[0]||null}}catch(o){}if(!i){e.innerHTML='<section class="max-w-md mx-auto py-20 px-6 text-center"><h1 class="text-2xl font-extrabold">\uAE00\uC744 \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</h1><p class="text-sm text-gray-600 mt-2">\uC694\uCCAD\uD558\uC2E0 \uAE00\uC774 \uC874\uC7AC\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.</p><div class="mt-6"><a href="/" data-route class="px-4 py-2 rounded-full bg-black text-white">\uD648\uC73C\uB85C</a></div></section>';return}try{await this.supabase.from(s).update({view_count:(i.view_count||0)+1}).eq("id",i.id)}catch(o){console.warn("view_count update \uC2E4\uD328:",o)}const r=this.escapeHTML(i.title||"\uC81C\uBAA9 \uC5C6\uC74C"),n=this.formatDate(i.created_at),l=i.category?`<span class="text-xs px-2 py-1 rounded-full bg-black/5">${this.escapeHTML(i.category)}</span>`:"",d=Array.isArray(i.tags)&&i.tags.length?i.tags:this.extractTagsFromHTML(i.refined_content),u=d&&d.length?`<div class="mt-2 flex flex-wrap gap-2">${d.map(o=>`<span class="text-xs px-2 py-1 rounded-full bg-blue-50 border border-blue-200">${this.escapeHTML(o)}</span>`).join("")}</div>`:"";await ScriptLoader.loadUtilities();const c=this.renderContentHTML(i.refined_content),h=this.state.user?`<a href="/writer/${encodeURIComponent(i.slug)}" data-route class="px-3 py-1 rounded-full border">\uC218\uC815</a>`:"";e.innerHTML=`<article class="post-detail py-10"><div class="post-detail-inner"><h1 class="post-title text-3xl font-extrabold tracking-tight">${r}</h1><div class="post-meta flex items-center"><span class="post-date">${n}</span>${l?l.replace("<span",'<span class="post-category"'):""}</div>${u?u.replace("<div",'<div class="post-tags"'):""}<div class="blog-post-content prose-custom">${c}</div></div><div class="post-detail-inner"><div class="mt-8 flex items-center gap-3"><button id="btn-like" class="px-3 py-1 rounded-full border">\uC88B\uC544\uC694 <span id="like-count"></span></button><button id="btn-share" class="px-3 py-1 rounded-full border">\uACF5\uC720</button><button id="btn-copy" class="px-3 py-1 rounded-full border">\uB9C1\uD06C\uBCF5\uC0AC</button>${h}</div><div id="related-posts" class="mt-12"></div><div id="popular-posts" class="mt-12"></div></div></article>`;const g=i.thumbnail_url?this.getTransformedPublicUrl(i.thumbnail_url,{width:1200,height:630,resize:"cover",quality:85,format:"webp"}):"/og-image.svg";this.updatePageMeta(i.title,i.summary||"",window.location.href,g);try{const o="likes:"+(i.slug||i.id),p=DOM.$("#like-count"),m=DOM.$("#btn-like"),b=DOM.$("#btn-share"),w=DOM.$("#btn-copy");let $=Number(localStorage.getItem(o)||"0");p&&(p.textContent=String($)),m&&m.addEventListener("click",()=>{$+=1,localStorage.setItem(o,String($)),p&&(p.textContent=String($))}),b&&b.addEventListener("click",async()=>{try{navigator.share?await navigator.share({title:i.title,text:i.summary||"",url:window.location.href}):(await navigator.clipboard.writeText(window.location.href),UIComponents.showToast("\uB9C1\uD06C\uAC00 \uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success"))}catch(f){}}),w&&w.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(window.location.href),UIComponents.showToast("\uB9C1\uD06C\uAC00 \uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4.","success")}catch(f){}})}catch(o){}this.loadRelatedPosts(i).catch(o=>this.handleError(o,"loadRelatedPosts")),this.loadPopularPosts(i.id).catch(o=>this.handleError(o,"loadPopularPosts"))}renderContentHTML(t){if(!t)return'<p class="text-gray-600">\uCF58\uD150\uCE20\uAC00 \uC544\uC9C1 \uC900\uBE44\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.</p>';try{const i=typeof t=="string"?JSON.parse(t):t;if(i&&Array.isArray(i.blocks)){this._contentFirstImageEagerDone=!1;const a=i.blocks.map(r=>this.renderEditorBlock(r)).join("");return this.dedupeConsecutiveImages(a)}if(i&&i.ops&&Array.isArray(i.ops)){const a=i.ops.map(d=>{const u=typeof d.insert=="string"?this.escapeHTML(d.insert):"",c=d.attributes||{};let h=u;return c.bold&&(h=`<strong>${h}</strong>`),c.italic&&(h=`<em>${h}</em>`),c.underline&&(h=`<u>${h}</u>`),h}).join(""),r=window.DOMPurify?window.DOMPurify.sanitize(a):a,n=this.transformPlainImagesToOptimized(r),l=this.ensureImageAltAttributes(n,"");return this.dedupeConsecutiveImages(l)}}catch(i){}const e=typeof t=="string";if(e&&(/!\[[^\]]*\]\([^)]+\)/.test(t)||/\[[^\]]+\]\([^)]+\)/.test(t)||/(^|\n)\s{0,3}#{1,6}\s/.test(t)||/(^|\n)\s{0,3}[-*]\s+/.test(t)||/(^|\n)\s{0,3}\d+\.\s+/.test(t))&&window.marked){const i=e?t:String(t),a=this.preprocessPlainTextToMarkdown(i),r=window.marked.parse(a),n=window.DOMPurify?window.DOMPurify.sanitize(r):r,l=this.transformPlainImagesToOptimized(n),d=this.ensureImageAltAttributes(l,"");return this.dedupeConsecutiveImages(d)}if(e&&/<\w+[^>]*>/i.test(t)){const i=t,a=window.DOMPurify?window.DOMPurify.sanitize(i):i,r=this.transformPlainImagesToOptimized(a),n=this.ensureImageAltAttributes(r,"");return this.dedupeConsecutiveImages(n)}if(window.marked){const i=e?t:String(t),a=this.preprocessPlainTextToMarkdown(i),r=window.marked.parse(a),n=window.DOMPurify?window.DOMPurify.sanitize(r):r,l=this.transformPlainImagesToOptimized(n),d=this.ensureImageAltAttributes(l,"");return this.dedupeConsecutiveImages(d)}return`<pre>${this.escapeHTML(typeof t=="string"?t:JSON.stringify(t))}</pre>`}renderEditorBlock(t){var i;const e=t.type,s=t.data||{};switch(e){case"paragraph":return`<p>${this.escapeHTML(s.text||"")}</p>`;case"header":return`<h${s.level||2}>${this.escapeHTML(s.text||"")}</h${s.level||2}>`;case"list":const a=(s.items||[]).map(r=>`<li>${this.escapeHTML(r)}</li>`).join("");return s.style==="ordered"?`<ol>${a}</ol>`:`<ul>${a}</ul>`;case"quote":return`<blockquote>${this.escapeHTML(s.text||"")}</blockquote>`;case"image":if((i=s.file)!=null&&i.url){const r=this.escapeHTML(s.caption||""),n=navigator&&navigator.connection?navigator.connection:{},l=!!n.saveData,d=n.effectiveType||"",u=l||/(^|[^a-z])(2g|3g)/.test(d),c=u?[360,600]:[480,768,1200],h=u?900:1200,g=u?75:85,o=u?60:80,p=u?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px",m=this.getOptimizedPublicUrl(s.file.url,{width:h,quality:g,format:"webp"}),b=c.map(x=>`${this.getOptimizedPublicUrl(s.file.url,{width:x,quality:o,format:"webp"})} ${x}w`).join(", "),w=s.width&&s.height?` width="${s.width}" height="${s.height}"`:"",$=!s.width||!s.height?' class="aspect-16-9"':"",f=!this._contentFirstImageEagerDone;if(f){this._contentFirstImageEagerDone=!0;try{if(!document.querySelector(`link[rel="preload"][as="image"][href="${m}"]`)){const M=document.createElement("link");M.rel="preload",M.as="image",M.href=m,b&&M.setAttribute("imagesrcset",b),M.setAttribute("imagesizes",p),M.crossOrigin="anonymous",document.head.appendChild(M)}try{const M=new URL(m,window.location.origin).origin;if(!document.querySelector(`link[rel="preconnect"][href="${M}"]`)){const L=document.createElement("link");L.rel="preconnect",L.href=M,L.crossOrigin="anonymous",document.head.appendChild(L)}}catch(M){}}catch(x){}}return`<figure><img src="${m}" srcset="${b}" sizes="${p}" alt="${r}"${f?"":' loading="lazy"'}${f?' fetchpriority="high"':' fetchpriority="low"'} decoding="async"${w}${$}/><figcaption>${r}</figcaption></figure>`}return"";case"code":return`<pre><code>${this.escapeHTML(s.code||"")}</code></pre>`;default:return""}}setupContentEditor(t=null){const e=DOM.$("#post-content-editor"),s=DOM.$("#editor-toolbar");if(!e)return;e.setAttribute("role","textbox"),e.setAttribute("aria-label","\uCF58\uD150\uCE20 \uD3B8\uC9D1\uAE30"),this._lastSelectionRange=null,e.addEventListener("focus",()=>document.execCommand("defaultParagraphSeparator",!1,"p"));const i=()=>{if(!s)return;const a=(r,n)=>{const l=s.querySelector(`button[data-cmd="${r}"]`);l&&l.classList.toggle("bg-black text-white",!!n)};try{a("bold",document.queryCommandState("bold")),a("italic",document.queryCommandState("italic")),a("underline",document.queryCommandState("underline"));const r=document.queryCommandValue("formatBlock");a("h1",/H1/i.test(r)),a("h2",/H2/i.test(r)),a("p",/P/i.test(r))}catch(r){}};if(document.addEventListener("selectionchange",()=>{if(document.activeElement===e){const a=window.getSelection();a&&a.rangeCount&&(this._lastSelectionRange=a.getRangeAt(0)),i()}}),s){const a=r=>{r.target.closest("[data-cmd]")&&r.preventDefault()};s.addEventListener("pointerdown",a,{passive:!1}),s.addEventListener("mousedown",a,{passive:!1}),s.addEventListener("touchstart",a,{passive:!1}),s.addEventListener("click",r=>{const n=r.target.closest("[data-cmd]");if(!n)return;const l=n.getAttribute("data-cmd");e.focus();const d=window.getSelection();if(d&&this._lastSelectionRange)try{d.removeAllRanges(),d.addRange(this._lastSelectionRange)}catch(u){}this.execEditorCommand(l),i()})}e.addEventListener("keydown",a=>{(a.ctrlKey||a.metaKey)&&(a.key.toLowerCase()==="b"&&(a.preventDefault(),this.execEditorCommand("bold"),i()),a.key.toLowerCase()==="i"&&(a.preventDefault(),this.execEditorCommand("italic"),i()),a.key.toLowerCase()==="u"&&(a.preventDefault(),this.execEditorCommand("underline"),i()),a.shiftKey&&a.key==="1"&&(a.preventDefault(),this.execEditorCommand("h2"),i()),a.shiftKey&&a.key==="2"&&(a.preventDefault(),this.execEditorCommand("h2"),i()))}),e.addEventListener("dragover",a=>{a.preventDefault()}),e.addEventListener("drop",async a=>{var n;a.preventDefault();const r=(n=a.dataTransfer)==null?void 0:n.files;r&&r.length&&await this.handleEditorFiles(r,t)}),e.addEventListener("paste",async a=>{var l;const r=((l=a.clipboardData)==null?void 0:l.items)||[],n=[];for(const d of r)if(d.kind==="file"){const u=d.getAsFile();u&&u.type.startsWith("image/")&&n.push(u)}n.length?(a.preventDefault(),await this.handleEditorFiles(n,t)):setTimeout(()=>{this.linkifyElementContent(e)},0)}),e.addEventListener("click",a=>{const r=a.target.closest("figcaption");r&&(r.setAttribute("contenteditable","true"),r.focus())}),e.addEventListener("input",a=>{const r=a.target.closest("figcaption");if(r){const n=r.closest("figure"),l=n?n.querySelector("img"):null;if(l){const d=r.textContent.trim();l.setAttribute("alt",d||l.getAttribute("alt")||"")}}clearTimeout(this._linkifyTimer),this._linkifyTimer=setTimeout(()=>{this.linkifyElementContent(e)},200)}),e.addEventListener("blur",a=>{a.target&&a.target.matches("figcaption")&&a.target.removeAttribute("contenteditable")},!0)}execEditorCommand(t){switch(t){case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"h1":document.execCommand("formatBlock",!1,"h2");break;case"h2":document.execCommand("formatBlock",!1,"h2");break;case"p":document.execCommand("formatBlock",!1,"p");break;case"ul":document.execCommand("insertUnorderedList");break;case"ol":document.execCommand("insertOrderedList");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":this.insertHTMLAtCursor("<pre><code></code></pre>");break;case"link":{const e=prompt("\uB9C1\uD06C URL\uC744 \uC785\uB825\uD558\uC138\uC694");e&&document.execCommand("createLink",!1,e);break}case"clear":document.execCommand("removeFormat");break;default:break}}insertHTMLAtCursor(t){document.execCommand("insertHTML",!1,t)}linkifyElementContent(t){try{if(!t)return;const e=/(?:https?:\/\/[^\s<]+|www\.[^\s<]+)$/g,s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),i=[];let a;for(;a=s.nextNode();){const r=a.parentElement;if(!r||r.closest("a"))continue;const n=a.nodeValue||"";/(https?:\/\/|www\.)/.test(n)&&i.push(a)}i.forEach(r=>{const n=r.nodeValue||"",l=[],d=[];let u=0;if(n.replace(/(?:https?:\/\/[^\s<]+|www\.[^\s<]+)/g,(h,g)=>(l.push(n.slice(u,g)),d.push(h),u=g+h.length,h)),l.push(n.slice(u)),d.length===0)return;const c=document.createDocumentFragment();for(let h=0;h<l.length;h++){const g=l[h];g&&c.appendChild(document.createTextNode(g));const o=d[h];if(o){const p=o.startsWith("www.")?"https://"+o:o,m=document.createElement("a");m.href=p,m.textContent=o,m.rel="noopener noreferrer",m.target="_blank",c.appendChild(m)}}r.parentNode.replaceChild(c,r)})}catch(e){console.warn("linkifyElementContent error",e)}}async handleEditorFiles(t,e){try{for(let s=0;s<t.length;s++){const i=t.item?t.item(s):t[s];if(!i||!i.type.startsWith("image/"))continue;const a=`img_${Date.now()}_${s}.webp`,r=`content-images/${a}`,{savedPath:n,width:l,height:d}=await this.uploadImageToBucket(i,r),u=navigator&&navigator.connection?navigator.connection:{},c=!!u.saveData,h=u.effectiveType||"",g=c||/(^|[^a-z])(2g|3g)/.test(h),o=g?900:1200,p=g?75:85,m=g?60:80,b=this.getTransformedPublicUrl(n,{width:o,quality:p,format:"webp"}),w=this.deriveAltFromFileName(i.name||a),f=(g?[360,600]:[480,768,1200]).map(x=>`${this.getTransformedPublicUrl(n,{width:x,quality:m,format:"webp"})} ${x}w`).join(", "),v=g?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px",y=l&&d?` width="${l}" height="${d}"`:"";this.insertHTMLAtCursor(`<figure><img src="${b}" srcset="${f}" sizes="${v}" alt="${this.escapeHTML(w)}" loading="lazy" decoding="async"${y}/><figcaption>${this.escapeHTML(w)}</figcaption></figure>`)}}catch(s){this.handleError(s,"handleEditorFiles")}}extractTagsFromHTML(t){try{const e=typeof t=="string"?t:String(t||""),s=document.createElement("div");s.innerHTML=e;const i=s.querySelector("[data-tags]");return((i==null?void 0:i.getAttribute("data-tags"))||"").split(",").map(r=>r.trim()).filter(Boolean)}catch(e){return[]}}async loadRelatedPosts(t){if(!this.supabase)return;const e=window.Config&&window.Config.DB_TABLE_NAME||"posts",{data:s,error:i}=await this.supabase.from(e).select("id, title, summary, slug, category, thumbnail_url, created_at").eq("status","published").neq("id",t.id).eq("category",t.category).order("created_at",{ascending:!1}).limit(3);if(i)throw i;const a=DOM.$("#related-posts");if(!a)return;if(!s||s.length===0){a.innerHTML="";return}const r=s.map(n=>{const l="/post/"+encodeURIComponent(n.slug||n.id),d=!!n.thumbnail_url,u=d?(()=>{const o=[96,120,144,160],p="(max-width: 640px) 96px, 120px",m=this.getTransformedPublicUrl(n.thumbnail_url,{width:120,height:120,resize:"cover",quality:80,format:"webp"}),b=o.map(w=>`${this.getTransformedPublicUrl(n.thumbnail_url,{width:w,height:w,resize:"cover",quality:80,format:"webp"})} ${w}w`).join(", ");return`<img src="${m}" srcset="${b}" sizes="${p}" alt="${this.escapeHTML(n.title||"")}" class="post-card-thumb-img" width="120" height="120" decoding="async" loading="lazy"/>`})():`<span class="thumb-initial">${this.escapeHTML(String(n.title||"N").trim().charAt(0).toUpperCase())}</span>`;return`<article class="post-card post-card-compact"><a href="${l}" data-route class="post-card-thumb${d?"":" placeholder"}">${u}</a><div class="post-card-main"><h3 class="post-card-title"><a href="${l}" data-route>${this.escapeHTML(n.title)}</a></h3><p class="post-card-meta">${this.formatDate(n.created_at)}</p></div></article>`}).join("");a.innerHTML=`<h2 class="text-lg font-bold mb-3">\uAD00\uB828 \uAE00</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${r}</div>`}async loadPopularPosts(t=null){const e=DOM.$("#popular-posts");if(!e||!this.supabase)return;const s=window.Config&&window.Config.DB_TABLE_NAME||"posts",i=Date.now();this._reqTokens.popular=i;const a=`popular:${t||""}`,{data:r,error:n}=await this.withDedupe(a,()=>this.supabase.from(s).select("id, title, slug, thumbnail_url, created_at, view_count").eq("status","published").order("view_count",{ascending:!1,nullsFirst:!1}).limit(5));if(n)throw n;let l=(r||[]).filter(c=>c&&c.id!==t);if(!l||l.length===0){e.innerHTML="";return}if(this._reqTokens.popular!==i)return;const d='<h2 class="text-lg font-bold mb-3">\uB9CE\uC774 \uBCF8 \uAE00</h2>',u=l.map((c,h)=>{const g="/post/"+encodeURIComponent(c.slug||c.id),o=Number(c.view_count||0),p=this.formatDateKR(c.created_at);return`<li class="popular-item"><span class="popular-rank">${h+1}</span><a class="popular-link" href="${g}" data-route>${this.escapeHTML(c.title||"")}</a><span class="popular-date">${p}</span><span class="popular-views">${o.toLocaleString("ko-KR")}</span></li>`}).join("");e.innerHTML=d+`<ul class="popular-list">${u}</ul>`}deriveAltFromFileName(t=""){try{let e=String(t||"").replace(/\.[a-z0-9]+$/i,"");return e=decodeURIComponent(e),e=e.replace(/[_\-]+/g," ").replace(/\s+/g," ").trim(),e||"\uC774\uBBF8\uC9C0"}catch(e){return"\uC774\uBBF8\uC9C0"}}ensureImageAltAttributes(t,e=""){try{const s=document.createElement("div");return s.innerHTML=String(t||""),s.querySelectorAll("img").forEach(a=>{if((a.getAttribute("alt")||"").trim())return;let n="";const l=a.closest("figure"),d=l?l.querySelector("figcaption"):null;if(n=((d==null?void 0:d.textContent)||"").trim(),n||(n=String(e||"").trim()),!n){const u=a.getAttribute("src")||"";try{const h=(new URL(u,window.location.origin).pathname.split("/").pop()||"").split("?")[0];n=this.deriveAltFromFileName(h)}catch(c){const h=(u.split("/").pop()||"").split("?")[0];n=this.deriveAltFromFileName(h)}}a.setAttribute("alt",n||"\uC774\uBBF8\uC9C0"),d&&!d.textContent.trim()&&(d.textContent=n||"\uC774\uBBF8\uC9C0")}),s.innerHTML}catch(s){return t}}preprocessPlainTextToMarkdown(t=""){try{let e=String(t||"");return e=e.replace(/^\s*h([1-6])\s+(.+)$/gmi,(s,i,a)=>`${"#".repeat(Number(i))} ${a}`),e=e.replace(/(^|\s)(https?:\/\/[^\s]+\.(?:png|jpe?g|webp|gif|svg))(?!\S)/gmi,(s,i,a)=>`${i}![](${a})`),e}catch(e){return String(t||"")}}transformPlainImagesToOptimized(t,e=""){try{const s=document.createElement("div");s.innerHTML=String(t||"");const i=navigator&&navigator.connection?navigator.connection:{},a=!!i.saveData,r=i.effectiveType||"",n=a||/(^|[^a-z])(2g|3g)/.test(r),l=n?[360,600]:[480,768,1200],d=n?900:1200,u=n?75:85,c=n?60:80,h=n?"(max-width: 600px) 100vw, 600px":"(max-width: 768px) 100vw, 768px";return Array.from(s.querySelectorAll("img")).forEach((o,p)=>{if(o.hasAttribute("srcset"))return;const m=o.getAttribute("src")||"";if(!m)return;const w=(o.getAttribute("alt")||"").trim()||(()=>{try{const T=(new URL(m,window.location.origin).pathname.split("/").pop()||"").split("?")[0];return this.deriveAltFromFileName(T)}catch(L){const T=(m.split("/").pop()||"").split("?")[0];return this.deriveAltFromFileName(T)}})()||e||"\uC774\uBBF8\uC9C0",$=this.getOptimizedPublicUrl(m,{width:d,quality:u,format:"webp"}),f=l.map(L=>`${this.getOptimizedPublicUrl(m,{width:L,quality:c,format:"webp"})} ${L}w`).join(", "),v=document.createElement("figure"),y=o.cloneNode(!0);y.setAttribute("src",$),y.setAttribute("srcset",f),y.setAttribute("sizes",h),y.setAttribute("alt",w),p===0?(y.removeAttribute("loading"),y.setAttribute("fetchpriority","high")):(y.setAttribute("loading","lazy"),y.setAttribute("fetchpriority","low")),y.setAttribute("decoding","async"),v.appendChild(y);const M=document.createElement("figcaption");M.textContent=w,v.appendChild(M);const k=o.parentElement;k&&k.tagName.toLowerCase()==="p"?k.replaceWith(v):o.replaceWith(v)}),s.innerHTML}catch(s){return t}}dedupeConsecutiveImages(t){try{const e=document.createElement("div");e.innerHTML=String(t||"");const s=a=>`${a.getAttribute("src")||""}|${a.getAttribute("srcset")||""}`,i=Array.from(e.querySelectorAll("figure, img")).filter(a=>!(a.tagName.toLowerCase()==="img"&&a.closest("figure")));for(let a=0;a<i.length;a++){const r=i[a],n=r.tagName.toLowerCase()==="img"?r:r.querySelector("img");if(!n)continue;const l=r.previousElementSibling;if(!l)continue;const d=l.tagName.toLowerCase()==="img"?l:l.querySelector&&l.querySelector("img");if(!d)continue;s(n)===s(d)&&r.remove()}return e.innerHTML}catch(e){return t}}getOptimizedPublicUrl(t,e={}){try{const s=new URL(t,window.location.origin);if(!/supabase\.co\/.+\/object\/public\//.test(s.href))return t;const a=new URLSearchParams;e.width&&a.set("width",String(e.width)),e.height&&a.set("height",String(e.height)),e.resize&&a.set("resize",String(e.resize)),e.format&&a.set("format",String(e.format)),e.quality&&a.set("quality",String(e.quality));const r=a.toString();return r?s.search&&s.search.length>1?`${s.href}&${r}`:`${s.href}?${r}`:s.href}catch(s){return t}}getTransformedPublicUrl(t,e={}){var s;try{if(!t)return"";if(/^https?:\/\//i.test(t))return this.getOptimizedPublicUrl(t,e);const i=window.Config&&window.Config.IMAGE_BUCKET_NAME||"thought-images",a=this.supabase.storage.from(i).getPublicUrl(t,{transform:{width:e.width,height:e.height,resize:e.resize,format:e.format,quality:e.quality}});return((s=a==null?void 0:a.data)==null?void 0:s.publicUrl)||""}catch(i){return""}}async loadHomePosts(t=new URLSearchParams){const e=DOM.$("#home-posts");if(!e)return;const s=Number(t.get("page")||"1");e.innerHTML='<div class="animate-pulse space-y-3"><div class="h-6 bg-gray-200 rounded"></div><div class="h-24 bg-gray-200 rounded"></div><div class="h-24 bg-gray-200 rounded"></div></div>';const i=t.get("scenario");if(i==="empty"){e.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';return}if(i==="error"){e.innerHTML='<div class="text-red-600"><p class="font-semibold">\uAC8C\uC2DC\uAE00\uC744 \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</p><p class="text-sm text-red-500">\uC9C4\uB2E8 \uC2DC\uB098\uB9AC\uC624\uC5D0 \uC758\uD574 \uC624\uB958\uAC00 \uAC15\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.</p></div>';return}if(await this.ensureSupabaseReady(1200),!this.supabase)return;const a=window.Config&&window.Config.POSTS_PER_PAGE||10,r=(s-1)*a,n=r+a-1,l=window.Config&&window.Config.DB_TABLE_NAME||"posts",d=Date.now();this._reqTokens.home=d;const u=`home:${r}-${n}`;try{const{data:c,count:h,error:g}=await this.withDedupe(u,()=>this.supabase.from(l).select("id, title, summary, slug, category, thumbnail_url, created_at",{count:"exact"}).eq("status","published").order("created_at",{ascending:!1}).range(r,n));if(g)throw g;if(!c||c.length===0){e.innerHTML='<div class="text-gray-500">\uD45C\uC2DC\uD560 \uAC8C\uC2DC\uAE00\uC774 \uC5C6\uC2B5\uB2C8\uB2E4.</div>';const o=DOM.$("#home-pagination");o&&(o.innerHTML="");return}try{const o=DOM.$("#home-pagination");if(o){const p=Math.max(1,Math.ceil((h||0)/a));if(p<=1)o.innerHTML="";else{const m=(x,M=null,k=!1)=>`<button data-page="${x}" class="px-3 py-1 rounded border ${k?"bg-black text-white":"hover:bg-black/5"}">${M||x}</button>`,b=s>1?m(s-1,"\uC774\uC804"):'<span class="px-3 py-1 text-gray-400">\uC774\uC804</span>',w=s<p?m(s+1,"\uB2E4\uC74C"):'<span class="px-3 py-1 text-gray-400">\uB2E4\uC74C</span>',$=5,f=Math.max(1,s-Math.floor($/2)),v=Math.min(p,f+$-1),y=[];for(let x=f;x<=v;x++)y.push(m(x,null,x===s));o.innerHTML=b+y.join("")+w,o.querySelectorAll("button[data-page]").forEach(x=>{x.onclick=()=>{const M=Number(x.getAttribute("data-page"))||1;this.navigate(`/?page=${M}`)}})}}}catch(o){}if(this._reqTokens.home!==d)return;e.innerHTML=this.renderPostsListHTML(c);try{const o=Array.from(e.querySelectorAll(".post-card-thumb-img"));if(o.length){const p=o.find(m=>{const b=m.getBoundingClientRect();return b&&b.height>0&&b.top>=0&&b.top<(window.innerHeight||0)*.9})||o[0];if(p){p.getAttribute("loading")==="lazy"&&p.removeAttribute("loading"),p.setAttribute("fetchpriority","high");const m=p.currentSrc||p.getAttribute("src"),b=p.getAttribute("srcset")||"",w=p.getAttribute("sizes")||"";if(m){if(!document.querySelector(`link[rel="preload"][as="image"][href="${m}"]`)){const f=document.createElement("link");f.rel="preload",f.as="image",f.href=m,b&&f.setAttribute("imagesrcset",b),w&&f.setAttribute("imagesizes",w),f.crossOrigin="anonymous",document.head.appendChild(f)}try{const f=new URL(m,window.location.origin).origin;if(!document.querySelector(`link[rel="preconnect"][href="${f}"]`)){const y=document.createElement("link");y.rel="preconnect",y.href=f,y.crossOrigin="anonymous",document.head.appendChild(y)}}catch(f){}}}}}catch(o){}}catch(c){const h=c&&(c.message||c.msg)?String(c.message||c.msg):"\uC54C \uC218 \uC5C6\uB294 \uC624\uB958",g=c&&(c.status||c.code)?String(c.status||c.code):"";e.innerHTML='<div class="error-banner"><div class="error-banner-content"><svg class="error-banner-icon" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v2h2v-2zm0-8H9v6h2V5z"/></svg><div class="error-banner-text"><div class="error-banner-title">\uAC8C\uC2DC\uAE00\uC744 \uBD88\uB7EC\uC624\uC9C0 \uBABB\uD588\uC2B5\uB2C8\uB2E4.</div><div class="error-banner-message">\uC7A0\uC2DC \uD6C4 \uB2E4\uC2DC \uC2DC\uB3C4\uD574 \uC8FC\uC138\uC694.'+(g?" ("+this.escapeHTML(g)+")":"")+'</div><div class="error-details">'+this.escapeHTML(h)+"</div></div></div></div>",this.handleError(c,"loadHomePosts")}}renderPostsListHTML(t){return t.map((e,s)=>{const i="/post/"+encodeURIComponent(e.slug||e.id),a=navigator&&navigator.connection?navigator.connection:{},r=!!a.saveData,n=a.effectiveType||"",l=r||/(^|[^a-z])(2g|3g)/.test(n),d=280,u=Math.round(d*(9/16)),c=l?70:80,h=l?[d]:[d,d*2],g="(max-width: 640px) 100vw, 280px",o=e.thumbnail_url?this.getTransformedPublicUrl(e.thumbnail_url,{width:d,height:u,resize:"cover",quality:c,format:"webp"}):null,p=e.thumbnail_url?h.map(k=>`${this.getTransformedPublicUrl(e.thumbnail_url,{width:k,height:Math.round(k*(u/d)),resize:"cover",quality:c,format:"webp"})} ${k}w`).join(", "):"",m=s===0,b=m?"":' loading="lazy"',w=m?' fetchpriority="high"':' fetchpriority="low"';if(m&&o)try{if(!document.querySelector(`link[rel="preload"][as="image"][href="${o}"]`)){const L=document.createElement("link");L.rel="preload",L.as="image",L.href=o,p&&L.setAttribute("imagesrcset",p),L.setAttribute("imagesizes",g),L.crossOrigin="anonymous",document.head.appendChild(L)}}catch(k){}const $=o?`<img src="${o}"${p?` srcset="${p}" sizes="${g}"`:""} alt="${this.escapeHTML(e.title||"")}" class="post-card-thumb-img" width="${d}" height="${u}" decoding="async"${b}${w}/>`:"",f=this.escapeHTML(String(e.title||"N").trim().charAt(0).toUpperCase()),v=`<a href="${i}" data-route class="post-card-thumb${o?"":" placeholder"}">${o?$:`<span class="thumb-initial">${f}</span>`}</a>`,y=this.formatDateKR(e.created_at),x=e.category?`<span class="badge">${this.escapeHTML(e.category)}</span>`:"",M=this.state.user?`<a href="/writer/${encodeURIComponent(e.slug)}" data-route class="btn-xs">\uD3B8\uC9D1</a>`:"";return'<article class="post-card post-card-wide" data-route data-href="'+i+`" tabindex="0"><h2 class="post-card-title"><a href="${i}" data-route>${this.escapeHTML(e.title||"\uC81C\uBAA9 \uC5C6\uC74C")}</a></h2><div class="post-card-content-grid"><div class="post-card-summary-block">`+(e.summary?`<p class="post-card-summary">${this.escapeHTML(e.summary)}</p>`:"")+`<div class="post-card-meta">\uC791\uC131\uC77C ${y}${e.category?` \xB7 \uCE74\uD14C\uACE0\uB9AC ${x}`:""}</div><div class="post-card-actions">${M}</div></div>`+v+"</div></article>"}).join("")}formatDateKR(t){try{const e=new Date(t),s=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${s}.${i}.${a}`}catch(e){return""}}formatDate(t){try{return new Date(t).toLocaleDateString("ko-KR",{year:"numeric",month:"short",day:"numeric"})}catch(e){return""}}escapeHTML(t){return String(t||"").replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[e])}async logSiteVisit(){try{const{error:t}=await this.supabase.from("site_visits").insert({visited_at:new Date().toISOString()});if(t)throw t}catch(t){console.warn("site_visits insert \uC2E4\uD328:",t.message||t)}}async uploadImageToBucket(t,e){const s=window.Config&&window.Config.IMAGE_BUCKET_NAME||"thought-images",{blob:i,width:a,height:r}=await this.convertToWebP(t),{error:n}=await this.supabase.storage.from(s).upload(e,i,{contentType:"image/webp",upsert:!0});if(n)throw n;return{savedPath:e,width:a,height:r}}async convertToWebP(t){if(t.type==="image/webp"){const r=await this.readImageFromFile(t);return{blob:t,width:r.width,height:r.height}}const e=await this.readImageFromFile(t),s=document.createElement("canvas");return s.width=e.width,s.height=e.height,s.getContext("2d").drawImage(e,0,0),{blob:await new Promise(r=>s.toBlob(r,"image/webp",.9)),width:e.width,height:e.height}}readImageFromFile(t){return new Promise((e,s)=>{const i=URL.createObjectURL(t),a=new Image;a.onload=()=>{URL.revokeObjectURL(i),e(a)},a.onerror=s,a.src=i})}}window.BlogApp=BlogApp;
