<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>Routing/Navigation Smoke Tests</title>
  <style>
    .app-view { display: none; opacity: 0; }
    .app-view.active { display: block; opacity: 1; }
  </style>
</head>
<body>
  <!-- 최소 테스트용 DOM 스캐폴드 -->
  <div id="app-loader">로딩...</div>
  <div id="main-nav-container"></div>
  <div id="app-container">
    <div id="view-library" class="app-view"></div>
    <div id="view-post" class="app-view"></div>
    <div id="view-archives" class="app-view"></div>
    <div id="view-writer" class="app-view"></div>
  </div>

  <script>
    // Supabase 최소 스텁
    window.supabase = { auth: { signOut: async () => {} } };
  </script>

  <!-- 앱 스크립트 로드 -->
  <script src="/js/config.js"></script>
  <script src="/js/dom-utils.js"></script>
  <script src="/js/ui-components.js"></script>
  <script src="/js/blog-app.js"></script>

  <script>
    function assert(cond, msg) {
      const el = document.createElement('div');
      el.textContent = (cond ? '✅ ' : '❌ ') + msg;
      el.style.color = cond ? 'green' : 'red';
      document.body.appendChild(el);
      if (!cond) console.error('Assertion failed:', msg);
    }

    function isVisible(el) {
      if (!el) return false;
      const style = window.getComputedStyle(el);
      return style.display !== 'none' && style.opacity !== '0';
    }

    window.addEventListener('DOMContentLoaded', () => {
      const app = new BlogApp();
      // 초기 라우팅 후 홈 표시 확인
      setTimeout(() => {
        const home = document.getElementById('view-library');
        assert(isVisible(home), '초기 홈(view-library)이 표시되어야 합니다');

        // 동일 뷰로 재네비게이션해도 숨김되지 않는지 확인
        app.navigate('/');
        setTimeout(() => {
          assert(isVisible(home), '동일 뷰 재전환 후에도 홈이 숨김되지 않아야 합니다');

          // 아카이브로 이동 후 네비 활성 상태 확인
          app.navigate('/archives');
          setTimeout(() => {
            const navLinks = document.querySelectorAll('#nav-links a[data-route]');
            const archivesLink = Array.from(navLinks).find(a => a.getAttribute('href') === '/archives');
            assert(!!archivesLink, '네비에 아카이브 링크가 존재해야 합니다');
            assert(archivesLink.classList.contains('font-semibold'), '아카이브 링크가 활성 스타일(font-semibold)을 가져야 합니다');
            assert(archivesLink.getAttribute('aria-current') === 'page', '아카이브 링크에 aria-current="page"가 있어야 합니다');

            // 로고 클릭 시 홈 표시 확인
            const brand = document.querySelector('#main-nav-container a[data-route][href="/"]');
            brand && brand.dispatchEvent(new MouseEvent('click', { bubbles: true }));
            setTimeout(() => {
              assert(isVisible(home), '로고 클릭 후 홈이 정상 표시되어야 합니다');
              // 레이아웃 폭 일관성 검사 (네비 vs 포스트 뷰)
              app.navigate('/post/test-slug');
              setTimeout(() => {
                const nav = document.querySelector('#main-nav-container nav');
                const post = document.querySelector('#view-post article');
                const navW = nav ? nav.getBoundingClientRect().width : 0;
                const postW = post ? post.getBoundingClientRect().width : 0;
                assert(Math.abs(navW - postW) < 2, '네비와 포스트 본문 폭이 일치해야 합니다');
              }, 50);
            }, 50);
          }, 50);
        }, 50);
      }, 50);
    });
  </script>
</body>
</html>